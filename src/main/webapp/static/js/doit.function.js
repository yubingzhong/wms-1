/*
 *
 * Welcome to view this js file. X_X
 * Name:Doit.im javascipt Function
 * Site:http://www.doit.im/
 * Description:All javascript library used in doit.im
 *
 */
if(!-[1,]){$.ajaxSetup({cache:false})}(function(){var a=document.createElement("input");window.supports={placeholder:"placeholder" in a}})();(function(a){Do.bindPlaceholder=function(b){if(!window.supports.placeholder){var e=a(b),c=e.attr("placeholder");if(c){if(b.value==""){b.value=c;a(b).addClass("placeholder")}e.focus(function(){if(this.value==c){a(this).removeClass("placeholder");this.value=""}}).blur(function(){if(this.value==""){a(this).addClass("placeholder");this.value=c}})}}};Array.prototype.emptyFilter=function(){for(i=0;i<this.length;i++){if(this[i]==""){this.splice(i,1);i--}}return this};Do.alert=function(b,c){alert(b);c()};Do.parseJSON=function(b){if(typeof(b)=="object"){return b}else{return a.parseJSON(b)}};Do.objClone=function(g){if(!g||typeof g!=="object"){return g}if(typeof g.clone==="function"){return g.clone()}var e=Object.prototype.toString.call(g);if(e==="[object Date]"){return new Date(g.getTime())}var h=e==="[object Array]"?[]:{};var f,b;for(f in g){if(g.hasOwnProperty(f)){b=g[f];if(b&&typeof b==="object"){h[f]=Do.objClone(b)}else{h[f]=b}}}return h};Do.maskAll=function(e){var f=a(document).height();var c=a('<div id="body-wrap" class="body-wrap font-family" style="display:none"></div>');if(a("#body-wrap").length){b()}else{a("body").append(c);b()}function b(){if(e=="show"){a("#body-wrap").show().height(f)}else{a("#body-wrap").hide()}}};Do.parseInt=function(b){return parseInt(b,10)};Do.addZero=function(b){if(b<10){return"0"+b}else{return b}};Do.cutText=function(c,b){if(c.length>b){c=c.substring(0,b)+"..."}return c};Do.maxText=function(c,b){if(c==null){return}if(c.length>b){c=c.substring(0,b)}return c};Do.isEmptyStr=function(b){if(b==null||b==undefined){return false}if(typeof(b)=="string"){if(b.replace(/\s/g,"")==""){return true}else{return false}}else{return false}};Do.uniqueArray=function(c){var f=[];for(var e=0,b=c.length;e<b;++e){jQuery.inArray(c[e],f)<0&&f.push(c[e])}return f};Do.trimArray=function(b){for(i=0;i<b.length;i++){b[i]=a.trim(b[i])}return b};Do.replaceArrayLastElement=function(e,c){var f=e.length;e[f-1]=c;return e};Do.escapeHTML=function(b){return(b.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;"))};Do.escapeArrayHTML=function(b){for(i=0;i<b.length;i++){if(b[i]!=null){b[i]=b[i].replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;")}}return b};Do.unescapeArrayHTML=function(b){for(i=0;i<b.length;i++){if(b[i]!=null){b[i]=b[i].replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&#39;/g,"'").replace(/&quot;/g,'"').replace(/&amp;/g,"&")}}return b};Do.unescapeHTML=function(b){if(b==null||b==""){return b}return(b.replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&#39;/g,"'").replace(/&quot;/g,'"').replace(/&amp;/g,"&"))};Do.oneByone=function(b){if(a.isArray(b)){for(i=0;i<b.length;i++){var c=b[i];alert(c);c()}}else{alert("不支持非数组的参数")}};Do.Base64=function(){_keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";this.encode=function(e){var b="";var m,k,h,l,j,g,f;var c=0;while(c<e.length){m=e[c++];k=e[c++];h=e[c++];l=m>>2;j=((m&3)<<4)|(k>>4);g=((k&15)<<2)|(h>>6);f=h&63;if(isNaN(k)){g=f=64}else{if(isNaN(h)){f=64}}b=b+_keyStr.charAt(l)+_keyStr.charAt(j)+_keyStr.charAt(g)+_keyStr.charAt(f)}return b}};Do.randomUUID=function(){var c=[];for(var b=0;b<16;b++){c[b]=Math.floor(Math.random()*256)}c[6]=(c[6]&15)|64;c[8]=(c[8]&63)|128;return c};Do.makeUUID=function(){var b=Do.randomUUID();var e=new Do.Base64();var c=e.encode(b);return c};Do.id=function(b){if(typeof b=="string"){return a(document.getElementById(b))}};Do.log=function(b){if(typeof(console)!="undefined"&&typeof(console.log)=="function"){console.log(b)}};Array.prototype.unique=function(){for(var c=0;c<this.length;c++){for(var b=0;b<this.length-c;b++){if(this[c]==this[c+b+1]){this.splice(c+b+1,1);b--}}}return this};Object.clone=function(f){var e=Object.create(Object.getPrototypeOf(f)),g=Object.getOwnPropertyNames(f);for(var b=g.length,c;b--;){c=g[b];Object.defineProperty(e,c,Object.getOwnPropertyDescriptor(f,c))}return e};if(!String.prototype.capitalize){String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)}}Do.hotkey=function(){var b=false;GTD.hotkey_close=function(){a("div.overlay").remove();a("div.hotkey_help").remove()};GTD.hotkey_toggleHotkeyHelp=function(){if(a(".hotkey_help").length>0){GTD.hotkey_close()}else{var e=a('<div class="overlay"></div>');var c=a('				<div class="hotkey_help">					<h3><a class="close_btn" href="#"><span class="hidden">close</span></a>'+L.Hotkey_TITLE+"</h3>					<ul>						<li><span>n : </span>"+L.Hotkey_NEW+"</li>						<li><span>o : </span>"+L.Hotkey_OPEN+"</li>						<li><span>u : </span>"+L.Hotkey_BACKTOLIST+"</li>                        <li><span>e : </span>"+L.Hotkey_EDIT+"</li>						<li><span>alt + c : </span>"+L.Hotkey_COMPLETE+"</li>						<li><span>d : </span>"+L.Hotkey_DELETE+"</li>						<li><span>f : </span>"+L.Hotkey_FULLSCREEN+"</li>						<li><span>p : </span>"+L.Hotkey_PRIORITY+"</li>						<li><span>j : </span>"+L.Hotkey_NEXT+"</li>						<li><span>k : </span>"+L.Hotkey_PREVIOUS+"</li>						<li><span>gi : </span>"+L.Hotkey_GOTOINBOX+"</li>						<li><span>gt : </span>"+L.Hotkey_GOTOTODAY+"</li>					</ul>				</div>");a("body").append(e).append(c);e.css({width:a(document).width()+32,height:a(document).height(),}).show();c.css({left:function(){return(a(window).width()-c.width())/2},top:function(){return a(window).scrollTop()+(a(window).height()-c.height())/2}}).show();a(document).bind("click.hotkey_help",function(g){var f=a(g.target).parents(".hotkey_help").length;if(!f){GTD.hotkey_close();a(document).unbind(".hotkey_help");return false}});c.find(".close_btn").click(function(){GTD.hotkey_close();return false})}};a(document).unbind("keyup.hotkey").bind("keyup.hotkey",function(f){if(/input|textarea/.test(f.target.tagName.toLowerCase())){return}var c=f.keyCode;switch(c){case 191:f.preventDefault();if(!f.shiftKey){a(".search-input").trigger("focus").val("")}break;default:break}});a(document).unbind("keydown.hotkey").bind("keydown.hotkey",function(n){var o=n.keyCode;if(a(".task-view:visible").length==1&&a("#taskform").is(":hidden")){if(o=="85"){n.preventDefault();a(".goback a").trigger("click")}}if(/input|textarea/.test(n.target.tagName.toLowerCase())){return}var p=a("div#task_container li.task:not(.quick)").length-1;var m=a("div#task_container li.task:not(.quick)").index(a("div#task_container li.s:last"));var j=(m==0||m==-1)?p:m-1;var l=m===p?0:m+1;switch(n.keyCode){case 27:GTD.hotkey_close();break;case 67:if(n.altKey){a("#task_group li.s").each(function(){a(this).find("div.checkbox div.task-checkbox").trigger("click")})}break;case 69:if(a("#task_group li.s").length>0){a("#task_group li.s:first .task-control-edit").trigger("click")}break;case 70:if(Doit.currentBox!="calendar"){if(a("#sidebar").is(":hidden")){var g=a("#main").data("style");a("#main").animate({marginLeft:g},1000,"easeOutBounce",function(){});a("#sidebar").animate({opacity:1},700).fadeIn("slow")}else{a("#sidebar").hide();var g=a("#main").css("marginLeft");a("#main").data("style",g);a("#main").animate({marginLeft:"0"},1000,"easeOutBounce",function(){})}}break;case 68:if(a("div#task_container li.s").length>0&&!n.altKey){a("#task_group li.s").each(function(){a(this).find(".task-control-del").trigger("click")})}break;case 71:b=true;break;case 74:a("div#task_container li.task").removeClass("s");a("div#task_container li.task:not(.quick):eq("+l+")").addClass("s");var s=a("#task_quick_add").is(":hidden")?0:a("#task_quick_add").height();var r=a("div#task_container").height()-s;var q=a("div#task_container li.s").position().top+37;if(q>r){var k=q-r;a("div#task_container").scrollTop(k)}else{a("div#task_container").scrollTop(0)}break;case 75:a("div#task_container li.task").removeClass("s");a("div#task_container li.task:not(.quick):eq("+j+")").addClass("s");var k=a("#task_container")[0].scrollHeight;var s=a("#task_quick_add").is(":hidden")?0:a("#task_quick_add").height();var q=a("div#task_container li.s").position().top+s;var f=a("#task_container").scrollTop();var c=37;if(f>q){a("div#task_container").scrollTop(f-c)}if(j==0){a("div#task_container").scrollTop(0)}if(p==j){a("div#task_container").scrollTop(k)}break;case 78:a("#sidebar_addtask").trigger("click");break;case 79:if(a("#task_group li.s").length>0){window.location.href=a("#task_group li.s:first .link-title").attr("href")}break;case 80:a("#task_group li.s").each(function(){var e={};var h=a(this).attr("id");a.each(TASKS,function(x,u){var t=u.repeat_no==null?"":"_"+u.repeat_no;var w="task_"+u.id+t;if(h==w){e=u;e.priority=e.priority==3?0:e.priority+1;a.ajax.updateTask({data:e,onSuccess:function(v){GTD.updateTask(e);if(Doit.currentGroupBy=="group_priority"){GTD.showOrHideGroup()}},onFailure:function(v){}},"")}})});break;default:}if(b){switch(n.keyCode){case 73:window.location="#/time/inbox";b=false;break;case 84:window.location="#/time/today";b=false;break;default:}}setTimeout(function(){b=false},5000);if(!a.browser.mozilla&&n.shiftKey&&n.keyCode==191){GTD.hotkey_toggleHotkeyHelp()}});if(a.browser.mozilla){a(document).bind("keypress",firefox_keypress=function(c){if(/input|textarea/.test(c.target.tagName.toLowerCase())){return}if(c.charCode==63){GTD.hotkey_toggleHotkeyHelp()}})}}})(jQuery);(function(b){b.ajax.today_resources=(function(c){a("/v1/today_resources","GET",c)});b.ajax.user_boxes=(function(c){a("/v1/boxes","GET",c)});b.ajax.add_user_boxes=(function(c,e){a("/v1/boxes","POST",c,e)});b.ajax.update_user_boxes=(function(c,e){a("/v1/boxes","PUT",c,e)});b.ajax.context_resources=(function(c){a("/v1/context_resources","GET",c)});b.ajax.project_resources=(function(c){a("/v1/project_resources","GET",c)});b.ajax.archive_resources=(function(c){a("/v1/archive_resources","GET",c)});b.ajax.review_resources=(function(c){a("/v1/review_resources","GET",c)});b.ajax.contact_resources=(function(c){a("/v1/contact_resources","GET",c)});b.ajax.calendar_resources=(function(c){a("/v1/calendar_resources","GET",c)});b.ajax.getTime=(function(c,e){a(Doit.RestTime,"GET",c,e)});b.ajax.getTask=(function(c,e){a("/v1","GET",c,e)});b.ajax.createTask=(function(c){a(Doit.RestTask,"POST",c)});b.ajax.updateTask=(function(c,e){a(Doit.RestTask,"POST",c,e)});b.ajax.listTask=(function(c,e){a(Doit.RestTask,"GET",c,e)});b.ajax.listSmartBoxTask=(function(c,e){a(Doit.RestTask,"GET",c,e)});b.ajax.listTaskByContext=(function(c,e){a(Doit.RestTask+"/context","GET",c,e)});b.ajax.createContext=(function(c){a(Doit.RestContext,"POST",c)});b.ajax.updateContext=(function(c,e){a(Doit.RestContext,"POST",c,e)});b.ajax.delContext=(function(c,e){a(Doit.RestContext,"POST",c,e)});b.ajax.createProject=(function(c){a(Doit.RestProject,"POST",c)});b.ajax.comProject=(function(c){a(Doit.RestProject,"POST",c)});b.ajax.listTaskByProject=(function(c,e){a(Doit.RestTask+"/project","GET",c,e)});b.ajax.updateProject=(function(c,e){a(Doit.RestProject,"POST",c,e)});b.ajax.delProject=(function(c,e){a(Doit.RestProject,"POST",c,e)});b.ajax.updateTask=(function(c,e){a(Doit.RestTask,"POST",c,e)});b.ajax.search=(function(c,e){a(Doit.RestSearch,"POST",c,e)});b.ajax.getPersonalInfo=(function(c,e){a(Doit.RestSetting,"GET",c,e)});b.ajax.getTagList=(function(c,e){a(Doit.RestTag,"GET",c,e)});b.ajax.updatePersonalInfo=(function(c,e){a(Doit.RestSetting,"POST",c,e)});b.ajax.updatePreference=(function(c,e){a(Doit.RestSetting,"POST",c,e)});b.ajax.resendTaskRemindKeepEmail=(function(c,e){a(Doit.RestSetting,"GET",c,e)});b.ajax.changePassword=(function(c,e){a(Doit.RestSetting,"POST",c,e)});b.ajax.delTags=(function(c,e){a(Doit.RestTag,"post",c,e)});b.ajax.createTag=(function(c,e){a(Doit.RestTag,"POST",c,e)});b.ajax.getArchiveTask=(function(c,e){a(Doit.RestArchive,"POST",c,e)});b.ajax.getCalendarTask=(function(c,e){a(Doit.RestCalendar,"GET",c,e)});b.ajax.messages=(function(c,e){a(Doit.RestMessage,"POST",c,e)});b.ajax.delMessage=(function(c,e){a(Doit.RestMessage,"POST",c,e)});b.ajax.listMessage=(function(c,e){a(Doit.RestMessage,"GET",c,e)});b.ajax.createContactGroup=(function(c){a(Doit.RestContactGroup,"POST",c)});b.ajax.updateContactGroup=(function(c,e){a(Doit.RestContactGroup,"POST",c,e)});b.ajax.delContactGroup=(function(c,e){a(Doit.RestContactGroup,"POST",c,e)});b.ajax.listContactGroup=(function(c){a(Doit.RestContactGroup,"GET",c)});b.ajax.listContact=(function(c){a(Doit.RestContact,"GET",c)});b.ajax.getContact=(function(c,e){a(Doit.RestContact,"GET",c,e)});b.ajax.createContact=(function(c,e){a(Doit.RestContact,"POST",c,e)});b.ajax.updateContact=(function(c,e){a(Doit.RestContact,"POST",c,e)});b.ajax.delContact=(function(c,e){a(Doit.RestContact,"POST",c,e)});b.ajax.delSingleContact=(function(c,e){a(Doit.RestContactGroup,"POST",c,e)});b.ajax.listTaskByContactGroup=(function(c,e){a(Doit.RestTask+"/contact_group","GET",c,e)});b.ajax.listTaskByContact=(function(c,e){a(Doit.RestTask+"/contact","GET",c,e)});b.ajax.listUngroupedContactTask=(function(c,e){a(Doit.RestTask+"/contact_group","GET",c,e)});b.ajax.addContactToGroup=(function(c){a(Doit.RestContact+"/contacts","POST",c)});b.ajax.archiveCompleted=(function(c,e){a(Doit.RestTask,"POST",c,e)});b.ajax.clearTrash=(function(c,e){a(Doit.RestTask,"POST",c,e)});b.ajax.checkLength=(function(c,e){a(Doit.RestCheckLength,"GET",c,e)});b.ajax.sortList=(function(c,e){a(Doit.RestTask,"POST",c,e)});function a(e,g,c,f){GTD.loadingData("show");b.ajax({url:f?e+"/"+f:e,type:g,data:JSON.stringify(c.data),contentType:"application/json; charset=utf-8",timeout:60000,complete:function(j,k){GTD.loadingData("hide");var h=j.status;switch(k){case"success":if(h==200&&c.onSuccess){c.onSuccess(j);GTD.loadingData("hide")}break;case"error":switch(h){case 401:GTD.M({text:L.AJAX_401,duration:60000},"error");setTimeout(function(){window.location="/signin"},5000);break;case 400:if(c.onError){c.onError(j)}break;case 500:if(c.onFailure){c.onFailure(j)}GTD.M({text:L.AJAX_500,duration:60000},"error");break;case 502:GTD.M({text:L.AJAX_500,duration:60000},"error");break;default:GTD.M({text:L.AJAX_ERROR,duration:60000},"error");break}break;case"timeout":GTD.M({text:L.AJAX_TIMEOUT,duration:60000},"error");break;default:break}}})}})(jQuery);(function(a){Time.setTodayDateToLocalDate=function(){return Time.setDateTime(Doit.time.format("yyyy-mm-dd HH:MM"))};Time.setDateToLocalDate=function(b){return Time.setDateTime(b.format("yyyy-mm-dd"))};Time.setDateToLocalDateTime=function(b){return Time.setDateTime(b.format("yyyy-mm-dd HH:MM"))};Time.setDateTime=function(g){if(!g||g==""||g==L.TASK_START_AT||g==L.TASK_END_AT){return null}var b=a.trim(g).split(" ");var f=b[0].split("-");var e=f[0]+"-"+f[1]+"-"+f[2];if(b[1]!=null){var c=b[1].split(":");e=e+"T"+c[0]+":"+c[1]+Time.zoneToString(Do.cookie("user_timezone"))}else{e=e+"T00:00"+Time.zoneToString(Do.cookie("user_timezone"))}date=Time.strToDatetime(e);return date};Time.strToDatetime=function(c){if(!c||c==""){return null}var b=new Date();b.setISO8601(c);return b};Time.strToDate=function(c){if(c==null||c==""){return null}var b=new Date(Doit.time);if((typeof c)=="string"){b.setISO8601(Time.dateStrToISO8601Str(c));b=Time.userDay(b)}else{b=Time.userDay(c)}return b};Time.strToDateObject=function(b){b=Time.strToDatetimeStr(b);return Time.setDateTime(b)};Time.strToDateIgTimezone=function(b){b=Time.strToDatetimeStr(b).replace(/-/g,"/");return new Date(b)};Time.userDay=function(c){var e=new Date();var g=Time.zoneToString(Do.cookie("user_timezone"));var f=c.toISO8601String(4,g);var b=f.split(/\-|\T|\+/);var h=b[0]+"-"+b[1]+"-"+b[2]+"T00:00"+g;e.setISO8601(h);return e};Time.strToDatetimeStr=function(g){var b=new Date();if(g==null){return""}if((typeof g)=="string"){if(g==""){return""}var c=g.split(/\-|\ |\:/);return c[0]+"-"+c[1]+"-"+c[2]+" "+c[3]+":"+c[4]}else{var f=Time.zoneToString(Do.cookie("user_timezone"));b=g;var e=b.toISO8601String(4,f);var c=e.split(/\-|\T|\+/);return c[0]+"-"+c[1]+"-"+c[2]+" "+c[3]}};Time.zoneToString=function(e){var f=e.split(".");var h=f[0];if(f.length==1){var g="0"}else{var g=Do.parseInt(f[1])*(0.6)}var c=h>=0?"+":"-";var b=Do.addZero(h<0?-h:h);return c+b+":"+g+"0"};Time.zoneToRubyString=function(e){var f=e.split(".");var h=f[0];if(f.length==1){var g="0"}else{var g=Do.parseInt(f[1])*(0.6)}var c=h>=0?"+":"-";var b=Do.addZero(h<0?-h:h);return c+b+ +g+"0"};Time.dateStrToISO8601Str=function(e){var b=e.split(" ");var c=b[1].split(":");return b[0]+"T"+c[0]+":"+c[1]+Time.zoneToString(Do.cookie("user_timezone"))};Time.userDayStr=function(c){var f=Time.zoneToString(Do.cookie("user_timezone"));var e=c.toISO8601String(4,f);var b=e.split(/\-|\T|\+/);var g=b[0]+"-"+b[1]+"-"+b[2];return g};Date.prototype.setISO8601=function(c){var e="([0-9]{4})(-([0-9]{2})(-([0-9]{2})(T([0-9]{2}):([0-9]{2})(:([0-9]{2})(.([0-9]+))?)?(Z|(([-+])([0-9]{2}):([0-9]{2})))?)?)?)?";var g=c.match(new RegExp(e));var f=0;var b=new Date(g[1],0,1);if(g[3]){b.setMonth(g[3]-1)}if(g[5]){b.setDate(g[5])}if(g[7]){b.setHours(g[7])}if(g[8]){b.setMinutes(g[8])}if(g[10]){b.setSeconds(g[10])}if(g[12]){b.setMilliseconds(Number("0."+g[12])*1000)}if(g[14]){f=(Number(g[16])*60)+Number(g[17]);f*=((g[15]=="-")?1:-1)}f-=b.getTimezoneOffset();time=(Number(b)+(f*60*1000));this.setTime(Number(time))};Date.prototype.toISO8601String=function(f,j){if(!f){var f=6}if(!j){var j="Z";var b=this}else{var h=j.match(/([-+])([0-9]{2}):([0-9]{2})/);var e=(Number(h[2])*60)+Number(h[3]);e*=((h[1]=="-")?-1:1);var b=new Date(Number(Number(this)+(e*60000)))}var k=function(l){return((l<10)?"0":"")+l};var g="";g+=b.getUTCFullYear();if(f>1){g+="-"+k(b.getUTCMonth()+1)}if(f>2){g+="-"+k(b.getUTCDate())}if(f>3){g+="T"+k(b.getUTCHours())+":"+k(b.getUTCMinutes())}if(f>5){var c=Number(b.getUTCSeconds()+"."+((b.getUTCMilliseconds()<100)?"0":"")+k(b.getUTCMilliseconds()));g+=":"+k(c)}else{if(f>4){g+=":"+k(b.getUTCSeconds())}}if(f>3){g+=j}return g};Date.prototype.getUserDate=function(){var c=this;var b=c.getUserDateArray();return Do.parseInt(b[2])};Date.prototype.getUserDay=function(){var c=this;var b=new Date();b.setFullYear(c.getUserFullYear());b.setMonth(c.getUserMonth());b.setDate(c.getUserDate());b.setHours(0,0,0,0);return b.getDay()};Date.prototype.getUserMonth=function(){var c=this;var b=c.getUserDateArray();return Do.parseInt(b[1])-1};Date.prototype.getUserDateArray=function(){var c=this;var f=Time.zoneToString(Do.cookie("user_timezone"));var e=c.toISO8601String(4,f);var b=e.split(/\-|\T|\+/);return b};Date.prototype.getUserFullYear=function(){var c=this;var b=c.getUserDateArray();return Do.parseInt(b[0])};Date.prototype.getUserHours=function(){var c=this;var b=c.getUserDateArray();return Do.parseInt(b[3])};Date.prototype.getUserMinutes=function(){var c=this;var b=c.getUserDateArray();return Do.parseInt(b[4])};Date.prototype.getUserSeconds=function(){var c=this;var b=c.getUserDateArray();return Do.parseInt(b[5])};String.prototype.toDateTime=function(){if(!this||this==""){return}var c=new Date();var b=this.split(" ");var g=b[0].split("-");var f=g[0]+"-"+g[1]+"-"+g[2];if(b[1]!=null){var e=b[1].split(":");f=f+"T"+e[0]+":"+e[1]+Time.zoneToString(Do.cookie("user_timezone"))}else{f=f+"T00:00"+Time.zoneToString(Do.cookie("user_timezone"))}c=Time.strToDatetime(f);return c};Time.timeToDate=function(c){if(typeof(c)=="string"){var b=Time.strToDateObject(c)}else{var b=c}return b};Time.dateToLocaldate=function(c,b){d=b==null?new Date():b;utc=d.getTime()+(d.getTimezoneOffset()*60000);nd=new Date(utc+(3600000*c));return nd}})(jQuery);(function($){$.fn.ellipsis=function(enableUpdating){var s=document.documentElement.style;if(!("textOverflow" in s||"OTextOverflow" in s)){return this.each(function(){var el=$(this);if(el.css("overflow")=="hidden"){var originalText=el.html();var w=el.width();var t=$(this.cloneNode(true)).hide().css({position:"absolute",width:"auto",overflow:"visible","max-width":"inherit"});el.after(t);var text=originalText;while(text.length>0&&t.width()>el.width()){text=text.substr(0,text.length-1);t.html(text+"...")}el.html(t.html());t.remove();if(enableUpdating==true){var oldW=el.width();setInterval(function(){if(el.width()!=oldW){oldW=el.width();el.html(originalText);el.ellipsis()}},200)}}})}else{return this}};$.fn.selection=function(){var s,e,range,stored_range;if(this[0].selectionStart==undefined){var selection=document.selection;if(this[0].tagName.toLowerCase()!="textarea"){var val=this.val(),range=selection.createRange().duplicate();range.moveEnd("character",val.length);s=(range.text==""?val.length:val.lastIndexOf(range.text));range=selection.createRange().duplicate();range.moveStart("character",-val.length);e=range.text.length}else{range=selection.createRange();stored_range=range.duplicate();stored_range.moveToElementText(this[0]);stored_range.setEndPoint("EndToEnd",range);s=stored_range.text.length-range.text.length;e=s+range.text.length}}else{s=this[0].selectionStart;e=this[0].selectionEnd}var te=this[0].value.substring(s,e);return{start:s,end:e,text:te}};GTD.syncTime=function(){$.ajax.getTime({onSuccess:function(resp){var data_time=Do.parseJSON(resp.responseText).server_time.split(" ");Doit.time=new Date(data_time[0].replace(/-/g,"/")+" "+data_time[1])}},"")};GTD.find_contact_name_by_user_email=function(id){for(var i=0;i<Doit.contacts.length;i++){if(id==Doit.contacts[i].email){return Doit.contacts[i].name}}};GTD.find_contacts_name_by_user_emails=function(emails){if(emails==null){return null}var str="";for(i=0;i<emails.items.length;i++){var name=GTD.find_contact_name_by_user_email(emails.items[i].contact);str=str+name+","}str=str.substring(0,str.length-1);return str};GTD.find_contact_name_by_user_emails=function(ids){if(ids!=null){var str="";for(var i=0;i<ids.items.length;i++){str=str+ids.items[i].contact+","}str=str.substring(0,str.length-1);return str}else{if(GTD.Contact.selection_contact_id!=null){var str=$(document.getElementById(GTD.Contact.selection_contact_id)).text();return str}}};GTD.remindMathBack=function(time_str,start_str){var return_time=new Object();var time=new Date(time_str);var start=new Date(start_str);var last_time=eval(start-time)/1000/60;if(last_time%1440==0){return_time.time=last_time/1440;return_time.unit="day"}else{if(last_time%60==0){return_time.time=last_time/60;return_time.unit="hour"}else{return_time.time=last_time;return_time.unit="min"}}if(last_time==0){return_time.unit="min"}return return_time};GTD.addToArray=function(data,array){array.push(data)};GTD.loadingData=function(type){switch(type){case"show":$("#data_loading").show();break;case"hide":setTimeout(function(){$("#data_loading").hide()},500);break;default:alert("Foolish!")}};GTD.getMonthWeekByDay=function(date){var month_week={};month_week.day=date.getDay();var date=date.getDate();var num=1;while(date-7>0){num++;date=date-7}month_week.num=num;return month_week};$.fn.isNumInput=function(){return this.each(function(){var A=$(this);A.bind("keyup",function(event){if(!/^[0-9]*$/.test(A.val())){A.val("");GTD.M(L.I_TASKS_INPUT_NUMBER)}})})};$.fn.isNumInputLargeThanZero=function(){return this.each(function(){var A=$(this);A.bind("keyup",function(event){if(!/^[0-9]*$/.test(A.val())||Do.parseInt(A.val())<=0){A.val("1");GTD.M(L.I_TASKS_INPUT_NUMBER_0)}})})};Doit.getTid=function(){if($.inArray(Doit.currentBox,["context","project"])==-1){return null}return GTD[Doit.currentBox.capitalize()]["selection_"+Doit.currentBox+"_id"]};GTD.disableSelection=function(){$("body").attr("unselectable","on").css({MozUserSelect:"none",WebkitUserSelect:"none"})};GTD.enableSelection=function(){$("body").attr("unselectable","off").css({MozUserSelect:"",WebkitUserSelect:""})}})(jQuery);GTD.showDate=function(f){var a=f;if(a.hasClass("disabled")){return}function n(s){var j=s.val()||a.val();if((j.split(" ").length==1)&&(j.split("-").length==3)){return true}else{return false}}function l(s){var j=s.val()||a.val();if((j.split(" ").length==2)&&(j.split("-").length==3)){return true}else{return false}}function c(s){var j=s.val();if(j.split("-").length==1){return true}else{return false}}function w(s){var j=s.val()||a.val();if(!l(j)){return}else{return j}}function m(s){var j=s.val()||a.val();if(!c(s)){return}else{return j.split(" ")[0]}}function h(s){var j=s.val()||a.val();if(!l(s)){return}else{return j.split(" ")[1]}}function H(s){var j=s.val()||a.val();if(c(s)){return}else{return new Date(j.replace(/-/g,"/"))}}function z(j){return j<10?("0"+j):j}$("#dpDiv").remove();var p=Doit.weekstartday=="Sunday"?0:1;$.datepicker.setDefaults($.datepicker.regional["zh-CN"]);$.datepicker.setDefaults({firstDay:p});a.parents(".meta-inner").find(".popup").append('<div id="dpDiv"><div id="left_date"></div><div id="right_date"></div><div class="clear"></div><input type="hidden" id="hidden_date" name="hidden_date" value="" /></div>');$("#right_date").html("<h3>"+L.DATEPICKER_TIME+"</h3><div id='all_date_pan'><div id='date_time'></div><div class='every-hour' id='date_up'><span class='ui-icon ui-icon-triangle-1-n'/></span></div><div id='date_out_wrap'><ul id='date_hh_mm'></ul></div><div class='every-hour' id='date_down'><span class='ui-icon ui-icon-triangle-1-s'/></span></div></div><div id='unsetDate'>"+L.DATEPICKER_UNSET+"</div><button id='submitDate' type='button'>"+L.DATEPICKER_OK+"</button>");if((a.hasClass("task-end-at"))&&(!c($("#taskform .task-start-at")))){var g=a.val().split(" ");var v=new Date(H($("#taskform .task-start-at")));if(v.getHours()==23){v.setHours(v.getHours()+1)}if(g.length==2){$("#hidden_date").val(g[0]);$("#left_date").datepicker({defaultDate:g[0],onSelect:function(s,j){$("#hidden_date").val(s)},dateFormat:"yy-mm-dd",minDate:v});$("#date_time").text(g[1])}else{if(g.length==1){var r=g[0].split("-");if(r.length==3){$("#hidden_date").val(g[0]);$("#left_date").datepicker({defaultDate:a.val(),onSelect:function(s,j){$("#hidden_date").val(s)},dateFormat:"yy-mm-dd",minDate:v})}else{var k=new Date(Doit.time).getHours();if((k>=22)&&(a.data("realVal")==null)&&(n($("#taskform .task-start-at")))){v.setDate(v.getDate()+1);var C=v.getFullYear()+"-"+z(v.getMonth()+1)+"-"+z(v.getDate());$("#hidden_date").val(C);$("#left_date").datepicker({onSelect:function(s,j){$("#hidden_date").val(s)},dateFormat:"yy-mm-dd",minDate:v})}else{var C=v.getFullYear()+"-"+z(v.getMonth()+1)+"-"+z(v.getDate());$("#hidden_date").val(C);$("#left_date").datepicker({onSelect:function(s,j){$("#hidden_date").val(s)},dateFormat:"yy-mm-dd",minDate:v})}}}}}else{if(a.hasClass("repeat_end_at")){$("#right_date").remove();var v=new Date(H(a.parent().find(".repeat_start_at")));$("#hidden_date").val(v.getFullYear()+"-"+z(v.getMonth()+1)+"-"+v.getDate());$("#left_date").datepicker({onSelect:function(s,j){setTimeout(function(){a.val(s);$("#dpDiv").remove()},200)},dateFormat:"yy-mm-dd",minDate:v})}else{if(a.hasClass("nlinput")){if(!Do.isEmptyStr($("#task_start_at").val())){var N=new Date($("#task_start_at").val().replace(/-/g,"/")).addMinutes(-10).format("yyyy-mm-dd HH:MM")}else{var N=Do.objClone(Doit.time).addMinutes(10).format("yyyy-mm-dd HH:MM")}var b=N.substring(0,N.length-6);$("#hidden_date").val(b);a.data("realVal",N);$("#left_date").datepicker({onSelect:function(s,j){setTimeout(function(){$("#hidden_date").val(s)},200);return false},dateFormat:"yy-mm-dd",defaultDate:b})}else{if((a.hasClass("task-end-at"))&&(c($("#taskform .task-start-at")))){var k=new Date(Doit.time).getHours();if(a.data("realVal")==null){var g=a.val().split(" ");v=new Date(Doit.time);if(k>=22){v.setDate(v.getDate()+1)}var C=v.getFullYear()+"-"+z(v.getMonth()+1)+"-"+z(v.getDate());$("#hidden_date").val(C);$("#left_date").datepicker({onSelect:function(s,j){$("#hidden_date").val(s)},dateFormat:"yy-mm-dd",defaultDate:g[0],});$("#date_time").text(g[1])}else{N=new Date(a.data("realVal").replace(/-/g,"/"));var C=N.getFullYear()+"-"+z(N.getMonth()+1)+"-"+z(N.getDate());$("#hidden_date").val(C);$("#left_date").datepicker({onSelect:function(s,j){$("#hidden_date").val(s)},dateFormat:"yy-mm-dd",defaultDate:N});$("#date_time").text(a.data("realVal").split(" ")[1])}}else{var g=a.val().split(" ");if(g.length==2){$("#hidden_date").val(g[0]);$("#left_date").datepicker({defaultDate:g[0],onSelect:function(s,j){$("#hidden_date").val(s)},dateFormat:"yy-mm-dd"});$("#date_time").text(g[1])}if(g.length==1){var r=g[0].split("-");if(r.length==3){$("#hidden_date").val(g[0]);$("#left_date").datepicker({defaultDate:$.trim(a.val()),onSelect:function(s,j){$("#hidden_date").val(s)},dateFormat:"yy-mm-dd"})}else{$("#left_date").datepicker({onSelect:function(s,j){$("#hidden_date").val(s)},dateFormat:"yy-mm-dd"})}}}}}}$("#submitDate").hover(function(){$(this).addClass("up-down-hover")},function(){$(this).removeClass("up-down-hover")});$("#date_up").hide();$("#date_out_wrap").hide();$("#date_down").hide();var E=new Date(Doit.time);var A=E.getFullYear();var e=E.getMonth()+1;var O=E.getDate();var M=E.getHours();var J=E.getMinutes();var Q=new Array();for(var K=0;K<24;K++){for(var I=0;I<60;I+=15){var t=(K<10?"0"+K:K);var q=(I<10?"0"+I:I);$("<li id='li_"+t+"_"+q+"'>"+t+":"+q+" "+(K<12?"AM":"PM")+"</li>").appendTo($("#date_hh_mm"));if((K==M&&I>=J)||(K==M+1)){var D=t+":"+q;Q.push(D)}}}if(Q.length==0){Q.push("23:45")}if($("#hidden_date").val()==""){$("#hidden_date").val(A+"-"+z(parseInt(e,10))+"-"+z(parseInt(O,10)))}$("#date_time").toggle(function(){$("#date_up").show();$("#date_out_wrap").show();$("#date_down").show()},function(){$("#date_up").hide();$("#date_out_wrap").hide();$("#date_down").hide()});$("#date_hh_mm>li").each(function(){if($(this).attr("id").substring($(this).attr("id").length-2,$(this).attr("id").length)=="00"){$(this).addClass("every-hour")}$(this).bind("click",function(){$("#date_time").html($(this).html());$("#date_hh_mm>li").each(function(){$(this).removeClass("date-time-click");if($(this).attr("id").substring($(this).attr("id").length-2,$(this).attr("id").length)=="00"){$(this).addClass("every-hour")}});$(this).removeClass("every-hour");$(this).addClass("date-time-click")});$(this).hover(function(){$(this).addClass("date-time-hover")},function(){$(this).removeClass("date-time-hover")});if(a.val().split(" ").length==2){if($(this).text().indexOf(a.val().split(" ")[1])!=-1){var s=$.inArray(this,$("#date_hh_mm>li"));$("#date_hh_mm li:first-child").css("margin-top",-s*16+"px");if(parseInt($("#date_hh_mm li:first-child").css("margin-top"),10)<-1424){$("#date_hh_mm li:first-child").css("margin-top",-1424+"px")}$(this).attr("class","date-time-click");$("#date_time").html($(this).html())}}else{if((a.hasClass("task-end-at"))&&($("#taskform .task-start-at").val().split(" ").length==2)){var j=new Date(Doit.time);j.setHours(parseInt($("#taskform .task-start-at").val().split(" ")[1].split(":")[0],10)+1);j.setMinutes(parseInt($("#taskform .task-start-at").val().split(" ")[1].split(":")[1],10));var R=z(j.getHours())+":"+z(j.getMinutes());if($(this).text().indexOf(R)!=-1){$(this).attr("class","date-time-click");var s=$.inArray(this,$("#date_hh_mm>li"));$("#date_hh_mm li:first-child").css("margin-top",-s*16+"px");if(parseInt($("#date_hh_mm li:first-child").css("margin-top"),10)<-1424){$("#date_hh_mm li:first-child").css("margin-top",-1424+"px")}$("#date_time").html($(this).html())}}else{if($(this).text().indexOf(Q[0])!=-1){$(this).attr("class","date-time-click");var s=$.inArray(this,$("#date_hh_mm>li"));$("#date_hh_mm li:first-child").css("margin-top",-s*16+"px");if(parseInt($("#date_hh_mm li:first-child").css("margin-top"),10)<-1424){$("#date_hh_mm li:first-child").css("margin-top",-1424+"px")}$("#date_time").html($(this).html())}}}});function F(){$("#date_hh_mm li:first-child").css("margin-top",parseInt($("#date_hh_mm li:first-child").css("margin-top"),10)>=0?0:(parseInt($("#date_hh_mm li:first-child").css("margin-top")))+16+"px")}function y(){$("#date_hh_mm li:first-child").css("margin-top",parseInt($("#date_hh_mm li:first-child").css("margin-top"),10)<=-1424?-1424:(parseInt($("#date_hh_mm li:first-child").css("margin-top")))-16+"px")}$("#date_up").mouseover(function(){timeID=setInterval(F,100);$(this).addClass("up-down-hover")});$("#date_up").mouseout(function(){clearInterval(timeID);$(this).removeClass("up-down-hover")});$("#date_down").mouseover(function(){timeID=setInterval(y,100);$(this).addClass("up-down-hover")});$("#date_down").mouseout(function(){clearInterval(timeID);$(this).removeClass("up-down-hover")});$("#date_out_wrap").hover(function(){$(this).bind("mousewheel",function(s,R){var j=R<0?y:F;j();s.preventDefault()})},function(){$(this).unbind("mousewheel")});if($("#taskform_allday").attr("checked")&&!a.hasClass("nlinput")){GTD.showRightTimePan()}else{GTD.hideRightTimePan()}$("#dpDiv").css("top",a.position().top+a.outerHeight());$("#dpDiv").css("left",a.position().left);if(a.hasClass("task-start-at")){$("#unsetDate").remove()}else{if(a.hasClass("task-end-at")){var x;var u=$("#taskform .task-start-at").val();if(u.split("-").length==3){if(u.split(" ").length==2){}else{var t=(M+2)>=24?(M+2-24):(M+2);x=z(t)+":00 "+((M+2)<12?"AM":"PM")}}else{var t=(M+2)>=24?(M+2-24):(M+2);x=z(t)+":00 "+((M+2)<12?"AM":"PM")}$("#date_time").text(x)}}$("#date_hh_mm>li").each(function(){if($(this).text().indexOf($("#date_time").text().split(" ")[0])!=-1){$("#date_hh_mm>li").each(function(){$(this).removeClass("date-time-click")});var j=$.inArray(this,$("#date_hh_mm>li"));$("#date_hh_mm li:first-child").css("margin-top",-j*16+"px");if(parseInt($("#date_hh_mm li:first-child").css("margin-top"),10)<-1424){$("#date_hh_mm li:first-child").css("margin-top",-1424+"px")}$(this).attr("class","date-time-click");$("#date_time").html($(this).html())}$(this).bind("dblclick",P)});function P(){GTD.showRightTimePan();GTD.hideRightTimePan()}$("#dpDiv").find("a.ui-state-default").parent("td").bind("click",o);if(a.data("realVal")!=null||a.data("realVal")!=undefined){var B=a.data("realVal");var G=B.split(" ")[1];$("#date_time").html(G+" "+(G<12?"AM":"PM"))}$("#submitDate").bind("click",o);function o(){var j=$("#hidden_date").val()+" "+$("#date_time").html();j=j.substring(0,j.length-3);a.val(j);a.data("realVal",j);if(a.hasClass("task-start-at")){GTD.makeLeftGTRight(a,j);$(".repeat_end_at").val(L.END_TIME);$(".repeat_start_at").html($("#hidden_date").val());$("#taskform .task-starttime").trigger("click")}else{if(a.hasClass("nlinput")){$("#dpDiv").remove();return false}else{GTD.makeLeftGTRight(a,j);$(".task-deadline .meta-default-text").hide();$(".task-deadline .clear-this").show();$("#taskform .task-deadline").trigger("click")}}GTD.Taskform.setDataByDatepicker(this,j,a);$("#taskform .meta .popup").hide();$("#dpDiv").remove();return false}$("#unsetDate").click(function(j){if(a.attr("id")=="task_end_at"){$(".task-deadline .clear-this").trigger("click");j.stopPropagation()}$("#dpDiv").remove()})};GTD.showRightTimePan=function(){$("#date_time").addClass("date-time-disable");$("#date_time").unbind("click");$("#date_up").hide();$("#date_out_wrap").hide();$("#date_down").hide()};GTD.hideRightTimePan=function(){$("#date_time").removeClass("date-time-disable");$("#date_time").toggle(function(){$("#date_up").show();$("#date_out_wrap").show();$("#date_down").show()},function(){$("#date_up").hide();$("#date_out_wrap").hide();$("#date_down").hide()})};GTD.moveTaskToCal=function(e){$("#dpDiv").remove();$("#movetocal").remove();var h=Doit.weekstartday=="Sunday"?0:1;$.datepicker.setDefaults($.datepicker.regional["zh-CN"]);$.datepicker.setDefaults({firstDay:h});$(".positioning-x").append('<div id="movetocal" class="movetocal-datepicker"><div id="left_date"></div><div id="right_date"></div><div class="clear"></div><input type="hidden" id="hidden_date" name="hidden_date" value="" /></div>');$("#movetocal").fadeIn(700);$("#right_date").html("<label for='movetocal_allday'><input checked type='checkbox' id='movetocal_allday' />"+L.DATEPICKER_TIME+"</label><div id='all_date_pan'><div id='date_time'></div><div class='every-hour' id='date_up'><span class='ui-icon ui-icon-triangle-1-n'/></span></div><div id='date_out_wrap'><ul id='date_hh_mm'></ul></div><div class='every-hour' id='date_down'><span class='ui-icon ui-icon-triangle-1-s'/></span></div></div><div id='unsetDate'>"+L.CANCEL+"</div><button id='submitDate' type='button'>"+L.DATEPICKER_OK+"</button>");$("#movetocal_allday").bind("click",function(){if($(this).attr("checked")){$("#date_time").removeClass("date-time-disable")}else{$("#date_time").addClass("date-time-disable")}});var n=new Date(new Date(Doit.time).setDate(Doit.time.getDate()+2));$("#hidden_date").val(n.format("yyyy-mm-dd"));$("#left_date").datepicker({onSelect:function(s,j){$("#hidden_date").val(s)},dateFormat:"yy-mm-dd",minDate:n});$("#date_up").hide();$("#date_out_wrap").hide();$("#date_down").hide();var f=new Date(Doit.time);var r=f.getFullYear();var p=f.getMonth()+1;var c=f.getDate();var b=f.getHours();var a=f.getMinutes();var g=new Array();for(var t=0;t<24;t++){for(var q=0;q<60;q+=15){var u=(t<10?"0"+t:t);var v=(q<10?"0"+q:q);$("<li id='li_"+u+"_"+v+"'>"+u+":"+v+" "+(t<12?"AM":"PM")+"</li>").appendTo($("#date_hh_mm"));if((t==b&&q>=a)||(t==b+1)){var m=u+":"+v;g.push(m)}}}if(g.length==0){g.push("23:45")}if($("#hidden_date").val()==""){$("#hidden_date").val(r+"-"+Do.addZero(parseInt(p,10))+"-"+Do.addZero(parseInt(c,10)))}$("#date_time").toggle(function(){$("#date_up").show();$("#date_out_wrap").show();$("#date_down").show()},function(){$("#date_up").hide();$("#date_out_wrap").hide();$("#date_down").hide()});$("#date_hh_mm>li").each(function(){if($(this).attr("id").substring($(this).attr("id").length-2,$(this).attr("id").length)=="00"){$(this).addClass("every-hour")}$(this).bind("click",function(){$("#date_time").html($(this).html());$("#date_hh_mm>li").each(function(){$(this).removeClass("date-time-click");if($(this).attr("id").substring($(this).attr("id").length-2,$(this).attr("id").length)=="00"){$(this).addClass("every-hour")}});$(this).removeClass("every-hour");$(this).addClass("date-time-click")});$(this).hover(function(){$(this).addClass("date-time-hover")},function(){$(this).removeClass("date-time-hover")});if($(this).text().indexOf(g[0])!=-1){$(this).attr("class","date-time-click");var j=$.inArray(this,$("#date_hh_mm>li"));$("#date_hh_mm li:first-child").css("margin-top",-j*16+"px");if(parseInt($("#date_hh_mm li:first-child").css("margin-top"),10)<-1424){$("#date_hh_mm li:first-child").css("margin-top",-1424+"px")}$("#date_time").html($(this).html())}});function w(){$("#date_hh_mm li:first-child").css("margin-top",parseInt($("#date_hh_mm li:first-child").css("margin-top"),10)>=0?0:(parseInt($("#date_hh_mm li:first-child").css("margin-top")))+16+"px")}function k(){$("#date_hh_mm li:first-child").css("margin-top",parseInt($("#date_hh_mm li:first-child").css("margin-top"),10)<=-1424?-1424:(parseInt($("#date_hh_mm li:first-child").css("margin-top")))-16+"px")}$("#date_up").mouseover(function(){timeID=setInterval(w,100);$(this).addClass("up-down-hover")});$("#date_up").mouseout(function(){clearInterval(timeID);$(this).removeClass("up-down-hover")});$("#date_down").mouseover(function(){timeID=setInterval(k,100);$(this).addClass("up-down-hover")});$("#date_down").mouseout(function(){clearInterval(timeID);$(this).removeClass("up-down-hover")});$("#date_out_wrap").hover(function(){$(this).bind("mousewheel",function(s,x){var j=x<0?k:w;j();s.preventDefault()})},function(){$(this).unbind("mousewheel")});$("#date_hh_mm>li").each(function(){if($(this).text().indexOf($("#date_time").text().split(" ")[0])!=-1){$("#date_hh_mm>li").each(function(){$(this).removeClass("date-time-click")});var j=$.inArray(this,$("#date_hh_mm>li"));$("#date_hh_mm li:first-child").css("margin-top",-j*16+"px");if(parseInt($("#date_hh_mm li:first-child").css("margin-top"),10)<-1424){$("#date_hh_mm li:first-child").css("margin-top",-1424+"px")}$(this).attr("class","date-time-click");$("#date_time").html($(this).html())}$(this).bind("dblclick",l)});function l(){GTD.showRightTimePan();GTD.hideRightTimePan()}$("#submitDate").bind("click",o);function o(){var x=$("#movetocal_allday").attr("checked")?$("#date_time").html():"00:00 AM";if($("#movetocal_allday").attr("checked")){var j=false}else{var j=true}var s=$("#hidden_date").val()+" "+$("#date_time").html();s=s.substring(0,s.length-3)+" "+Time.zoneToRubyString(Do.cookie("user_timezone"));e(s,j);$("#movetocal").remove()}$("#unsetDate").click(function(){$("#movetocal").remove()})};(function(f){GTD.getTaskParent=function(m,l){switch(Doit.currentGroupBy){case"group_context":l=f(document.getElementById("groupby_context_"+(m.context_id==null?"none":encodeURIComponent(m.context_id)))).find(".taskList");break;case"group_project":l=f(document.getElementById("groupby_project_"+(m.project_id==null?"none":encodeURIComponent(m.project_id)))).find(".taskList");break;case"group_priority":l=f("#groupby_priority_"+m.priority+" .taskList");break;default:if(Doit.currentBox=="scheduled"){l=GTD.isRepeat(m)?f("div#groupby_schedule_repeat ul.taskList"):f("div#groupby_schedule_"+GTD.getTaskTimeValue(m)+" ul.taskList")}return l}return l};GTD.getTaskDataById=function(n,m){for(var l=0;l<TASKS.length;l++){if(TASKS[l]==null){l++}if(m!=null){if(n==TASKS[l].id&&m==TASKS[l].repeat_no){return TASKS[l]}}else{if(n==TASKS[l].id&&TASKS[l].repeat_no==null){return TASKS[l]}}}};GTD.prependTaskNode=function(l,m){var n=f(l);n.prepend(m)};GTD.isRepeatModeNode=function(l){return"scheduled"==Doit.currentBox&&"repeat"==l};GTD.isSendTask=function(m){var l=GTD.getTaskForwardValue(m);return l&&"receive"!=l};GTD.isReceiveTask=function(m){var l=GTD.getTaskForwardValue(m);return l&&"receive"==l};GTD.canTaskDrag=function(l){return((!GTD.isWaitingOthers(l)&&!GTD.isSendTask(l))||Doit.currentBox=="project"||Doit.currentBox=="context")&&"contact"!=Doit.currentBox&&Doit.currentBox!="archiver"&&Doit.currentBox!="smartbox"};GTD.checkBoxComplete=function(l){var m=f(l);return m.bind("click",function(o){var n=f(o.target).parent().parent();GTD.completeTask(n);o.stopPropagation()})};GTD.completeTask=function(m){var n=m.attr("repeat_no")=="undefined"?null:m.attr("repeat_no");var o=m.attr("tid");var l=GTD.getTaskDataById(o,n);if(m.hasClass("completed")){m.removeClass("completed");l.completed=null}else{m.addClass("completed");l.completed=Doit.time;l.now=false}GTD.taskUnescapeHTML(l);f.ajax.updateTask({data:l,onSuccess:function(s){GTD.taskEscapeHTML(l);GTD.removeTaskFromArray(l);var r="";if(l.repeat_no!=null){r="_"+l.repeat_no}if(m.is("li")){var t="taskview_task_"+l.id+r;Do.id(t).toggleClass("completed")}else{if(m.hasClass("task-view")){var t="task_"+l.id+r;m=Do.id(t);m.toggleClass("completed");Do.id("taskview_"+t).hide().remove();window.location=f(".goback a").attr("href");f("#toolbar .goback a").trigger("click")}}if(Doit.currentBox=="trash"){return}if(m.hasClass("completed")){m.effect("transfer",{to:"completed",className:"ui-effects-transfer"},500,function(){GTD.fadeOut(m)})}else{var q=GTD.getTaskBox(l);var p=Doit.currentBox;GTD.fadeOut(m);if(p!=q){f("div#sidebar li#"+q).effect("highlight",{color:"#0069bc"},500)}}GTD.reduceCount();GTD.setTasksCount(Doit.currentBox);if(window.name=="doitnow"){t=m.attr("id");window.opener.GTD.removeTaskFromArray(l);window.opener.GTD.reduceCount();window.opener.GTD.fadeOutParent(t,"normal")}},onFailure:function(p){}},"")};GTD.emptyTasks=function(){f('#task_container .group,#task_container li.task:not(".quick")').remove()};GTD.emptyPage=function(){GTD.emptyTasks();f("#empty_tip_content").hide();GTD.quickAdd.hide();f("#task_container").hide();f("#sidebar .in .focus").hide();f("#sidebar .in .more").hide();f("#sidebar .in .fixed").hide();f("#setting_content").hide().empty()};GTD.showPage=function(){f("#task_container").show()};GTD.markStar=function(l){f(l).bind("click",function(){var o=f(this).parents(".task");var m=o.attr("tid");var n=o.attr("repeat_no");var p=GTD.find_task_by_id_repeatno(TASKS,m,n);if(n==null){n=""}else{n="_"+n}var q=Do.objClone(p);if(f(this).hasClass("s")){GTD.set_next(p);f(l).removeClass("s")}else{GTD.set_today(p);f(l).addClass("s")}GTD.taskUnescapeHTML(p);f.ajax.updateTask({data:p,onSuccess:function(s){if(f.inArray(Doit.currentBox,["context","project","contact"])>-1){GTD.taskEscapeHTML(p);GTD.updateTaskList(p)}else{GTD.removeTask(p);var r=GTD.getTaskBox(p);if(Doit.currentBox!=r){f("div#sidebar li#"+r).effect("highlight",{color:"#0069bc"},500);GTD.increaseCount(f("#today"))}if(Doit.currentBox=="today"){GTD.reduceCount()}}if(window.name=="doitnow"){var t="task_"+m+n;window.opener.GTD.removeTaskFromArray(p);window.opener.GTD.reduceCount();window.opener.GTD.fadeOutParent(t,"normal")}},onFailure:function(){f(l).toggleClass("s");p=q},onError:function(){f(l).toggleClass("s");p=q}},"");return false})};GTD.markNow=function(l){f(l).bind("click",function(){var o=f(this).parents(".task");var m=o.attr("tid");var n=o.attr("repeat_no");var p=GTD.find_task_by_id_repeatno(TASKS,m,n);if(n==null){n=""}else{n="_"+n}var q=Do.objClone(p);if(f(this).hasClass("s")){p.now=false;f(l).removeClass("s")}else{if(Doit.currentBox!="today"){GTD.set_today(p)}p.now=true;f(l).addClass("s")}GTD.taskUnescapeHTML(p);f.ajax.updateTask({data:p,onSuccess:function(r){if(f.inArray(Doit.currentBox,["next"])>-1){GTD.removeTask(p);f("div#sidebar li#today").effect("highlight",{color:"#0069bc"},500);GTD.increaseCount(f("#today"))}else{if(f(l).hasClass("s")){o.fadeOut("fast",function(){var t=o.parents(".group");f("#groupby_now .taskList").append(o);if(t.find("li").length==0){t.hide()}o.effect("highlight",1000);GTD.showOrHideGroup()});if(p.now&&Doit.currentBox=="today"){o.draggable("option","disabled",true);o.removeClass("ui-state-disabled")}}else{if(window.name=="doitnow"){var s="task_"+m+n;GTD.removeTaskFromArray(p);GTD.fadeOut(Do.id(s),"normal");window.opener.GTD.refreshTaskList()}else{o.fadeOut("fast",function(){f(this).remove();GTD.showOrHideGroup();var t=Doit.currentGroupBy;GTD.group.addNewTask(p,t)})}}GTD.taskEscapeHTML(p);GTD.updateTaskList(p)}if(GTD.childWindow!=undefined&&!GTD.childWindow.closed){GTD.childWindow.location.reload()}},onFailure:function(){f(l).toggleClass("s");p=q},onError:function(){f(l).toggleClass("s");p=q}},"");return false})};GTD.addTask=function(U,l,u,T){if(U==null){return}var s=GTD.getTaskWaitValue(U);var B=GTD.getTaskScheduleValue(U);var J=GTD.getTaskForwardValue(U);var M=GTD.getTaskTimeBox(U);var t=GTD.getTaskBox(U);var S="";var V=GTD.findNameByUUID(Doit.contexts,U.context_id);var n=GTD.findNameByUUID(Doit.projects,U.project_id);if(U.repeat_no!=null){S="_"+U.repeat_no}var G=f("<li></li>").attr({id:"task_"+U.id+S,order:T,tid:U.id,box:t,wait:s,forward:J,time:M,schedule:B,context:V,project:n,priority:U.priority,tags:U.tags}).addClass("task");if(U.repeat_no!=null){G.attr("repeat_no",U.repeat_no)}if(U.completed!=null){G.addClass("completed")}if(!u){u=GTD.getTaskParent(U,f("#taskList"))}if(l){GTD.prependTaskNode(u,G)}else{u.append(G)}var K=f('<div class="pri" title="'+L.taskbar_priority+'"></div>');G.append(K);var z=f("<div class='drag'></div>");G.append(z);G.draggable({cursorAt:{left:10},handle:".drag",appendTo:"body",scroll:false,iframeFix:true,revert:"invalid",start:function(){if(GTD.isRepeat(U)){f("#sidebar li").not("#completed").not("#trash").droppable("option","disabled",true)}GTD.disableSelection()},helper:function(X){if(f(this).hasClass("s")&&f(".task.s").length>1){return f("<li>"+f(".task.s").length+" "+L.i_tasks_selected+"</li>").addClass("task-move")}else{var W=f(this).clone().width(f(this).width()).css({opacity:"0.7",border:"1px solid #cccccc"});W.find(".task-control").hide();return W}},stop:function(){f("#sidebar li").droppable("option","disabled",false);GTD.enableSelection()}});if(U.now&&Doit.currentBox=="today"){G.draggable("option","disabled",true);G.removeClass("ui-state-disabled")}if(!GTD.canTaskDrag(U)){z.css({visibility:"hidden"});G.draggable("option","disabled",true);G.removeClass("ui-state-disabled")}var p=f("<div class='icon'></div>");var o=f("<div class='checkbox'><div class='task-checkbox' tid='"+U.id+S+"'></div></div>");if(U.archived==null){GTD.checkBoxComplete(o.find(".task-checkbox"))}G.append(o);if(U.notes&&U.notes!=""){var m=f("<div class='comment'></div>").attr("title",Do.unescapeHTML(U.notes));p.append(m)}if(U.reminders&&U.reminders.length>0){var P=f("<div class='reminder'></div>").attr("title",L.taskbar_reminder);p.append(P)}if(U.priority>0){K.addClass("pri-"+U.priority)}else{K.addClass("pri-0")}if(GTD.isForwardMe(U)){var y=GTD.find_contact_name_by_user_email(U.forwarded_by);var Q=f("<div class='forward'></div>").attr("title",L.taskbar_forward+y);p.append(Q)}if(GTD.isSendTask(U)){var H=GTD.find_contacts_name_by_user_emails(U.assignment);var v=f("<div class='forward'></div>").attr("title",L.taskbar_forward_to+H);p.append(v)}if(Doit.currentBox!="archiver"&&Doit.currentBox!="completed"&&Doit.currentBox!="trash"){var w=f("<div class='today'></div>").attr("title",L.taskbar_today);p.append(w);GTD.markStar(w);if(GTD.isTodayTask(U)){w.addClass("s")}}p.append('<div class="mask"></div>');var D=f('<div class="task-time"><div class="end-at"></div></div>');var F=D.find(".end-at");var N=GTD.get_taskbar_end_at(U,D);if(N!=""){D.find(".end-at").css("display","block").html(N)}p.append(D);G.append(p);if(window.name!="doitnow"){var r=f("<div class='title'></div>").append('<a class="link-title" title="'+U.title+'" href="#/task/'+U.id+S+'">'+U.title+"</a>")}else{var r=f("<div class='title'></div>").append('<a class="link-title" title="'+U.title+'" href="javascript:;">'+U.title+"</a>")}r.find("span").taskview();var R=f('<div class="start-at"></div>');var E=GTD.get_taskbar_start_at(U,R);if(E!=""){r.prepend(R.html(E))}if(GTD.isRepeat(U)){var x=f("<div class='repeat'></div>").attr("title",L.taskbar_repeat);r.prepend(x)}if(V&&(Doit.currentBox=="project"||f.inArray(Doit.getTid(),["all","none",null])>-1)){var O=f("<a href='#/context/"+U.context_id+"' title='"+L.TF_CONTEXT+":"+V+"' class='context'>@</a>").append(V);r.append(O)}else{G.removeAttr("context")}if(n&&(Doit.currentBox=="context"||f.inArray(Doit.getTid(),["all","none",null])>-1)){var I=f("<a href='#/project/"+U.project_id+"' title='"+L.TF_PROJECT+":"+n+"' class='project'>#</a>").append(n);r.append(I)}else{G.removeAttr("project")}G.append(r);if(window.name!="doitnow"){G.taskview()}else{G.doitnowTaskview()}var A=f('<div class="task-control" style="display:none"></div>');G.hover(function(){var W=Math.random();A.data("hoverSN",W);setTimeout(function(){if(A.data("hoverSN")==W){A.show()}},250)},function(){A.stop();A.hide().data("hoverSN",0)});if(U.trashed==null&&Doit.currentBox!="archiver"){var C=f('<div class="task-control-icon task-control-edit" title="'+L.EDIT+'">'+L.EDIT+"</div>");C.editTask(TASKS);A.append(C)}var q=f('<div class="task-control-icon task-control-del" title="'+L.DELETE+'">'+L.DELETE+"</div>");q.removeTask(TASKS);A.append(q);if(!S){A.find("div").attr("data-id",U.id)}else{A.find("div").attr("data-id",U.id).attr("data-repeat-no",S.replace(/_/g,""))}p.prepend(A);G.find(".title a").ellipsis();return G};GTD.get_taskbar_end_at=function(r,s){if(r.end_at==null||GTD.isRepeat(r)||f.inArray(Doit.currentBox,["completed","archiver"])>-1){return""}var u=s.find(".end-at");u.show();var o=r.all_day;var v=Do.cookie("user_timezone");var n=Time.strToDate(r.end_at);var p=Time.timeToDate(r.end_at);var q=Time.dateToLocaldate(v,p);var m=Time.strToDate(Time.setTodayDateToLocalDate());var l=Date.compare(n,m);switch(l){case -1:var t=(m-n)/(3600*24*1000);u.addClass("past");if(t==1){return L.i_task_overdue+t+L.i_task_overdue2}else{return L.i_task_overdue+t+L.i_task_overdue3}break;case 0:u.addClass("past");if(o){return L.i_task_dueday}else{if(typeof(r.end_at)=="string"){return L.i_task_dueday+' <span class="more">('+r.end_at.split(" ")[1].substring(0,5)+")</span>"}else{return L.i_task_dueday+' <span class="more">('+(Time.dateToLocaldate(v,r.end_at).toString("HH:mm"))+")</span>"}}break;case 1:var t=(n-m)/(3600*24*1000);if(t<=14){u.addClass("less");return L.i_task_dayleft1+t+L.i_task_dayleft2}else{u.addClass("more");if(m.getFullYear()==p.getFullYear()){return q.format("isTaskbarTime")}else{return q.getFullYear()}}break;default:break}};GTD.get_taskbar_start_at=function(s,p){if(s.start_at==null||GTD.isRepeat(s)||f.inArray(Doit.currentBox,["completed","archiver"])>-1){return""}var q=s.all_day;var w=Do.cookie("user_timezone");var t=Time.strToDate(s.start_at);var r=Time.timeToDate(s.start_at);var l=Time.dateToLocaldate(w,r);var v=Time.setTodayDateToLocalDate();var n=Time.strToDate(v);var m=Date.compare(t,n);switch(m){case 1:var u=n.getWeek();var o=t.getWeek();if(Date.equals(n.addDays(1),t)){if(q){if(Doit.currentBox!="tomorrow"){return L.TOMORROW}else{return""}}else{if(Doit.currentBox!="tomorrow"){return L.TOMORROW+" "+Time.dateToLocaldate(w,r).toString("HH:mm")}else{return Time.dateToLocaldate(w,r).toString("HH:mm")}}}else{if(u==o){return Time.dateToLocaldate(w,r).format("taskbarStartatWeek")}else{if(t.getFullYear()==n.getFullYear()){return l.format("isTaskbarTime")}else{if(t.getFullYear()>n.getFullYear()){return l.getFullYear()}}}}break;case 0:if(q){if(Doit.currentBox!="today"){}}else{if(v.getTime()>r.getTime()){p.addClass("past")}return Time.dateToLocaldate(w,r).toString("HH:mm")}break;case -1:p.addClass("past");if(n.getFullYear()==t.getFullYear()){return l.format("isTaskbarTime")}else{return l.getFullYear()}break;default:break}};GTD.isTaskCanDrop=function(p){var q=f(p).attr("tid");var o=f(p).attr("repeat_no");var n=Do.objClone(GTD.find_task_by_id_repeatno(TASKS,q,o));var l=n.end_at;var m=GTD.Taskform.checkToday(l);return m};GTD.isToCurrentBox=function(l){if("context"==Doit.currentBox){return GTD.Context.selection_context_id==l.attr("uuid")||(GTD.Context.selection_context_id=="none"&&"context_none"==l.attr("id"))||"context_all"==l.attr("id")}else{if("project"==Doit.currentBox){return GTD.Project.selection_project_id==l.attr("uuid")||(GTD.Project.selection_project_id=="none"&&"project_none"==l.attr("id"))||"project_all"==l.attr("id")}else{return Doit.currentBox==l.attr("id")}}};f.fn.editTask=function(l){return this.click(function(p){var m=f(this).attr("data-id");var o=f(this).attr("data-repeat-no");var q=GTD.find_task_by_id_repeatno(l,m,o);var n=GTD.isWaitingOthers(q);var r=GTD.isWaitingMe(q);q=Do.objClone(q);Do.log("当前编辑的任务数据的克隆↓");Do.log(q);if(n){GTD.Taskform.popup("sent",q)}else{if(r){GTD.Taskform.popup("received",q)}else{GTD.Taskform.popup("edit",q)}}return false})};f.fn.removeTask=function(l){return this.click(function(t){t.stopPropagation();var u=f(".taskList");var r=f(this).attr("data-id");var v=f(this).attr("data-repeat-no");var p=GTD.find_task_by_id_repeatno(l,r,v);if(v==null){v=""}else{v="_"+v}var o="task_"+r+v;var m="taskview_"+o;var n=f(document.getElementById(o));var s=f(document.getElementById(m));if(Doit.currentBox=="trash"){p.deleted=Doit.time}else{GTD.set_trash(p)}var q=f("#trash");GTD.taskUnescapeHTML(p);f.ajax.updateTask({data:p,onSuccess:function(w){GTD.removeTaskFromArray(p);f(".paper-tab .spec").trigger("click");if(s.is("div")){s.fadeOut("fast",function(){GTD.fadeOut(n,"normal");window.location=f(".goback a").attr("href");f("#toolbar .goback a").trigger("click")})}else{GTD.fadeOut(n,"normal")}GTD.reduceCount();if(window.name=="doitnow"){id=n.attr("id");window.opener.GTD.removeTaskFromArray(p);window.opener.GTD.reduceCount();window.opener.GTD.fadeOutParent(id,"normal")}},onFailure:function(w){}},"")})};GTD.removeTask=function(m){if(m.repeat_no!=null){var n="_"+m.repeat_no}else{n=""}var l=f(".taskList").find('li[id="task_'+m.id+n+'"]');GTD.reduceCount();GTD.removeTaskFromArray(m);GTD.fadeOut(l);if(f(".task-view:visible").length!=0){window.location=f(".goback a").attr("href");f(".goback a").trigger("click")}};f.fn.archiveTask=function(m){var l=f(this);l.click(function(){parent=f(".taskList");var n=l.attr("data-id");var o=l.attr("data-repeat-no");data=GTD.find_task_by_id_repeatno(m,n,o);if(o==null){o=""}else{o="_"+o}var q="task_"+n+o;var r="taskview_"+q;var p=f(document.getElementById(q));var s=f(document.getElementById(r));GTD.taskUnescapeHTML(data);data.archived=Doit.time;f.ajax.updateTask({data:data,onSuccess:function(t){GTD.M("任务已归档！");GTD.removeTaskFromArray(data);f(".paper-tab .spec").trigger("click");s.fadeOut("fast",function(){GTD.fadeOut(p,"normal");window.location=f(".goback a").attr("href");f("#toolbar .goback a").trigger("click")});GTD.reduceCount()},onFailure:function(t){}},"")})};GTD.moveTask=function(m,q){if(GTD.isToCurrentBox(q)){return}if(m.length>1){var l=[];m.each(function(){var w=f(this).attr("id");var v=f(this).attr("tid");var u=f(this).attr("repeat_no");var s=GTD.find_task_by_id_repeatno(TASKS,v,u);GTD.taskUnescapeHTML(s);l.push(s)})}else{var r=m.attr("id");var p=m.attr("tid");var o=m.attr("repeat_no");var l=GTD.find_task_by_id_repeatno(TASKS,p,o);GTD.taskUnescapeHTML(l)}if(l.length==undefined&&l!=null){if(GTD.isRepeatno(l)&&"completed"==q.attr("id")){l.completed=Doit.time;f.ajax.updateTask({data:l,onSuccess:function(s){GTD.removeTaskFromArray(l);GTD.increaseCount(q);GTD.reduceCount();m.effect("transfer",{to:q.attr("id"),className:"ui-effects-transfer"},500,function(){GTD.fadeOut(m);GTD.loadingData("hide")})},onFailure:function(s){}},"")}else{if(GTD.isRepeat(l)&&"context"!=Doit.currentBox&&"project"!=Doit.currentBox&&"contact"!=Doit.currentBox&&"archiver"!=Doit.currentBox){if("scheduled"==q.attr("id")){return false}else{GTD.loadingData("show");GTD.buildTask(l,q.attr("id"),Doit.currentBox);f.ajax.updateTask({data:l,onSuccess:function(s){if(GTD.isInAll()&&!GTD.isOut(q.attr("id"))){GTD.updateTask(l,f("#task-title")).effect("highlight",1000);GTD.loadingData("hide")}else{GTD.removeTaskFromArray(l);GTD.increaseCount(q);GTD.reduceCount();m.effect("transfer",{to:q.attr("id"),className:"ui-effects-transfer"},500,function(){GTD.fadeOut(m);GTD.loadingData("hide")})}}},"")}}else{if(!GTD.isRepeat(l)&&"scheduled"==q.attr("id")){GTD.moveTaskToCal(function(t,s){l.all_day=s;GTD.set_schedule(l,t);f.ajax.updateTask({data:l,onSuccess:function(u){GTD.removeTaskFromArray(l);GTD.increaseCount(q);GTD.reduceCount();m.effect("transfer",{to:q.attr("id"),className:"ui-effects-transfer"},500,function(){GTD.fadeOut(m);GTD.loadingData("hide")})}},"")})}else{if(!GTD.isRepeat(l)&&GTD.isWaitingOthers(l)&&Doit.currentBox!="project"&&Doit.currentBox!="context"&&("trash"!=q.attr("id")||"completed"!=q.attr("id"))){return false}else{function n(){GTD.buildTask(l,q.attr("id"),Doit.currentBox);f.ajax.updateTask({data:l,onSuccess:function(s){if(GTD.isInAll()&&!GTD.isOut(q.attr("id"))||Doit.currentBox=="search"){GTD.updateTask(l,f("#task-title")).effect("highlight",1000)}else{GTD.removeTaskFromArray(l);GTD.increaseCount(q);GTD.reduceCount();m.effect("transfer",{to:q.attr("id"),className:"ui-effects-transfer"},500,function(){GTD.fadeOut(m)})}}},"")}n()}}}}return}else{if(Doit.currentBox!="scheduled"&&"scheduled"==q.attr("id")){GTD.moveTaskToCal(function(t,s){f.each(l,function(v){var u=this;u.all_day=s;GTD.set_schedule(u,t);f.ajax.updateTask({data:u,onSuccess:function(w){GTD.removeTaskFromArray(u);GTD.increaseCount(q);GTD.reduceCount();m.eq(v).effect("transfer",{to:q.attr("id"),className:"ui-effects-transfer"},500,function(){GTD.fadeOut(m.eq(v));GTD.loadingData("hide")})}},"")})})}}};GTD.fadeOut=function(m,n){if(n==null){n="fast"}var l=m.parents(".group");m.fadeOut(n,function(){m.removeClass("s");m.remove();if(l.find("li").length==0){l.hide()}if(TASKS.length==0||f("#task_group").find("li.task").length==0){GTD.EmptyTip("show")}})};GTD.fadeOutParent=function(o,n){var m=Do.id(o);if(n==null){n="fast"}var l=m.parents(".group");m.fadeOut(n,function(){m.removeClass("s");m.remove();if(l.find("li").length==0){l.hide()}if(TASKS.length==0||f("#task_group").find("li.task").length==0){GTD.EmptyTip("show")}})};GTD.updateTaskArray=function(m){for(var l=0;l<TASKS.length;l++){if(m.id==TASKS[l].id&&m.repeat_no==TASKS[l].repeat_no){TASKS.splice(l,1,m);TASKS_FILTER=TASKS;break}}};GTD.updateTask=function(Q,O,x){var F=GTD.getTaskWaitValue(Q);var I=GTD.getTaskScheduleValue(Q);var y=GTD.getTaskForwardValue(Q);var v=GTD.getTaskTimeBox(Q);var z=GTD.getTaskBox(Q);var o=GTD.findNameByUUID(Doit.contexts,Q.context_id);var p=GTD.findNameByUUID(Doit.projects,Q.project_id);if(Q.repeat_no!=null){var E="_"+Q.repeat_no}else{E=""}GTD.updateTaskArray(Q);if(!x){x=GTD.getTaskParent(Q,f("#taskList"))}var G=f("#task_container").find('li[id="task_'+Q.id+E+'"]');if(x.parent().attr("id")!=G.parent().parent().attr("id")){GTD.prependTaskNode(x,G);GTD.showOrHideGroup()}if(!GTD.canTaskDrag(Q)){G.find(".drag").css({visibility:"hidden"});G.draggable("option","disabled",true);G.removeClass("ui-state-disabled")}else{G.find(".drag").css({visibility:"visible"});G.draggable("option","disabled",false)}if(G.find(".icon").length==0){var D=f("<div class='icon'></div>")}else{var D=G.find(".icon")}var q=G.find(".pri").removeClass().addClass("pri");if(G.find(".checkbox").length==0){var P=f("<div class='checkbox'><div class='task-checkbox' tid='"+Q.id+E+"'></div></div>");G.append(P);GTD.checkBoxComplete(P.find(".task-checkbox"))}G.find(".repeat").remove();G.find(".project").remove();G.find(".context").remove();G.find(".comment").remove();G.find(".reminder").remove();G.find(".priority1").remove();G.find(".priority2").remove();G.find(".priority3").remove();G.find(".today").remove();G.find(".doitnow").remove();G.find(".overdue").remove();G.find(".dayleft").remove();G.find(".forward").remove();G.find(".start-at").remove();if(v){G.attr("time",v)}else{G.removeAttr("time")}if(z){G.attr("box",z)}else{G.removeAttr("box")}if(F){G.attr("wait",F)}else{G.removeAttr("wait")}if(Q.notes&&Q.notes!=""){var t=f("<div class='comment'></div>").attr("title",Do.unescapeHTML(Q.notes));D.append(t)}if(Q.reminders&&Q.reminders.length>0){var w=f("<div class='reminder'></div>").attr("title",L.taskbar_reminder);D.append(w)}if(Q.priority>0){q.addClass("pri-"+Q.priority)}else{q.addClass("pri-0")}if(GTD.isForwardMe(Q)){var C=GTD.find_contact_name_by_user_email(Q.forwarded_by);var r=f("<div class='forward'></div>").attr("title",L.taskbar_forward+C);D.append(r)}if(GTD.isSendTask(Q)){var K=GTD.find_contacts_name_by_user_emails(Q.assignment);var J=f("<div class='forward'></div>").attr("title",L.taskbar_forward_to+K);D.append(J)}if(Doit.currentBox!="archiver"&&Doit.currentBox!="completed"&&Doit.currentBox!="trash"){var s=f("<div class='today'></div>").attr("title",L.taskbar_today);D.append(s);GTD.markStar(s);if(GTD.isTodayTask(Q)){s.addClass("s")}}var A=G.find(".title");A.before(D);G.find(".link-title").html(Q.title);var m=G.find(".task-time");var n=m.find(".end-at");var u=GTD.get_taskbar_end_at(Q,m);if(u!=""){n.css("display","block").html(u)}else{n.css("display","none")}D.append(m);G.append(D);var M=f('<div class="start-at"></div>');var N=GTD.get_taskbar_start_at(Q,M);if(N!=""){A.prepend(M.html(N))}if(GTD.isRepeat(Q)){var l=f("<div class='repeat'></div>").attr("title",L.taskbar_repeat);A.prepend(l)}if(o&&(Doit.currentBox=="project"||f.inArray(Doit.getTid(),["all","none",null])>-1)){var B=f("<a href='#/context/"+Q.context_id+"' title='"+L.TF_CONTEXT+":"+o+"' class='context'>@</a>").append(o);A.append(B)}else{G.removeAttr("context")}if(p&&(Doit.currentBox=="context"||f.inArray(Doit.getTid(),["all","none",null])>-1)){var H=f("<a href='#/project/"+Q.project_id+"' title='"+L.TF_PROJECT+":"+p+"' class='project'>#</a>").append(p);A.append(H)}else{G.removeAttr("project")}G.attr("priority",Q.priority);G.attr("schedule",I);G.attr("wait",F);G.attr("forward",y);G.find(".title a").ellipsis();return G};GTD.showOrHideGroup=function(){var l=f("div#task_group .group");l.each(function(){var m=f(this);if(m.children("ul.taskList").children("li.task").length>0){m.show()}else{m.hide()}})};GTD.reduceCount=(function(){var n=f("#"+Doit.currentBox);var m=n.find(".count");if(m){var l=Do.parseInt(m.html());GTD.updateCount(n,l-1)}GTD.setTitle(null,l-1)});GTD.increaseCount=(function(o){var n=f(o);var m=n.find(".count");if(m){var l=Do.parseInt(m.html());GTD.updateCount(n,l+1)}GTD.setTitle()});GTD.updateCount=function(m,l){if(m){var n=m.find(".count");if(n){n.html(l)}}GTD.setTitle()};GTD.setTasksCount=function(m){switch(m){case"today":var l=f(".taskList li:not(.completed)").size();f("#today .count").html(l);GTD.setTitle(null,l);break;case"inbox":var l=f(".taskList li:not(.completed)").size();f("#inbox .count").html(l);GTD.setTitle(null,l);break;default:break}};GTD.removeTaskFromArray=function(m){for(var l=0;l<TASKS.length;l++){if(TASKS[l]==null){l++}if(m.id==TASKS[l].id&&m.repeat_no==TASKS[l].repeat_no){TASKS.splice(l,1);TASKS_FILTER=TASKS;break}}};GTD.isOut=function(l){return"context_none"==l||"project_none"==l||"completed"==l||"trash"==l};GTD.isInAll=function(){return("project"==Doit.currentBox&&"all"==GTD.Project.selection_project_id)||("context"==Doit.currentBox&&"all"==GTD.Context.selection_context_id)};GTD.buildTask=function(m,l,n){switch(l){case"inbox":GTD.set_inbox(m);break;case"next":GTD.set_next(m);break;case"today":GTD.set_today(m);break;case"waiting":GTD.set_waiting(m);break;case"tomorrow":GTD.set_tomorrow(m);break;case"someday":GTD.set_someday(m);break;case"completed":GTD.set_completed(m);break;case"trash":GTD.set_trash(m);break;default:if("project"==n){GTD.set_project(m,Do.id(l).attr("uuid"))}else{if("context"==n){GTD.set_context(m,Do.id(l).attr("uuid"))}else{if("search"==n){if(l=="context_none"||l=="context_all"||/^s\_context/.test(l)){GTD.set_context(m,Do.id(l).attr("uuid"))}else{if(l=="project_none"||l=="project_all"||/^s\_project/.test(l)){GTD.set_project(m,Do.id(l).attr("uuid"))}}}}}break}};f.fn.showTaskList=function(){var l=f(this);l.empty();if(TASKS&&TASKS.length==0){return l}f.each(TASKS,function(m){GTD.addTask(this,null,l,TASKS.length-m)});GTD.setTaskPaperHeight();return l};GTD.getOverdueTagTask=function(l){var n;if(typeof(l.end_at)=="string"){var q=Time.strToDate(l.end_at);if(q==null){return false}n=q.getTime()-3600*24*1000*7}else{if(l.end_at==null){return false}n=Time.userDay(l.end_at).getTime()-3600*24*1000*7}var m=Time.setDateToLocalDate(new Date(Doit.time));if(GTD.notDeletedAndNotCompleted(l)&&l.attribute=="plan"&&m.getTime()>=n){var o=(m.getTime()-n)/(3600*24*1000);var p=7-Do.parseInt(o);return p}return null};GTD.showDuePast=function(l){var m=Do.parseInt(GTD.getOverdueTagTask(l));if(m<0){m=m*(-1);if(m==1){return[L.i_task_overdue+m+L.i_task_overdue2,m]}else{return[L.i_task_overdue+m+L.i_task_overdue3,m]}}else{if(m==0){return[L.i_task_dueday,"!"]}}return null};GTD.showOverDue=function(l){var m=GTD.getOverdueTagTask(l);if(m>0){return L.i_task_dayleft1+m+L.i_task_dayleft2}return null};GTD.isIn=function(l,m){if("smartbox"==m){return false}else{if("scheduled"==m){return GTD.isScheduleJS(l)}else{if("completed"==m){return GTD.isCompleted(l)}else{if("trash"==m){return GTD.isTrash(l)}else{if("waiting"==m){return GTD.isWaiting(l)}}}}}if(GTD.isRepeat(l)){return false}if("context"==m){return h(l)}else{if("project"==m){return c(l)}else{if("inbox"==m){return GTD.isInbox(l)}else{if("next"==m){return GTD.isNext(l)}else{if("today"==m){return GTD.isTodayJS(l)}else{if("tomorrow"==m){return GTD.isTomorrowJS(l)}else{if("someday"==m){return GTD.isSomedayJS(l)}else{if(m=="smartbox"){return true}}}}}}}}};GTD.isTomorrowJS=function(l){if(l.start_at==null){return false}var n=Time.strToDate(l.start_at);var m=Time.setTodayDateToLocalDate();m=Time.userDay(m);m.setDate(m.getDate()+1);return m.getTime()==n.getTime()&&!GTD.isRepeat(l)&&!GTD.isWaiting(l)};GTD.isSomedayJS=function(l){return !GTD.isRepeat(l)&&l.start_at==null&&!GTD.isWaiting(l)};GTD.isRepeatTask=function(l,n){var m=new Date(Doit.time);m=Time.userDay(m);if("today"==n){}else{if("tomorrow"==n){m.setDate(m.getDate()+1)}else{if("project"==n){return GTD.isRepeat(l)&&l.start_at!=null&&c(l)}else{if("context"==n){return GTD.isRepeat(l)&&l.start_at!=null&&h(l)}}}}return GTD.isInRepeat(m,l)};function h(l){var m=GTD.Context.selection_context_id;return GTD.notDeletedAndNotCompleted(l)&&((l.context_id==m)||(m=="all"&&l.context_id!=null)||((m=="none")&&l.context_id==null))&&!GTD.isWaiting(l)}function c(l){var m=GTD.Project.selection_project_id;return GTD.notDeletedAndNotCompleted(l)&&((l.project_id==m)||(m=="all"&&l.project_id!=null)||((m=="none")&&l.project_id==null))&&!GTD.isWaiting(l)}GTD.needAddNode=function(l){if("scheduled"==Doit.currentBox){return GTD.isSchedule(l)}else{if("waiting"==Doit.currentBox){return GTD.isWaitingBox(l)}}if(GTD.isRepeat(l)){return false}if("context"==Doit.currentBox){return h(l)}else{if("project"==Doit.currentBox){return c(l)}else{if("inbox"==Doit.currentBox){return GTD.isInbox(l)}else{if("today"==Doit.currentBox){return GTD.isToday(l)}else{if("tomorrow"==Doit.currentBox){return GTD.isTomorrow(l)}else{if("someday"==Doit.currentBox){return GTD.isSomeday(l)}}}}}}};GTD.isInRepeat=function(m,l){if(f.isEmptyObject(l.start_at)){return false}if(!GTD.isRepeat(l)){return false}return true};function e(m){var n=(m+1)/7;var l=(m+1)%7;if(l>0){return n+1}else{return n}}function a(n,m){var p=m.repeater;var q=Time.strToDate(p.ends_on);if(q!=null&&(q.getTime()+3600*24*1000)<=n.getTime()){return false}var l=Time.strToDate(m.start_at);if(l.getTime()>n.getTime()){return false}var o=(n.getTime()-l.getTime())%(3600*24*1000*Do.parseInt(p.cycle));if(o==0){return true}return false}function j(n,m){var o=m.repeater;var p=Time.strToDate(o.ends_on);if(p&&(p.getTime()+3600*1000*24)<=n.getTime()){return false}var l=Time.strToDate(m.start_at);if(l.getTime()>n.getTime()){return false}if("weekday"==o.repeats_by){if(e(l.getUserDate())==e(n.getUserDate())&&l.getUserDay()==n.getUserDay()){return true}}else{if(l.getUserDate()==n.getUserDate()){return true}}return false}function g(o,n){var r=n.repeater;var s=Time.strToDate(r.ends_on);if(s&&(s.getTime()+3600*1000*24)<=o.getTime()){return false}var m=Time.strToDate(n.start_at);var l;if(typeof(r.day)=="string"){l=r.day.split(/,/)}else{l=r.day}for(var p=0;p<l.length;p++){m.setDate(m.getDate()-(m.getUserDay()-Do.parseInt(l[p])));var q=(o.getTime()-m.getTime())%(3600*24*1000*7*Do.parseInt(r.cycle));if(q==0){return true}}return false}function b(n,m){var o=m.repeater;var p=Time.strToDate(o.ends_on);if(p&&(p.getTime()+3600*1000*24)<=n.getTime()){return false}var l=Time.strToDate(m.start_at);if(l.getTime()>n.getTime()){return false}if(n.getUserDay()>=1&&n.getUserDay()<=5){return true}return false}function k(n,m){var p=m.repeater;var q=Time.strToDate(p.ends_on);if(q&&(q.getTime()+3600*1000*24)<=n.getTime()){return false}var l=Time.strToDate(m.start_at);if(l.getTime()>n.getTime()){return false}var o=(n.getUserFullYear()-l.getUserFullYear())%Do.parseInt(p.cycle);if(o==0&&n.getUserMonth()==l.getUserMonth()&&n.getUserDate()==l.getUserDate()){return true}return false}GTD.changeReminderTime=function(p,n){var o=p.reminders;var r=p.start_at;if(typeof(r)=="string"){r=Time.strToDateObject(r)}if(o==[]){return[]}for(i=0;i<o.length;i++){item=o[i];var m=n;var q=item.time;if(typeof(q)=="string"){q=Time.strToDatetimeStr(q).replace(/-/g,"/")}if(typeof(m)=="string"){m=Time.strToDatetimeStr(m).replace(/-/g,"/")}var l=GTD.remindMathBack(q,m);q=l.time;unit=l.unit;item.time=GTD.remindMath(q,unit,r)}return o};GTD.isCanDragToTodayPastTask=function(o){if(o==null){return false}if(typeof o=="object"){o=o.format("yyyy/mm/dd HH:MM")}else{o=o.split(" ")[0]}o=new Date(o.replace(/-/g,"/"));var n=new Date(Doit.time.format("yyyy/mm/dd HH:MM"));var m=o.getTime();var l=n.getTime();if(m<l){return true}else{return false}};GTD.set_inbox=function(m){var l=GTD.Taskform.checkToday(m.end_at);if(l){m.end_at=null}m.attribute="inbox";m.now=false;m.start_at=null;m.reminders=[];GTD.set_noDeleteAndNoComplete(m)};GTD.set_next=function(l){l.attribute="next";l.now=false;l.start_at=null;l.reminders=[];GTD.set_noDeleteAndNoComplete(l)};GTD.set_today=function(q){var p=GTD.isCanDragToTodayPastTask(q.end_at);q.attribute="plan";var m=Doit.time.clone();var l=q.start_at;var n=Do.objClone(l);var o=Time.zoneToRubyString(Do.cookie("user_timezone"));if(!q.all_day&&q.start_at!=null){if(typeof(l)=="object"){l=Time.strToDatetimeStr(l)}var r=l.split(" ");q.start_at=m.format("yyyy-mm-dd")+" "+r[1]+" "+o;if(p){q.end_at=q.start_at}}else{q.start_at=m.format("yyyy-mm-dd")+" 00:00 "+o;if(p){q.end_at=q.start_at}q.all_day=true}q.reminders=GTD.changeReminderTime(q,n);GTD.set_noDeleteAndNoComplete(q)};GTD.set_waiting=function(l){l.attribute="waiting";l.now=false;l.start_at=null;l.reminders=[];GTD.set_noDeleteAndNoComplete(l)};GTD.set_tomorrow=function(r){var m=Doit.time.clone();m.setDate(m.getDate()+1);var l=r.start_at;var n=Do.objClone(l);var o=Time.zoneToRubyString(Do.cookie("user_timezone"));if(!r.all_day&&r.start_at!=null){if(typeof(l)=="object"){l=Time.strToDatetimeStr(l)}var s=l.split(" ");r.start_at=m.format("yyyy-mm-dd")+" "+s[1]+" "+o;var q=GTD.Taskform.checkToday(r.end_at);var p=Time.strToDateObject(r.start_at);if(q){r.end_at=new Date(p.setHours(p.getHours()+1))}}else{r.start_at=m.format("yyyy-mm-dd")+" 00:00 "+o;var q=GTD.Taskform.checkToday(r.end_at);if(q){r.end_at=r.start_at}r.all_day=true}r.attribute="plan";r.now=false;r.reminders=GTD.changeReminderTime(r,n);GTD.set_noDeleteAndNoComplete(r)};GTD.set_schedule=function(p,l){var m=Do.objClone(p.start_at);p.start_at=l;var o=GTD.Taskform.checkToday(p.end_at);if(o||p.end_at<p.start_at){p.end_at=p.start_at}if(!p.all_day){var n=Time.strToDateObject(p.start_at);p.end_at=new Date(n.setHours(n.getHours()+1))}p.attribute="plan";p.now=false;p.reminders=GTD.changeReminderTime(p,m);GTD.set_noDeleteAndNoComplete(p)};GTD.set_someday=function(m){var l=GTD.Taskform.checkToday(m.end_at);if(l){m.end_at=null}m.start_at=null;m.attribute="noplan";m.now=false;m.reminders=[];GTD.set_noDeleteAndNoComplete(m)};GTD.set_completed=function(m){var l=Time.setTodayDateToLocalDate();m.trashed=null;m.completed=l;m.now=false;Doit.allCompletedCount++};GTD.set_trash=function(m){var l=Time.setTodayDateToLocalDate();m.archived=null;m.now=false;m.trashed=l};GTD.set_noDeleteAndNoComplete=function(l){l.trashed=null;l.archived=null;l.completed=null};GTD.set_context=function(m,l){if("none"==l||l==null){l=null}m.context_id=l};GTD.set_project=function(m,l){if("none"==l||l==null){l=null}m.project_id=l};GTD.getTaskWaitValue=function(l){if(GTD.isWaitingOthers(l)){return"other"}else{if(GTD.isWaitingMe(l)){return"me"}}};GTD.isWaitingOthers=function(l){return l.assignment!=null};GTD.isWaitingMe=function(l){return l.forwarded_by!=null};GTD.isRepeat=function(l){return l.repeater!=null};GTD.isRepeatno=function(l){return l.repeat_no!=null};GTD.isWaiting=function(l){return l.attribute=="waiting"};GTD.notDeletedAndNotCompleted=function(l){return !l.trashed&&!l.completed};GTD.isTrash=function(l){return l.trashed};GTD.isCompleted=function(l){return l.completed};GTD.repeatNotEnd=function(m,n){var l=Time.strToDatetimeStr(m.repeater.ends_on).toDateTime();return !l||(l!=null&&(l.getTime()+3600*24*1000)>n.getTime())};GTD.repeatNotEndJS=function(m,n){var l=m.repeater.ends_on;return !l||(l!=null&&(l.getTime()+3600*24*1000)>n.getTime())};GTD.isInbox=function(l){return l.attribute=="inbox"};GTD.isNext=function(l){return l.attribute=="next"};GTD.isTodayTask=function(l){if(typeof(l.start_at)=="string"){return GTD.isToday(l)}else{return GTD.isTodayJS(l)}};GTD.isToday=function(l){var n=Time.strToDate(l.start_at);if(n==null){return false}if(typeof(Doit.time)=="string"){var m=Time.setDateToLocalDateTime(new Date(Doit.time))}else{var m=Time.setTodayDateToLocalDate()}return l.attribute=="plan"&&m.getTime()>=n.getTime()&&!GTD.isWaiting(l)&&!GTD.isRepeat(l)};GTD.isTodayJS=function(l){var n=Time.strToDate(l.start_at);if(n==null){return false}if(typeof(Doit.time)=="string"){var m=Time.setDateToLocalDateTime(new Date(Doit.time))}else{var m=Time.setTodayDateToLocalDate()}return l.attribute=="plan"&&m.getTime()>=n.getTime()&&!GTD.isWaiting(l)&&!GTD.isRepeat(l)};GTD.isWaitingBox=function(l){return l.attribute=="waiting"};GTD.isTomorrow=function(l){var n=Time.strToDate(l.start_at);if(n==null){return false}if(typeof(Doit.time)=="string"){var m=Time.setDateToLocalDateTime(new Date(Doit.time))}else{var m=Time.setTodayDateToLocalDate()}m=Time.userDay(m);m.setDate(m.getDate()+1);return m.getTime()==n.getTime()&&!GTD.isRepeat(l)&&!GTD.isWaiting(l)};GTD.isSchedule=function(m){var o=Time.strToDate(m.start_at);if(o==null){return false}if(typeof(Doit.time)=="string"){var n=Time.setDateToLocalDateTime(new Date(Doit.time))}else{var n=Time.setTodayDateToLocalDate()}n=Time.userDay(n);var l=Time.userDay(n);n.setDate(n.getDate()+2);return((m.attribute=="plan"&&n<=o&&!GTD.isRepeat(m))||GTD.isRepeat(m))&&!GTD.isWaitingOthers(m)};GTD.isScheduleJS=function(m){if(m.start_at==null){return false}if(typeof(Doit.time)=="string"){var n=Time.setDateToLocalDateTime(new Date(Doit.time))}else{var n=Time.setTodayDateToLocalDate()}n=Time.userDay(n);var l=Time.userDay(n);n.setDate(n.getDate()+2);return((m.attribute=="plan"&&n.getTime()<=m.start_at.getTime()&&!GTD.isRepeat(m)||(GTD.isRepeat(m)&&GTD.repeatNotEndJS(m,l)))&&!GTD.isWaitingOthers(m))};GTD.isSomeday=function(l){return l.attribute=="noplan"};GTD.isArchive=function(l){return l.archived!=null};GTD.isTimeTask=function(l){var m=Time.strToDate(l.start_at);if(m==null){return false}return !GTD.isRepeat(l)&&!GTD.isWaiting(l)};GTD.isDeadlineTask=function(l){var m=Time.strToDate(l.end_at);if(m==null){return false}return !GTD.isRepeat(l)};GTD.timeBeforeToday=function(m,l){return l.getTime()>m.getTime()};GTD.timeIsToday=function(m,l){return l.getTime()===m.getTime()};GTD.timeIsTomorrow=function(m,l){var n=new Date(Doit.time);n.setTime(l.getTime());n.setDate(n.getDate()+1);return n.getTime()==m.getTime()};GTD.timeIsThisweek=function(n,m){var o=new Date(Doit.time);o.setTime(m.getTime());var l=Doit.weekstartday=="Sunday"?0:1;o.setDate(o.getDate()-o.getUserDay()+l);if(n.getTime()<o.getTime()){return false}o.setDate(o.getDate()+6);if(n.getTime()>o.getTime()){return false}return true};GTD.timeIsNextweek=function(n,m){var o=new Date(Doit.time);o.setTime(m.getTime());var l=Doit.weekstartday=="Sunday"?0:1;o.setDate(o.getDate()+7-o.getUserDay()+l);if(n.getTime()<o.getTime()){return false}o.setDate(o.getDate()+6);if(n.getTime()>o.getTime()){return false}return true};GTD.timeIsThismonth=function(m,l){var n=new Date(Doit.time);n.setTime(l.getTime());n.setDate(n.getDate()-n.getUserDate()+1);if(m.getTime()<n.getTime()){return false}n.setMonth(n.getMonth()+1);n.setDate(n.getDate()-1);if(m.getTime()>n.getTime()){return false}return true};GTD.timeIsNextmonth=function(m,l){var n=new Date(Doit.time);n.setTime(l.getTime());n.setDate(n.getDate()-n.getUserDate()+1);n.setMonth(n.getMonth()+1);if(m.getTime()<n.getTime()){return false}n.setMonth(n.getMonth()+1);n.setDate(n.getDate()-1);if(m.getTime()>n.getTime()){return false}return true};GTD.timeIsMore=function(m,l){var n=new Date(Doit.time);n.setTime(l.getTime());n.setMonth(n.getMonth()+2);n.setDate(n.getDate()-n.getUserDate()+1);if(m.getTime()<n.getTime()){return false}return true};GTD.getTaskScheduleValue=function(l){return l.repeater!=null?"repeat":GTD.getTaskTimeValue(l)};GTD.getTaskDeadlineValue=function(l){return l.repeater!=null?"repeat":GTD.getTaskDeadlineTimeValue(l)};GTD.getTaskTimeValue=function(m){if(!GTD.isTimeTask(m)){return}var n=Time.strToDate(m.start_at);var l=Time.setTodayDateToLocalDate();l=Time.userDay(l);if(GTD.timeBeforeToday(n,l)){return"beforetoday"}if(GTD.timeIsToday(n,l)){return"today"}if(GTD.timeIsTomorrow(n,l)){return"tomorrow"}if(GTD.timeIsThisweek(n,l)){return"thisweek"}if(GTD.timeIsNextweek(n,l)){return"nextweek"}if(GTD.timeIsThismonth(n,l)){return"thismonth"}if(GTD.timeIsNextmonth(n,l)){return"nextmonth"}if(GTD.timeIsMore(n,l)){return"nextmonth"}};GTD.getTaskDeadlineTimeValue=function(m){if(!GTD.isDeadlineTask(m)){return}var n=Time.strToDate(m.end_at);var l=Time.setTodayDateToLocalDate();l=Time.userDay(l);if(GTD.timeBeforeToday(n,l)){return"beforetoday"}if(GTD.timeIsToday(n,l)){return"today"}if(GTD.timeIsTomorrow(n,l)){return"tomorrow"}if(GTD.timeIsThisweek(n,l)){return"thisweek"}if(GTD.timeIsNextweek(n,l)){return"nextweek"}if(GTD.timeIsThismonth(n,l)){return"thismonth"}if(GTD.timeIsNextmonth(n,l)){return"nextmonth"}if(GTD.timeIsMore(n,l)){return"nextmonth"}};GTD.getTaskForwardValue=function(l){if(GTD.isForwardMe(l)){return"receive"}else{if(GTD.isForwardTo(l)&&l.completed){return"completed"}else{if(GTD.isForwardTo(l)){return"send"}}}};GTD.isForwardMe=function(l){return l.forwarded_by!=Doit.me&&l.forwarded_by!=null};GTD.isForwardTo=function(l){return l.assignment!=null||l.forwarded_by==Doit.me};GTD.getTaskBox=function(l){if(GTD.isTrash(l)){return"trash"}if(GTD.isCompleted(l)){return"completed"}if(GTD.isInbox(l)){return"inbox"}if(GTD.isNext(l)){return"next"}if(GTD.isToday(l)){return"today"}if(GTD.isWaitingBox(l)){return"waiting"}if(GTD.isTomorrow(l)){return"tomorrow"}if(GTD.isSchedule(l)){return"scheduled"}if(GTD.isSomeday(l)){return"someday"}if(GTD.isArchive(l)){return"archived"}return null};GTD.getTaskTimeBox=function(l){if(l.completed!=null||l.trashed!=null){l=Do.objClone(l);l.completed=null;l.trashed=null}var m=GTD.getTaskBox(l);return m};GTD.find_task_by_id_repeatno=function(p,o,n){var l;for(var m=0;m<p.length;m++){if(p[m]==null){m++}if(o==p[m].id&&n==p[m].repeat_no){l=p[m];break}}return l};GTD.find_name_by_uuid=function(n,o){var m;for(var l=0;l<n.length;l++){if(n[l].id==o){m=n[l].name;break}}return m};GTD.updateArray=function(l,o,n){for(var m=0;m<o.length;m++){if(n==o[m].name){o[m].name=l;break}}};GTD.updateTaskList=function(n){for(var l=0;l<TASKS.length;l++){var m=TASKS[l];if(n.id==m.id&&n.repeat_no==m.repeat_no){TASKS.splice(l,1,n);TASKS_FILTER=TASKS;break}}};GTD.removeFromArray=function(o,n,m){if(m=="message"){for(var l=0;l<n.length;l++){if(o==n[l].id){n.splice(l,1);break}}}else{for(var l=0;l<n.length;l++){if(o==n[l].name){n.splice(l,1);break}}}};GTD.removeFromArrayByUUID=function(m,n){for(var l=0;l<n.length;l++){if(m==n[l].id){n.splice(l,1);break}}};GTD.issameName=function(l,n){var o=false;var m=n;f.each(m,function(p){if(m[p].name==l){o=true}});return o};GTD.taskEscapeHTML=function(l){if(l.title!=null&&l.title!=""){l.title=Do.escapeHTML(l.title)}if(l.notes!=null&&l.notes!=""){l.notes=Do.escapeHTML(l.notes)}if(l.context!=null&&l.context!=""){l.context=Do.escapeHTML(l.context)}if(l.project!=null&&l.project!=""){l.project=Do.escapeHTML(l.project)}if(l.tags.length>0){l.tags=Do.escapeArrayHTML(l.tags)}return l};GTD.taskUnescapeHTML=function(l){if(l.title!=null&&l.title!=""){l.title=Do.unescapeHTML(l.title)}if(l.notes!=null&&l.notes!=""){l.notes=Do.unescapeHTML(l.notes)}if(l.context!=null&&l.context!=""){l.context=Do.unescapeHTML(l.context)}if(l.project!=null&&l.project!=""){l.project=Do.unescapeHTML(l.project)}if(l.tags.length>0){l.tags=Do.unescapeArrayHTML(l.tags)}return l};GTD.findUUIDByName=function(m,l){var n=null;f.each(m,function(o){if(m[o].name==l){n=m[o].id}});return n};GTD.findNameByUUID=function(n,m){if(m==null){return null}var l=null;f.each(n,function(o){if(n[o].id==m){l=n[o].name}});return l}})(jQuery);(function(b){GTD.Message={};b.MODE_SINGLE="single";b.MODE_APPEND="append";b.ACTION_INVITED="invite";b.ACTION_INVITED_PASS="invite_pass";b.ACTION_SEND_TASK="send_task";b.ACTION_SEND_TASK_COMPLETED="task_completed";b.ACTION_ALL_TASK_COMPLETED="all_task_completed";b.ACTION_TASK_DELETED="task_deleted";b.ACTION_SEND_TASK_COMPLETE="task_complete";b.ACTION_REMINDER="reminder";b.RESULT_AGREED="invite_pass";b.RESULT_REFUSED="invite_reject";GTD.Message.delReminderFromTask=function(g){var f=g.task.id;var l=g.task.repeat_no;var h=GTD.find_task_by_id_repeatno(TASKS,f,l);Do.log(g);var k=g.id;if(h.reminders.length==1){h.reminders=[]}else{var j=h.reminders;for(i=0;i<j.length;i++){var m=h.reminders[i];if(g.target_id==m.id){j.splice(i,1)}}}};GTD.Message.countUnread=function(){var f=b(".user-info-msg-unread").length;if(f>0){b("#user_info_msg_count").show()}else{b("#user_info_msg_count").hide()}b("#user_info_msg_count").text(f);if(b("#user_info_msg_box dd").length==0){b("#no_msg").show();b("#user_info_msg_box>dl").hide();b("#user_info_msg_box_ft").hide()}else{b("#no_msg").hide();b("#user_info_msg_box>dl").show();b("#user_info_msg_box_ft").show()}};b.fn.everyTimeListMsg=function(){b(this).everyTime("150s",function(f){b.ajax.listMessage({onSuccess:function(l){var p=Do.parseJSON(l.responseText).server_time.split(" ");Doit.time=new Date(p[0].replace(/-/g,"/")+" "+p[1]);var n=Do.parseJSON(l.responseText).entries;for(var o=0;o<n.length;o++){var k=n[n.length-o-1];if(k!=null&&k.mode==b.MODE_SINGLE){var g=k.task;if(g.all_day){length_cut=15}else{length_cut=9}var q=g.start_at.substring(0,g.start_at.length-length_cut).replace(/-/g,"/");if(g.end_at!=null){var h=" - "+g.end_at.substring(0,g.end_at.length-length_cut).replace(/-/g,"/")}else{h=""}var j=q+h;Do.alert(k.task.title+"\n\n"+j,function(){})}else{if(k.mode==b.MODE_APPEND){b(this).prependMessage(k)}}}Doit.messages=b.merge(n,Doit.messages)}},"news")},0)};b.fn.prependMessage=function(f){GTD.Message.createDl(f.id,f.action,f.read,f.body,f.sender_nickname,f.result);b("#user_info_msg_box input[data-id='"+f.id+"']").next().markOneRead();GTD.Message.countUnread()};b.fn.markOneRead=function(){b(this).click(function(){if(b(this).parent().hasClass("user-info-msg-unread")){GTD.Message.msgRead([b(this).prev().attr("data-id")]);b(this).parent().removeClass("user-info-msg-unread")}})};GTD.Message.showList=function(){if(b("#user_info_msg_box dd").length==0){b.each(Doit.messages,function(n){var g=Doit.messages[n];if(g!=null&&g.mode==b.MODE_SINGLE){var k=g.task;if(k.all_day){length_cut=15}else{length_cut=9}var j=k.start_at.substring(0,k.start_at.length-length_cut).replace(/-/g,"/");if(k.end_at!=null){var h=" - "+k.end_at.substring(0,k.end_at.length-length_cut).replace(/-/g,"/")}else{h=""}var l=j+h;Do.alert(g.body+"\n\n"+l,function(){})}else{if(g.mode==b.MODE_APPEND){var f=Doit.messages.length-n-1;var o=Doit.messages[f];GTD.Message.createDl(o.id,o.action,o.read,o.body,o.sender_nickname,o.result,o.task);b("#user_info_msg_box input[data-id='"+o.id+"']").next().markOneRead()}}});GTD.Message.countUnread()}};b("#msg_box_mark_read").click(function(){var f=[];var g=b(this).parent().prev().find("input:checked").parent();g.each(function(){if(b(this).hasClass("user-info-msg-unread")){f.push(b(this).find("input").attr("data-id"))}});if(f.length>0){GTD.Message.msgRead(f)}});b("#msg_box_delete").click(function(){var g=[];var f=b(this).parent().prev().find("input:checked").parent();if(f.length>0){f.each(function(){g.push(b(this).find("input").attr("data-id"))});GTD.Message.msgDel(g)}GTD.Message.countUnread()});GTD.Message.msgRead=function(f){b.ajax.messages({data:{ids:f},onSuccess:function(g){b.each(f,function(h){var j=f[h];b("#user_info_msg_box dd[data-id='"+j+"']").prev().removeClass("user-info-msg-unread")});GTD.Message.countUnread()}},"read")};GTD.Message.msgDel=function(f){b.ajax.messages({data:{ids:f},onSuccess:function(g){var h=b("#msg_box_mark_read").parent().prev().find("input:checked").parent();h.each(function(){b(this).removeClass("user-info-msg-unread");b(this).next().fadeOut(function(){b(this).remove();GTD.Message.countUnread()});b(this).fadeOut(function(){b(this).remove();GTD.Message.countUnread()})})},onFailure:function(g){alert("消息失败了鸟");GTD.Message.countUnread()}},"empty")};GTD.Message.getMessageTaskBox=function(f){var j="";if(f){var g=f.attribute;switch(g){case"inbox":j='<a href="/home/#/time/inbox">['+L.INBOX+"]</a>";break;case"noplan":j='<a href="/home/#/time/someday">['+L.SOMEDAY+"]</a>";break;case"waiting":j='<a href="/home/#/time/waiting">['+L.WAITING+"]</a>";break;case"plan":var h=GTD.getTaskBox(f);switch(h){case"today":j='<a href="/home/#/time/today">['+L.TODAY+"]</a>";break;case"tomorrow":j='<a href="/home/#/time/tomorrow">['+L.TOMORROW+"]</a>";break;case"scheduled":j='<a href="/home/#/time/scheduled">['+L.SCHEDULED+"]</a>";break;case"trash":j='<a href="/home/#/time/trash">['+L.TRASH+"]</a>";break;case"completed":j='<a href="/home/#/time/completed">['+L.COMPLETED+"]</a>";break;case"archived":j='<a href="/home/#/archiver">['+L.ARCHIVER+"]</a>";break;default:break}break;case"next":j='<a href="/home/#/time/next">['+L.NEXT+"]</a>";break;default:Do.log("WTF!")}}return j};GTD.Message.createDl=function(g,p,h,n,f,w,j){var t;var m;var o="";var s;if(h){o=""}else{o=" class='user-info-msg-unread'"}switch(p){case b.ACTION_INVITED:var v=b("<div></div>");s=true;t=L.i_message_invite_by_bn+" "+f+" "+L.i_message_invite_by_an;m=f+" "+L.i_message_request_friend;var l=b('<span class="msg-btn"></span>').html(L.i_message_agree).attr("mid",g).isAgreeLink();var k=b('<span class="msg-btn"></span>').html(L.i_message_refuse).attr("mid",g).isRefuseLink();if(w==b.RESULT_AGREED){v.append(L.i_message_agree_return)}else{if(w==b.RESULT_REFUSED){v.append(L.i_message_refuse_return)}else{var u=b("<div></div>").append(l).append(k).addClass("link-bar");v.append(u)}}break;case b.ACTION_INVITED_PASS:t=L.i_message_invitation_passed_bn+" "+f+" "+L.i_message_invitation_passed_an;m=L.i_message_can_forward;break;case b.ACTION_SEND_TASK:var r=GTD.Message.getMessageTaskBox(j);t=L.i_message_forwarded_by_bn+" "+f+" "+L.i_message_forwarded_by_an;m=r+n;break;case b.ACTION_SEND_TASK_COMPLETED:t=L.i_message_forwarded_complete_bn+" "+f+" "+L.i_message_forwarded_complete_an;m=n;break;case b.ACTION_ALL_TASK_COMPLETED:t=L.i_message_forwarded_complete;m=n;break;case b.ACTION_TASK_DELETED:t=L.i_message_forwarded_deleted_by_bn+" "+f+" "+L.i_message_forwarded_deleted_by_an;m=n;break;case b.ACTION_SEND_TASK_COMPLETE:t=L.I_MESSAGE_FORWARDED_OWNER_FINISH_BN+" "+f+" "+L.I_MESSAGE_FORWARDED_OWNER_FINISH_AN;m=n;default:}if(p!=b.ACTION_REMINDER){var q=b("#user_info_msg_box dl").prepend("<dt"+o+"><input data-id="+g+" type='checkbox' /><span>"+t+"</span></dt><dd data-id='"+g+"'>"+m+"</dd>")}if(s){q.find("dd[data-id="+g+"]").append(v)}GTD.Message.countUnread()};b.fn.isAgreeLink=function(){var f=this;return f.one("click",function(g){b.agreeMsg(b(g.target).attr("mid"),b.RESULT_AGREED)})};b.getMessage=function(g){for(var f=0;f<Doit.messages.length;f++){if(Doit.messages[f].id==g){return Doit.messages[f]}}};b.fn.isRefuseLink=function(){var f=this;return f.one("click",function(g){b.agreeMsg(b(g.target).attr("mid"),b.RESULT_REFUSED)})};b.agreeMsg=function(h,f,g){b.message={id:h,result:f};b.ajax.messages({data:b.message,onSuccess:function(k){var j=b.getMessage(h);if(!j.read){GTD.Message.countUnread()}j.result=f;j.read=true;b("dd[data-id='"+h+"']").find(".link-bar span").remove();if(f==b.RESULT_AGREED){b("dd[data-id='"+h+"']").find(".link-bar").append(L.i_message_agree_return)}else{b("dd[data-id='"+h+"']").find(".link-bar").append(L.i_message_refuse_return)}},onFailure:function(j){alert("消息失败了鸟")}},"agree")};function c(f){if(f>0){b("#user_info_msg_count").html(f).show()}else{b("#user_info_msg_count").html(f).hide()}}function e(){var g=b("#user_info_msg_count").html();if(!g){g=0}var f=parseInt(g);c(++f)}function a(){var g=b("#user_info_msg_count").html();if(!g){g=0}var f=parseInt(g);c(--f)}})(jQuery);if(!$.fn.formbox){$.fn.formbox=function(){$(this).each(function(e,c){var a=$(c).find(".formbox-head").parent();a.children(".formbox-main:gt(0)").each(function(f,h){var g=$(h);g.hide()});a.css("padding-bottom","46px");a.children(".formbox-foot").css({position:"absolute",bottom:0,width:$(this).width()});var b=a.find(".formbox-tab");b.click(function(h){if(!$(this).hasClass("current")){var f=$(this);var g=b.index($(h.currentTarget));var l=a.children(".formbox-main:visible");var k=a.children(".formbox-main").eq(g);a.css({overflow:"hidden",height:a.height()});l.stop(true,true);a.stop(true,false);l.fadeOut(200);k.show().css({visibility:"hidden",overflow:"hidden"});var j=k.outerHeight();k.hide().css({visibility:"visible",overflow:"visible"});a.animate({height:j+42},{duration:200,complete:function(){a.css({height:"auto",overflow:"visible"});b.removeClass("current");f.addClass("current");k.fadeIn(200)}})}})})}}$(".select-box:not(.disabled)").live("click",function(b){var c=$(b.currentTarget);if(c.children(".selected").length===0){var a=c.width();c.data("width",c.width());c.addClass("selecting");c.css({width:c.outerWidth()+2});c.wrapInner($('<div class="selected" />').css("width",c.data("width")+2+"px"));$("body").trigger("click.select_box");b.stopPropagation();$("body").unbind("click.select_box");$("body").bind("click.select_box",function(f){if(c.find("li").index(f.target)>-1||c.find(".selected-text").index(f.target)>-1){var g=$(f.target).attr("data-id");var e=g!=null?g:"";c.find(".selected-text").text($(f.target).text()).attr("data-id",e);f.stopPropagation()}if(!$(f.target).closest(".tip-box-wrap").find("#add_new_box").is("div")){c.find(".selected-text").unwrap();c.removeClass("selecting");c.css({width:a});$("body").unbind("click.select_box")}});c.find("div.selected>ul").unbind("mousewheel");c.find("div.selected>ul").bind("mousewheel",function(e){e.stopPropagation()})}});(function(a){GTD.quickAdd=(function(){var g=function(){var j=Doit.currentBox;var k=a("div#task_quick_add");var m=a("input#quick_add_input");if(a.inArray(j,["scheduled","contact"])>-1||a("div#sidebar li.s").is("#context_all")||a("div#sidebar li.s").is("#project_all")){k.hide()}else{if(a.inArray(j,["smartbox","completed","trash","calendar","archiver"])>-1){k.hide()}else{k.show()}}m.unbind();m.quickAddTask();m.smartAdd();m.bind("keydown",function(n){if(n.which==13&&a("#smart_add_list").css("visibility")=="hidden"){a.smartAdd.readyToPostTask(this.value)}});var l=k.find(".help");l.bind("click",function(){var o=l.position().left+26;var n=l.position().top;a("#task_quick_add .help-div").css({top:n,left:o});a("#task_quick_add .help-div").toggle()})};var e=function(){var j=Doit.currentBox;var k=a("div#task_quick_add");var l=a("input#quick_add_input");if(a.inArray(j,["scheduled","contact"])>-1||a("div#sidebar li.s").is("#context_all")||a("div#sidebar li.s").is("#project_all")){k.hide()}else{if(a.inArray(j,["smartbox","completed","trash","calendar","archiver"])>-1){k.hide()}else{k.show()}}};var f=function(){Doit.projects_smart=[];Doit.contexts_smart=[];Doit.tags_smart=[];a.each(Doit.projects,function(j,k){Doit.projects_smart.push(Do.unescapeHTML(k.name))});a.each(Doit.contexts,function(j,k){Doit.contexts_smart.push(Do.unescapeHTML(k.name))});a.each(Doit.tags,function(j,k){Doit.tags_smart.push(Do.unescapeHTML(k.name))});a.smartAdd.setRules({flag:"^",list:[L.INBOX,L.TODAY,L.NEXT,L.TOMORROW,L.WAITING,L.SOMEDAY,"mm-dd ("+L.EG+"04-01)","yy-mm-dd ("+L.EG+"2012-12-20)"],repeat:false,hr:6,className:["","",""]},{flag:"#",list:Doit.projects_smart,repeat:false,hr:-1},{flag:"@",list:Doit.contexts_smart,repeat:false,hr:-1},{flag:"&",list:Doit.tags_smart,repeat:true,hr:-1},{flag:"!",list:["1","2","3"],repeat:false,hr:-1})};a.fn.quickAddTask=function(){var j=a(this);j.data("default",j.val());j.css({color:"#888"});j.focus(function(){if(a(this).val()==L.QUICK_ADD_TEXT){j.val("").css({color:"#000"})}}).blur(function(){if(a(this).val()==""){j.val(L.QUICK_ADD_TEXT).css({color:"#888"})}})};var c=function(o){var p=a("input#quick_add_input");p.unbind("keydown");var j=Do.randomUUID();var n=new Do.Base64();var k=n.encode(j);var m={all_day:false,archived:null,assignment:null,attribute:"inbox",completed:null,context_id:null,created:Doit.time,deleted:null,end_at:null,forwarded_by:null,hidden:null,id:k,notes:"",priority:0,project_id:null,reminders:[],repeat_no:null,repeater:null,start_at:null,tags:[],title:o,trashed:null,updated:Doit.time};var l=Doit.currentBox;if(a.inArray(l,["inbox","next","today","tomorrow","someday","waiting"])>-1){GTD["set_"+l](m)}else{if(a.inArray(l,["context","project"])>-1){if(Doit.getTid()=="none"){GTD.set_inbox(m)}else{GTD["set_"+l](m,Doit.getTid())}}}if(m.context!=null&&m.context!=""){m.context=Do.unescapeHTML(m.context)}if(m.project!=null&&m.project!=""){m.project=Do.unescapeHTML(m.project)}a.ajax.createTask({data:m,onSuccess:function(r){GTD.EmptyTip("hide");p.quickAddTask();p.val("").css({color:"#000"});if(m.context!=null&&m.context!=""){m.context=Do.escapeHTML(m.context)}if(m.project!=null&&m.project!=""){m.project=Do.escapeHTML(m.project)}m.title=Do.escapeHTML(m.title);var q=GTD.addTask(m,null,a("div#task_quick_add ul"),a("li.task").length);a("div#task_quick_add ul li:eq(0)").after(q);q.effect("highlight",1500);TASKS.push(m);TASKS_FILTER=TASKS;if(a.inArray(l,["inbox","today"])>-1){GTD.increaseCount(a("#"+l))}GTD.M(L.TIPS_TASK_ADDED_OK)},onError:function(q){GTD.M(L.AJAX_TASK_ADDING_FAILED,"error");p.quickAddTask()},onFailure:function(q){GTD.M(L.AJAX_TASK_ADDING_FAILED,"error");p.quickAddTask()}})};var b=function(){a("div#task_quick_add").hide()};var h=function(){a("div#task_quick_add").show()};return{init:function(){g()},hide:function(){b()},show:function(){h()},showornot:function(){e()},smart:function(){f()}}})()})(jQuery);GTD.group=function(){var n=function(){var z=$("div#task_group");z.find("h4").taskListToggle();z.find("div.group").each(function(){var A=$(this);if(A.children("ul.taskList").children("li.task").length>0){A.show()}else{A.hide()}})};var t=function(C,A){Doit.currentGroupBy="group_context";var z=$('<div id="groupby_context" class="groups"></div>');A.append(z);$.each(Doit.contexts,function(E,D){var F=$('<div id="groupby_context_'+encodeURIComponent(D.id)+'" class="group"><h4><span class="group-title">'+D.name+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');z.append(F)});var B=$('<div id="groupby_context_none" class="group"><h4><span class="group-title">'+L.NONE_GROUP+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');z.append(B);$.each(C,function(D,F){if(F==null){return}if(Doit.currentBox=="today"&&F.now){return}var E=F.context_id;if(E!=null){GTD.addTask(F,null,Do.id("groupby_context_"+encodeURIComponent(E)).children("ul.taskList"),$("li.task").length)}else{GTD.addTask(F,null,B.find("ul.taskList"),$("li.task").length)}});n()};var x=function(D,B){Doit.currentGroupBy="group_project";var A=$('<div id="groupby_project" class="groups"></div>');B.append(A);var z=[];$.each(Doit.projects,function(F,E){var G=$('<div id="groupby_project_'+encodeURIComponent(E.id)+'" class="group"><h4><span class="group-title">'+E.name+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');A.append(G)});var C=$('<div id="groupby_project_none" class="group"><h4><span class="group-title">'+L.NONE_GROUP+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');A.append(C);$.each(D,function(E,F){if(F==null){return}if(Doit.currentBox=="today"&&F.now){return}var G=F.project_id;if(G!=null){GTD.addTask(F,null,Do.id("groupby_project_"+encodeURIComponent(G)).children("ul.taskList"),$("li.task").length)}else{GTD.addTask(F,null,C.find("ul.taskList"),$("li.task").length)}});n()};var a=function(B,A){Doit.currentGroupBy="group_priority";var z=$('<div id="groupby_priority" class="groups">				<div id="groupby_priority_3" class="group">					<h4><span class="group-title">'+L.TASK_PRI_NUM3+'</span><span class="unfold"></span></h4>					<ul class="taskList"></ul>				</div>				<div id="groupby_priority_2" class="group">					<h4><span class="group-title">'+L.TASK_PRI_NUM2+'</span><span class="unfold"></span></h4>					<ul class="taskList"></ul>				</div>				<div id="groupby_priority_1" class="group">					<h4><span class="group-title">'+L.TASK_PRI_NUM1+'</span><span class="unfold"></span></h4>					<ul class="taskList"></ul>				</div>				<div id="groupby_priority_0" class="group">					<h4><span class="group-title">'+L.NO_PRIORITY+'</span><span class="unfold"></span></h4>					<ul class="taskList"></ul>				</div>			</div>');A.append(z);$.each(B,function(C,D){if(D==null){return}if(Doit.currentBox=="today"&&D.now){return}GTD.addTask(D,null,$("div#groupby_priority_"+D.priority+" ul.taskList"),$("li.task").length)});n()};var s=function(D,C){Doit.currentGroupBy="group_waiting";var B=$('<div id="groupby_waiting" class="groups"></div>');var A=$('<div id="groupby_waiting_others" class="group"><h4><span class="group-title">'+L.i_group_schedule_senttomulti+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var z=$('<div id="groupby_waiting_mine" class="group"><h4><span class="group-title">'+L.i_group_schedule_mine+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');B.append(A).append(z);$.each(D,function(G,I){if(I.assignment===null){GTD.addTask(I,null,z.find("ul.taskList"),$("li.task").length)}else{if(I.assignment.items.length==1){var E=I.assignment.items[0].contact;var H=GTD.find_contact_name_by_user_email(E);E=E.replace("@","at").replace(/\./g,"_");console.log(E=="adams_xuatgmail.com");var F=B.children("#groupby_waiting_"+E).length==1?B.children("#groupby_waiting_"+E):$('<div id="groupby_waiting_'+E+'" class="group"><h4><span class="group-title">'+L.i_group_schedule_senttoone+H+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');A.before(F);GTD.addTask(I,null,F.find("ul.taskList"),$("li.task").length)}else{GTD.addTask(I,null,A.find("ul.taskList"),$("li.task").length)}}});B.find("div.group").each(function(){var E=$(this);if(E.find("ul.taskList li.task").length===0){E.hide()}else{E.show()}});C.append(B);B.find("h4").taskListToggle()};var j=function(G,F,z){Doit.currentGroupBy="group_contact";var C=$('<div id="groupby_contact" class="groups"></div>');var A=$('<div id="groupby_contact_send" class="group"><h4><span class="group-title">'+L.i_group_forward_send+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var E=$('<div id="groupby_contact_recieve" class="group"><h4><span class="group-title">'+L.i_group_forward_received+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');C.append(A).append(E);var D=A.find("ul.taskList");var B=E.find("ul.taskList");$.each(G,function(H,I){if(I.assignment!=null){GTD.addTask(I,null,D,$("li.task").length)}if(I.forwarded_by!=null){GTD.addTask(I,null,B,$("li.task").length)}});if(z!=undefined){$.each(G,function(I,J){if(J.forwarded_by!=null&&J.forwarded_by!=z){E.find("ul.taskList li.task").each(function(){var K=$(this);if(K.attr("id")==="task_"+J.id){K.remove()}})}if(J.assignment!=null){var H=false;$.each(J.assignment.items,function(M,K){if(K.contact===z){H=true}});if(!H){A.find("ul.taskList li.task").each(function(){var K=$(this);if(K.attr("id")==="task_"+J.id){K.remove()}})}}})}C.find("div.group").each(function(){var H=$(this);if(H.find("ul.taskList li.task").length===0){H.hide()}else{H.show()}});F.append(C);C.find("h4").taskListToggle()};var y=function(B,A){Doit.currentGroupBy="group_weekly";var z=$('<div id="groupby_weekly" class="groups"></div>');A.append(z);$.each(B,function(E,H){var D=Time.strToDateIgTimezone(H.completed);var C=D.format("dddd");var G=$("div#groupby_weekly_"+C);if(G.length===0){var F=$('<div id="groupby_weekly_'+C+'" class="archiver_group group"><h4><span class="group-title">'+C+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');z.append(F);GTD.addTask(H,null,F.find("ul.taskList"),$("li.task").length)}else{GTD.addTask(H,null,G.find("ul.taskList"),$("li.task").length)}});z.find("h4").taskListToggle(B,A);z.find("li.task .task-checkbox").unbind("click")};var o=function(B,A){Doit.currentGroupBy="group_monthly";var z=$('<div id="groupby_monthly" class="groups"></div>');A.append(z);$.each(B,function(F,N){var C=Time.strToDateIgTimezone(N.completed);var G=C.format("isMonth");var J=C.format("dddd");var D=C.format("isDay");var E=C.format("yyyy_mm_dd");var K=G+L.WORDSPACE+D;if(Doit.currentBox=="completed"){var H=J+L.COMMA+K+L.COMMA+C.getFullYear()}else{var H=J+L.COMMA+K}var I=$("div#groupby_monthly_"+E);if(I.length===0){var M=$('<div id="groupby_monthly_'+E+'" class="archiver_group group"><h4><span class="group-title">'+H+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');z.append(M);GTD.addTask(N,null,M.find("ul.taskList"),$("li.task").length)}else{GTD.addTask(N,null,I.find("ul.taskList"),$("li.task").length)}});z.find("h4").taskListToggle();if(Doit.currentBox=="archiver"){z.find("li.task .task-checkbox").unbind("click")}};var q=function(E,z){Doit.currentGroupBy="group_scheduled";var C=$('<div id="groupby_schedule" class="groups"></div>');var J=$('<div id="groupby_schedule_repeat" class="group"><h4><span class="group-title">'+L.REPEAT+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var D=$('<div id="groupby_schedule_beforetoday" class="group"><h4><span class="group-title">'+L.BEFORE_TODAY+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var I=$('<div id="groupby_schedule_today" class="group"><h4><span class="group-title">'+L.i_group_schedule_today+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var A=$('<div id="groupby_schedule_tomorrow" class="group"><h4><span class="group-title">'+L.i_group_schedule_tomorrow+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var G=$('<div id="groupby_schedule_thisweek" class="group"><h4><span class="group-title">'+L.i_group_schedule_thisweek+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var F=$('<div id="groupby_schedule_nextweek" class="group"><h4><span class="group-title">'+L.i_group_schedule_nextweek+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var B=$('<div id="groupby_schedule_thismonth" class="group"><h4><span class="group-title">'+L.i_rest_of_this_month+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var H=$('<div id="groupby_schedule_nextmonth" class="group"><h4><span class="group-title">'+L.i_next_month+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var K=$('<div id="groupby_schedule_notime" class="group"><h4><span class="group-title">'+L.i_no_start_on+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');C.append(J).append(D).append(I).append(A).append(G).append(F).append(B).append(H).append(K);z.append(C);$.each(E,function(M,N){if(N==null){return}if(Doit.currentBox=="today"&&N.now){return}var O=GTD.getTaskScheduleValue(N);if(O!=null){GTD.addTask(N,null,$("div#groupby_schedule_"+O+" ul.taskList"),$("li.task").length)}else{GTD.addTask(N,null,K.find("ul.taskList"),$("li.task").length)}});n()};var b=function(E,z){Doit.currentGroupBy="group_deadline";var C=$('<div id="groupby_deadline" class="groups"></div>');var J=$('<div id="groupby_deadline_repeat" class="group"><h4><span class="group-title">'+L.REPEAT+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var D=$('<div id="groupby_deadline_beforetoday" class="group"><h4><span class="group-title">'+L.BEFORE_TODAY+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var I=$('<div id="groupby_deadline_today" class="group"><h4><span class="group-title">'+L.i_group_schedule_today+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var A=$('<div id="groupby_deadline_tomorrow" class="group"><h4><span class="group-title">'+L.i_group_schedule_tomorrow+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var G=$('<div id="groupby_deadline_thisweek" class="group"><h4><span class="group-title">'+L.i_group_schedule_thisweek+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var F=$('<div id="groupby_deadline_nextweek" class="group"><h4><span class="group-title">'+L.i_group_schedule_nextweek+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var B=$('<div id="groupby_deadline_thismonth" class="group"><h4><span class="group-title">'+L.i_rest_of_this_month+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var H=$('<div id="groupby_deadline_nextmonth" class="group"><h4><span class="group-title">'+L.i_next_month+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var K=$('<div id="groupby_deadline_notime" class="group"><h4><span class="group-title">'+L.i_no_end_at+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');C.append(J).append(D).append(I).append(A).append(G).append(F).append(B).append(H).append(K);z.append(C);$.each(E,function(M,N){if(N==null){return}if(Doit.currentBox=="today"&&N.now){return}var O=GTD.getTaskDeadlineValue(N);if(O!=null){GTD.addTask(N,null,$("div#groupby_deadline_"+O+" ul.taskList"),$("li.task").length)}else{GTD.addTask(N,null,K.find("ul.taskList"),$("li.task").length)}});n()};var p=function(D,z){Doit.currentGroupBy="group_box";var B=$('<div id="group_box" class="groups"></div>');var F=$('<div id="groupby_inbox" class="group"><h4><span class="group-title">'+L.INBOX+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var G=$('<div id="groupby_today" class="group"><h4><span class="group-title">'+L.TODAY+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var A=$('<div id="groupby_tomorrow" class="group"><h4><span class="group-title">'+L.TOMORROW+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var C=$('<div id="groupby_next" class="group"><h4><span class="group-title">'+L.NEXT+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var H=$('<div id="groupby_scheduled" class="group"><h4><span class="group-title">'+L.SCHEDULED+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var I=$('<div id="groupby_someday" class="group"><h4><span class="group-title">'+L.SOMEDAY+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');var E=$('<div id="groupby_waiting" class="group"><h4><span class="group-title">'+L.WAITING+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');B.append(F).append(G).append(C).append(A).append(H).append(I).append(E);z.append(B);$.each(D,function(J,M){var K=GTD.getTaskBox(M);GTD.addTask(M,null,$("div#groupby_"+K+" ul.taskList"),$("li.task").length)});n()};var e=function(B,A){if($("#groupby_now").length){return}var z=$('<div id="groupby_now" class="group doitnow"><h4><span class="group-title">'+L.DOITNOW+'</span><span class="unfold"></span><span class="external"></span></h4><ul class="taskList"></ul></div>');$.each(B,function(D,C){GTD.addTask(C,null,z.find("ul.taskList"),$("li.task").length)});A.append(z);GTD.doitNowExternal(z.find(".external"));$("#groupby_now .taskList").sortable({appendTo:"body",items:"li.task",helper:function(D){var C=$(D.target).parents(".task");if(C.hasClass("s")&&$(".task.s").length>1){return $("<li>"+$(".task.s").length+" "+L.i_tasks_selected+"</li>").addClass("task-move").css({width:"auto",height:"14px"})}else{C.find(".task-control").hide();return C.clone()}},placeholder:"sort-placeholder",opacity:0.7,update:function(C,E){var F=[];$("#groupby_now .taskList .task").each(function(){var G=$(this).attr("tid");var H=$(this).attr("repeat_no");if(H==null){F.push([G])}else{F.push([G,H])}});var D={};D.index=F;$.ajax.sortList({data:D,onSuccess:function(G){},onFailure:function(G){}},"doitnow")}})};var l=function(B,A){Doit.currentGroupBy="group_none";var z=$('<div id="groupby_none" class="group"><ul class="taskList"></ul></div>');$.each(B,function(D,C){if(C==null){return}if(Doit.currentBox=="today"&&C.now){return}GTD.addTask(C,null,z.find("ul.taskList"),$("li.task").length)});A.append(z);n()};var g=function(A,z){if(A.is(":hidden")){A.show()}z.effect("highlight",1000)};var u=function(z){var B="";var A=z.context_id;var C=GTD.findNameByUUID(Doit.contexts,A);B=A!=null?Do.id("groupby_context_"+encodeURIComponent(A)):$("div#groupby_context_none");if(B.length===0){B=$('<div id="groupby_context_'+encodeURIComponent(A)+'" class="group"><h4><span class="group-title">'+C+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');$("div#groupby_context_none").before(B)}return B};var w=function(z){var A="";var C=z.project_id;var B=GTD.findNameByUUID(Doit.projects,C);A=C!=null?Do.id("groupby_project_"+encodeURIComponent(C)):$("div#groupby_project_none");if(A.length===0){A=$('<div id="groupby_project_'+encodeURIComponent(C)+'" class="group"><h4><span class="group-title">'+B+'</span><span class="unfold"></span></h4><ul class="taskList"></ul></div>');$("div#groupby_project_none").before(A)}return A};var c=function(z){return $("div#groupby_priority_"+z.priority)};var r=function(A){if(A.assignment==null){return $("div#groupby_waiting_mine")}else{if(A.assignment.items.length==1){var z=A.assignment.items[0].contact.replace("@","at").replace(".","_");return $("#groupby_waiting_"+z)}else{return $("#groupby_waiting_others")}}};var h=function(){return $("div#groupby_contact_send")};var m=function(z){var A=GTD.getTaskScheduleValue(z);return A!=null?$("div#groupby_schedule_"+A):$("div#groupby_schedule_notime")};var f=function(z){var A=GTD.getTaskDeadlineValue(z);return A!=null?$("div#groupby_deadline_"+A):$("div#groupby_deadline_notime")};var v=function(z){var A=GTD.getTaskBox(z);return $("div#groupby_"+A)};var k=function(){return $("div#groupby_none")};return{getGroups:function(B,z){if(Doit.currentBox!="search"){$("#search_result").hide()}if(Doit.currentBox!="project"){$("#project_info").remove()}var C=$("div#tags li.tag-selected-all").hasClass("s")?TASKS:TASKS_FILTER;var A=$("div#task_group");A.empty();$("div#task_quick_add ul li.task:not(li:eq(0))").remove();if(C.length===0){GTD.loadingData("hide");GTD.EmptyTip("show");GTD.showPage()}else{GTD.EmptyTip("hide")}if($("#context_all").hasClass("s")){if(B=="default"){B="context"}}switch(B){case"context":t(C,A);break;case"project":x(C,A);break;case"priority":a(C,A);break;case"scheduled":q(C,A);break;case"deadline":b(C,A);break;case"waiting":s(C,A);break;case"contact":j(C,A,z);break;case"weekly":y(C,A);break;case"monthly":o(C,A);break;case"box":p(C,A);break;default:l(C,A)}GTD.loadingData("hide")},addNewTask:function(A,C){GTD.EmptyTip("hide");var D=C.replace("group_","");var B="",z="";switch(D){case"context":B=u(A);break;case"project":B=w(A);break;case"priority":B=c(A);break;case"waiting":B=r(A);break;case"contact":B=h();break;case"scheduled":B=m(A);break;case"deadline":B=f(A);break;case"box":B=v(A);break;default:B=k()}z=GTD.addTask(A,null,B.children("ul.taskList"),$("li.task").length);if(!(Doit.currentBox==="scheduled"&&(z.attr("schedule")==="beforetoday"||z.attr("schedule")==="today"))){g(B,z)}}}}();$.fn.groupMode=function(){var a=$(this);a.delegate("a","click",function(){$("#groupby_pop").hide();var f=$(this).attr("rel");$("#groupby h3 a").html($(this).text()+"<span></span>").attr("rel",f);GTD.loadingData("show");if(Doit.currentBox=="next"&&f=="default"){GTD.group.getGroups("project")}else{GTD.group.getGroups(f)}if($("#sidebar .s").length==0){return}switch(Doit.currentPage){case"time":switch(f){case"default":f=null;break;case"waiting":f="contacts";break;case"monthly":f="completed_at";break;case"scheduled":f="start_at";break;case"deadline":f="end_at";break;default:break}var c=$("#sidebar .s").data("data");c.group_by=f;$.ajax.update_user_boxes({data:c,onSuccess:function(){$("#sidebar .s").data("data",c);Do.log("Set groupby of current box to "+c.group_by+"!")}},"");break;case"context":var b=$("#sidebar .s");var c=b.data("data");var e=b.attr("data-name");if(e=="all"){break}switch(f){case"default":f=null;break;case"scheduled":f="start_at";break;case"deadline":f="end_at";break;default:break}Do.log("Current context is "+c.name+",groupby is "+c.group_by);c.group_by=f;if(e!="none"){$.ajax.updateContext({data:c,onSuccess:function(){$("#sidebar .s").data("data",c);Do.log("Set groupby of current context"+c.name+" to "+c.group_by+"!")}},"")}else{$.ajax.update_user_boxes({data:c,onSuccess:function(){$("#sidebar .s").data("data",c);Do.log("Set groupby of current box to "+c.group_by+"!")}},"")}break;case"project":var b=$("#sidebar .s");var c=b.data("data");var e=b.attr("data-name");switch(f){case"default":f="box";break;case"scheduled":f="start_at";break;case"deadline":f="end_at";break;default:break}Do.log("Current project is "+c.name+",groupby is "+c.group_by);c.group_by=f;if(e!="none"&&e!="all"){$.ajax.updateProject({data:c,onSuccess:function(){$("#sidebar .s").data("data",c);Do.log("Set groupby of current project"+c.name+" to "+c.group_by+"!")}},"")}else{if(e=="all"){if(f=="box"){c.group_by="status"}}$.ajax.update_user_boxes({data:c,onSuccess:function(){$("#sidebar .s").data("data",c);Do.log("Set groupby of current box to "+c.group_by+"!")}},"")}break;default:break}})};$.fn.groupPopToggle=function(){var a=$(this);a.bind("click.poptoggle",function(c){if($("div#groupby_pop").is(":visible")){$("div#groupby_pop").hide()}else{$("div#groupby_pop li a").each(function(){if($("div#groupby h3 a").attr("rel")===$(this).attr("rel")){$("div#groupby_pop li").removeClass("s");$(this).parent("li").addClass("s")}});var b=$("div#groupby_pop li");switch(Doit.currentBox){case"context":b.eq(1).hide();b.eq(2).show();b.eq(3).show();break;case"project":b.eq(0).find("a").attr("rel","box");b.eq(1).show();b.eq(2).hide();b.eq(3).show();break;case"someday":b.eq(0).find("a").attr("rel","default");b.eq(3).hide();break;case"tomorrow":b.eq(0).find("a").attr("rel","default");b.eq(3).hide();break;case"next":b.eq(0).find("a").attr("rel","default");b.eq(3).hide();break;case"inbox":b.eq(0).find("a").attr("rel","default");b.eq(3).hide();break;case"contact":b.eq(0).find("a").attr("rel","contact");break;case"waiting":b.eq(0).find("a").attr("rel","waiting");b.eq(1).show();b.eq(2).show();b.eq(3).hide();break;case"scheduled":b.eq(0).find("a").attr("rel","scheduled");b.eq(1).show();b.eq(2).show();b.eq(3).hide();break;case"completed":b.eq(0).find("a").attr("rel","monthly");break;case"archiver":b.eq(3).hide();switch(Doit.currentGroupBy){case"group_weekly":b.eq(0).find("a").attr("rel","weekly");break;case"group_monthly":b.eq(0).find("a").attr("rel","monthly");break;default:}break;default:b.eq(0).find("a").attr("rel","default");b.show()}$("div#groupby_pop").show()}c.preventDefault();c.stopPropagation();$(document).one("click",function(){$("div#groupby_pop").hide()})})};$.fn.taskListToggle=function(){var a=$(this);a.toggle(function(){if(!$(this).siblings("ul.taskList").is(":animated")){$(this).find("span.unfold").addClass("fold");$(this).siblings("ul.taskList").stop(true,false).hide()}},function(){if(!$(this).siblings("ul.taskList").is(":animated")){$(this).find("span.unfold").removeClass("fold");$(this).siblings("ul.taskList").stop(true,false).show()}})};GTD.group.showTaskByGroupby=function(a){switch(a){case"start_at":GTD.group.getGroups("scheduled");a="scheduled";break;case"end_at":GTD.group.getGroups("deadline");a="deadline";break;case"priority":GTD.group.getGroups("priority");a="priority";break;case"completed_at":if(Doit.currentBox=="completed"){GTD.group.getGroups("monthly");a="monthly"}else{GTD.group.getGroups("default")}break;case"contacts":GTD.group.getGroups("waiting");a="waiting";break;case"contact":GTD.group.getGroups("contact");a="contact";break;case"context":GTD.group.getGroups("context");a="context";break;case"project":GTD.group.getGroups("project");a="project";break;case"status":GTD.group.getGroups("project");a="status";break;case"box":GTD.group.getGroups("box");a="box";break;default:GTD.group.getGroups("default");break}if(Doit.currentPage=="time"){var b=(a==null||$.inArray(a,["box","contact","waiting","monthly"])>-1)?L.GROUP_BY_DEFAULT:$('#groupby_pop li a[rel="'+a+'"]').text()}else{var b=(a==null||$.inArray(a,["box","status"])>-1)?L.GROUP_BY_DEFAULT:$('#groupby_pop li a[rel="'+a+'"]').text()}$("#groupby h3 a").html(b+"<span></span>").attr("rel",a)};GTD.weekOfMonthEn=function(b){if(b==null){return}var c=0;if(typeof b=="string"){if(b.split("-").length<3){return}var c=Do.parseInt(Do.parseInt(b.split("-")[2])/7);if(b.split("-")[2]%7>0){c+=1}}else{var a=b.getUserDate();var c=Do.parseInt(a/7);if(a%7>0){c+=1}}switch(c){case 1:return L.RR_FIRST;break;case 2:return L.RR_SECOND;break;case 3:return L.RR_THIRD;break;case 4:return L.RR_FOURTH;break;case 5:return L.RR_FIFTH;break;default:return;break}};GTD.weekOfMonthStr=function(a){switch(a){case 1:return L.RR_FIRST;break;case 2:return L.RR_SECOND;break;case 3:return L.RR_THIRD;break;case 4:return L.RR_FOURTH;break;case 5:return L.RR_FIFTH;break;default:return;break}};GTD.weekDayByNum=function(b){if(b>6){return""}var a=[L.RR_SUN,L.RR_MON,L.RR_TUS,L.RR_WED,L.RR_THU,L.RR_FRI,L.RR_SAT];return a[b]};GTD.monthByNum=function(a){if(a>12){return}var b=[L.RR_JAN,L.RR_FEB,L.RR_MAR,L.RR_APR,L.RR_MAY,L.RR_JUN,L.RR_JUL,L.RR_JAG,L.RR_SEP,L.RR_OCT,L.RR_NOV,L.RR_DEC];return b[a-1]};GTD.numMonthByNum=function(a){if(a>11){return}var b=[L.RR_JAN_NUM,L.RR_FEB_NUM,L.RR_MAR_NUM,L.RR_APR_NUM,L.RR_MAY_NUM,L.RR_JUN_NUM,L.RR_JUL_NUM,L.RR_JAG_NUM,L.RR_SEP_NUM,L.RR_OCT_NUM,L.RR_NOV_NUM,L.RR_DEC_NUM];return b[a-1]};GTD.taskView=function(I,C,u,v){if(Do.id(C).length==1){Do.id(C).remove()}var a=I.project_id!=null?('<span class="project">#'+GTD.findNameByUUID(Doit.projects,I.project_id)+"</span>"):'<span class="project"></span>';var O=$('<div class="task-view" id="'+C+'" tid="'+u+'"><h3><span class="task-checkbox"></span>'+a+'<span class="title">'+I.title+"</span></h3></div>");if(v!=null){O.attr("repeat_no",v)}$("#task_container").append(O);O.hide();var b=$('<ul class="detail"></ul>');if(I.completed!=null){O.addClass("completed")}O.append(b);if(I.archived==null){GTD.checkBoxComplete(O.find("h3 span.task-checkbox"))}var r=I.notes===""?"":I.notes;if($.trim(I.notes)!=""){var M=r.replace(/[a-z0-9_\-+=.]+@[a-z0-9\-]+(\.[a-z0-9-]+)+/ig,function(l){return"<a href='mailto:"+l+"'>"+l+"</a>"});var e=/((http|ftp|https|file):\/\/([\w\-]+\.)+[\w\-]+(\/[\w\u4e00-\u9fa5\-\.\/?\@\%\!\&=\+\~\:\#\;\,]*)?)/ig;M=M.replace(e,"<a href='$1' target='_blank' title='$1'>$1</a>");var x=$('<li class="note"><span class="icon"></span><span class="con">'+M+"</span></li>");x.data("detail",r);x.find(".icon").bind("click",function(){GTD.openNoteInWindow(r,I.title)})}b.append(x);var U="";if(I.start_at!=null){U=Time.strToDatetimeStr(I.start_at);var T=I.all_day?U.split(" ")[0]:U;U=T.replace(/-/g,"/");if(I.end_at!=null){var Q=Time.strToDatetimeStr(I.end_at);var R=I.all_day?Q.split(" ")[0]:Q;Q=R.replace(/-/g,"/");U+=" - "+Q}if(I.attribute==="waiting"&&Doit.currentBox!="completed"&&Doit.currentBox!="trash"){U=L.REPEAT_WAITING_FOR+" "+U}}else{box=GTD.getTaskBox(I);U=box;if(U=="archiver"){if(I.attribute=="inbox"){U=L.INBOX}else{if(I.attribute=="next"){U=L.NEXT}else{if(I.attribute=="noplan"){U=L.SOMEDAY}else{if(I.attribute=="waiting"){U=L.WAITING}}}}}else{U=L[U.toUpperCase()]}if(I.end_at!=null){var Q=Time.strToDatetimeStr(I.end_at);var R=I.all_day?Q.split(" ")[0]:Q;Q=R.replace(/-/g,"/");if(I.all_day){U+=L.RR_COMMA+L.TIME_END_ON+Q}else{U+=L.RR_COMMA+L.TIME_END_AT+Q}}}var ab=$('<li class="time"><span class="icon"></span><span class="con">'+U+"</span></li>");b.append(ab);var D=$('<li class="repeat"><span class="icon"></span></li>');if(I.repeater!=null){var A=GTD.getRepeatStr(I.repeater,I.start_at);var z=$('<span class="con">'+A+"</span>");D.append(z)}b.append(D);var h="";switch(I.priority){case 1:h="p1";break;case 2:h="p2";break;case 3:h="p3";break;default:h="p0"}var H=$('<div class="priority '+h+'"></div>');O.prepend(H);var aa=$('<ul class="group"></ul>');var ac=I.context_id!=null?GTD.findNameByUUID(Doit.contexts,I.context_id):"";var N=$('<li class="context"><span class="icon"></span><span class="con">'+ac+"</span></li>");aa.append(N);var F=$('<li class="tags"><span class="icon"></span></li>');var V=I.tags.length;for(var Y=0;Y<V;Y++){if($.trim(I.tags[Y]).length){var B=$('<span class="tag">'+I.tags[Y]+"</span>");F.append(B)}}aa.append(F);var g="";var s=$('<li class="reminders"><span class="icon"></span></li>');var X=I.reminders.length;for(var Y=0;Y<X;Y++){var g="";if(!I.reminders[Y].sent){var c=I.reminders[Y].view;if(c=="relative"){var n=Time.strToDatetimeStr(I.reminders[Y].time);var p=Time.strToDatetimeStr(I.start_at);var K=GTD.remindMathBack(n.replace(/-/g,"/"),p.replace(/-/g,"/"));var Z=K.time;var P=K.unit;var ad=I.reminders[Y].mode;g+=L.AHEAD_CN+Z+L.WORDSPACE+L[P.toUpperCase()]+L.AHEAD_EN+"("+L["REMINDER_"+ad.toUpperCase()]+");"}else{var k=I.reminders[Y].time.substr(0,16);var ad=I.reminders[Y].mode;g+=k+"("+L["REMINDER_"+ad.toUpperCase()]+");"}}else{g=L.ALREADY;switch(I.reminders[Y].mode){case"email":g+=L.EMAIL;break;default:g+=L.POPUP}g+=L.ALREADY_REMINDED}g=$('<span class="reminder con">'+g+"</span>");s.append(g)}aa.append(s);b.append(aa);var E="";var w=$('<li class="forward"><span class="icon"></span></li>');if(I.forwarded_by!=null){var S=GTD.find_contact_name_by_user_email(I.forwarded_by);var o=S==undefined?L.CONTACT_DELETED:S;E+=o+" -> "+L.MYSELF;if(I.assignment!=null){var X=I.assignment.items.length;var W=GTD.find_contact_name_by_user_email(I.assignment.items[0].contact)===null?I.assignment.items[0].contact:GTD.find_contact_name_by_user_email(I.assignment.items[0].contact);var q=W==undefined?L.CONTACT_DELETED:W;if(X===1){E+=" -> "+q}else{for(var Y=1;Y<X;Y++){var G=GTD.find_contact_name_by_user_email(I.assignment.items[Y].contact)===null?I.assignment.items[Y].contact:GTD.find_contact_name_by_user_email(I.assignment.items[Y].contact);var j=G==undefined?L.CONTACT_DELETED:G;q+=", "+j}E+=" -> "+q}}}else{if(I.assignment!=null){var X=I.assignment.items.length;var W=GTD.find_contact_name_by_user_email(I.assignment.items[0].contact)===null?I.assignment.items[0].contact:GTD.find_contact_name_by_user_email(I.assignment.items[0].contact);var q=W==undefined?L.CONTACT_DELETED:W;if(X===1){E+=L.MYSELF+" -> "+q}else{for(var Y=1;Y<X;Y++){var G=GTD.find_contact_name_by_user_email(I.assignment.items[Y].contact)===null?I.assignment.items[Y].contact:GTD.find_contact_name_by_user_email(I.assignment.items[Y].contact);var j=G==undefined?L.CONTACT_DELETED:G;q+=", "+j}E+=L.MYSELF+" -> "+q}}}var z=$('<span class="con">'+E+"</span>");w.append(z);b.append(w);$("#toolbar .task-tool").remove();var y=$('<div class="edit-task task-tool"><a href="javascript:;" title="'+L.EDIT+'">'+L.EDIT+"</a></div>");var f=$('<div class="del-task task-tool"><a href="javascript:;" title="'+L.DELETE+'">'+L.DELETE+"</a></div>");var J=$('<div class="archive-task task-tool"><a href="javascript:;" title="'+L.ARCHIVE+'">'+L.ARCHIVE+"</a></div>");if(I.completed!=null&&I.trashed==null&&I.archived==null){J.insertAfter($("#toolbar .goback"));f.insertAfter($("#toolbar .goback"));y.insertAfter($("#toolbar .goback"))}else{if(Doit.currentBox==="archiver"){f.insertAfter($("#toolbar .goback"))}else{if(Doit.currentBox==="trash"){f.insertAfter($("#toolbar .goback"))}else{f.insertAfter($("#toolbar .goback"));y.insertAfter($("#toolbar .goback"))}}}if(v==null){$("#toolbar .task-tool").attr("data-id",u)}else{$("#toolbar .task-tool").attr("data-id",u).attr("data-repeat-no",v)}TASKS=TASKS?TASKS:new Array(I);$("#toolbar .edit-task").editTask(TASKS);$("#toolbar .del-task").removeTask(TASKS);$("#toolbar .archive-task").archiveTask(TASKS);O.show();b.find("li").each(function(l,m){if(!$.trim($(m).text()).length){$(m).hide()}else{$(m).show()}})};$.fn.doitnowTaskview=function(){$(this).find(".link-title").bind("click",function(){var g=$(this).parents(".task");var u=g.attr("tid");var v=g.attr("repeat_no");var G=GTD.find_task_by_id_repeatno(TASKS,u,v);if(v==null){v=""}else{v="_"+v}var B="taskview_"+u+v;if(Do.id(B).length==1){Do.id(B).show();return}var a=G.project_id!=null?('<span class="project">#'+GTD.findNameByUUID(Doit.projects,G.project_id)+"</span>"):'<span class="project"></span>';var K=$('<li class="task-view" id="'+B+'" tid="'+u+'"><h3>'+a+'<span class="title">'+G.title+'</span></h3><div class="pri"></div><div class="close"></div></li>');K.find(".close").bind("click",function(){$(this).parent().remove()});if(v!=null){K.attr("repeat_no",v)}K.hide();var b=$('<ul class="detail"></ul>');if(G.completed!=null){K.addClass("completed")}K.append(b);var r=G.notes===""?"":G.notes;if($.trim(G.notes)!=""){var I=r.replace(/[a-z0-9_\-+=.]+@[a-z0-9\-]+(\.[a-z0-9-]+)+/ig,function(l){return"<a href='mailto:"+l+"'>"+l+"</a>"});var e=/((http|ftp|https|file):\/\/([\w\-]+\.)+[\w\-]+(\/[\w\u4e00-\u9fa5\-\.\/?\@\%\!\&=\+\~\:\#\;\,]*)?)/ig;I=I.replace(e,"<a href='$1' target='_blank' title='$1'>$1</a>");var x=$('<li class="note"><span class="icon"></span><span class="con">'+I+"</span></li>");x.data("detail",r);x.find(".icon").bind("click",function(){GTD.openNoteInWindow(r,G.title)})}b.append(x);var R="";if(G.start_at!=null){R=Time.strToDatetimeStr(G.start_at);var Q=G.all_day?R.split(" ")[0]:R;R=Q.replace(/-/g,"/");if(G.end_at!=null){var N=Time.strToDatetimeStr(G.end_at);var O=G.all_day?N.split(" ")[0]:N;N=O.replace(/-/g,"/");R+=" - "+N}if(G.attribute==="waiting"&&Doit.currentBox!="completed"&&Doit.currentBox!="trash"){R=L.REPEAT_WAITING_FOR+" "+R}}else{box=GTD.getTaskBox(G);R=box;if(R=="archiver"){if(G.attribute=="inbox"){R=L.INBOX}else{if(G.attribute=="next"){R=L.NEXT}else{if(G.attribute=="noplan"){R=L.SOMEDAY}else{if(G.attribute=="waiting"){R=L.WAITING}}}}}else{R=L[R.toUpperCase()]}if(G.end_at!=null){var N=Time.strToDatetimeStr(G.end_at);var O=G.all_day?N.split(" ")[0]:N;N=O.replace(/-/g,"/");if(G.all_day){R+=L.RR_COMMA+L.TIME_END_ON+N}else{R+=L.RR_COMMA+L.TIME_END_AT+N}}}var Y=$('<li class="time"><span class="icon"></span><span class="con">'+R+"</span></li>");b.append(Y);var C=$('<li class="repeat"><span class="icon"></span></li>');if(G.repeater!=null){var z=GTD.getRepeatStr(G.repeater,G.start_at);var y=$('<span class="con">'+z+"</span>");C.append(y)}b.append(C);var h="";switch(G.priority){case 1:h="p1";break;case 2:h="p2";break;case 3:h="p3";break;default:h="p0"}K.find(".pri").addClass(h);var X=$('<ul class="group"></ul>');var Z=G.context_id!=null?GTD.findNameByUUID(Doit.contexts,G.context_id):"";var J=$('<li class="context"><span class="icon"></span><span class="con">'+Z+"</span></li>");X.append(J);var E=$('<li class="tags"><span class="icon"></span></li>');var S=G.tags.length;for(var V=0;V<S;V++){if($.trim(G.tags[V]).length){var A=$('<span class="tag">'+G.tags[V]+"</span>");E.append(A)}}X.append(E);var f="";var s=$('<li class="reminders"><span class="icon"></span></li>');var U=G.reminders.length;for(var V=0;V<U;V++){var f="";if(!G.reminders[V].sent){var c=G.reminders[V].view;if(c=="relative"){var n=Time.strToDatetimeStr(G.reminders[V].time);var p=Time.strToDatetimeStr(G.start_at);var H=GTD.remindMathBack(n.replace(/-/g,"/"),p.replace(/-/g,"/"));var W=H.time;var M=H.unit;var aa=G.reminders[V].mode;f+=L.AHEAD_CN+W+L.WORDSPACE+L[M.toUpperCase()]+L.AHEAD_EN+"("+L["REMINDER_"+aa.toUpperCase()]+");"}else{var k=G.reminders[V].time.substr(0,16);var aa=G.reminders[V].mode;f+=k+"("+L["REMINDER_"+aa.toUpperCase()]+");"}}else{f=L.ALREADY;switch(G.reminders[V].mode){case"email":f+=L.EMAIL;break;default:f+=L.POPUP}f+=L.ALREADY_REMINDED}f=$('<span class="reminder con">'+f+"</span>");s.append(f)}X.append(s);b.append(X);var D="";var w=$('<li class="forward"><span class="icon"></span></li>');if(G.forwarded_by!=null){var P=GTD.find_contact_name_by_user_email(G.forwarded_by);var o=P==undefined?L.CONTACT_DELETED:P;D+=o+" -> "+L.MYSELF;if(G.assignment!=null){var U=G.assignment.items.length;var T=GTD.find_contact_name_by_user_email(G.assignment.items[0].contact)===null?G.assignment.items[0].contact:GTD.find_contact_name_by_user_email(G.assignment.items[0].contact);var q=T==undefined?L.CONTACT_DELETED:T;if(U===1){D+=" -> "+q}else{for(var V=1;V<U;V++){var F=GTD.find_contact_name_by_user_email(G.assignment.items[V].contact)===null?G.assignment.items[V].contact:GTD.find_contact_name_by_user_email(G.assignment.items[V].contact);var j=F==undefined?L.CONTACT_DELETED:F;q+=", "+j}D+=" -> "+q}}}else{if(G.assignment!=null){var U=G.assignment.items.length;var T=GTD.find_contact_name_by_user_email(G.assignment.items[0].contact)===null?G.assignment.items[0].contact:GTD.find_contact_name_by_user_email(G.assignment.items[0].contact);var q=T==undefined?L.CONTACT_DELETED:T;if(U===1){D+=L.MYSELF+" -> "+q}else{for(var V=1;V<U;V++){var F=GTD.find_contact_name_by_user_email(G.assignment.items[V].contact)===null?G.assignment.items[V].contact:GTD.find_contact_name_by_user_email(G.assignment.items[V].contact);var j=F==undefined?L.CONTACT_DELETED:F;q+=", "+j}D+=L.MYSELF+" -> "+q}}}var y=$('<span class="con">'+D+"</span>");w.append(y);b.append(w);K.show();b.find("li").each(function(l,m){if(!$.trim($(m).text()).length){$(m).hide()}else{$(m).show()}});g.after(K)})};GTD.getRepeatStr=function(j,a){if(j==null){return}var h=j.mode;var f=j.cycle;var c=j.ends_on==null?null:Time.getDateOrDatetime(Time.strToDatetimeStr(j.ends_on));var k="";a=Time.strToDate(a);if(h=="daily"){if(f==1){k=L.RR_DAILY}else{if(f>1){k=L.RR_EVERY+" "+f+" "+L.RR_DAYS}}k+=L.RR_REPEAT}else{if(h=="monthly"){if(f==1){k=L.RR_MONTHLY}else{if(f>1){k=L.RR_EVERY+" "+f+" "+L.RR_MONTHS}}var e=j.date==null?"weekday":"monthday";if(a!=null){if(e==="monthday"){switch(j.date){case"-1":case -1:k+=L.RR_LAST_0;break;case"-2":case -2:k+=L.RR_LAST_1;break;case"-3":case -3:k+=L.RR_LAST_2;break;default:k+=" "+L.RR_ON+" "+L.RR_DAY+" "+j.date+L.RR_DAY_1}}else{if(e==="weekday"){var l=j.day;if(j.week==="-1"){k+=L.RR_LAST+GTD.weekDayByNum(l)}else{k+=" "+L.RR_ON+" "+L.RR_THE+" "+GTD.weekOfMonthStr(Do.parseInt(j.week))+L.RR_GE+" "+GTD.weekDayByNum(l)}}}}k+=L.RR_REPEAT}else{if(h=="weekly"){if(j.day=="1,2,3,4,5"){if(f==1){k+=L.WEEKDAY}else{if(f>1){k=L.RR_EVERY+" "+f+" "+L.RR_WEEKDAYS}}k+=L.RR_REPEAT}else{if(j.day==="0,1,2,3,4,5,6"||j.day==="1,2,3,4,5,6,0"){if(f==1){k+=L.RR_DAILY;k+=L.RR_REPEAT}else{if(f>1){k=L.RR_EVERY+" "+f+" "+L.RR_ALLDAYS}}}else{if(f==1){k=L.RR_WEEKLY}else{if(f>1){k=L.RR_EVERY+" "+f+" "+L.RR_WEEKS}}var b=j.day;if(b.length!=0){k+=" "+L.RR_ON+" "}if(typeof(b)=="string"){b=b.split(",")}for(var g=0;g<b.length;g++){k+=GTD.weekDayByNum(Do.parseInt(b[g]));if(g!=b.length-1){k+=L.RR_CAESURA+" "}}k+=L.RR_REPEAT}}}else{if(h=="yearly"){if(f==1){k+=L.RR_YEARLY}else{if(f>1){k+=L.RR_EVERY+" "+f+" "+L.RR_YEARS}}if(a){k+=" "+L.RR_ON+" "+GTD.monthByNum(Do.parseInt(a.getMonth()+1))+" "+a.getUserDate()+L.RR_MDAY+L.RR_REPEAT}}}}}if(c){k+=" "+L.RR_COMMA+L.RR_UNTIL+" "+c}return k};GTD.openNoteInWindow=function(c,f){c=c.replace(/\n/gi,"<br />");var a=c.replace(/[a-z0-9_\-+=.]+@[a-z0-9\-]+(\.[a-z0-9-]+)+/ig,function(g){return"<a href='mailto:"+g+"'>"+g+"</a>"});var b=/((http|ftp|https|file):\/\/([\w\-]+\.)+[\w\-]+(\/[\w\u4e00-\u9fa5\-\.\/?\@\%\!\&=\+\~\:\#\;\,]*)?)/ig;a=a.replace(b,"<a href='$1' target='_blank' title='$1'>$1</a>");var e=window.open("","Notes","");a='<h1 style="text-align:center">'+f+"</h1><br /><p>"+a+"</p>";e.document.write(a);e.document.close()};GTD.updateTaskView=function(S){var B=S;var P="";if(S.repeat_no!=null){P="_"+S.repeat_no}var x="taskview_task_"+B.id+P;var E=Do.id(x);var b=E.find("ul.detail");var w=B.title;E.find("h3 span.title").html(B.title);b.find("li.note").remove();var q=B.notes===""?"":B.notes;if($.trim(B.notes)!=""){var D=q.replace(/[a-z0-9_\-+=.]+@[a-z0-9\-]+(\.[a-z0-9-]+)+/ig,function(l){return"<a href='mailto:"+l+"'>"+l+"</a>"});var e=/((http|ftp|https|file):\/\/([\w\-]+\.)+[\w\-]+(\/[\w\u4e00-\u9fa5\-\.\/?\@\%\!\&=\+\~\:\#\;\,]*)?)/ig;D=D.replace(e,"<a href='$1' target='_blank' title='$1'>$1</a>");var s=$('<li class="note"><span class="icon"></span><span class="con">'+D+"</span></li>");s.find(".icon").unbind("click").bind("click",function(){GTD.openNoteInWindow(q,w)});s.data("detail",q)}b.find("li.time").before(s);E.find(".note a.btn-more").show_note_detail();var K="";if(B.start_at!=null){K=Time.strToDatetimeStr(B.start_at);var J=B.all_day?K.split(" ")[0]:K;K=J.replace(/-/g,"/");if(B.end_at!=null){var G=Time.strToDatetimeStr(B.end_at);var H=B.all_day?G.split(" ")[0]:G;G=H.replace(/-/g,"/");K+=" - "+G}if(B.attribute==="waiting"&&Doit.currentBox!="completed"&&Doit.currentBox!="trash"){K=L.REPEAT_WAITING_FOR+" "+K}}else{K=($.inArray(Doit.currentBox,["project","context","contact"])>-1)?"inbox":Doit.currentBox;if(K=="waiting"){K=L.REPEAT_WAITING_FOR}else{if(K==="contact"){K=L.REPEAT_WAITING_FOR}else{K=L[K.toUpperCase()]}}if(B.end_at!=null){var G=Time.strToDatetimeStr(B.end_at);var H=B.all_day?G.split(" ")[0]:G;G=H.replace(/-/g,"/");if(B.all_day){K+=L.TIME_END_ON+G}else{K+=L.TIME_END_AT+G}}}b.find("li.time span.con").text(K);var a=B.project_id!=null?"#"+GTD.findNameByUUID(Doit.projects,B.project_id):"";E.find(".project").html(a);var g="";switch(B.priority){case 1:g="p1";break;case 2:g="p2";break;case 3:g="p3";break;default:g="p0"}E.find(".priority").removeClass().addClass("priority").addClass(g);var T=E.find(".group");var U=B.context_id!=null?GTD.findNameByUUID(Doit.contexts,B.context_id):"";b.find("li.context span.con").html(U);b.find("li.tags").remove();var z=$('<li class="tags"><span class="icon"></span></li>');var M=B.tags.length;for(var Q=0;Q<M;Q++){var v=$('<span class="tag">'+B.tags[Q]+"</span>");z.append(v)}T.append(z);b.find("li.reminders").remove();var r=$('<li class="reminders"><span class="icon"></span></li>');var O=B.reminders.length;for(var Q=0;Q<O;Q++){var f="";if(!B.reminders[Q].sent){var c=B.reminders[Q].view;if(c=="relative"){var k=Time.strToDatetimeStr(B.reminders[Q].time);var o=Time.strToDatetimeStr(B.start_at);var C=GTD.remindMathBack(k.replace(/-/g,"/"),o.replace(/-/g,"/"));var R=C.time;var F=C.unit;var V=B.reminders[Q].mode;f+=L.AHEAD_CN+R+L.WORDSPACE+L[F.toUpperCase()]+L.AHEAD_EN+"("+L["REMINDER_"+V.toUpperCase()]+");"}else{var j=B.reminders[Q].time.substr(0,16);var V=B.reminders[Q].mode;f+=j+"("+L["REMINDER_"+V.toUpperCase()]+");"}}else{f=L.ALREADY;switch(B.reminders[Q].mode){case"email":f+=L.EMAIL;break;default:f+=L.POPUP}f+=L.ALREADY_REMINDED}f=$('<span class="reminder con">'+f+"</span>");r.append(f)}T.append(r);if(B.repeater!=null){var u=GTD.getRepeatStr(B.repeater,B.start_at)}b.find("li.repeat span.con").text(u);var y="";if(B.forwarded_by!=null){var I=GTD.find_contact_name_by_user_email(B.forwarded_by);var n=I==undefined?L.CONTACT_DELETED:I;y+=n+" -> "+L.MYSELF;if(B.assignment!=null){var O=B.assignment.items.length;var N=GTD.find_contact_name_by_user_email(B.assignment.items[0].contact)===null?B.assignment.items[0].contact:GTD.find_contact_name_by_user_email(B.assignment.items[0].contact);var p=N==undefined?L.CONTACT_DELETED:N;if(O===1){y+=" -> "+p}else{for(var Q=1;Q<O;Q++){var A=GTD.find_contact_name_by_user_email(B.assignment.items[Q].contact)===null?B.assignment.items[Q].contact:GTD.find_contact_name_by_user_email(B.assignment.items[Q].contact);var h=A==undefined?L.CONTACT_DELETED:A;p+=", "+h}y+=" -> "+p}}}else{if(B.assignment!=null){var O=B.assignment.items.length;var N=GTD.find_contact_name_by_user_email(B.assignment.items[0].contact)===null?B.assignment.items[0].contact:GTD.find_contact_name_by_user_email(B.assignment.items[0].contact);var p=N==undefined?L.CONTACT_DELETED:N;if(O===1){y+=L.MYSELF+" -> "+p}else{for(var Q=1;Q<O;Q++){var A=GTD.find_contact_name_by_user_email(B.assignment.items[Q].contact)===null?B.assignment.items[Q].contact:GTD.find_contact_name_by_user_email(B.assignment.items[Q].contact);var h=A==undefined?L.CONTACT_DELETED:A;p+=", "+h}y+=L.MYSELF+" -> "+p}}}b.find("li.forward span.con").text(y);b.find("li").each(function(l,m){if(!$.trim($(m).text()).length){$(m).hide()}else{$(m).show()}})};GTD.singleTask=function(a){a=a.split("_");var k=a[0];var l=a.length==2?a[1]:null;var j="task_"+a.join("_");var g=l==null?"id="+encodeURIComponent(k):"id="+encodeURIComponent(k)+"&repeat_no="+l;$("#project_info").hide();$("#search_result").hide();$("#task_group").hide();$("#empty_tip_content").hide();$("#setting_content").hide().empty();$(".archiver-tool").hide();GTD.quickAdd.hide();$("#groupby").hide();$("#paper_title .tags").hide();$("#toolbar .goback").remove();var h=$('<div class="goback"><a href="javascript:;" data-title="'+document.title+'" title="'+L.BACK+'">'+L.BACK+"</a></div>").insertAfter($("#groupby"));h.find("a").bind("click",function(){if(Doit.currentBox=="search"){$("#search_result").show()}else{if(Doit.currentBox=="archiver"){$(".archiver-tool").show()}else{$("#project_info").show();GTD.quickAdd.showornot()}}document.title=$(this).attr("data-title");$("#task_container .task-view").hide();$("#toolbar .goback").remove();$("#toolbar .task-tool").remove();$("#paper_title .tags").show();$("#task_group,#groupby").show()});var c="taskview_"+j;if($(".taskList li").length==0){$.ajax.getTask({onSuccess:function(p){var m=Do.parseJSON(p.responseText);Do.log("当前打开的任务数据↓");Do.log(m);var o=GTD.getTaskBox(m);Doit.currentBox=o;$("#sidebar .s").removeClass("s");$("#"+o).addClass("s");if($(".taskList li").length==0){var n=$("#sidebar .s a").attr("href");h.find("a").attr("href",n)}f(m)}},"task?"+g)}else{if(Doit.currentPage=="time"){var b=$("#sidebar .s a").attr("href")}else{var b="#/"+Doit.currentPage}h.find("a").attr("href",b);var e=GTD.find_task_by_id_repeatno(TASKS,k,l);Do.log("当前打开的任务数据↓");Do.log(e);f(e)}function f(m){document.title=m.title+" | Doit.im";GTD.taskView(m,c,k,l);$(".task-view").hide();Do.id(c).show()}GTD.loadingData("hide")};$.fn.taskview=function(){var a=$(this);a.unbind("dblclick").bind("dblclick",function(){$(this).find(".task-control-edit").trigger("click");return false});a.bind("click",function(k){$("#quick_add_input").trigger("blur");if(k.ctrlKey||k.metaKey){$(this).toggleClass("s")}else{if(k.shiftKey){var f=$("div#task_container li.task");var b=$("div#task_container li.s");var g=b.length;if(g==0){$(this).toggleClass("s")}else{if(g==1){var j=$("div#task_container li.task").index($("div#task_container li.s"));var c=$("div#task_container li.task").index($(this));var m=c>j?f.slice(j,c+1):f.slice(c,j+1);m.addClass("s")}else{var h=$("div#task_container li.task").index($("div#task_container li.s:first"));var l=$("div#task_container li.task").index($("div#task_container li.s:last"));var c=$("div#task_container li.task").index($(this));var m;if(c<h){var m=f.slice(c,h+1);m.addClass("s")}else{if(c>l){var m=f.slice(l,c+1);m.addClass("s")}}}}}else{if($(this).hasClass("s")&&!$(k.target).hasClass("link-title")){$("#task_container li.task.s").removeClass("s")}else{$("#task_container li.task.s").removeClass("s");$(this).addClass("s")}}}});a.hover(function(){if(!$(this).is(".s")){$(this).addClass("hover")}},function(){$(this).removeClass("hover")})};$.fn.show_note_detail=function(){$this=$(this);$this.bind("click.show",function(c){var b=$(c.target).parent("li.note");var a=$(c.target).siblings("#note_detail");if(a.length===0){var a=$('<div id="note_detail"><div class="in"><div class="bd">'+b.data("detail")+"</div></div></div>");a.find(".in").tipBox("top",-30);b.append(a).show()}else{if(a.is(":visible")){a.hide()}else{a.show()}}})};$.initTaskList=function(){$("#toolbar .goback").remove();$("#toolbar .task-tool").remove();$("#paper_title div.tags").show();$("div#task_container div.task-view").remove();$("div#task_group,#groupby").show();if(Doit.currentBox=="archiver"){$(".archiver-tool").show()}else{GTD.quickAdd.show()}};GTD.updateTags=function(){$.ajax.getTagList({onSuccess:(function(b){var a=Do.parseJSON(b.responseText).entries;Doit.tags=a;GTD.tags()})},"")};GTD.tags=function(){var h=$("#paper_title div.tags").attr("style");$("#paper_title div.tags").remove();var e=[];$.each(TASKS,function(k,l){if(l==null){return}$.each(l.tags,function(n,m){if($.trim(m).length){e.push(m)}})});var g=[];Doit.tagsArray=$.map(Doit.tags,function(l,k){return l.name});$.each(Doit.tagsArray,function(k,l){if($.inArray(l,e)>-1){g.push(l)}});g=g.concat(e);g.unique();Doit.tagsArray=Doit.tagsArray.concat(e);Doit.tagsArray.unique();var j=$('<div class="tags"><ul></ul><div class="tags-control"></div></div>');$("div#paper_title div.in").append(j);if(g.length>0){$.each(g,function(l,m){var k=$('<li title="'+L.TAG+":"+m+'">'+m+"</li>");j.find("ul").append(k)})}$('<li class="tag-selected-untagged" title="'+L.TAG+":"+L.i_tasks_tag_none+'">'+L.i_tasks_tag_none+"</li>").prependTo(j.children("ul"));$('<li class="tag-selected-all" title="'+L.TAG+":"+L.i_tasks_tag_all+'">'+L.i_tasks_tag_all+"</li>").prependTo(j.children("ul"));j.attr("style",h);if($(".paper-date").html()==""){var a=$("#toolbar .tags ul").show().width()-281}else{var a=$("#toolbar .tags ul").show().width()}var c=0;$("#toolbar .tags ul").show().find("li").each(function(){var k=$(this).outerWidth(true);c+=k});if(a<=c){var f=$('<span class="control prev disabled"></span>');var b=$('<span class="control next"></span>');b.bind("click",function(){var n=$(this);var l=0;$("#toolbar .tags ul").show().find("li").each(function(){var o=$(this).outerWidth(true);l+=o});a=$("#toolbar .tags ul").show().width();var m=$("#toolbar .tags ul").css("marginLeft");m=Do.parseInt(m.substr(0,m.length-2))*(-1);var k=$("#toolbar .tags ul").width()-m;if(n.hasClass("cant")||l<=k||k>=(l-m)){n.addClass("disabled");return false}n.addClass("cant");f.removeClass("disabled");j.children("ul").animate({"margin-left":"-=300"},500,function(){n.removeClass("cant");var p=$("#toolbar .tags ul").css("marginLeft");p=Do.parseInt(p.substr(0,p.length-2))*(-1);var o=$("#toolbar .tags ul").width()-p;if(l<=o||o>=(l-p)){n.addClass("disabled");return false}})});f.bind("click",function(){var k=$(this);if(k.hasClass("cant")){return false}k.addClass("cant");b.removeClass("disabled");if(j.children("ul").css("marginLeft")!="0px"){j.children("ul").animate({"margin-left":"+=300"},500,function(){k.removeClass("cant");if(j.children("ul").css("marginLeft")=="0px"){k.addClass("disabled")}})}else{k.removeClass("cant")}});j.children(".tags-control").append(f).append(b)}j.find("li").tagFilter();j.find("li").removeClass("s");j.find("li.tag-selected-all").addClass("s");TASKS_FILTER=TASKS;$("ul#taskList li.task").removeClass("search-hidden")};$.fn.tagsToggle=function(){var a=$(this);a.click(function(){if($(this).hasClass("fold")){$(this).addClass("unfold").removeClass("fold")}else{$(this).addClass("fold").removeClass("unfold");$("div#paper_title div.tags").css({height:"auto"})}});return this};$.fn.tagFilter=function(){$(this).bind("click",function(c){var b=$(this);if(b.hasClass("tag-selected-all")){b.addClass("s").siblings().removeClass("s");TASKS_FILTER=TASKS;var f=Doit.currentGroupBy.replace("group_","");GTD.group.getGroups(f);return false}else{if(b.hasClass("tag-selected-untagged")){b.addClass("s").siblings().removeClass("s");TASKS_FILTER=TASKS;GTD.tagFilter("untagged");GTD.showHideGroup();return false}else{if($("#paper_title .tags li.tag-selected-untagged").hasClass("s")){TASKS_FILTER=TASKS}$("#paper_title .tags li.tag-selected-all").removeClass("s");$("#paper_title .tags li.tag-selected-untagged").removeClass("s");if(b.hasClass("s")){b.removeClass("s");TASKS_FILTER=TASKS}else{if(c.ctrlKey||c.metaKey){b.addClass("s")}else{TASKS_FILTER=TASKS;$("div#paper_title div.tags li.s").removeClass("s");b.addClass("s")}}var a=$("div#paper_title div.tags li.s");if(a.length){a.each(function(){var e=$(this).text();GTD.tagFilter(e)})}else{$("#paper_title .tags li.tag-selected-all").addClass("s");$("ul.taskList li.task").removeClass("search-hidden");TASKS_FILTER=TASKS;var f=Doit.currentGroupBy.replace("group_","");GTD.group.getGroups(f)}GTD.showHideGroup()}}})};GTD.showHideGroup=function(){$("div#task_group div.group").each(function(){var a=$(this);if(a.is(":visible")&&!a.find("li:not(.search-hidden)").length){a.hide()}else{if(a.is(":hidden")&&a.find("li:not(.search-hidden)").length){a.show()}}})};GTD.tagFilter=function(a){a=Do.escapeHTML(a);var b=[];if(a!="untagged"){b=$.grep(TASKS_FILTER,function(c){var e=(!!c.repeat_no)?"_"+c.repeat_no:"";if($.inArray(a,c.tags)>-1){Do.id("task_"+c.id+e).removeClass("search-hidden");return c}else{Do.id("task_"+c.id+e).addClass("search-hidden")}})}else{b=$.grep(TASKS_FILTER,function(c){var e=(!!c.repeat_no)?"_"+c.repeat_no:"";if(!c.tags.length){Do.id("task_"+c.id+e).removeClass("search-hidden");return c}else{Do.id("task_"+c.id+e).addClass("search-hidden")}})}TASKS_FILTER=b;return b};GTD.runTimeFunc=function(){$("#sidebar_addtask").click(function(){GTD.Taskform.popup("add")});GTD.Time.setTasksCount();GTD.Time.leftBox();GTD.smartBox.init();if(Doit.currentBox!="search"&&Doit.currentBox!="task"){setTimeout(function(){var c=Doit.url;var b=c[1]==null?"today":c[1];window.location="#/time/"+b;if(c!="time"){GTD.Time.loadTimeboxTask(b)}},1000)}else{if(Doit.currentBox=="task"){var a=Doit.url.toString().replace(/task\//,"");GTD.singleTask(a)}}$("#btn_empty_trash").click(function(b){var c=GTD.confirmBox({title:L.DIALOG_TITLE_WARNING,msgTitle:L.DIALOG_WARNING_EMPTY_TRASH,msgText:L.DIALOG_WARNING_OPERATION_IRRECOVERABLE,deleteCallback:function(){$.ajax.clearTrash({data:{},onSuccess:function(){$(".reload-data").trigger("click")}},"clear_trash")}});return false});$("#btn_archive_tasks").click(function(b){b.preventDefault();var c=GTD.confirmBox({title:L.DIALOG_TITLE_WARNING,msgTitle:L.DIALOG_WARNING_ARCHIVE,msgText:"",deleteCallback:function(){$.ajax.archiveCompleted({data:{},onSuccess:function(){$(".reload-data").trigger("click")}},"archive_completed")}})})};GTD.runContextFunc=function(){$("#sidebar_addtask").click(function(){GTD.Taskform.popup("add")});$.initTaskList();$("#sidebar_add_new_context .add-new").addContext();$("#context_del").delContext();$("#context_list").listContexts();$("#context_root li").rootContext();GTD.callback_afterContextData()};GTD.runProjectFunc=function(){$("#sidebar_addtask").click(function(){GTD.Taskform.popup("add")});$("#sidebar_addproject").click(function(){GTD.Projectform.popup("add")});$.initTaskList();$("#project_del").delProject();$("#project_list").listProjects();$("#project_root li").rootProject();GTD.callback_afterProjectData()};GTD.runContactFunc=function(){$.initTaskList();GTD.Message.showList();GTD.quickAdd.hide();var a=$("#sidebar_contact .tip-box").tipBox("left");var a=$("#sidebar_contact .tip-box").tipBox("left");$("div#contact_add").addContactPop();$("div#contact_del").deleteOperation();GTD.initContactGroup();$("#contact_all .contact-title").trigger("click")};GTD.runArchiverFunc=function(){$.initTaskList();GTD.quickAdd.hide();$("ul#archiver_menu li").toggleArchiverType();GTD.archiveInit();$("ul#group_weekly li.control").getAnohterWeek();$("ul#group_monthly li.control").getAnohterMonth();var a=Doit.weekstartday=="Sunday"?0:1;$(".groupby-week,.groupby-month").each(function(){$(this).datepicker({showOtherMonths:true,selectOtherMonths:true,dateFormat:"yy-mm-dd",changeMonth:true,firstDay:a,changeYear:true,hasHours:false,onSelect:function(c,b){if($(this).parent("li").is("#weekly")){$(this).val(GTD.formatThisWeekDate(c.replace(/-/g,"/"))).attr("rel",new Date(c.replace(/-/g,"/")).format("yyyy-mm-dd"));GTD.getArchiveTask(new Date(c.replace(/-/g,"/")).format("yyyy-mm-dd"),"weekly")}else{$(this).val(new Date(c.replace(/-/g,"/")).format("onlyMonth")).attr("rel",new Date(c.replace(/-/g,"/")).format("yyyy-mm-dd"));GTD.getArchiveTask(new Date(c.replace(/-/g,"/")).format("yyyy-mm-dd"),"monthly")}}})});$("#weekly").trigger("click")};GTD.runCalendarFunc=function(){GTD.quickAdd.hide();CA.TABLE=$(".calendar .grid").html();CA.init();$(window).resize(function(){var a=$("div.grid").data("row");GTD.adjustHeight(a);$(".more-task").bind("click",function(){CA.showMoreMonth($(this).parent().attr("rel"),this);return false})})};GTD.init_time_data=function(){Doit.currentGroupBy="group_none";$.ajax.today_resources({onSuccess:function(b){var a=Do.parseJSON(b.responseText);Doit.contexts=a.resources.contexts;Doit.tags=a.resources.tags;Doit.projects=a.resources.projects;Doit.contacts=a.resources.contacts;Doit.messages=a.resources.messages;Doit.inbox_count=a.resources.utils[0].inbox_count;Doit.today_count=a.resources.utils[0].today_count;Doit.allCompletedCount=a.resources.utils[0].all_completed_count;Doit.nextTasksCount=a.resources.utils[0].next_tasks_count;Doit.me=a.resources.utils[0].current_username;Doit.account=a.resources.utils[0].current_account;Doit.nickname=a.resources.utils[0].current_nickname;Doit.maxOrder=TASKS?TASKS.length:0;Doit.settings=a.resources.settings[0];Doit.weekstartday=Doit.settings.week_start;Doit.activated=a.resources.settings[0].status;GTD.notice.init();Doit.boxes=a.resources.boxes;GTD.Message.showList();GTD.removeFrame();GTD.loadTimeFunc();GTD.runTimeFunc();GTD.setHeight();GTD.quickAdd.smart()}})};GTD.loadTimeFunc=function(){GTD.Time=new Object();GTD.Time.leftBox=function(){$li=$("#sidebar li");return $li.each(function(){$(this).droppable({accept:".task",hoverClass:"box-state-highlight",tolerance:"pointer",drop:function(b,a){if($(a.draggable).hasClass("s")){$("#task_container li.s").each(function(){GTD.moveTask($(this),$(b.target))})}else{GTD.moveTask($(a.draggable),$(b.target))}}})})};GTD.Time.loadTimeboxTask=function(g,f){if(g==null){return false}$("div#groupby_pop").hide();$("#sidebar .s").removeClass("s");var e=Do.id(g);e.addClass("s");GTD.emptyTasks();GTD.loadingData("show");var b=g;$.initTaskList();if(e.hasClass("smart-box")){Doit.currentBox="smartbox"}else{Doit.currentBox=b}if(b=="scheduled"||b=="completed"||b=="trash"){GTD.quickAdd.hide()}var c=e.data("data");if($.inArray(b,["inbox","today","next","tomorrow","someday","scheduled","completed","trash","waiting"])>-1){if(b=="today"){$.ajax.listTask({onSuccess:function(k){var j=Do.parseJSON(k.responseText);TASKS=j.entries;TASKS_FILTER=TASKS;Doit.maxOrder=TASKS.length;GTD.tags();if(b=="inbox"||b=="today"){GTD.Time.resetTasksCount($("#sidebar .s"))}$("div#groupby h3 a").html(L.GROUP_BY_DEFAULT+"<span></span>").attr("rel","default");var h=Do.id(g).data("data").group_by;Do.log("groupby of current box is "+h+"!");if(h==null){switch(b){case"scheduled":GTD.group.getGroups("scheduled");break;case"waiting":GTD.group.getGroups("waiting");break;case"next":GTD.group.getGroups("project");break;case"completed":GTD.group.getGroups("monthly");break;default:GTD.group.getGroups("default");break}}else{GTD.group.showTaskByGroupby(h)}GTD.setTitle();GTD.Time.resetTasksCount($(this));GTD.loadingData("hide");if(f){f()}}},b)}else{$.ajax.listTask({onSuccess:function(k){var j=Do.parseJSON(k.responseText);TASKS=j.entries;TASKS_FILTER=TASKS;Doit.maxOrder=TASKS.length;GTD.tags();if(b=="inbox"||b=="today"){GTD.Time.resetTasksCount($("#sidebar .s"))}$("div#groupby h3 a").html(L.GROUP_BY_DEFAULT+"<span></span>").attr("rel","default");var h=Do.id(g).data("data").group_by;Do.log("groupby of current box is "+h+"!");if(h==null){switch(b){case"scheduled":GTD.group.getGroups("scheduled");break;case"waiting":GTD.group.getGroups("waiting");break;case"next":GTD.group.getGroups("project");break;case"completed":GTD.group.getGroups("monthly");break;default:GTD.group.getGroups("default");break}}else{GTD.group.showTaskByGroupby(h)}GTD.setTitle();GTD.Time.resetTasksCount($(this));GTD.loadingData("hide");if(f){f()}}},b)}}else{var a=Doit.RestTask;Doit.RestTask+="/box";$.ajax.listSmartBoxTask({onSuccess:function(k){data=Do.parseJSON(k.responseText);TASKS=data.entries;TASKS_FILTER=TASKS;Doit.maxOrder=TASKS.length;GTD.setTitle();GTD.tags();GTD.quickAdd.hide();switch(c.group_by){case"start_at":case"end_at":var h="scheduled";var j="time";break;case null:var h="default";var j="default";break;default:var h=c.group_by;var j=h}$("div#groupby h3 a").html(L["GROUP_BY_"+j.toUpperCase()]+"<span></span>").attr("rel",h);GTD.group.getGroups(h);GTD.Time.resetTasksCount($(this));GTD.loadingData("hide");if(f){f()}}},encodeURIComponent(b));Doit.RestTask=a}};GTD.Time.isSame=function(b,a){return b==a};GTD.Time.isScheduleBox=function(a){return"scheduled"==a};GTD.Time.isNomalBox=function(a){return"scheduled"!=a&&"waiting"!=a};GTD.Time.isWaitingBox=function(a){return"waiting"==a};GTD.Time.setTasksCount=function(){$("#today .count").html(Doit.today_count);$("#inbox .count").html(Doit.inbox_count)};GTD.Time.resetTasksCount=function(b){var c=b.find(".count");var a=TASKS.length;if(c){c.html(a)}};GTD.smartBox=function(){$.fn.newSmartBox=function(){var b=$(this);b.bind("click",function(){GTD.Smartfolder.popup()})};$.fn.editBox=function(){var b=$(this);b.bind("click",function(){$("div#sidebar li").unbind("click");$("div#sidebar li").removeClass("s");var c=b.parent("div.edit");c.hide();$("div.box-toolbar div.done").show();$("div#sidebar input.box-status").show();$("div#sidebar span.count").hide();$("a#btn_archive_tasks").hide();$("a#btn_empty_trash").hide();$("div#sidebar li").removeClass("hidden");var e=$("div#sidebar div.more li:not(.sys)");e.each(function(){var f=$(this).data("data");var g=$(this).find("input.box-status");if(f.hidden==false){g.data("value",false).attr("checked",true)}else{g.data("value",true).attr("checked",false)}});return false})};$.fn.savBoxStatus=function(){var b=$(this);b.bind("click",function(){var c=$("div#sidebar div.more li");c.each(function(){var e=$(this).data("data");e.hidden=$(this).find("input.box-status").data("value");_data_unescape=Do.objClone(e);Do.unescapeArrayHTML(_data_unescape.box_condition.contexts);Do.unescapeArrayHTML(_data_unescape.box_condition.projects);Do.unescapeArrayHTML(_data_unescape.box_condition.tags);_data_unescape.name=Do.unescapeHTML(_data_unescape.name);$.ajax.update_user_boxes({data:_data_unescape,onSuccess:function(){if(_data_unescape.hidden==true){var f=$.inArray(e.type,["next","tomorrow","someday","scheduled"])>-1?$("div#sidebar li#"+_data_unescape.type):Do.id(_data_unescape.id);f.addClass("hidden")}}},"")});$("div.box-toolbar .btn-cancel").trigger("click");return false})};$.fn.cancelEditBox=function(){var b=$(this);b.bind("click",function(){$("div.done").hide();$("div.box-toolbar div.edit").show();$("div#sidebar input.box-status").hide();$("div#sidebar span.count").show();$("a#btn_archive_tasks").show();$("a#btn_empty_trash").show();var c=$("div#sidebar div.more li:not(.sys)");c.each(function(){var e=$(this).data("data");if(e.hidden==true){var f=$.inArray(e.type,["next","tomorrow","someday","scheduled"])>-1?$("div#sidebar li#"+e.type):Do.id(e.id);f.addClass("hidden")}});return false})};$.fn.editSmartBoxDetail=function(){var b=$(this);b.bind("click",function(){GTD.Smartfolder.popup("update",b.parents("li").data("data"));return false})};$.fn.displayEditBox=function(){var b=$(this);b.hover(function(){if($(this).find("input.box-status").is(":hidden")){$(this).find("span.edit-box").show()}},function(){$(this).find("span.edit-box").hide()})};$.fn.toogleBoxDisplay=function(){var b=$(this);b.bind("click",function(c){if($(this).data("value")==false){$(this).data("value",true);$(this).attr("checked",false)}else{$(this).data("value",false);$(this).attr("checked",true)}c.stopPropagation()})};function a(){var b=$("div#sidebar div.more ul");$.each(Doit.boxes,function(e,c){if($.inArray(c.type,["inbox","today","trash","completed"])<0){switch(c.type){case"waiting":var f=$('<li id="waiting" class="sys"><a class="side-item" href="#/time/waiting"><input class="box-status" type="checkbox" checked="checked" disabled="disabled" /><span class="tit waiting">'+L.WAITING+"</span></a></li>");f.droppable({accept:".task",hoverClass:"box-state-highlight",tolerance:"pointer",drop:function(h,g){if($(g.draggable).hasClass("s")){$("#task_container li.s").each(function(){GTD.moveTask($(this),$(h.target))})}else{GTD.moveTask($(g.draggable),$(h.target))}}});break;case"next":case"tomorrow":case"someday":case"scheduled":var f=c.hidden==false?$('<li id="'+c.type+'"><a class="side-item" href="#/time/'+c.type+'"><span class="edit-box"></span><input class="box-status" type="checkbox" checked="checked" /><span class="tit '+c.type+'">'+L[c.type.toUpperCase()]+"</span></a></li>"):$('<li id="'+c.type+'" class="hidden"><a class="side-item" href="#/time/'+c.type+'"><span class="edit-box"></span><input class="box-status" type="checkbox" /><span class="tit '+c.type+'">'+L[c.type.toUpperCase()]+"</span></a></li>");f.droppable({accept:".task",hoverClass:"box-state-highlight",tolerance:"pointer",drop:function(h,g){if($(h.target).attr("id")=="scheduled"&&$(g.draggable).hasClass("s")){GTD.moveTask($("#task_container li.s"),$(h.target));return false}if($(g.draggable).hasClass("s")){$("#task_container li.s").each(function(){GTD.moveTask($(this),$(h.target))})}else{GTD.moveTask($(g.draggable),$(h.target))}}});break;case"next":case"doitnow":case"nocontext":case"noproject":case"contacts":case"projects":var f=$('<li style="display:none"></li>');break;default:var f=c.hidden==false?$('<li id="'+c.id+'" class="smart-box"><a class="side-item" href="#/time/'+c.id+'"><span class="edit-box" title="'+L.EDIT_SMART_BOX+'"></span><input class="box-status" type="checkbox" checked="checked" /><span class="tit smart">'+c.name+"</span></a></li>"):$('<li id="'+c.id+'" class="hidden"><span class="edit-box"></span><input class="box-status" type="checkbox" /><span class="tit smart">'+c.name+"</span></li>");f.displayEditBox()}f.data("data",c);f.find("input.box-status").toogleBoxDisplay();f.find("span.edit-box").editSmartBoxDetail();b.append(f)}else{$("div#sidebar li#"+c.type).data("data",c)}});$("div#sidebar div.more").append(b)}return{init:function(){a();$("div#sidebar .box-toolbar .smartfolder-add").newSmartBox();$("div.box-toolbar .edit .btn-edit").editBox();$("div.box-toolbar .btn-cancel").cancelEditBox();$("div.box-toolbar .btn-save").savBoxStatus()},saveSmartBox:function(c){Do.log("更新到左栏的自定义箱子数据↓");Do.log(c);if(Do.id(c.id).length==0){var b=$("div#sidebar div.more ul");var g=$('<li id="'+c.id+'" class="smart-box"><a class="side-item" href="#/time/'+c.id+'"><span class="edit-box" title="'+L.EDIT_SMART_BOX+'"></span><input class="box-status" type="checkbox" checked="checked" /><span class="tit smart">'+c.name+"</span></a></li>");g.data("data",c);g.find("input.box-status").toogleBoxDisplay();g.displayEditBox();g.find("span.edit-box").editSmartBoxDetail();b.append(g)}else{var e=Do.id(c.id);if(c.deleted==null){var f=e.find("input.box-status");if(c.hidden==false){f.attr("checked",true);f.data("value",false)}else{f.attr("checked",false);f.data("value",true)}e.find("span.tit").html(c.name);e.data("data",c)}else{e.remove()}}}}}()};GTD.init_context_data=function(){Doit.currentBox="context";Doit.currentGroupBy="group_none";$.ajax.context_resources({onSuccess:function(b){var a=Do.parseJSON(b.responseText);TASKS=a.resources.tasks;Doit.contexts=a.resources.contexts;Doit.tags=a.resources.tags;Doit.boxes=a.resources.boxes;Doit.projects=a.resources.projects;Doit.contacts=a.resources.contacts;Doit.messages=a.resources.messages;Doit.inbox_count=a.resources.utils[0].inbox_count;Doit.today_count=a.resources.utils[0].today_count;Doit.allCompletedCount=a.resources.utils[0].all_completed_count;Doit.nextTasksCount=a.resources.utils[0].next_tasks_count;Doit.me=a.resources.utils[0].current_username;Doit.account=a.resources.utils[0].current_account;Doit.nickname=a.resources.utils[0].current_nickname;TASKS_FILTER=TASKS;Doit.maxOrder=TASKS?TASKS.length:0;Doit.settings=a.resources.settings[0];Doit.weekstartday=Doit.settings.week_start;Doit.activated=a.resources.settings[0].status;GTD.notice.init();GTD.Message.showList();GTD.removeFrame();GTD.loadContextFunc();GTD.runContextFunc();GTD.setHeight();GTD.quickAdd.smart()}})};GTD.loadContextFunc=function(){GTD.Context={};$.fn.listContexts=function(){var f=Doit.contexts;var h=$(this);var g=$("<ul></ul>");$.each(Doit.boxes,function(j){var k=Doit.boxes[j];if(k.type=="nocontext"){$("#context_none").data("data",k);return}});$.each(f,function(k){var l=f[k];var j=$('<li uuid="'+l.id+'" class="sub-box"></li>');j.attr("id","s_context_"+encodeURIComponent(l.id)).attr("data-name",l.name).attr("title",Do.unescapeHTML(l.name)).append('<a class="side-item" href="#/context/'+l.id+'" id="'+l.id+'">'+l.name+"</a>");j.data("data",l);g.append(j)});h.append(g.contents());$("#context_list li").ellipsis();$("#context_list li").contextDo();GTD.Context.selection_context_id="none"};$.fn.contextDo=function(){return this.each(function(){var f=$(this);f.contextBox();f.bind("dblclick",function(g){GTD.Context.editContext(f)})})};$.fn.rootContext=function(){return this.each(function(){$(this).contextBox();$(this).bind("click",function(f){})})};$.fn.contextBox=function(){this.bind("click",function(f){$(this).selectContextOnIt()}).not("#context_all").droppable({hoverClass:"box-state-highlight",tolerance:"pointer",drop:function(f,g){if($(g.draggable).hasClass("s")){$("#task_container li.s").each(function(){GTD.moveTask($(this),$(f.target))})}else{GTD.moveTask($(g.draggable),$(f.target))}}})};$.fn.selectContextOnIt=function(){};GTD.Context.selectContextOnIt=function(g){$("div#groupby h3 a").html(L.GROUP_BY_DEFAULT+"<span></span>").attr("rel","default");$("#sidebar li.s").removeClass("s");$(g).addClass("s");var f=$(g).attr("uuid");var h=$(g).attr("data-name");GTD.loadingData("show");switch(h){case"none":GTD.Context.selection_context_id="none";break;case"all":GTD.Context.selection_context_id="all";break;default:GTD.Context.selection_context_id=f;break}f=encodeURIComponent(Do.unescapeHTML(h));$.ajax.listTaskByContext({onSuccess:function(k){Doit.currentBox="context";$.initTaskList();TASKS=Do.parseJSON(k.responseText).entries;TASKS_FILTER=TASKS;Doit.maxOrder=TASKS.length;if(f=="all"){GTD.group.getGroups("context");GTD.quickAdd.hide()}else{var j=$(g).data("data").group_by;GTD.group.showTaskByGroupby(j)}GTD.tags()}},f)};$.fn.addContext=function(){$(this).bind("focus",function(){if($(this).val()==L.NEW_CONTEXT){$(this).val("")}}).bind("blur",function(){if($.trim($(this).val()).length===0){$(this).val(L.NEW_CONTEXT)}});$(this).bind("keyup",function(g){if(g.keyCode==13){var f=$('<li class="sub-box"></li>');a(f,this)}});$(this).bind("keydown",function(f){if(f.keyCode==27){f.preventDefault();$(this).val(L.NEW_CONTEXT)}})};$.fn.delContext=function(){$(this).bind("click",function(h){var g=GTD.Context.selection_context_id;if(g!=null&&g!="none"&&g!="all"){if($("#task_group li:not(.completed)").length){GTD.confirmBox({title:L.DIALOG_TITLE_WARNING,msgTitle:L.DIALOG_WARNING_DELETE_CONTEXT,msgText:"",deleteCallback:f})}else{f()}}});function f(){var g=Do.id("s_context_"+encodeURIComponent(GTD.Context.selection_context_id));var h=g.attr("data-name");var k=g.attr("uuid");var j={deleted:Doit.time,name:Do.unescapeHTML(h),id:k};$.ajax.delContext({data:j,onSuccess:function(m){GTD.removeFromArrayByUUID(GTD.Context.selection_context_id,Doit.contexts);var l=$("#context_list");var n=l.css("background");if(l.get(0).scrollHeight-l.get(0).clientHeight>0){l.css({background:"#fff"});g.fadeOut(function(){l.css({background:n})})}else{g.fadeOut(function(){g.remove()})}GTD.Context.selection_context_id=null;window.location.hash="#/context/all"},onFailure:function(l){}},"")}};function b(){$("#delContextBtn").cantClick();$("#editContextBtn").cantClick()}$.isAllCBox=function(f){return"all"==f};GTD.Context.editContext=function(f){var g=f.attr("data-name");var h=$('<input class="short sideitem-edit-input" type="text" maxlength="30"/>').attr("value",Do.unescapeHTML(f.attr("data-name")));h.blur(function(k){var j=Do.escapeHTML($.trim(this.value));if($.trim(j).length&&g!=j){GTD.Context.updateContext(f,this)}else{c(f,null)}}).bind("keyup",function(k){if(k.keyCode==13){var j=Do.escapeHTML($.trim(this.value));if($.trim(j).length&&g!=j){GTD.Context.updateContext(f,this)}else{c(f,null)}}}).bind("keydown",function(j){if(j.keyCode==27){c(f,null)}});f.empty();f.append(h);h.focus()};function e(g){var h=false;var f=Doit.contexts;$.each(f,function(j){if(f[j].name==g){h=true}});return h}function a(m,l){var n=false;var g=$.trim(l.value);if(!g.length){GTD.M(L.CONTEXT_TIP);return}g=Do.maxText(g,30);var h=Doit.contexts;$.each(h,function(p){if(h[p].name==Do.escapeHTML(g)){n=true}});if(!n){var f=Do.randomUUID();var k=new Do.Base64();var o=k.encode(f);var j={deleted:null,created:Doit.time,name:g,group_by:null,id:o};$.ajax.createContext({data:j,onSuccess:function(q){j.name=Do.escapeHTML(j.name);GTD.addToArray(j,Doit.contexts);$(l).val("");m.attr("uuid",j.id).attr("id","s_context_"+encodeURIComponent(j.id)).attr("data-name",j.name).attr("title",Do.unescapeHTML(j.name)).append('<a class="side-item" href="#/context/'+j.id+'" id="'+j.id+'">'+j.name+"</a>");var p=$("#context_list");if(p.get(0).scrollHeight-p.get(0).clientHeight>0){var r=p.css("background");p.css({background:"#fff"});p.append(m.fadeIn(function(){p.css({background:r})}));p.scrollTop(5000)}else{p.append(m.fadeIn())}m.ellipsis();m.data("data",j);window.location="#/context/"+j.id;m.contextBox();m.bind("dblclick",function(s){GTD.Context.editContext(m)})},onError:function(p){GTD.M(L.AJAX_CONTEXT_ADDING_FAILED,"error")},onFailure:function(p){GTD.M(L.AJAX_CONTEXT_ADDING_FAILED,"error")}})}else{GTD.M(L.CONTEXT_EXIST)}}GTD.Context.updateContext=function(f,g){var h=$.trim(g.value)==""?"New Context":$.trim(g.value);h=Do.maxText(h,30);var k=f.attr("data-name");var j=f.data("data");j.name=h;$.ajax.updateContext({data:j,onSuccess:function(l){f.attr("data-name",Do.escapeHTML(h));var m=Do.escapeHTML($.trim(g.value));GTD.updateArray(m,Doit.contexts,f.attr("data-name"));c(f,null);f.data("data",j);f.trigger("click")},onError:function(l){GTD.M(L.CONTEXT_EXIST,"error");f.find("input").trigger("focus");f.attr("data-name",k)},onFailure:function(l){}},encodeURIComponent(Do.unescapeHTML(k)))};function c(f,h){if(h!=null){GTD.Context.selection_context_id=h.id;f.empty().attr("id","s_context_"+encodeURIComponent(h.id)).attr("data-name",h.name).attr("title",Do.unescapeHTML(h.name)).append('<a class="side-item" href="#/context/'+h.id+'" id="'+h.id+'">'+h.name+"</a>").isContext()}else{var j=f.attr("data-name");var g=f.attr("uuid");GTD.Context.selection_context_id=g;f.empty().attr("title",Do.unescapeHTML(j)).attr("id","s_context_"+encodeURIComponent(g)).html('<a class="side-item" href="#/context/'+g+'" id="'+g+'">'+j+"</a>")}f.ellipsis()}};GTD.init_project_data=function(){Doit.currentBox="project";Doit.currentGroupBy="group_none";$.ajax.project_resources({onSuccess:function(b){var a=Do.parseJSON(b.responseText);TASKS=a.resources.tasks;Doit.contexts=a.resources.contexts;Doit.tags=a.resources.tags;Doit.boxes=a.resources.boxes;Doit.projects=a.resources.projects;Doit.contacts=a.resources.contacts;Doit.messages=a.resources.messages;Doit.inbox_count=a.resources.utils[0].inbox_count;Doit.today_count=a.resources.utils[0].today_count;Doit.allCompletedCount=a.resources.utils[0].all_completed_count;Doit.nextTasksCount=a.resources.utils[0].next_tasks_count;Doit.me=a.resources.utils[0].current_username;Doit.account=a.resources.utils[0].current_account;Doit.nickname=a.resources.utils[0].current_nickname;TASKS_FILTER=TASKS;Doit.maxOrder=TASKS?TASKS.length:0;Doit.settings=a.resources.settings[0];Doit.weekstartday=Doit.settings.week_start;Doit.activated=a.resources.settings[0].status;GTD.notice.init();GTD.Message.showList();GTD.removeFrame();GTD.loadProjectFunc();GTD.runProjectFunc();GTD.setHeight();GTD.quickAdd.smart()}})};GTD.loadProjectFunc=function(){GTD.Project={};$.fn.listProjects=function(){var b=Doit.projects;var e=$(this);var c=$("<ul></ul>");$.each(Doit.boxes,function(f){var g=Doit.boxes[f];if(g.type=="noproject"){$("#project_none").data("data",g)}else{if(g.type=="projects"){$("#project_all").data("data",g)}}});$.each(b,function(h,g){if(g.completed==null){var j=b[h];var f=$('<li uuid="'+j.id+'" class="sub-box"><a class="side-item" href="#/project/'+j.id+'" id="'+j.id+'"><span title="'+L.PROJECT_EDIT+'" class="edit-box"></span></a></li>');f.attr("id","s_project_"+encodeURIComponent(j.id)).attr("data-name",j.name).attr("title",Do.unescapeHTML(j.name));title=$('<span class="title">'+j.name+"</span>");f.find("a").append(title);f.data("data",j);c.append(f)}});e.append(c.contents());$("#project_list li .title").ellipsis();$("#project_list li").projectDo();GTD.Project.selection_project_id="none"};$.fn.projectDo=function(){return this.each(function(){var b=$(this);b.projectBox();b.bind("dblclick",function(c){GTD.Project.editProject(b)});b.hover(function(){b.find(".edit-box").show()},function(){b.find(".edit-box").hide()})})};$.fn.rootProject=function(){return this.each(function(){$(this).projectBox();$(this).bind("click",function(b){})})};$.fn.projectBox=function(){this.bind("click",function(b){$(this).selectOnIt();if($(b.target).hasClass("edit-box")){GTD.Project.editProject($(this));return false}}).not("#project_all").droppable({hoverClass:"box-state-highlight",tolerance:"pointer",drop:function(b,c){if($(c.draggable).hasClass("s")){$("#task_container li.s").each(function(){GTD.moveTask($(this),$(b.target))})}else{GTD.moveTask($(c.draggable),$(b.target))}}})};$.fn.selectOnIt=function(b){};GTD.Project.projectInfo=function(h){$("#project_info").remove();var e=$(h).data("data");var j=e.name;var g=e.notes;var f=$('<div id="project_info">                        <h3><span class="project-checkbox" title="'+L.COMPLETE_PROJECT+'"></span><span class="title">'+j+"</span></h3>                    </div>");var b=$('<ul class="detail"></ul>');var c=g==null?"":$('<li class="note"><span class="icon"></span><span class="con">'+Do.escapeHTML(g)+"</span></li>");b.append(c);f.append(b);$("#task_container").prepend(f);f.find(".project-checkbox").comProject()};GTD.Project.selectOnIt=function(e,c){$("div#groupby h3 a").html(L.GROUP_BY_DEFAULT+"<span></span>").attr("rel","default");$("#sidebar li.s").removeClass("s");$(c).addClass("s");var b=$(c).attr("uuid");var f=$(c).attr("data-name");GTD.loadingData("show");switch(f){case"none":GTD.Project.selection_project_id="none";break;case"all":GTD.Project.selection_project_id="all";break;default:GTD.Project.selection_project_id=b;break}b=encodeURIComponent(Do.unescapeHTML(f));$.ajax.listTaskByProject({onSuccess:function(h){Doit.currentBox="project";$.initTaskList();TASKS=Do.parseJSON(h.responseText).entries;TASKS_FILTER=TASKS;Doit.maxOrder=TASKS.length;if(b=="all"){var g=$(c).data("data").group_by;GTD.group.showTaskByGroupby(g);GTD.quickAdd.hide();$("#project_info").remove()}else{if(b!="none"){GTD.Project.projectInfo(c)}else{$("#project_info").remove()}var g=$(c).data("data").group_by;GTD.group.showTaskByGroupby(g)}GTD.tags();if(e){e()}}},b)};$.fn.comProject=function(){return this.each(function(){$(this).click(function(j){var b=$("#project_list li.s");var g=b.attr("uuid");var f=Do.unescapeHTML(b.attr("data-name"));if(g==GTD.Project.selection_project_id){e()}else{GTD.Project.selectOnIt(e,b)}function e(){if(TASKS.length>0){h()}else{c()}}function h(){GTD.confirmBox({title:L.DIALOG_TITLE_WARNING,msgTitle:L.DIALOG_WARNING_COMPLETE_PROJECT,msgText:"",deleteCallback:c,cancelCallback:function(){b.removeClass("completed")}})}function c(){var k={deleted:null,completed:Doit.time,created:Doit.time,id:g,name:f};$.ajax.comProject({data:k,onSuccess:function(l){GTD.removeFromArrayByUUID(g,Doit.projects);b.fadeOut("slow",function(){window.location.hash="#/project/all";b.remove()});Doit.projects=$.grep(Doit.projects,function(o,m){if(o.com_id!=g){return true}})},onFailure:function(l){b.removeClass("completed")}})}return false})})};$.fn.isEditProject=function(){if(GTD.Project.selection_project_id!=null&&!$(this).hasClass("enabled")){$(this).removeClass("disabled").addClass("enabled").bind("click",function(c){var b=Do.id("s_project_"+encodeURIComponent(GTD.Project.selection_project_id));GTD.Project.editProject(b)})}};$.fn.delProject=function(){$(this).bind("click",function(c){if(GTD.Project.selection_project_id!=null&&GTD.Project.selection_project_id!="none"&&GTD.Project.selection_project_id!="all"){if($("#task_group li:not(.completed)").length){GTD.confirmBox({title:L.DIALOG_TITLE_WARNING,msgTitle:L.DIALOG_WARNING_DELETE_PROJECT,msgText:"",hideCancel:true,deleteCallback:function(){}})}else{b()}}});function b(){var c=Do.id("s_project_"+encodeURIComponent(GTD.Project.selection_project_id));var e=c.attr("data-name");var f={deleted:Doit.time,name:Do.unescapeHTML(e)};$.ajax.delProject({data:f,onSuccess:function(g){GTD.removeFromArrayByUUID(GTD.Project.selection_project_id,Doit.projects);var j=$("#project_list");var h=j.css("background");if(j.get(0).scrollHeight-j.get(0).clientHeight>0){j.css({background:"#fff"});c.fadeOut(function(){j.css({background:h})})}else{c.fadeOut(function(){c.remove()})}GTD.Project.selection_project_id=null;window.location.hash="#/project/all"},onFailure:function(g){}},"")}};function a(){$("#delProjectBtn").cantClick();$("#editProjectBtn").cantClick()}$.isAllPBox=function(b){return"all"==b};$.removeProjectArea=function(){$("#task-group").find("div:has(.taskList):not(#groupby-none)").remove();$("#task-group #groupby-none").find(".group-title").remove();Doit.currentGroupBy="group_none"};GTD.Project.editProject=function(b){var c=b.data("data");GTD.Projectform.popup("edit",c,b)}};$.fn.projectForm_clickToEdit=function(){return this.each(function(){$(this).click(function(b){var a=$(this);if(a.hasClass("disabled")){return false}a.find(".meta-input").trigger("focus");b.stopPropagation()})})};$.fn.projectForm_focusToEdit=function(){return this.each(function(){$(this).bind("focus",function(){var b=$(this).closest(".meta");var a=b.find(".meta-default-text");b.addClass("focus").find(".meta-default-text").hide()})})};$.fn.projectForm_blurToNormal=function(){return this.each(function(){var b=$(this).closest(".meta");var a=b.find(".meta-default-text");$(this).unbind("blur").bind("blur",function(){var c=$.trim($(this).val());if(c==""){a.show();$(this).val("")}b.removeClass("focus")})})};$.fn.projectForm_showXorNot=function(){return this.each(function(){var b=$(this);var a=$(this).closest(".meta");b.bind("keyup",function(){var c=$.trim($(this).val());if(a.hasClass("task-title")){if(c!=""){$("#project_form .taskform-btn-save").removeClass("disabled")}else{$("#project_form .taskform-btn-save").addClass("disabled")}}if(a.hasClass("task-title")||$(this).is("textarea")){if(c!=""){a.find(".clear-this").show()}else{a.find(".clear-this").hide()}}})})};$.fn.projectForm_clickX=function(){return this.each(function(){$(this).click(function(b){b.stopPropagation();var a=$(this).closest(".meta");var f=a.find(".meta-wrap");var c=a.find(".meta-input");if(a.hasClass("task-title")){$("#project_form .taskform-btn-save").addClass("disabled");c.val("").trigger("focus")}else{if(a.hasClass("task-notes")){c.val("").trigger("focus").removeAttr("style")}else{c.val("").trigger("focus")}}if(a.find(".token").length<1){$(this).hide()}})})};GTD.Projectform={};GTD.Projectform.save=function(e){$("#project_form .taskform-btn-save").addClass("disabled");var b=GTD.Projectform.getData();var j=e==null?$('<li class="sub-box"><a class="side-item"><span title="'+L.PROJECT_EDIT+'" class="edit-box"></span></a></li>'):e;var k=false;var a=b.name;if(!a.length){GTD.M(L.PROJECT_TIP);return}var c=Doit.projects;$.each(c,function(l){if(c[l].name==Do.escapeHTML(a)){k=true}});if(GTD.Projectform.type=="edit"){k=false}if(!k){var f=b;if(GTD.Projectform.type=="add"){function h(n){n.name=Do.escapeHTML(n.name);GTD.addToArray(n,Doit.projects);j.attr("uuid",n.id).attr("id","s_project_"+encodeURIComponent(n.id)).attr("data-name",n.name).attr("title",Do.unescapeHTML(n.name)).find("a").attr("id",n.id).attr("href","#/project/"+n.id).append('<span class="title">'+n.name+"</span>");var m=$("#project_list");if(m.get(0).scrollHeight-m.get(0).clientHeight>0){var l=m.css("background");m.css({background:"#fff"});m.append(j.fadeIn(function(){m.css({background:l})}));m.scrollTop(5000)}else{m.append(j.fadeIn())}j.find(".title").ellipsis();j.projectDo();window.location="#/project/"+n.id;j.data("data",n);GTD.overlay.remove();$("#project_form").fadeOut("fast",function(){$(this).removeAttr("style")})}$.ajax.createProject({data:f,onSuccess:function(l){h(f)},onError:function(m){var l=Do.parseJSON(m.responseText);if(l.retcode=="E005"){f.id=l.online_data.id;h(f)}},onFailure:function(l){GTD.M(L.AJAX_PROJECT_ADDING_FAILED,"error")}})}else{var g=j.attr("data-name");$.ajax.updateProject({data:f,onSuccess:function(l){var m=Do.escapeHTML(f.name);f.name=m;j.find(".title").html(m);j.attr("data-name",m);GTD.updateArray(m,Doit.projects,j.attr("data-name"));j.data("data",f);j.trigger("click");if(j.hasClass("s")){GTD.Project.projectInfo(j)}GTD.overlay.remove();$("#project_form").fadeOut("fast",function(){$(this).removeAttr("style")})},onError:function(l){GTD.M(L.PROJECT_EXIST,"error");j.attr("data-name",g)},onFailure:function(l){alert("onFailure")}})}}else{GTD.M(L.PROJECT_EXIST)}};GTD.Projectform.getData=function(){if(GTD.Projectform.type=="add"){var b=Do.randomUUID();var e=new Do.Base64();var c=e.encode(b);GTD.Projectform.data={deleted:null,completed:null,notes:null,created:Doit.time,name:"New project",id:c,group_by:"box"}}var f=$.trim($("#project_form .task-title .meta-input").val());if(f!=""){GTD.Projectform.data.name=f}var a=$.trim($("#project_form .task-notes .meta-input").val());if(a!=""){GTD.Projectform.data.notes=a}else{GTD.Projectform.data.notes=null}return GTD.Projectform.data};GTD.Projectform.event=function(a){$("#project_form .meta").projectForm_clickToEdit();$("#project_form .meta .meta-input,#taskform .meta textarea").projectForm_focusToEdit().projectForm_blurToNormal().projectForm_showXorNot();$("#project_form .meta .clear-this").projectForm_clickX();$("#project_form .taskform-btn-cancel").bind("click",function(){window.onbeforeunload=null;GTD.overlay.remove();$("#project_form").fadeOut("fast",function(){$(this).removeAttr("style")});$("#project_form").unbind(".escCancel")});$("#project_form .taskform-btn-save").bind("click",function(){window.onbeforeunload=null;if($(this).hasClass("disabled")){return false}GTD.Projectform.save(a);$("#project_form").unbind(".escCancel")})};GTD.Projectform.init=function(b){switch(b){case"add":break;case"edit":$("#project_form .taskform-title").text(L.PROJECT_EDIT);break;default:break}var a=$("#project_form");GTD.overlay.add(0);a.show();a.animate({opacity:1,top:"+=50"},500,function(){$("#project_form .task-title").trigger("click")})};GTD.Projectform.setData=function(b){Do.log("当前编辑的项目数据↓");Do.log(b);$("#project_form .taskform-btn-save").removeClass("disabled");var c=Do.unescapeHTML(b.name);$("#project_form .task-title .meta-default-text").hide();$("#project_form .task-title .clear-this").show();$("#project_form .task-title .meta-input").val(c);var a=b.notes;if(a!=null){a=Do.unescapeHTML(a);$("#project_form .task-notes .meta-default-text").hide();$("#project_form .task-notes .clear-this").show();$("#project_form .task-notes .meta-input").val(a);$("#project_form .task-notes .textarea-tmp").html(a.replace(/\n/gi,"<br />"))}};GTD.Projectform.popup=function(a,c,b){window.onbeforeunload=function(){return"Want to leave this page?"};GTD.syncTime();GTD.Projectform.type=a;$("#project_form").html("").append(GTD.Projectform.node);GTD.Projectform.event(b);GTD.Projectform.init(a);GTD.Projectform.data=c;if(a!="add"){GTD.Projectform.setData(c)}$(document).bind("keydown.escCancel",function(g){var f=g.keyCode;if(f==27){var h=true;if($(".popup:visible").length||$(".autocomplete:visible").length||$(".task-deadline .popup").css("display")=="block"){h=false}if(h){$("#project_form .taskform-btn-cancel").trigger("click");$("#project_form :focus").trigger("blur");$(document).unbind("keydown.escCancel");$(document).unbind("keydown.save")}else{$("#project_form :focus").trigger("blur");$(".popup,.autocomplete").hide()}}});$(document).bind("keydown.save",function(g){var f=g.keyCode;if((g.ctrlKey||g.metaKey)&&f==13){$("#project_form .taskform-btn-save").trigger("click");$(document).unbind("keydown.save")}});$("#project_form .task-title").bind("keydown",function(g){var f=g.keyCode;if(f==13){$("#project_form .taskform-btn-save").trigger("click");$("input:focus").trigger("blur");return false}})};GTD.init_contact_data=function(){Doit.currentBox="contact";Doit.currentGroupBy="group_none";$.ajax.contact_resources({onSuccess:function(b){var a=Do.parseJSON(b.responseText);TASKS=a.resources.tasks;Doit.contexts=a.resources.contexts;Doit.tags=a.resources.tags;Doit.projects=a.resources.projects;Doit.contacts=a.resources.contacts;Doit.messages=a.resources.messages;Doit.inbox_count=a.resources.utils[0].inbox_count;Doit.today_count=a.resources.utils[0].today_count;Doit.allCompletedCount=a.resources.utils[0].all_completed_count;Doit.nextTasksCount=a.resources.utils[0].next_tasks_count;Doit.me=a.resources.utils[0].current_username;Doit.account=a.resources.utils[0].current_account;Doit.nickname=a.resources.utils[0].current_nickname;TASKS_FILTER=TASKS;Doit.maxOrder=TASKS?TASKS.length:0;Doit.settings=a.resources.settings[0];Doit.weekstartday=Doit.settings.week_start;Doit.activated=a.resources.settings[0].status;GTD.notice.init();Doit.contactGroups=a.resources.groups;GTD.setHeight();GTD.removeFrame();GTD.loadContactFunc();GTD.runContactFunc()}})};GTD.loadContactFunc=function(){GTD.Contact={};Do.bindPlaceholder($("#contact_mail"));$.fn.addContactPop=function(){var m=$(this);var l=$("div#add_contact_pop");m.bind("click",function(){if(l.is(":visible")){$("span.btn-close").trigger("click")}else{l.slideDown()}});$("span.btn-close").bind("click",function(){l.slideUp()});$("span.btn-add").addContact();$("input#contact_mail").bind("keyup",function(n){if(n.keyCode==13){$("span.btn-add").trigger("click")}else{if(n.keyCode==27){$("div#contact_add").trigger("click")}}})};function e(l){return/^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/.test($.trim(l))}function c(){if(!e($("input#contact_mail").val())){$("span.btn-add").addContact();GTD.M(L.E_USERNAME_INVALID);return false}Doit.RestContact="/v1/contacts";var l={};if((GTD.Contact.selection_contact_group_id&&GTD.Contact.selection_contact_group_id=="all")||!GTD.Contact.selection_contact_group_id){l={email:$.trim($("div#add_contact_pop input#contact_mail").val())}}else{l={email:$.trim($("div#add_contact_pop input#contact_mail").val()),groups:[GTD.Contact.selection_contact_group_id]}}l.name=$.trim($("div#add_contact_pop input#contact_mail").val());l.birthday=null;l.notes="";l.phone=null;$.ajax.createContact({data:l,onSuccess:function(n){$("input#contact_mail").val("");$("div#add_contact_pop span.btn-close").trigger("click");var m=$("div#contact_view h3.s");if(m.length!=0){m.removeClass("s");var o=$('<li class="waiting s">'+l.email+"</li>");o.hide();m.siblings("ul.contact-list").prepend(o);m.siblings("ul.contact-list").show();o.data("contact",l);o.contactOperation();o.fadeIn()}$("span.btn-add").addContact();GTD.M(L.ADD_CONTACT);f()},onError:function(n){var m=Do.parseJSON(n.responseText);switch(m.retcode){case"E041":GTD.M(L.ADD_CONTACT,"error");break;case"E042":GTD.M(L.UNABLE_ADD_SELF,"error");break;case"E046":GTD.M(L.ALREADY_BEEN_CONTACT,"error");break;default:}$("span.btn-add").addContact()},onFailure:function(m){$("span.btn-add").addContact()}},"invite")}$.fn.addContact=function(){var l=$(this);l.one("click",function(){if($.trim($("input#contact_mail").val())===""){l.addContact();return false}c()})};function a(n){var l=n.data("email");if(n===null){alert("请选择!");return false}var m={deleted:true,email:l};Doit.RestContact="/v1/contacts";$.ajax.delContact({data:m,onSuccess:function(o){GTD.Contact.selection_contact_id=null;n.fadeOut(function(){n.remove()});f();GTD.M(L.DELETE_CONTACT_SUCCESS)},onFailure:function(o){}},"")}function j(n){var l=Do.unescapeHTML(n.data("name"));if(n===null){alert(L.CONTACT_CHOOSE_GROUP);return false}var m={deleted:Doit.time,name:l};$.ajax.delContactGroup({data:m,onSuccess:function(o){GTD.removeFromArray(GTD.Contact.selection_contact_group_id,Doit.contactGroups);n.parent(".mod").fadeOut(function(){n.parent(".mod").remove()});GTD.Contact.selection_contact_group_id=null;f();b()},onFailure:function(o){}},"")}$.fn.deleteOperation=function(){var l=$(this);l.bind("click",function(){if($("div#contact_view div.bd .s").length===0){GTD.M(L.CONTACT_CHOOSE_GROUP);return false}var m=$("div#contact_view .s");if(m.is("h3")){if(m.data("name")==="all"){return false}GTD.confirmBox({appendTo:"#confirm_dialog_empty_trash",position:{x:"-185px",y:"0"},title:L.DIALOG_TITLE_WARNING,msgTitle:L.i_contact_del_group,msgText:L.OPERATION_IS_PERMANNENT,image:"exclamation",modal:true,deleteCallback:function(){j(m)}})}else{if(m.is("li")){if(m.parents("li")[0].id=="contact_all"){GTD.confirmBox({appendTo:"#confirm_dialog_empty_trash",position:{x:"-185px",y:"0"},title:L.DIALOG_TITLE_WARNING,msgTitle:L.i_contact_del_contact,msgText:L.OPERATION_IS_PERMANNENT,image:"exclamation",modal:true,deleteCallback:function(){a(m)}})}else{var n=m.text();var o=m.parents("li").find("h3").text();$.ajax.delSingleContact({onSuccess:function(p){GTD.Contact.selection_contact_id=null;m.fadeOut(function(){m.remove()});f();GTD.M(L.DELETE_CONTACT_FROM_GROUP_SUCCESS)},onFailure:function(p){}},o+"/contacts/"+n)}}}})};$.fn.addContactGroup=function(){var l=$(this);l.focus(function(){l.data("tip",l.val()).val("")}).blur(function(){l.val(l.data("tip"))});l.bind("keyup",function(m){if(m.keyCode==13){if(l.val()===""){l.blur();GTD.M(L.INPUT_NEW_CONTACT_GROUP_NAME);return false}GTD.creatNewContactGroup(l)}else{if(m.keyCode==27){l.blur()}}})};function b(){$.ajax.listContactGroup({onSuccess:function(m){var l=Do.parseJSON(m.responseText).entries;Doit.contactGroups=l},onFailure:function(l){}})}function f(){$.ajax.listContact({onSuccess:function(m){var l=Do.parseJSON(m.responseText).entries;Doit.contacts=l}})}GTD.creatNewContactGroup=function(l){var o=false;var m=$.trim(l.val())===""?L.i_contact_newgroup:$.trim(l.val());var p=Doit.contactGroups;$.each(p,function(r,q){if(q.name===Do.escapeHTML(m)||m===L.ALL_CONTACT_GROUP){o=true;GTD.M(L.CONTACT_GROUP_EXIST);return false}});if(!o){var n={created:Doit.time,deleted:null,name:m};$.ajax.createContactGroup({data:n,onSuccess:function(u){var t=$("div#sidebar div.bd>ul");var q=$("div.bd div.mod").length-1;var s=$('<li id="contact_group_'+q+'" class="mod"></li>');var r=$('<h3 class="contact-title"><span title="'+m+'" class="tit">'+m+'</span></h3><ul class="contact-list"></ul>');s.append(r);s.hide();t.append(s);s.fadeIn();r.data("name",Do.escapeHTML(m));r.find("span.tit").ellipsis();s.find("h3.contact-title").droppable({hoverClass:"box-state-highlight",drop:function(w,v){GTD.moveContactToGroup($(w.target).data("name"),$(v.draggable).data("email"))}});r.toggleContactGroup();r.showContactGroupRelateTask();r.renameContactGroup();$(l).val("");b();t.scrollTop(t[0].scrollHeight);s.effect("highlight",1000);GTD.M(L.CONTACT_GROUP_ADD_SUCCESS)},onFailure:function(q){}})}};function k(q,l){var o=false;var m=$.trim(l.val())===""?L.i_contact_newgroup:$.trim(l.val());var p=Doit.contactGroups;$.each(p,function(s,r){if(r.name===Do.escapeHTML(m)||m===L.ALL_CONTACT_GROUP){o=true;GTD.M(L.CONTACT_GROUP_EXIST);return false}});if(!o){var n=q.data("name");$.each(Doit.contactGroups,function(r,t){if(n==t.name){var s={name:m};$.ajax.updateContactGroup({data:s,onSuccess:function(u){q.find("span.tit").empty().text(m);q.data("name",Do.escapeHTML(m));q.find("span.tit").attr("title",m);b();$.each(Doit.contacts,function(v,w){$.each(w.groups,function(y,x){if(x===n){x=m}})})},onError:function(u){GTD.M(L.CONTACT_GROUP_EXIST,"error")},onFailure:function(u){}},encodeURIComponent(Do.unescapeHTML(n)))}})}q.bind("click")}$.fn.renameContactGroup=function(){var l=$(this);l.bind("dblclick",function(){var m=l.data("name");var n=$('<input type="text" class="short" value="'+m+'" maxlength="30" />');n.click(function(){return false});l.find("span.tit").empty().append(n);n.focus();n.blur(function(){var o=Do.escapeHTML($.trim($(this).val()));if(m!=o){k(l,n)}else{l.find("span.tit").empty().html(m)}});n.bind("keyup",function(p){var o=Do.escapeHTML($.trim($(this).val()));if(p.keyCode===13){if(m!=o){k(l,n)}else{l.find("span.tit").empty().html(m)}}else{if(p.keyCode==27){l.find("span.tit").empty().html(m)}}});return false})};GTD.moveContactToGroup=function(m,n){var l=false;$.each(Doit.contacts,function(p,r){if(r.email==n){var s=r.groups;$.each(s,function(u,t){if(t===m){l=true}});if(!l){Doit.RestContact="/v1/groups/"+Do.unescapeHTML(m);var o=[];o.push(n);var q={contacts:o};$.ajax.addContactToGroup({data:q,onSuccess:function(t){$("div#contact_view h3").removeClass("s");$("div#contact_view h3").each(function(){var u=$(this);if(u.data("name")===m){GTD.Contact.selection_contact_group_id=u.data("name");Doit.RestContact="/v1/contacts/group/"+encodeURIComponent(Do.unescapeHTML(GTD.Contact.selection_contact_group_id));$.ajax.listContact({onSuccess:function(w){w=Do.parseJSON(w.responseText).entries;var v=u.siblings("ul.contact-list");v.empty();$.each(w,function(x,y){var z=y.status==="waiting"?$('<li class="waiting">'+y.name+"</li>"):$("<li>"+y.name+"</li>");if(y.email===n){z.addClass("s")}z.data("email",y.email);z.data("contact",y);z.draggable({cursor:"move",cursorAt:{left:0},appendTo:"body",scroll:false,start:function(){GTD.disableSelection()},helper:function(A){return $("<div>"+Do.escapeHTML($(this).text())+"...</div>").addClass("contact-move")},stop:function(){GTD.enableSelection()}});z.contactOperation();v.append(z)});$("ul.contact-list").slideUp();v.slideDown()},onFailure:function(v){}});$.ajax.listTaskByContact({onSuccess:function(v){TASKS=Do.parseJSON(v.responseText).entries;TASKS_FILTER=TASKS;Doit.maxOrder=TASKS.length;GTD.group.getGroups("contact",n);GTD.loadingData("hide")}},n)}});f()},onFailure:function(t){}},"")}}})};GTD.getContacts=function(l){if(GTD.Contact.selection_contact_group_id!="all"){Doit.RestContact="/v1/contacts/group/"+encodeURIComponent(Do.unescapeHTML(GTD.Contact.selection_contact_group_id))}else{Doit.RestContact="/v1/contacts"}$.ajax.listContact({onSuccess:function(n){n=Do.parseJSON(n.responseText).entries;if(GTD.Contact.selection_contact_group_id=="all"){Doit.contacts=n}if(n.length===0){return false}Doit.contacts=n;var m=l.siblings("ul.contact-list");m.empty();$.each(n,function(p,q){var o=q.name!=""?q.name:q.email;var r=q.status==="waiting"?$('<li class="waiting">'+o+'<span title="'+L.i_contact_form_edit_title+'" class="edit-box"></span></li>'):$("<li>"+o+'<span title="'+L.i_contact_form_edit_title+'" class="edit-box"></span></li>');r.data("email",q.email);r.data("contact",q);r.draggable({cursor:"move",cursorAt:{left:0},appendTo:"body",scroll:false,start:function(){GTD.disableSelection()},helper:function(s){return $("<div>"+Do.escapeHTML($(this).text())+"...</div>").addClass("contact-move")},stop:function(){GTD.enableSelection()}});r.contactOperation();m.append(r)});m.slideDown(function(){})},onFailure:function(m){}})};$.fn.toggleContactGroup=function(){var l=$(this);l.bind("click",function(o){Doit.currentBox="contact";$("ul.contact-list li").removeClass("s");$("div#add_contact_pop span.btn-close").trigger("click");var n=$("h3.contact-title");var m=l.siblings("ul.contact-list");if(m.is(":visible")){$(this).removeClass("s");m.slideUp()}else{n.removeClass("s");$(this).addClass("s");GTD.Contact.selection_contact_group_id=l.data("name");GTD.getContacts(l);$("ul.contact-list").hide();m.slideDown()}return false})};function h(){GTD.loadingData("show");$.ajax.listTaskByContactGroup({onSuccess:function(l){TASKS=Do.parseJSON(l.responseText).entries;TASKS_FILTER=TASKS;Doit.maxOrder=TASKS.length;GTD.group.getGroups("contact");GTD.tags();GTD.loadingData("hide")}})}$.fn.showContactGroupRelateTask=function(){var l=$(this);l.bind("click",function(){GTD.loadingData("show");$.initTaskList();var m=encodeURIComponent(Do.unescapeHTML(l.data("name")));if(m==="all"){$.ajax.listTaskByContact({onSuccess:function(n){TASKS=Do.parseJSON(n.responseText).entries;TASKS_FILTER=TASKS;Doit.maxOrder=TASKS.length;GTD.group.getGroups("contact");GTD.tags();GTD.loadingData("hide")}},m)}else{$.ajax.listTaskByContactGroup({onSuccess:function(n){TASKS=Do.parseJSON(n.responseText).entries;TASKS_FILTER=TASKS;Doit.maxOrder=TASKS.length;GTD.group.getGroups("contact");var o=$("div#tags li.tag-selected-all").hasClass("s")?TASKS:TASKS_FILTER;$.each(o,function(r,p){if(p.forwarded_by!=null&&p.assignment!=null){var w=false,u=false;var t=[];$.each(Doit.contacts,function(v,x){t.push(x.email)});if($.inArray(p.forwarded_by,t)>-1){w=true}$.each(p.assignment.items,function(v,x){if($.inArray(x.contact,t)>-1){u=true}});var q=$("div#groupby_contact_send");var s=$("div#groupby_contact_recieve");if(w&&!u){q.find("ul.taskList li.task").each(function(){var v=$(this);if(v.attr("id")==="task_"+p.id){v.remove()}})}if(u&&!w){s.find("ul.taskList li.task").each(function(){var v=$(this);if(v.attr("id")==="task_"+p.id){v.remove()}})}}});$("div#task_group").find("div.group").each(function(){var p=$(this);if(p.find("ul.taskList li.task").length===0){p.hide()}else{p.show()}});GTD.tags();GTD.loadingData("hide")}},m)}})};$.fn.showContactRelateTask=function(){var l=$(this);l.bind("click",function(){GTD.loadingData("show");$.initTaskList();var m=l.data("email");$.ajax.listTaskByContact({onSuccess:function(n){TASKS=Do.parseJSON(n.responseText).entries;TASKS_FILTER=TASKS;Doit.maxOrder=TASKS.length;GTD.group.getGroups("contact");GTD.loadingData("hide");$.each(TASKS,function(o,p){if(p.forwarded_by!=m){$("div#recieve li#task_"+p.id).remove()}})}},m)})};GTD.initContactGroup=function(){var l=$("#contact_view div.bd>ul");var m=$("#contact_all ul.contact-list");$("#contact_all h3.contact-title").data("name","all");$("#contact_all h3.contact-title").toggleContactGroup();$("#contact_all h3.contact-title").showContactGroupRelateTask();$.each(Doit.contactGroups,function(o,r){var q=$('<li id="contact_group_'+o+'" class="mod"></li>');var p=$('<h3 class="contact-title"><span title="'+r.name+'" class="tit">'+r.name+"</span></h3>");var n=$('<ul class="contact-list"></ul>');p.data("name",r.name);q.append(p).append(n);l.append(q);q.find("span.tit").ellipsis();p.toggleContactGroup();p.renameContactGroup();p.showContactGroupRelateTask();p.droppable({hoverClass:"box-state-highlight",drop:function(t,s){GTD.moveContactToGroup($(t.target).data("name"),$(s.draggable).data("email"))}})});$("#sidebar_add_new_contactG .add-new").addContactGroup()};function g(){var l={};l.name=$("div.tip-box input#edit_contact_name").val()===""?$("div.tip-box input#edit_contact_name").data("old"):$("div.tip-box input#edit_contact_name").val();l.email=$("div.tip-box input#edit_contact_email").val();l.phone=$("div.tip-box input#edit_contact_cell").val();l.notes=$("div.tip-box textarea#edit_contact_memo").val();l.birthday=$("div.tip-box div#years_list div.selected-text").text()+"-"+$("div.tip-box div#months_list div.selected-text").text()+"-"+$("div.tip-box div#days_list div.selected-text").text();$.each(Doit.contacts,function(m,n){if(n.email===l.email){l.groups=n.groups}});return l}$.fn.contactOperation=function(){var l=$(this);l.hover(function(){l.children(".edit-box").show()},function(){l.children(".edit-box").hide()});l.bind("click",function(n){Doit.currentBox="contact";if($(n.target).hasClass("edit-box")){l.trigger("dblclick")}GTD.Contact.selection_contact_id=l.data("email");$("div#contact_view .s").removeClass("s");l.addClass("s");$.initTaskList();var m=l.data("email");$.ajax.listTaskByContact({onSuccess:function(o){TASKS=Do.parseJSON(o.responseText).entries;TASKS_FILTER=TASKS;Doit.maxOrder=TASKS.length;GTD.group.getGroups("contact",m)}},m);return false});l.bind("dblclick",function(){var m=$(this);var n=l.data("contact");var o=n.birthday===null?[1980,1,1]:(n.birthday.split(" ")[0]).split("-");$("div.tip-box input#edit_contact_name").val(Do.unescapeHTML(n.name));$("div.tip-box input#edit_contact_name").data("old",Do.unescapeHTML(n.name));$("div.tip-box input#edit_contact_email").val(n.email);$("div.tip-box input#edit_contact_cell").val(n.phone);$("div.tip-box input#edit_contact_cell").bind("keyup",function(){var t=$(this);var r=t.val();var s=/^[0-9]$/.test(r);if(!s){t.val(t.val().replace(/[^\d]/g,""))}});$("div.tip-box div#years_list div.selected-text").text(o[0]);$("div.tip-box div#months_list div.selected-text").text(o[1]);$("div.tip-box div#days_list div.selected-text").text(o[2]);$("div.tip-box textarea#edit_contact_memo").val(Do.unescapeHTML(n.notes));var p=l.offset().top-45;var q=$("#contact_view div.tip-box").tipBox("left");q.show();$tipwp=q.parent().parent();$tipwp.css({top:p});$tipwp.fadeIn();$("div#edit_contact_cancel").bind("click",function(){$tipwp.fadeOut()});$("div#edit_contact_save").one("click",function(){Doit.RestContact="/v1/contacts";var r=g();$.ajax.updateContact({data:r,onSuccess:function(s){m.text(r.name);$("div#edit_contact_cancel").trigger("click");f();if(r.name!=null&&r.name!=""){r.name=Do.escapeHTML(r.name)}if(r.notes!=null&&r.notes!=""){r.notes=Do.escapeHTML(r.notes)}$("ul.contact-list li.s").data("contact",r);GTD.M(L.UPDATE_CONTACT_SUCCESS)},onFailure:function(s){}},r.email+"/email")});return false})};$.fn.closeContactDetailPop=function(){var l=$(this);l.one("click",function(){$("div.tip-box-wrap-position").fadeOut()})};$.fn.saveContactDetail=function(){var l=$(this);l.one("click",function(){Doit.RestContact="/v1/contacts";var m=g();$.ajax.updateContact({data:m,onSuccess:function(n){$("div#contact_view li.s").text(m.name);$("div#edit_contact_cancel").trigger("click");f()},onFailure:function(n){}},m.email+"/email")})}};GTD.init_archiver_data=function(){Doit.currentBox="archiver";Doit.currentGroupBy="group_none";if(typeof(Doit.time)=="string"){Doit.currentTime=new Date(Doit.time).format("yyyy-mm-dd")}else{Doit.currentTime=Doit.time.format("yyyy-mm-dd")}$.ajax.archive_resources({onSuccess:function(b){var a=Do.parseJSON(b.responseText);TASKS=a.resources.tasks;Doit.contexts=a.resources.contexts;Doit.tags=a.resources.tags;Doit.projects=a.resources.projects;Doit.contacts=a.resources.contacts;Doit.messages=a.resources.messages;Doit.inbox_count=a.resources.utils[0].inbox_count;Doit.today_count=a.resources.utils[0].today_count;Doit.allCompletedCount=a.resources.utils[0].all_completed_count;Doit.nextTasksCount=a.resources.utils[0].next_tasks_count;Doit.me=a.resources.utils[0].current_username;Doit.account=a.resources.utils[0].current_account;Doit.nickname=a.resources.utils[0].current_nickname;TASKS_FILTER=TASKS;Doit.maxOrder=TASKS?TASKS.length:0;Doit.settings=a.resources.settings[0];Doit.weekstartday=Doit.settings.week_start;Doit.activated=a.resources.settings[0].status;GTD.notice.init();GTD.Message.showList();GTD.removeFrame();GTD.loadArchiverFunc();GTD.runArchiverFunc();GTD.setHeight()}})};GTD.loadArchiverFunc=function(){GTD.archiveInit=function(){$("div#task_group").empty();$("div#paper_title ul#group_monthly").hide();$("div#paper_title ul#group_weekly").show();$("div.archiver-tool li.type").attr("id","weekly");$("div.archiver-tool li.type input.text-time").val(GTD.formatThisWeekDate(Doit.currentTime)).attr("rel",Doit.currentTime)};GTD.getArchiveTask=function(b,a){$("div#task_group").empty();$.ajax.getArchiveTask({data:{date:b},onSuccess:function(c){TASKS=Do.parseJSON(c.responseText).entries;TASKS_FILTER=TASKS;Doit.maxOrder=TASKS.length;GTD.EmptyTip();GTD.tags();if(a==="weekly"){GTD.group.getGroups("weekly")}else{GTD.group.getGroups("monthly")}}},a)};GTD.formatThisWeekDate=function(c){var b=new Do.getWeekDate(c);var a=b.getThisWeekDate();startDate=new Date(a[0].replace(/-/g,"/")).format("mediumDate");endDate=new Date(a[1].replace(/-/g,"/")).format("mediumDate");wrapDate=startDate+" - "+endDate;return wrapDate};GTD.formatWeekDate=function(c,e){var b=new Do.getWeekDate(c);if(e=="prev"){var a=b.getPrevWeekDate()}else{var a=b.getNextWeekDate()}startDate=new Date(a[0].replace(/-/g,"/")).format("mediumDate");endDate=new Date(a[1].replace(/-/g,"/")).format("mediumDate");nDate=new Date(a[0].replace(/-/g,"/")).format("yyyy-mm-dd");return[startDate,endDate,nDate]};GTD.getFormatMonth=function(b,c){var a=new Date(b.replace(/-/g,"/"));if(c=="prev"){var e=a.getMonth()-1}else{var e=a.getMonth()+1}var f=new Date(a.getFullYear(),e,1);return[f.format("onlyMonth"),f.format("yyyy-mm-dd")]};$.fn.getAnohterWeek=function(){function b(l,j){var g=GTD.formatWeekDate(l,"prev");var k=g[0];var h=g[1];var f=g[2];j.val(k+" - "+h).attr("rel",f);GTD.getArchiveTask(f,"weekly")}function a(k,h){var f=GTD.formatWeekDate(k,"next");var l=f[0];var j=f[1];var g=f[2];h.val(l+" - "+j).attr("rel",g);GTD.getArchiveTask(g,"weekly")}var c=$(this);var e=$("ul#group_weekly input");c.unbind("click").bind("click",function(){GTD.loadingData("show");var f=e.attr("rel");if($(this).is(".prev")){b(f,e)}else{a(f,e)}})};$.fn.getAnohterMonth=function(){function b(k,h){var j=GTD.getFormatMonth(k,"prev");var g=j[0];var f=j[1];h.val(g).attr("rel",f);GTD.getArchiveTask(f,"monthly")}function a(g,f){var k=GTD.getFormatMonth(g,"next");var j=k[0];var h=k[1];f.val(j).attr("rel",h);GTD.getArchiveTask(h,"monthly")}var c=$(this);var e=$("ul#group_monthly input");c.unbind("click").bind("click",function(){GTD.loadingData("show");var f=e.attr("rel");if($(this).is(".prev")){b(f,e)}else{a(f,e)}})};Do.getWeekDate=function(c){var j=new Date(c.replace(/-/g,"/"));var b=1000*60*60*24;this.getThisWeekDate=g;this.getPrevWeekDate=h;this.getNextWeekDate=e;this.wrapDate=f;this.getDayMillisecond=a;function h(){if(Doit.weekstartday=="Sunday"){var l=new Date(j-(j.getDay()+1)*b)}else{var l=new Date(j-(j.getDay())*b)}var k=new Date((l*1)-6*b);j=k;return[f(k),f(l)]}function e(){if(Doit.weekstartday=="Sunday"){var k=new Date((j*1)+(6-j.getDay()+1)*b)}else{var k=new Date((j*1)+(6-j.getDay()+2)*b)}var l=new Date((k*1)+6*b);j=k;return[f(k),f(l)]}function g(){j=new Date(c.replace(/-/g,"/"));if(Doit.weekstartday=="Sunday"){var k=new Date(j-(j.getDay()-0)*b)}else{var k=new Date(j-(j.getDay()-1)*b)}var l=new Date((k*1)+6*b);return[f(k),f(l)]}function f(n){var k=n.getMonth()+1;k=k<10?"0"+k:k;var l=n.getDate();l=l<10?"0"+l:l;return n.getFullYear()+"-"+k+"-"+l}function a(){return b}};$.fn.toggleArchiverType=function(){var a=$(this);a.bind("click",function(){Doit.currentBox="archiver";GTD.loadingData("show");$.initTaskList();GTD.setHeight();$("ul#archiver_menu li").removeClass("s");$(this).addClass("s");if($(this).is("#weekly")){$("ul#group_monthly").hide();$("ul#group_weekly").show();$("div.archiver-tool li.type").attr("id","weekly");$("div.archiver-tool li.type input.text-time").val(GTD.formatThisWeekDate(Doit.currentTime)).attr("rel",Doit.currentTime);GTD.getArchiveTask(Doit.currentTime,"weekly")}else{$("ul#group_weekly").hide();$("ul#group_monthly").show();$("div.archiver-tool li.type").attr("id","monthly");$("div.archiver-tool li.type input.text-time").val(new Date(Doit.currentTime.replace(/-/g,"/")).format("onlyMonth")).attr("rel",new Date(Doit.currentTime.replace(/-/g,"/")).format("yyyy-mm-dd"));GTD.getArchiveTask(Doit.currentTime,"monthly")}})}};GTD.init_calendar_data=function(){Doit.currentBox="calendar";Doit.currentGroupBy="group_none";$.ajax.calendar_resources({onSuccess:function(b){var a=Do.parseJSON(b.responseText);TASKS=a.resources.tasks;Doit.contexts=a.resources.contexts;Doit.tags=a.resources.tags;Doit.projects=a.resources.projects;Doit.contacts=a.resources.contacts;Doit.messages=a.resources.messages;Doit.inbox_count=a.resources.utils[0].inbox_count;Doit.today_count=a.resources.utils[0].today_count;Doit.allCompletedCount=a.resources.utils[0].all_completed_count;Doit.nextTasksCount=a.resources.utils[0].next_tasks_count;Doit.me=a.resources.utils[0].current_username;Doit.account=a.resources.utils[0].current_account;Doit.nickname=a.resources.utils[0].current_nickname;TASKS_FILTER=TASKS;Doit.maxOrder=TASKS?TASKS.length:0;Doit.settings=a.resources.settings[0];Doit.weekstartday=Doit.settings.week_start;Doit.activated=a.resources.settings[0].status;if(Doit.weekstartday=="Sunday"){$(".calendar .week-str").hide();$(".calendar .sunday-first").show()}else{$(".calendar .week-str").hide();$(".calendar .monday-first").show()}GTD.notice.init();GTD.Message.showList();GTD.setHeight();GTD.removeFrame();GTD.loadCalendarFunc();GTD.runCalendarFunc()}})};GTD.loadCalendarFunc=function(){CA={TASK_BYDAY:{},options:{year:null,month:null,thisyear:null,thismonth:null,thisdate:null,completed:false},getToday:function(){var a;if(typeof(Doit.time)=="string"){a=new Date(Doit.time)}else{a=Doit.time}this.options.year=this.options.thisyear=a.getFullYear();this.options.month=this.options.thismonth=a.getMonth()+1;this.options.thisdate=a.getDate()},getFirstDay:function(b,c){var a=new Date(b,c-1,1);return a.getDay()},getLastDay:function(a,b){var c=new Date(a,b,0);return c.getDay()},getMonthLength:function(b,c){var a=new Date(b,c,0);return a.getDate()},createTable:function(){},resetCaTable:function(b,e){var c=this.getFirstDay(b,e);var h=5;if(Doit.weekstartday=="Sunday"){var a=7-c}else{var a=8-c==8?1:8-c}var g=this.getMonthLength(b,e);var f=g-a;h=Math.ceil(f/7)+1;if(h==6){$(".calendar .grid").html(CA.TABLE);$(".grid").removeClass("five-row").addClass("six-row");h=6}else{$(".calendar .grid").html(CA.TABLE);$(".grid").removeClass("six-row").addClass("five-row");$(".month-row:last").remove()}$("td").css({width:$("div.grid").width()/7});this.changeTodayStyle(b,e);GTD.adjustHeight(h)},makeDaysArray:function(g,e){var k=[],a=this.getFirstDay(g,e),f=this.getMonthLength(g,e);if(Doit.weekstartday=="Sunday"){var l=7-a;var h=a-1}else{var l=8-a==8?1:8-a;var h=a-2==-2?5:a-2}var b=f-l,j=(Math.ceil(b/7)+1)*7;for(var c=h;c>=0;c--){k.push(0)}for(var c=1;c<=f;c++){k.push(c)}for(var c=1;c<=j-f-h-1;c++){k.push(0)}return k},insertDay:function(c,e,h){var g=this.makeDaysArray(c,e);var f=new Date(c,e-1,1);this.resetCaTable(c,e);this.changeMonthText();this.nonMonthStyle();for(i=0;i<g.length;i++){var a=g[i];if(a!=0){$(".calendar .day-num").not(":hidden").eq(i).text(a)}}if(h!=null){var b=setTimeout(function(){h()},500)}},insertTask:function(c,g){var f=this.getFirstDay(c,g);if(Doit.weekstartday=="Monday"){f=f-1==-1?6:f-1}$("td.task").empty();CA.TASK_BYDAY={};var b=$(".task").height();var a=Do.parseInt(b/20);var e=b-20;$.each(TASKS,function(m,r){var j=TASKS[m];CA.taskDayByDay(r,c,g);if(CA.isThisMonthTask(r)!=g){return}var q=CA.mathTaskDay(j);var p="day"+q;if(Doit.weekstartday=="Sunday"){var s=new Date(c,g-1,q).getDay();var t=(q+f-1)/7|0}else{var s=new Date(c,g-1,q).getDay();s=s-1==-1?6:s-1;var t=(q+f-1)/7|0}var k=CA.TASK_BYDAY;var o=k["day"+q].length;var h=$(".month-row:eq("+t+") .data-tb tr:visible:eq(1) .task:eq("+s+")");var n;if(h.find("div.list").length===0){n=$('<div class="list"></div>')}else{n=h.find("div.list")}var l=$('<div class="list-item"></div>');l.attr({id:"task_"+j.id,title:j.title,order:m,tid:j.id,context:j.context,project:j.project,priority:j.priority,tags:j.tags}).html(j.title);n.append(l);l.taskViewPop(j,q);if(o>a){n.find(".more-tasks").remove();n.append('<div class="more-tasks" rel='+q+'><a hef="javascript:void(0)" class="more-task">+more</a></div>')}h.append(n)});$(".more-tasks").css({top:e+"px"});$("div .calendar td div.list div").css({width:$("div.grid").width()/7-20});$(".task div.list div").ellipsis();$(".more-task").bind("click",function(){CA.showMoreMonth($(this).parent().attr("rel"),this);return false});GTD.loadingData("hide")},mathTaskDay:function(b){if(typeof(b.start_at)=="string"){var c=b.start_at.split(" ");var a=c[0].split("-")[2];return parseInt(a,10)}else{var a=b.start_at.getDate();return parseInt(a,10)}},isThisMonthTask:function(a){if(typeof(a.start_at)=="string"){var b=a.start_at.split(" ");var c=b[0].split("-")[1];return c}else{var c=a.start_at.getMonth()+1;return c}},taskDayByDay:function(b,e,f){var h=CA.TASK_BYDAY;var a=this.mathTaskDay(b);var g=this.getMonthLength(e,f);var c=h["day"+a];if(typeof(h["day"+a])=="object"){h["day"+a].push(b)}else{h["day"+a]=[];h["day"+a].push(b)}},updateTaskDayByDay:function(b){var e=CA.TASK_BYDAY;var a=this.mathTaskDay(b);var c=e["day"+a];c=$.grep(c,function(g,f){if(g.id==b.id){return b}else{return g}})},removeTaskDayByDay:function(b){var e=CA.TASK_BYDAY;var a=this.mathTaskDay(b);var c=e["day"+a];e["day"+a]=$.grep(c,function(g,f){if(g.id!=b.id){return g}})},showThisMonth:function(){CA.TASK_BYDAY={};this.getToday();$("#task_todo").trigger("click")},showNextMonth:function(){var b=this.options.year;var e=this.options.month+1;var a=e==13?b+1:b;var f=e==13?1:e;$("div#today").removeClass("disabled");CA.TASK_BYDAY={};$.extend(CA.options,{year:a,month:f});CA.insertDay(a,f);var c=a+"/"+f+"?completed="+CA.options.completed;$.ajax.getCalendarTask({onSuccess:function(g){TASKS=Do.parseJSON(g.responseText).entries;if(a==CA.options.year&&f==CA.options.month){CA.insertTask(a,f)}}},c)},showPrevMonth:function(){var b=this.options.year;var e=this.options.month-1;var a=e==0?b-1:b;var f=e==0?12:e;$("div#today").removeClass("disabled");CA.TASK_BYDAY={};$.extend(CA.options,{year:a,month:f});CA.insertDay(a,f);var c=a+"/"+f+"?completed="+CA.options.completed;$.ajax.getCalendarTask({onSuccess:function(g){TASKS=Do.parseJSON(g.responseText).entries;if(a==CA.options.year&&f==CA.options.month){CA.insertTask(a,f)}}},c)},showMoreMonth:function(h,f){$("div#cal_pop").remove();var e=CA.TASK_BYDAY["day"+h];if($(".task-detail").length==1){$(".task-detail").remove()}var c=new Date(CA.options.year,CA.options.month-1,h);$(".grid").append('<dl class="task-detail"><dt><a href="javascript:void(0)" class="btn-close"></a>'+c.format("calendarMoreTitle")+"</dt></dl>");$.each(e,function(n){var m=e[n];var o=$("<dd></dd>");o.attr({id:"task_"+m.id,title:m.title,order:n,tid:m.id,context:m.context,project:m.project,priority:m.priority,tags:m.tags}).html(m.title);o.taskViewPop(m,h);$(".task-detail").append(o)});$(".task-detail dd").ellipsis();var k=$(f).closest("table.data-tb").find("td").index($(f).closest("td.task"))-7;var l=$("div.month-row").index($(f).closest("div.month-row"));var g=$("div.month-row:first").height()*l;var a=$("div.grid").width();var j=$(f).closest("td.task").width()*k;var b=j+210>a?a-210:j;$(".task-detail").css({top:g,left:b});$(".task-detail .btn-close").bind("click",function(){$(".task-detail").remove();$("div#cal_pop").remove();return false});$("html").bind("keydown.closemore",function(m){if(m.keyCode==$.ui.keyCode.ESCAPE){$(".task-detail").remove();$(this).unbind(".closemore");$("div#cal_pop").remove()}})},rebuildDayTasks:function(b){$(".task-detail").remove();var c=CA.options.year;var f=CA.options.month;var e=this.getFirstDay(c,f);if(Doit.weekstartday=="Monday"){e=e-1==-1?6:e-1}DAY_TASKS=CA.TASK_BYDAY["day"+b];var g=new Date(c,f-1,b).getDay();var a=(b+e-1)/7|0;$(".task div.list div").ellipsis();$(".more-task").bind("click",function(){CA.showMoreMonth($(this).parent().attr("rel"),this);return false});if($("div.calendar div.tit div.disabled").is("#task_todo")){$("#task_todo").trigger("click")}else{$("#task_completed").trigger("click")}},switchTaskTodoOrCompleted:function(e){var a=this.options.year;var c=this.options.month;$("div.btn-control").removeClass("disabled");$(e).addClass("disabled");var b=$(e).is("#task_todo")?a+"/"+c+"?completed=false":a+"/"+c+"?completed=true";CA.options.completed=$(e).is("#task_todo")?false:true;$.ajax.getCalendarTask({onSuccess:function(f){TASKS=Do.parseJSON(f.responseText).entries;CA.insertDay(a,c,function(){CA.insertTask(a,c)})}},b)},changeMonthText:function(){var c=new Date(this.options.year,this.options.month-1,1);$("span#select_month span.date").text(c.format("calendarTitle"));var b=this.options.month>9?this.options.month:"0"+this.options.month;var a=b+" "+this.options.year;$("span#select_month span.date").data("date",a)},changeTodayStyle:function(f,b){var a=this.options.thisyear;var h=this.options.thismonth;var g=this.options.thisdate;var e=(f==a)&&(b==h);if(e){$("#select_today").addClass("disabled");var c=this.getFirstDay(a,h);var k=new Date(a,h-1,g).getDay();if(Doit.weekstartday=="Monday"){c=c-1==-1?6:c-1;k=k-1==-1?6:k-1}var j=(g+c-1)/7|0;$(".month-row:eq("+j+") .data-tb td:visible:eq("+k+")").addClass("today")}},nonMonthStyle:function(){var c=this.getFirstDay(this.options.year,this.options.month);var b=this.getLastDay(this.options.year,this.options.month);if(Doit.weekstartday=="Monday"){c=c==0?6:c-1;b=b==0?7:b-1}for(var a=0;a<c;a++){$(".month-row:eq(0) .bg-tb tr:eq(0) td:eq("+a+")").addClass("td-nonmonth");$(".month-row:eq(0) .data-tb tr:eq(0) td:eq("+a+")").addClass("td-title-nonmonth");$(".month-row:eq(0) .data-tb tr:eq(1) td:eq("+a+")").addClass("td-title-nonmonth");$(".month-row:eq(0) .data-tb tr:eq(2) td:eq("+a+")").addClass("td-task-nonmonth")}for(var a=b+1;a<7;a++){$(".month-row:last .bg-tb tr:eq(0) td:eq("+a+")").addClass("td-nonmonth");$(".month-row:last .data-tb tr:eq(0) td:eq("+a+")").addClass("td-title-nonmonth");$(".month-row:last .data-tb tr:eq(1) td:eq("+a+")").addClass("td-task-nonmonth")}$(".month-row .td-bg:not(.td-nonmonth), .day:visible:not(.td-title-nonmonth), .task:not(.td-task-nonmonth)").addCalendarTask()},init:function(a){$("#select_month .prev").click(function(){CA.showPrevMonth()});$("#select_month .next").click(function(){CA.showNextMonth()});$("#task_todo, #task_completed").bind("click",function(){CA.switchTaskTodoOrCompleted(this)});this.showThisMonth();$("div#today").addClass("disabled");$("div#today").click(function(){if($(this).hasClass("disabled")){return false}else{$(this).addClass("disabled");var b=CA.options.thisyear+"/"+CA.options.thismonth+"?completed="+CA.options.completed;$.ajax.getCalendarTask({onSuccess:function(c){TASKS=Do.parseJSON(c.responseText).entries;CA.showThisMonth()}},b)}})}};$.fn.addCalendarTask=function(){var a=$(this);a.bind("dblclick",function(j){var h=-1;if($(".td-bg:not(.td-nonmonth)").index($(j.target))!=-1){h=$(".td-bg:not(.td-nonmonth)").index($(j.target))}if($(".data-tb .day:not(.td-title-nonmonth)").index($(j.target))!=-1){h=$(".data-tb .day:visible:not(.td-title-nonmonth)").index($(j.target))}if($(".task:not(.td-task-nonmonth)").index($(j.target))!=-1){h=$(".task:not(.td-task-nonmonth)").index($(j.target))}if($(j.target).is("div.more-tasks")){h=$(".task:not(.td-task-nonmonth)").index($(j.target).parent(".task"))}var f=$("span#select_month span").data("date");if(Do.parseInt(h)+1<10){h="0"+(Do.parseInt(h)+1)}else{h+=1}var f=f.substring(3,7)+"-"+f.substring(0,2)+"-"+h;CA.start_at=f;GTD.Taskform.popup("add");$("div#taskform input#task_start_at").val(f);var n=f.replace("-","");var c=new Date();var l=c.getFullYear();var k=c.getMonth()+1;var m=c.getDate();var g=l+""+k+""+m;if(h<=m||Do.parseInt(n)<Do.parseInt(g)){var b=$("div#collection_box div.selected-text");b.attr("data-id","today");b.html($("div#collection_box li").eq(1).text())}if(h==Do.parseInt(m)+1){var b=$("div#collection_box div.selected-text");b.attr("data-id","tomorrow");b.html($("div#collection_box li").eq(2).text())}if("calendar"==Doit.currentBox){GTD.Taskform.setDataByDatepicker(null,$("#task_start_at").val(),$("#task_start_at"))}})};$.fn.calCompleteTask=function(a,c){var f=$(this);var g=$("div#cal_pop").data("task").id;var e=$("div#cal_pop").data("task").rep_no;var b=GTD.getTaskDataById(g,e);f.bind("click",function(){if($(this).parent("h3").hasClass("completed")){$(this).parent("h3").removeClass("completed");b.completed=null}else{$(this).parent("h3").addClass("completed");b.completed=Doit.time}b=GTD.taskUnescapeHTML(b);$.ajax.updateTask({data:b,onSuccess:function(h){b=GTD.taskEscapeHTML(b);GTD.updateTaskArray(b);CA.rebuildDayTasks(c)},onFailure:function(h){}},"");return false})};$.fn.calDeleteTask=function(b,a){var c=$(this);c.bind("click",function(){b.trashed=Doit.time;b=GTD.taskUnescapeHTML(b);$.ajax.updateTask({data:b,onSuccess:function(e){GTD.removeTaskFromArray(b);$("div#cal_pop").remove();CA.rebuildDayTasks(a)},onFailure:function(e){}},"");return false})};$.fn.calEditTask=function(b,a){var c=$(this);c.bind("click",function(){var e=GTD.isWaitingOthers(b);var f=GTD.isWaitingMe(b);if(e){GTD.Taskform.popup("sent",b)}else{if(f){GTD.Taskform.popup("received",b)}else{GTD.Taskform.popup("edit",b)}}return false})};GTD.calTaskOperate=function(){var e=$("div#cal_pop").data("task").id;var c=$("div#cal_pop").data("task").rep_no;var b=$("div#cal_pop").data("task").day;var a=GTD.getTaskDataById(e,c);$("span.task-checkbox").calCompleteTask(a,b);$("ul.btn li.del").calDeleteTask(a,b);$("ul.btn li.edit").calEditTask(a,b)};$.fn.taskViewPop=function(b,a){var c=$(this);c.bind("click",function(Y){$("div#cal_pop").remove();var s=$('<div id="cal_pop"><span class="icon-triangel"></span><div class="in"><div class="bd"></div></div></div>');s.data("task",{id:b.id,rep_no:b.repeat_no,day:a});if(b.completed!=null){var u=$('				<ul class="btn">					<li class="close">'+L.CLOSE+'</li>					<li class="del">'+L.DELETE+"</li>				</ul>")}else{var u=$('				<ul class="btn">					<li class="close">'+L.CLOSE+'</li>					<li class="edit">'+L.EDIT+'</li>					<li class="del">'+L.DELETE+"</li>				</ul>")}s.find(".in").append(u);$(".grid").append(s);var M=b.completed===null?$('<div class="calendar-task-view"><h3><span class="task-checkbox"></span><span class="task-title">'+b.title+"</span></h3></div>"):$('<div class="calendar-task-view"><h3 class="completed"><span class="task-checkbox"></span><span class="task-title">'+b.title+"</span></h3></div>");s.find(".bd").append(M);s.hide();var g=$('<ul class="detail"></ul>');M.append(g);var r=b.notes===""?"":b.notes;if(b.notes!=""){var y=$('<li class="note" title="'+r+'"><span class="icon"></span><span class="con">'+r+"</span></li>")}g.append(y);var S="";if(b.start_at!=null){S=Time.strToDatetimeStr(b.start_at);var Q=b.all_day?S.split(" ")[0]:S;S=Q.replace(/-/g,"/");if(b.end_at!=null){var O=Time.strToDatetimeStr(b.end_at);var P=b.all_day?O.split(" ")[0]:O;O=P.replace(/-/g,"/");S+=" - "+O}}else{S=($.inArray(Doit.currentBox,["project","context","calendar"])>-1)?"inbox":Doit.currentBox;if(S=="waiting"){S=L.REPEAT_WAITING_FOR}else{if(S==="contact"){S=L.REPEAT_WAITING_FOR}else{S=L[S.toUpperCase()]}}if(b.end_at!=null){var O=Time.strToDatetimeStr(b.end_at);var P=b.all_day?O.split(" ")[0]:O;O=P.replace(/-/g,"/");if(b.all_day){S+=L.TIME_END_ON+O}else{S+=L.TIME_END_AT+O}}}var Z=$('<li class="time"><span class="icon">'+L.TIME+'</span><span class="con">'+S+"</span></li>");g.append(Z);var aa=b.context!==null?b.context:"";if(aa!==""){var K=$('<li class="context"><span class="icon">'+L.TF_CONTEXT+':</span><span class="con">'+aa+"</span></li>");g.append(K)}var f=b.project!==null?b.project:"";if(f!==""){var W=$('<li class="project"><span class="icon">'+L.TF_PROJECT+':</span><span class="con">'+f+"</span></li>");g.append(W)}var p="";var k="";switch(b.priority){case 1:p=L.TASK_PRI1;k="p1";break;case 2:p=L.TASK_PRI2;k="p2";break;case 3:p=L.TASK_PRI3;k="p3";break;default:p="";k="p0"}if(p!=""){var H=$('<li class="priority"><span class="icon '+k+'">'+L.TF_PRIORITY+'</span><span class="con">'+p+"</span></li>");g.append(H)}var h="";var v=$('<li class="reminders"><span class="icon">'+L.TF_REMINDER+":</span></li>");var U=b.reminders.length;for(var X=0;X<U;X++){var h="";if(!b.reminders[X].sent){h=L.AHEAD_CN;if(typeof(b.reminders[X].time)=="object"){b.reminders[X].time=b.reminders[X].time.format("yyyy-mm-dd HH:MM")}if(typeof(b.start_at)=="object"){b.start_at=b.start_at.format("yyyy-mm-dd HH:MM")}var J=GTD.remindMathBack(b.reminders[X].time.replace(/-/g,"/"),b.start_at.replace(/-/g,"/"));h+=(J.time+""+J.unit);switch(b.reminders[X].mode){case"email":h+=L.EMAIL;break;default:h+=L.POPUP}}else{h=L.ALREADY;switch(b.reminders[X].mode){case"email":h+=L.EMAIL;break;default:h+=L.POPUP}h+=L.ALREADY_REMINDED}h=$('<span class="reminder con">'+h+"</span>");v.append(h)}g.append(v);var D=$('<li class="repeat"><span class="icon">'+L.REPEAT+"</span></li>");if(b.repeater!=null){var A=GTD.getRepeatStr(b.repeater,b.start_at);var z=$('<span class="con">'+A+"</span>");D.append(z)}g.append(D);var F=$('<li class="tags"><span class="icon">'+L.TF_TAG+":</span></li>");var T=b.tags.length;for(var X=0;X<T;X++){var B=$('<span class="tag">'+b.tags[X]+"</span>");F.append(B)}g.append(F);var E="";var x=$('<li class="forward"><span class="icon">'+L.i_message_forwarded_by_an+"</span></li>");if(b.forwarded_by!=null){var R=GTD.find_contact_name_by_user_email(b.forwarded_by);var o=R==undefined?L.CONTACT_DELETED:R;E+=o+" -> "+L.MYSELF;if(b.assignment!=null){var U=b.assignment.items.length;var V=GTD.find_contact_name_by_user_email(b.assignment.items[0].contact)===null?b.assignment.items[0].contact:GTD.find_contact_name_by_user_email(b.assignment.items[0].contact);var q=V==undefined?L.CONTACT_DELETED:V;if(U===1){E+=" -> "+q}else{for(var X=1;X<U;X++){var G=GTD.find_contact_name_by_user_email(b.assignment.items[X].contact)===null?b.assignment.items[X].contact:GTD.find_contact_name_by_user_email(b.assignment.items[X].contact);var n=G==undefined?L.CONTACT_DELETED:G;q+=", "+n}E+=" -> "+q}}}else{if(b.assignment!=null){var U=b.assignment.items.length;var V=GTD.find_contact_name_by_user_email(b.assignment.items[0].contact)===null?b.assignment.items[0].contact:GTD.find_contact_name_by_user_email(b.assignment.items[0].contact);var q=V==undefined?L.CONTACT_DELETED:V;if(U===1){E+=L.MYSELF+" -> "+q}else{for(var X=1;X<U;X++){var G=GTD.find_contact_name_by_user_email(b.assignment.items[X].contact)===null?b.assignment.items[X].contact:GTD.find_contact_name_by_user_email(b.assignment.items[X].contact);var n=G==undefined?L.CONTACT_DELETED:G;q+=", "+n}E+=L.MYSELF+" -> "+q}}}if(E!==""){var z=$('<span class="con">'+E+"</span>");x.append(z);g.append(x)}g.children("li").each(function(e,l){if($(l).find("span.con").length===0){$(l).hide()}else{$(l).show()}});var j=$(this).offset().top-213;var U=$(this).offset().left;var I=s.width();var C=$(document).width();if(U+I>C){var N=C-U-58;s.css({top:j,right:N});s.find("span.icon-triangel").addClass("right");s.find("div.in").addClass("right")}else{s.css({top:j,left:U})}$("html").animate({scrollTop:j},1500);s.show();s.find("ul.btn li.close").bind("click",function(){s.remove()});GTD.calTaskOperate();return false})};GTD.adjustHeight=function(f){var b=$(window).height()-231;var c=b/f;var a=c>=76.8?c:76.8;$("div.month-row").css({height:a});$("table.data-tb").css({top:-a});$("div.grid").data("row",f);$("td").css({width:$("div.grid").width()/7});$("div .calendar td div.list div").css({width:$("div.grid").width()/7-20});$("div .calendar td div.list div:not(.more-tasks)").each(function(){$(this).text($(this).attr("title"))});$(".task div.list div").ellipsis();var e=$(".task").height();$(".task").each(function(){var j=$(".task").index($(this));var h=$(".day").eq(j).find("span").text();var g=$(this).find(".list-item").length;var k=g*20;if(k>e){$(this).find(".more-tasks").remove();$(this).find(".list").append('<div class="more-tasks" rel='+h+'><a hef="javascript:void(0)" class="more-task">+more</a></div>')}else{$(this).find(".more-tasks").remove()}});$(".more-tasks").css({top:e-20+"px"})}};GTD.init_setting_data=function(){GTD.loadSettingFunc();$("#preferences_setting_title").trigger("click")};GTD.loadSettingFunc=function(){GTD.setting=new Object();$("#current_password_text+span").hide();$("#new_password_text+span").hide();$("#confirm_password_text+span").hide();$("#all_error_message").hide();function c(){day_div=$('<ul id="day-dropdown-box" class="dropdown-box"></ul>');for(var m=1;m<=31;m++){var n=$('<li id="day-'+l(m)+'">'+l(m)+"</li>");n.attr("value",m<7?0:(18*(m-6)));day_div.append(n);day_div.appendTo($("#settings_days_list"))}}function g(){month_div=$('<ul id="month-dropdown-box" class="dropdown-box"></ul>');for(var n=1;n<13;n++){var m=$('<li id="month-'+l(n)+'">'+l(n)+"</li>");month_div.append(m);month_div.appendTo($("#settings_months_list"))}}function h(){year_div=$('<ul id="year-dropdown-box" class="dropdown-box"></ul>');for(var n=1900;n<2010;n++){var m=$('<li id="year-'+n+'">'+n+"</li>");m.attr("value",n<1907?0:(18*(n-1906)));year_div.append(m);year_div.appendTo($("#settings_years_list"))}}function l(m){return m<10?("0"+m):m}c();g();h();$("#tag_select_all").click(function(){$("#checkbox_wrap input").each(function(){$(this).attr("checked",true)})});$("#tag_select_op").click(function(){$("#checkbox_wrap input").each(function(){$(this).attr("checked",!$(this).attr("checked"))})});var j=false;$("#web_setting ul#setting_menu li").click(function(n){if($(n.target).hasClass("current")&&j){return false}var m=$(this).index("#setting_menu li");$("#web_setting .setting-tab").removeClass("current");$(this).addClass("current");$("#web_setting .setting-main").hide().eq(m).show();j=true;$("#web_setting_save_btn .border").text(L.SAVE);f();if(this.id=="preferences_setting_title"){GTD.setting.getPreferencesSetting()}else{if(this.id=="personal_information_title"){GTD.setting.getPersonalInfomation()}else{if(this.id=="tag_manage_title"){$("#tag_select_delete").hide();$("#web_setting_save_btn .border").text(L.DELETE);GTD.setting.getTagManage()}else{if(this.id=="password_modify_title"){GTD.setting.getPasswordModify()}else{if(this.id=="remind_email_title"){$("#web_setting_save_btn .border").text(L.I_SETTING_REMIND_EMAIL_BUTTON);GTD.setting.getRemindEmail()}}}}}});var k=function(){$("#web_setting_save_btn").unbind("click");$("#web_setting_save_btn").click(function(){$("ul#setting_menu li").each(function(n){if($(this).hasClass("current")){if(this.id=="preferences_setting_title"){GTD.setting.setPreferencesSetting()}else{if(this.id=="personal_information_title"){var m=$.trim($("#nickname_text").val().toString());if(m){GTD.setting.setPersonalInfomation()}else{GTD.M(L.I_SETTING_NICKNAME_REQUIRED);$("#nickname_text").focus()}}else{if(this.id=="tag_manage_title"){$("#tag_select_delete").trigger("click");if($(".tags:checked").length>0){GTD.setting.setTagManage()}}else{if(this.id=="password_modify_title"){GTD.setting.setPasswordModify()}else{if(this.id=="remind_email_title"){var o=$.trim($("#remind_text").val().toString());var p=/^([-a-z0-9!\#$%&'*+\/=?^_`{|}~]+\.)*[-a-z0-9!\#$%&'*+\/=?^_`{|}~]+@((?:[-a-z0-9]+\.)+[a-z]{2,})$/;if(p.test(o)){GTD.setting.setRemindEmail(o)}else{GTD.M(L.E_USERNAME_INVALID)}}}}}}}})})};k();$("#web_setting_cancel_btn").click(function(){window.history.go(-1)});$("#password_modify_content .text").each(function(m){$(this).bind("blur",function(){if($(this).attr("value").length<6){$(this).addClass("input-error");$(".form-error").eq(m).show()}else{$(this).removeClass("input-error");$(".form-error").eq(m).hide()}});$(this).bind("focus",function(){$(this).removeClass("input-error");$(".form-error").eq(m).hide()})});$("#confirm_password_text").bind("blur",e);function e(){if($("#confirm_password_text").attr("value")!=$("#new_password_text").attr("value")){$("#confirm_password_text").addClass("input-error");$("#all_error_message").show()}else{$("#all_error_message").hide();$("#confirm_password_text").removeClass("input-error")}}function b(){var m=$("#web_setting_save_btn");m.unbind("click");m.parents(".btn-control").css({background:"none repeat scroll 0 0 #DDDDDD",color:"#888",cursor:"default"})}function f(){var m=$("#web_setting_save_btn");k();m.parents(".btn-control").css({background:"",color:"black",cursor:"pointer"})}GTD.setting.getPreferencesSetting=function(){$(".synchronous-cloz-btn").unbind("click").bind("click",function(){$.ajax({url:"/sync/disable",type:"get",complete:function(m){var n=m.status;if(n==200){GTD.setting.sync_btn_on()}else{GTD.M("取消关联失败/Cancel Conn Failed")}}})});$.ajax.getPersonalInfo({onSuccess:function(m){user=Do.parseJSON(m.responseText);$("#language_wrap .language-radio").each(function(){$(this).attr("value")==user.language?$(this).attr("checked",true):$(this).attr("checked",false)});$("#time_zone_list .selected-text").text(user.user_timezone);if(user.week_start=="Sunday"){$("#week_start_sunday_radio").attr("checked","checked")}else{$("#week_start_monday_radio").attr("checked","checked")}if(user.google_token&&user.calendar_id){GTD.setting.sync_btn_off()}else{GTD.setting.sync_btn_on()}},onFailure:function(m){}},"")};GTD.setting.getPersonalInfomation=function(){$.ajax.getPersonalInfo({onSuccess:function(m){user=Do.parseJSON(m.responseText);$("#nickname_text").attr("value",user.nickname);if((user.gender==true)||(user.gender==null)){$("#gender_radio_true").attr("checked",true)}else{$("#gender_radio_false").attr("checked",true)}if(user.birthday_year==null||user.birthday_month==null||user.birthday_day==null){$("#settings_years_list .selected-text").text("1970");$("#settings_months_list .selected-text").text("01");$("#settings_days_list .selected-text").text("01")}else{$("#settings_years_list .selected-text").text(user.birthday_year);$("#settings_months_list .selected-text").text(l(parseInt(user.birthday_month,10)+1));$("#settings_days_list .selected-text").text(l(parseInt(user.birthday_day,10)))}},onFailure:function(m){}},"")};GTD.setting.getTagManage=function(){$.ajax.getTagList({onSuccess:function(n){user_tags=Do.parseJSON(n.responseText).entries;$("#checkbox_wrap").html("");for(var m=0;m<user_tags.length;m++){$("#checkbox_wrap").append($("<div class='input-div'><input name='tags' value='"+user_tags[m].name+"' class='tags' type='checkbox' id='tag_"+m+"'><label title='"+user_tags[m].name+"' for='tag_"+m+"'>"+user_tags[m].name+"</label></div>"))}},onFailure:function(m){}},"")};GTD.setting.getPasswordModify=function(){};GTD.setting.getRemindEmail=function(){$.ajax.getPersonalInfo({onSuccess:function(m){user=Do.parseJSON(m.responseText);$("#remind_text").val(user.remind_email);$("span.email").text(user.remind_email);$("#remind_text").focus(function(){$(this).unbind("keyup");$(this).keyup(function(){$("span.email").text($(this).val());if($.trim($("#remind_text").val())!=""){a()}else{b()}})});a()},onFailure:function(m){}},"")};function a(){if(user.remind_email_status=="confirmed"){if($.trim($("#remind_text").val())==user.remind_email){b()}else{f()}}else{f()}}GTD.setting.setPreferencesSetting=function(){var m="cn";$("#language_wrap .language-radio").each(function(){if($(this).attr("checked")==true){user.language=$(this).val();m=user.language.toString()}});user.user_timezone=$("#time_zone_list .selected-text").text();user.week_start=$("#week_start_wrap input:checked").val();user.remind_email=$("#remind_text").val();$.ajax.updatePersonalInfo({data:{id:user.id,language:user.language,week_start:user.week_start,user_timezone:user.user_timezone},onSuccess:function(n){if(m=="cn"){GTD.M("偏好设置成功。")}else{if(m=="tw"){GTD.M("偏好設置成功。")}else{GTD.M("Preference modified successfully.")}}setTimeout(function(){window.location="/home/"},800)},onFailure:function(n){}},"")};GTD.setting.setPersonalInfomation=function(){user.nickname=$("#nickname_text").attr("value");if($("#gender_radio_true").attr("checked")==true){user.gender=true}else{user.gender=false}user.birthday_year=$("#settings_years_list .selected-text").text();user.birthday_month=Do.parseInt($("#settings_months_list .selected-text").text())-1;user.birthday_day=$("#settings_days_list .selected-text").text();$.ajax.updatePersonalInfo({data:{id:user.id,nickname:user.nickname,gender:user.gender,birthday_year:user.birthday_year,birthday_month:user.birthday_month,birthday_day:user.birthday_day},onSuccess:function(m){GTD.M(L.I_SETTING_PROFILE_SUCCESS)},onFailure:function(m){}},"")};GTD.setting.setTagManage=function(){var m=new Array();$(".tags:checked").each(function(){m.push($(this).attr("value"))});$.ajax.delTags({data:{tags:m},onSuccess:function(n){$(".tags:checked").parent().fadeOut("500").remove();GTD.updateTags();GTD.M(L.I_SETTING_TAGS_DELETE_SUCCESS)},onFailure:function(n){GTD.M(L.I_SETTING_TAGS_DELETE_FAILED)}},"del")};GTD.setting.setPasswordModify=function(){if($("#current_password_text").val()!=""||$("#new_password_text").val()!=""||$("#confirm_password_text").val()!=""){$.ajax.changePassword({data:{id:user.id,old_password:$("#current_password_text").attr("value"),new_password1:$("#new_password_text").attr("value"),new_password2:$("#confirm_password_text").attr("value")},onError:function(p){if($.trim(p.responseText)!=""){var m=Do.parseJSON(p.responseText);var o=m.retmsg;var n=m.retcode;if(n=="E011"){$("#new_password_text").addClass("input-error");$("#new_password_text + span").show()}else{if(n=="E012"){GTD.M(L.I_SETTING_WRONG_PASSWORD,"error")}else{if(n=="E013"){$("#confirm_password").addClass("input-error");$("#all_error_message").show()}}}}},onSuccess:function(m){$("#current_password_text").attr("value","");$("#new_password_text").attr("value","");$("#confirm_password_text").attr("value","");$("div#password_modify_content input").each(function(){var n=$(this);n.removeClass("input-error");n.siblings("span.form-error").hide()});GTD.M(L.I_SETTING_CHANGE_PASSWORD_SUCCESS)},onFailure:function(m){GTD.M(L.I_SETTING_CHANGE_PASSWORD_FAILED,"error")}},"change_password")}else{GTD.M(L.E_PASSWORD_REQUIRED)}};GTD.setting.setRemindEmail=function(m){user.remind_email=m;$.ajax.updatePersonalInfo({data:{id:user.id,remind_email:user.remind_email},onSuccess:function(n){GTD.M(L.I_SETTING_MAIL_SENT_SUCCESSFULLY)},onError:function(n){GTD.M(L.I_SETTING_REMIND_EMAIL_WRONG,"error")},onFailure:function(n){GTD.M(L.I_SETTING_REMIND_EMAIL_SEND_FAILED,"error")}},"")};GTD.setting.syncS=function(){GTD.M(L.I_SETTING_CONNECTED_SUCCESSFULLY);GTD.setting.sync_btn_off()};GTD.setting.syncF=function(){GTD.M(L.I_SETTING_CONNECTED_FAILED)};GTD.setting.sync_btn_off=function(){$(".btn-synchronous").unbind("click");$(".btn-synchronous").unbind("mouseover").bind("mouseover",function(){$(this).css("cursor","default")});$(".btn-synchronous").unbind("mousedown");$(".btn-synchronous").unbind("mouseup");$(".finish-synchronous").show()};GTD.setting.sync_btn_on=function(){$(".btn-synchronous").unbind("mouseover").bind("mouseover",function(){$(this).css("cursor","pointer")});$(".btn-synchronous").unbind("mousedown").bind("mousedown",function(){$(this).css("background-position","-50px -1000px")});$(".btn-synchronous").unbind("mouseup").bind("mouseup",function(){$(this).css("background-position","-50px -900px")});$(".btn-synchronous").unbind("click").bind("click",function(){var m=window.open("/sync/enable?type=2","","height=600,width=600")});$(".finish-synchronous").hide()}};(function(a){GTD.removeFrame=function(){a("#loading-wrap").remove();setTimeout(function(){a("#sidebar .in").show();a("#toolbar").show();setTimeout(function(){setTimeout(function(){a("#task_container").show()},500)},500)},500);a("body").css("overflow-y","auto")};GTD.setHeight=function(){var p=a(window).height();var k=a("#header").outerHeight(true);var e=0;var l=a("#sidebar .in .addtask").outerHeight(true);var f=a("#sidebar .in .focus").outerHeight(true);var c=a("#sidebar .in .more h3").outerHeight(true);var m=a("#sidebar .in .fixed").outerHeight(true);var n=a("#toolbar").outerHeight(true);var j=0;var h=p-k-e-j;var g=h-l-f-m-c;var o=p-k-e-n-j;a("#sidebar .in .more > ul").css({height:String(g)+"px"});o=h-n;var b=p-k-e;a("#setting_content").css({height:String(b)+"px"});a("#calendar_view").css({"min-height":String(b-20)+"px"});a("#sidebar .in").css({height:String(h)+"px"});a("#task_container").css({height:String(o)+"px"})};GTD.setTitle=function(g,f){var e=Doit.currentBox;var h=a("#sidebar .s .tit").text();var b=a("#header .s").attr("id");var k=a("#header .s").text();var j="";if(b=="header_time"&&g!="page"){var c=f==null?a(".taskList li:not(.completed)").length:f;switch(e){case"today":Doit.today_count=c;case"inbox":j="("+c+") "+h+" | Doit.im";break;default:j=h+" | Doit.im";break}}else{j=k+" | Doit.im"}document.title=j};GTD.notice={newVersion:a('<div class="new-version notice-mod">            <h3>'+L.NOTICE_NEW_VERSION+'</h3>            <div class="bd">                <div class="in">                </div>                <div class="ft">                    <span class="btn-confirm">'+L.NOTICE_ROGER+"</span>                </div>            </div>        </div>"),active:a('<div class="active notice-mod">            <h3>'+L.NOTICE_ACTIVE_EMAIL+'</h3>            <div class="bd">                <p>'+L.NOTICE_ACTIVE_EMAIL1+Doit.username+L.NOTICE_ACTIVE_EMAIL2+'</p>                <p class="resend">'+L.NOTICE_ACTIVE_EMAIL3+'<span class="btn-resend">'+L.NOTICE_RESEND+'</span> <span class="off">'+L.CLOSE+"</span></p>            </div>        </div>"),is_show_new_version:function(){if(Doit.last_login==null||Doit.last_login==""){return false}else{var b=Doit.lastVersion;var c=Time.strToDateObject(Doit.last_login);return b.getTime()>c.getTime()}},is_show_active_email:function(){var b=Doit.activated;if(b=="inactivated"){var c=true}else{var c=false}return c},_display_notice:function(){var e=a('<div class="notice"></div>');var b=false;var c=this.is_show_active_email();if(b){this.newVersion.find(".in").html('<iframe src="https://i.doit.im/cn/releases/web"></iframe>');e.append(this.newVersion);this.newVersion.find("span.btn-confirm").bind("click",function(){a(this).addClass("off");e.slideUp("slow")})}if(c){e.append(this.active);this.active.find("span.btn-resend").bind("click",function(){a(this).addClass("off");a.get("/member/resend",function(f){e.slideUp("slow")});a(this).removeClass("off")});e.find(".off").bind("click",function(){e.slideUp("slow")})}if(b||c){if(a("div.notice").length==0){a("body").append(e);setTimeout(function(){e.slideDown("slow")},5000)}else{setTimeout(function(){a("div.notice").slideDown("slow")},5000)}}},init:function(){this._display_notice()}};GTD.overlay=(function(){var b=a('<div class="overlay"><div class="overlay-x"><div class="overlay-y"></div></div></div>').hide().css({"background-color":"#000",opacity:0,position:"fixed",top:"0",left:"0","z-index":"200"});var c=a('<iframe src="javascript:false" style="position:absolute; visibility:inherit; top:0px; left:0px;height:0;width:0;z-index:-1; filter=\'progid:DXImageTransform.Microsoft.Alpha(style=0,opacity=0)\';"></iframe>');return{isVisible:function(){return b.is(":visible")},add:function(){a("body").append(b.css({width:a(window).width(),height:a(window).height()}));b.fadeTo("fast",(typeof arguments[0]==="number")?arguments[0]:0.4);if(!-[1,]){b.append(c);c.width("100%").height(b.height())}a(window).bind("resize.overlay",function(){b.css({width:a(window).width(),height:a(window).height()})})},remove:function(){b.fadeOut("fast",function(){b.remove()});a(window).unbind("resize.overlay")}}})();GTD.confirmBox=function(e){e=a.extend({appendTo:"#confirm_dialog_empty_trash",position:{x:"-185px",y:"0"},title:"",msgTitle:"",msgText:"",image:"exclamation",modal:true,hideCancel:false,deleteCallback:function(){},cancelCallback:function(){}},e);var b=a('<div class="confirm-dialog-box"></div>');var m=a('<div class="confirm-dialog-hd"></div>').appendTo(b);var k=a('<div class="confirm-dialog-hd-title"></div>').text(e.title).appendTo(m);var n=a('<div class="confirm-dialog-bd"></div>').appendTo(b);var g=a('<div class="confirm-dialog-image"></div>').addClass("confirm-dialog-image-"+e.image).appendTo(n);var c=a('<div class="confirm-dialog-text"></div>').append(a("<dl></dl>").append(a("<dt></dt>").text(e.msgTitle)).append(a("<dd></dd>").text(e.msgText))).appendTo(n);var l=a('<div class="confirm-dialog-ft"></div>').appendTo(b);var f=a('<div class="confirm-dialog-btn-box"></div>').appendTo(l);var j=a('<div class="btn-control"><div class="btn-control-icon btn-control-delete">'+L.OK+"</div></div>").click(function(){b.remove();if(GTD.overlay.isVisible()){GTD.overlay.remove()}e.deleteCallback()}).appendTo(f);if(!e.hideCancel){var h=a('<div class="btn-control"><div class="btn-control-icon btn-control-cancel">'+L.CANCEL+"</div></div>").click(function(){b.remove();if(GTD.overlay.isVisible()){GTD.overlay.remove()}e.cancelCallback()}).appendTo(f)}b.css({"z-index":"3000",position:"absolute",left:e.position.x,top:e.position.y});if(e.modal){GTD.overlay.add()}a(e.appendTo).append(b);return b};GTD.SetTimer=function(){var b=setInterval(function(){var c=new Date(Doit.time);var e=c.getSeconds();Doit.time=new Date(c.setSeconds(e+1));a("#paper_title span.paper-date").html(Doit.time.format("yyyy-mm-dd HH:MM:ss"))},1000)};GTD.reloadTaskList=function(){a("#toolbar .reload-data").click(function(){if(Doit.currentPage=="time"){var b=a("#sidebar li.s").attr("id");GTD.Time.loadTimeboxTask(b)}else{if(Doit.currentPage=="context"){var b=a("#sidebar li.s");GTD.Context.selectContextOnIt(b)}else{if(Doit.currentPage=="project"){var b=a("#sidebar li.s");GTD.Project.selectOnIt(null,b)}else{a("#sidebar li.s").trigger("click")}}}})};GTD.refreshTaskList=function(){a("#toolbar .reload-data").trigger("click")};GTD.topMenu=function(){a("#header .menu-item").click(function(){var b=a("div.notice");if(b.length){b.hide()}a("#header .s").removeClass("s");a(this).addClass("s");a("div#groupby h3 a").html(L.GROUP_BY_DEFAULT+"<span></span>").attr("rel","default");GTD.setTitle("page")})};a(window).resize(function(){GTD.setHeight()});GTD.load=function(b){GTD.emptyPage();setTimeout(function(){if(b==="calendar"){a("div#calendar_view").load("/home/"+b)}else{a("#sidebar .in").load("/home/"+b)}},567)};GTD.switchView=function(){a("#setting_content").hide().empty();if(Doit.currentBox==="calendar"){a(".header-bottom .s .allow,#main").show();a("#top_search").hide();a("div#sidebar").hide();a("div#task_paper").hide();a("div#main").css({"margin-left":"0px"});a("div#calendar_view").show()}else{a(".header-bottom .s .allow,#sidebar,#main").show();a("#top_search").show();a("div#sidebar").show();a("div#task_paper").show();a("div#main").css({"margin-left":"221px"});a("div#calendar_view").empty().hide()}if(Doit.currentBox==="archiver"){a("div.archiver-tool").show();a("div.archiver-tool li.type").attr("id","week")}else{a("div.archiver-tool").hide()}};a.history.init(function(c){if(Doit.prevPage==c){a(".goback a").trigger("click");Doit.prevPage=null;return}var j=c.split("time/");j[0]=j[0]==""?"time":j[0];Doit.url=j;c=j[0];GTD.loadingData("show");if(c==""){Doit.currentBox="time"}else{if(/^task\//.test(c)){}else{if(/^context\//.test(c)){Doit.currentBox="context"}else{if(/^project\//.test(c)){Doit.currentBox="project"}else{if(c=="settings"){}else{Doit.currentBox=c}}}}}GTD.switchView();if(c.indexOf("search/current")!=-1){c="search_current"}else{if(c.indexOf("search/global")!=-1){c="search_global"}else{if(c.indexOf("task/")!=-1){c="task"}else{if(c.indexOf("context/")!=-1){c="context"}else{if(c.indexOf("project/")!=-1){c="project"}}}}}switch(c){case"":case"time":if(Doit.currentPage==null||Doit.currentPage!="time"){Doit.currentPage="time";GTD.load("time")}else{if(Doit.currentPage=="time"){if(j[1]==null){j[1]="today"}GTD.Time.loadTimeboxTask(j[1])}}Doit.prevPage="time/"+j[1];break;case"search_current":a("#setting_content").hide().empty();if(a(".task-view:visible").length>0){a.initTaskList()}Doit.prevPage="search_current";var h=a.trim(a(".search-input").val());if(h==""){window.location="#/time/today"}else{Doit.search.current(h)}break;case"search_global":a("#setting_content").hide().empty();if(a(".task-view:visible").length>0){a.initTaskList()}Doit.prevPage="search_global";var h=j.toString().replace(/search\/global\//,"");Doit.currentBox="search";if(Doit.currentPage==null){a("#sidebar .in").load("/home/time",function(){Doit.currentPage="time";Doit.search.global(h)})}else{Doit.search.global(h)}break;case"task":var b=j.toString().replace(/task\//,"");if(Doit.currentPage==null){Doit.currentPage="time";Doit.currentBox="task";a("#sidebar .in").load("/home/time")}else{if(Doit.currentPage=="time"){if(a("#sidebar .s a").length!=0){Doit.prevPage=a("#sidebar .s a").attr("href").replace("#/","")}}else{Doit.prevPage=Doit.currentPage}GTD.singleTask(b)}break;case"context":var g=j.toString().replace(/context\//,"");GTD.callback_afterContextData=function(){if(g==""||g=="context"||g=="all"){GTD.Context.selectContextOnIt(a("#context_all"))}else{if(g=="none"){GTD.Context.selectContextOnIt(a("#context_none"))}else{if(Do.id(g).length==0){window.location.hash="#/context/all"}else{GTD.Context.selectContextOnIt(Do.id(g).parent())}}}};if(Doit.currentPage==null||Doit.currentPage!="context"){Doit.currentPage="context";GTD.load("context")}else{if(Doit.currentPage=="context"){GTD.callback_afterContextData()}}break;case"project":var f=j.toString().replace(/project\//,"");GTD.callback_afterProjectData=function(){if(f==""||f=="project"||f=="all"){GTD.Project.selectOnIt(null,a("#project_all"))}else{if(f=="none"){GTD.Project.selectOnIt(null,a("#project_none"))}else{if(Do.id(f).length==0){window.location.hash="#/project/all"}else{GTD.Project.selectOnIt(null,Do.id(f).parent())}}}};if(Doit.currentPage==null||Doit.currentPage!="project"){Doit.currentPage="project";GTD.load("project")}else{if(Doit.currentPage=="project"){GTD.callback_afterProjectData()}}break;case"settings":var e=a("#setting_content");e.hide().load("/home/setting",function(){a(this).show();a(".header-bottom .s .allow,#sidebar,#main").hide();a(".setting-del-account").bind("click",function(){GTD.confirmBox({title:L.setting_del_account,msgTitle:L.setting_del_account_confirm1,msgText:"",deleteCallback:function(){GTD.confirmBox({title:L.setting_del_account,msgTitle:L.setting_del_account_confirm2,msgText:"",modal:true,deleteCallback:function(){window.location.href="/member/delete"},cancelCallback:function(){alert(L.setting_del_account_confirm3_no)}});GTD.overlay.add()},cancelCallback:function(){}})})});Doit.prevPage="settings";break;case"contact":case"calendar":case"archiver":Doit.currentPage=c;GTD.load(c);break;default:window.location="#/time/today";break}if(c!="settings"){a("#header .menu-item").removeClass("s");a("#header_"+Doit.currentPage).addClass("s")}});GTD._M={};GTD._M.$tips2=a("#tips2");GTD._M.$tips2_ul=a("#tips2>ul");GTD._M.getAllChildrenHeight=function(){var b=0;GTD._M.$tips2_ul.children().each(function(e,c){b+=a(c).outerHeight()});return b};GTD._M.liFadeOut=function(c){if(!c){return}var b=c.outerHeight();GTD._M.$tips2_ul.stop().children().stop(false,true);GTD._M.$tips2_ul.css({height:GTD._M.$tips2_ul.height()});c.slideUp("normal",function(){a(this).remove()});GTD._M.$tips2_ul.animate({height:GTD._M.getAllChildrenHeight()-b},{complete:function(){if(GTD._M.$tips2_ul.children().length<1){GTD._M.$tips2.slideUp(200)}}});GTD._M.$tips2_ul.css({height:"auto"})};GTD._M.liFadeOutDelay=function(c,b){setTimeout(function(){GTD._M.liFadeOut(c)},b)};GTD.M=function(c,b){if(b==null||b=="normal"){GTD._M.$tips2.removeClass().addClass("normal")}else{if(b=="error"){GTD._M.$tips2.removeClass().addClass("error")}}c=(typeof c==="string")?{text:c}:c||{};c=a.extend({text:'默认消息。<br />调用方法：<br />GTD.Message("text")<br /> 或<br /> GTD.Message({ text: "text", duration: 5000 })',duration:5000},c);var e=a('<li title="Click to hide."/>').html(c.text).click(function(){GTD._M.liFadeOut(e)}).hide();GTD._M.$tips2_ul.append(e);GTD._M.$tips2_ul.stop().children().stop(false,true);GTD._M.$tips2_ul.css({height:GTD._M.$tips2_ul.height()});if(GTD._M.$tips2.is(":hidden")){GTD._M.$tips2.show()}GTD._M.$tips2_ul.animate({height:GTD._M.getAllChildrenHeight()},{duration:600,complete:function(){GTD._M.$tips2_ul.css({height:"auto"})}});if(c.duration){GTD._M.liFadeOutDelay(e,Number(c.duration)+600)}e.slideDown()};a.fn.tipBox=function(c,e){var b=60;if(typeof e=="number"){b=e}a(this).each(function(g,h){var f=a(h);if(f.parents(".tip-box-wrap-position").length){return}f.wrap('<div class="tip-box-wrap-position" id="" />').wrap('<div class="tip-box-wrap" id="" />');var k=f.parent();var n=k.parent();if(a.inArray(c,["left","right","top","bottom"])>-1){var j=a('<div class="tip-box-'+c+'" />').appendTo(n);var m;if(e==="center"){var l={left:"outerHeight",right:"outerHeight",top:"outerWidth",bottom:"outerWidth"};b=(f[l[c]])()/2+9}if(b>0){b=0-b;if(c=="left"||c=="right"){m="top"}else{m="left"}}else{if(c=="left"||c=="right"){m="bottom"}else{m="right"}}k.css(m,b+"px");if(c=="left"){k.css({left:"15px"})}else{if(c=="right"){k.css({right:"15px"})}else{if(c=="top"){k.css({top:"14px"})}else{if(c=="bottom"){k.css({bottom:"14px"})}}}}}});return a(this)};GTD.EmptyTip=function(g){var f=Doit.currentBox;if(a("#empty_tip_content").is("div")){var h=a("#empty_tip_content").empty().append('<p class="no-task">'+L.i_empty_notasks+"</p>")}else{var h=a("<div id='empty_tip_content' style='display:none;' class='empty-tip-content'></div>").append('<p class="no-task">'+L.i_empty_notasks+"</p>").insertAfter("#task_group")}if(a.inArray(f,["inbox","today","next","tomorrow","scheduled","someday","waiting","completed","trash"])>-1){if(window.name=="doitnow"){f="doitnow"}h.append(a("<p></p>").text(L["i_empty_tip_"+f]))}else{if(a.inArray(f,["context","project"])>-1){var e=({all:"all_",none:"no_"})[Doit.getTid()];if(!e){e="ptc_"}h.append(a("<p></p>").text(L["i_empty_tip_"+e+f]))}else{if(f=="contact"){h.append(a("<p></p>").text(L.i_empty_tip_contact_all));if(a("#contact_view h3.s").length&&!a("#contact_view h3.s").parent().is("#contact_all")){h.append(a("<p></p>").text(L.i_empty_tip_contact_group))}else{if(a("#contact_view li.s").length&&a("#contact_view li.s").is(":visible")){h.append(a("<p></p>").text(L.i_empty_tip_contact_person))}}}else{if(f=="archiver"){if(a("#weekly").hasClass("s")){h.append(a("<p></p>").text(L.i_empty_tip_archiver_week))}else{h.append(a("<p></p>").text(L.i_empty_tip_archiver_month))}}}}}function b(){h.show()}function c(){h.hide()}switch(g){case"show":b();break;case"hide":c();break;default:if(!TASKS.length){b()}else{c()}}}})(jQuery);(function(a){})(jQuery);(function($){GTD.Taskform={};$.fn.taskMetaAdd=function(){return this.each(function(){var $this=$(this);var $meta=$this.closest(".meta");$this.unbind("keydown.smartAdd").bind("keydown.smartAdd text",function(){var $input=$(this);if($meta.find(".input-tmp").is("div")){var $input_tmp=$meta.find(".input-tmp");$input_tmp.text($input.val())}else{var $input_tmp=$('<div class="input-tmp">'+$input.val()+"</div>");$meta.find(".input-li").append($input_tmp)}var $width=$meta.find(".input-tmp").width();$input.parent().css({width:$width+10+"px"})})})};$.fn.getDateTime=function(){if(!this.val()||this.val()==""){return null}var date=new Date(Doit.time);var dts=$.trim(this.val()).split(" ");var ds=dts[0].split("-");var datestring=ds[0]+"-"+ds[1]+"-"+ds[2];if(dts[1]!=null){var ts=dts[1].split(":");datestring=datestring+"T"+ts[0]+":"+ts[1]+Time.zoneToString(Do.cookie("user_timezone"))}else{datestring=datestring+"T00:00"+Time.zoneToString(Do.cookie("user_timezone"))}date=Time.strToDatetime(datestring);return date};GTD.setDateTime=function(odate){if(!odate||odate==""||odate==L.TASK_START_AT||odate==L.TASK_END_AT){return null}if($("#taskform_allday").is(":checked")){odate=odate.split(" ")[0]}var date=new Date(Doit.time);var dts=$.trim(odate).split(" ");var ds=dts[0].split("-");var datestring=ds[0]+"-"+ds[1]+"-"+ds[2];if(dts[1]!=null){var ts=dts[1].split(":");datestring=datestring+"T"+ts[0]+":"+ts[1]+Time.zoneToString(Do.cookie("user_timezone"))}else{datestring=datestring+"T00:00"+Time.zoneToString(Do.cookie("user_timezone"))}date=Time.strToDatetime(datestring);return date};$.fn.taskForm_priChoose=function(){return this.each(function(){var elem=$(this);var li=elem.find("li");var length=elem.find("li").length;var now_index=elem.find(".hover").index(elem.find("li"));var next_index;function set(li){var li_text=li.text();var li_id=li.attr("data-id");$("#taskform .task-priority .meta-input").val(li_text).attr("data-id",li_id);$("#taskform .task-priority .popup").hide()}$(document).unbind("keyup.priChoose").bind("keyup.priChoose",function(e){if($("#taskform .task-priority .popup").is(":visible")){var keycode=e.keyCode;switch(keycode){case 38:if(now_index==0){now_index=length}next_index=now_index-1;li.removeClass("hover");li.eq(next_index).addClass("hover");now_index-=1;break;case 40:if(now_index==(length-1)){now_index=-1}next_index=now_index+1;li.removeClass("hover");li.eq(next_index).addClass("hover");now_index+=1;break;case 13:var now_li=li.eq(now_index);li.removeClass("select");set(now_li);now_li.addClass("select");return false;default:break}}});li.unbind("click.priChoose").bind("click.priChoose",function(){var $meta=$(this).parents(".meta");$meta.find(".meta-default-text").hide();li.removeClass("select");set($(this));$(this).addClass("select");return false});li.unbind("mouseover.priChoose").bind("mouseover.priChoose",function(){li.removeClass("hover");$(this).addClass("hover");now_index=$(this).index()})})};$.fn.taskForm_boxChoose=function(){return this.each(function(){var elem=$(this);var li=elem.find(".left li");var length=$(this).find("li").length;var now_index=elem.find(".hover").index(elem.find("li"));var next_index;function set(li){var box_text=li.text();var box_id=li.attr("data-id");$("#taskform .task-starttime .box").text(box_text).attr("data-id",box_id);$(".datepicker").each(function(){$(this).data("realVal",null)});var data_id=li.attr("data-id");var today=GTD.setDateTime(Doit.time.format("yyyy-mm-dd HH:MM"));switch(data_id){case"inbox":case"next":$(".task-start-at").removeClass("disabled").val("");if(data_id!="next"){$(".task-end-at").val("").trigger("blur")}$(".repeat_start_at").text(L.TASK_START_AT);$("#dpDiv").remove();$("#taskform .meta .popup").hide();GTD.Taskform.disableNoStartat(true);break;case"today":var ts=Time.userDayStr(today);$(".task-start-at").removeClass("disabled").val(ts);$(".task-end-at").val("").trigger("blur");$("#taskform_allday").attr("checked","checked");$(".repeat_start_at").text(ts);$("#dpDiv").remove();$("#taskform .meta .popup").hide();GTD.Taskform.disableNoStartat(false);break;case"tomorrow":today.setDate(today.getDate()+1);var tomorrow=Time.userDayStr(today);$(".task-start-at").removeClass("disabled").val(tomorrow);$(".task-end-at").val("").trigger("blur");$("#taskform_allday").attr("checked","checked");$(".repeat_start_at").text(tomorrow);$("#dpDiv").remove();$("#taskform .meta .popup").hide();GTD.Taskform.disableNoStartat(false);break;case"scheduled":today.setDate(today.getDate()+2);var after=Time.userDayStr(today);$(".task-start-at").removeClass("disabled").val(after);$(".task-end-at").val("").trigger("blur");$("#taskform_allday").attr("checked","checked");$(".repeat_start_at").text(after);$("#dpDiv").remove();GTD.showDate($(".task-start-at"));GTD.Taskform.disableNoStartat(false);break;case"someday":$(".task-start-at").addClass("disabled").val("");$(".task-end-at").val("").trigger("blur");$("#taskform_allday").attr("checked","checked");$(".repeat_start_at").text(L.TASK_START_AT);$("#dpDiv").remove();$("#taskform .meta .popup").hide();GTD.Taskform.disableNoStartat(true);break;case"waiting":$(".task-start-at").removeClass("disabled").val("");$("#taskform_allday").attr("checked","checked");$(".repeat_start_at").text(L.TASK_START_AT);$("#dpDiv").remove();$("#taskform .meta .popup").hide();GTD.Taskform.disableNoStartat(true);break;default:Do.log("WTF!")}$(".task-deadline .clear-this").hide()}$(document).unbind("keyup.boxChoose").bind("keyup.boxChoose",function(e){if($("#taskform .task-starttime .popup").is(":visible")){var keycode=e.keyCode;switch(keycode){case 38:if(now_index==0){now_index=length}next_index=now_index-1;li.removeClass("hover");li.eq(next_index).addClass("hover");now_index-=1;break;case 40:if(now_index==(length-1)){now_index=-1}next_index=now_index+1;li.removeClass("hover");li.eq(next_index).addClass("hover");now_index+=1;break;case 13:var now_li=li.eq(now_index);li.removeClass("select");set(now_li);now_li.addClass("select");return false;default:break}}});li.unbind("click.boxChoose").bind("click.boxChoose",function(){var $meta=$(this).parents(".meta");$meta.find(".meta-default-text").hide();li.removeClass("select");set($(this));$(this).addClass("select");return false});li.unbind("mouseover.boxChoose").bind("mouseover.boxChoose",function(){li.removeClass("hover");$(this).addClass("hover");now_index=$(this).index()})})};$.fn.taskForm_clickToEdit=function(){return this.each(function(){$(this).click(function(e){var $meta=$(this);if($meta.hasClass("disabled")){return false}if($meta.hasClass("smart")){$meta.find(".autocomp-input").trigger("focus")}else{if($meta.hasClass("task-reminder")){if(!$(e.target).closest(".popup").is("div")&&!$(e.target).hasClass("popup")){$meta.find(".meta-input").trigger("focus")}}else{if($meta.hasClass("task-repeat")){if(!$(e.target).closest(".popup").is("div")&&!$(e.target).hasClass("popup")){$meta.find(".meta-input").trigger("focus")}}else{if($meta.hasClass("task-starttime")){if(!$(e.target).closest(".popup").is("div")&&!$(e.target).hasClass("popup")){$meta.find(".meta-input").trigger("focus");$meta.find(".popup").show()}}else{if($meta.hasClass("task-deadline")){if(!$(e.target).parents(".popup").is("div")&&!$(e.target).hasClass("popup")){$meta.find(".meta-input").trigger("focus");$meta.find(".popup").show()}}else{$meta.find(".meta-input").trigger("focus")}}}}}e.stopPropagation()})})};$.fn.taskForm_focusToEdit=function(){return this.each(function(){$(this).bind("focus.editmeta",function(){$("#taskform .meta").removeClass("focus");$("#taskform .s").removeClass("s");$("#taskform .popup,#taskform .autocomplete").hide();$(document).trigger("click");var $meta=$(this).closest(".meta");var $meta_default=$meta.find(".meta-default-text");var $autoinput=$meta.find(".autocomp-input");var $token=$meta.find(".token");$meta.addClass("focus").find(".meta-default-text").hide();if($meta.hasClass("toggle")){$("#taskform .toggle").removeClass("toggle");$("#taskform .taskform-foot").hide()}if($meta.hasClass("task-notes")){if($(this).val()!=""){var notes_height=$meta.find(".textarea-tmp").height();$(this).css({height:notes_height+"px","overflow-y":"auto"})}}if($autoinput.hasClass("cant")&&$token.length==1){$token.trigger("click")}if($meta.hasClass("task-reminder")){$meta.find(".popup").show().taskForm_reminderPopup()}if($meta.hasClass("task-repeat")){$meta.find(".popup").show().taskForm_repeatPopup();if($("#repeat_monthly").is(":visible")){$("#taskform .task-repeat select.type").trigger("change")}}if($meta.hasClass("task-starttime")){$meta.find(".popup").show();$meta.taskForm_boxChoose()}if($meta.hasClass("task-priority")){$meta.find(".popup").show();$meta.taskForm_priChoose()}if($meta.hasClass("task-deadline")){$meta.find(".popup").show();if($("#dpDiv").length==0||$("#dpDiv").is(":hidden")){GTD.showDate($(".task-end-at"));return false}}})})};$.fn.taskForm_blurToNormal=function(){return this.each(function(){var $meta=$(this).closest(".meta");var $meta_default=$meta.find(".meta-default-text");$(this).unbind("blur").bind("blur",function(){var value=$.trim($(this).val());$(document).unbind(".delitem");if($meta.hasClass("smart")){var $token_size=$meta.find(".token").length;if($token_size<1){$meta_default.show();$(this).val("")}$meta.find(".token").removeClass("s")}else{if($meta.hasClass("task-notes")){if(value==""){$meta_default.show();$(this).val("")}}else{if($meta.hasClass("task-reminder")){if(value==""){$meta_default.show();$(this).val("")}}else{if($meta.hasClass("task-starttime")){if(value==""&&$meta.find(".box").html()==""){$meta_default.show();$(this).val("")}}else{if(value==""){$meta_default.show();$(this).val("")}}}}}$meta.removeClass("focus")})})};$.fn.taskForm_reminderPopup=function(init){return this.each(function(){if(!Do.isEmptyStr($(".task-repeat .meta-input").val())){$(this).find(".unit .absolute").attr("disabled","disabled")}else{$(this).find(".unit .absolute").removeAttr("disabled")}if(Do.isEmptyStr($("#task_start_at").val())){$(".task-reminder .popup .unit").val("ondate").trigger("change");$(this).find(".unit .relative").attr("disabled","disabled")}else{$(this).find(".unit .relative").removeAttr("disabled")}$(this).undelegate().delegate(".unit","change",function(){if($(this).val()=="ondate"){$(this).parent().attr("data-type","absolute");if(!Do.isEmptyStr($("#task_start_at").val())){var _defaultDate=new Date($("#task_start_at").val().replace(/-/g,"/")).addMinutes(-10).format("yyyy-mm-dd HH:MM")}else{var _defaultDate=Do.objClone(Doit.time).addMinutes(10).format("yyyy-mm-dd HH:MM")}$(this).prev().hide();$(this).next().val(_defaultDate).show()}else{$(this).parent().attr("data-type","relative");$(this).next().hide();$(this).prev().show()}});if(init!="event"){$(document).bind("click.reminderPopup",function(e){if($(e.target).closest(".task-reminder").is("li")){}else{$("#taskform .task-reminder .popup").hide();$(document).unbind(".reminderPopup")}});var $this=$(this);function get(){var str="";$this.find("li").each(function(){var val=$.trim($(this).find(".text").val());var reminder_type=$(this).attr("data-type");if(reminder_type=="relative"){if(val!=""){var num=Do.parseInt($(this).find(".text").val());var unit=$(this).find(".unit").val();var type=$(this).find(".type").val();str+=L.AHEAD_CN+num+L.WORDSPACE+L[unit.toUpperCase()]+L.AHEAD_EN+"("+L["REMINDER_"+type.toUpperCase()]+");"}}else{var reminder_time=$(this).find(".nlinput").val();var type=$(this).find(".type").val();str+=reminder_time+"("+L["REMINDER_"+type.toUpperCase()]+");"}});if(str!=""){$("#taskform .task-reminder .meta-default-text").hide();$("#taskform .task-reminder .meta-input").val(str);$("#taskform .task-reminder .clear-this").show()}else{$("#taskform .task-reminder .meta-default-text").show();$("#taskform .task-reminder .meta-input").val("")}$("#taskform .task-reminder .popup").hide();$(document).unbind(".reminderPopup")}$this.find(".ok").unbind("click").bind("click",get)}})};GTD.Taskform.resetReminder=function(type){if(type=="repeat"){if($('.task-reminder .popup li[data-type="relative"]').length>=1){$('.task-reminder .popup li[data-type="absolute"]').remove();$(".task-reminder .popup .ok").trigger("click")}else{$(".task-reminder .popup .unit").val("min").trigger("change");$(".task-reminder .popup .unset").trigger("click")}}else{if($('.task-reminder .popup li[data-type="absolute"]').length>=1){$('.task-reminder .popup li[data-type="relative"]').remove();$(".task-reminder .popup .ok").trigger("click")}else{$(".task-reminder .popup .unit").val("ondate").trigger("change");$(".task-reminder .popup .unset").trigger("click")}}};$.fn.taskForm_reminderAdd=function(){return this.each(function(){$(this).bind("click",function(){var node=$('<li data-type="relative">                <select class="type">                    <option value="popup">'+L.REMINDER_POPUP+'</option>                    <option value="email">'+L.REMINDER_EMAIL+'</option>                </select>                <input type="text" value="10" class="reminder text" />                <select class="unit">                    <option value ="min" class="relative">'+L.MIN+'</option>                    <option value ="hour" class="relative">'+L.HOUR+'</option>                    <option value="day" class="relative">'+L.DAY+'</option>                    <option value="ondate" class="absolute">'+L.ONDATE+'</option>                </select>                <input style="display:none;" type="text" readonly class="datepicker nlinput" />                <div class="reduce">-</div>                </li>');if(!Do.isEmptyStr($(".task-repeat .meta-input").val())){node.find(".unit .absolute").attr("disabled","disabled")}node.find(".reminder").isNumInput();function reduce(elem){elem.bind("click",function(){$(this).parent().remove();return false})}node.find(".nlinput").reminderDatepicker();reduce(node.find(".reduce"));var num=$("#taskform .task-reminder .popup ul li").length;if(num<5){$("#taskform .task-reminder .popup ul").append(node);if(Do.isEmptyStr($("#task_start_at").val())){$(".task-reminder .popup .unit").val("ondate").trigger("change");node.find(".unit .relative").attr("disabled","disabled")}}})})};$.fn.taskForm_repeatPopup=function(){return this.each(function(){$(document).bind("click.repeatPopup",function(e){if($(e.target).closest(".task-repeat").is("li")){}else{$("#taskform .task-repeat .popup").hide();$(document).unbind(".repeatPopup")}})})};$.fn.taskForm_repeatType=function(){return this.each(function(){$(this).bind("change",function(){var type=$(this).find(":selected").attr("data-id");$("#taskform .task-repeat dl").hide();$("#"+type).show();if(type=="repeat_weekly"){var now=new Date(Doit.time);var weekday=now.getDay()==0?6:now.getDay()-1;var $weekday=$("dl#repeat_weekly dd.task-repeat-box div.checkbox:eq("+weekday+")");$weekday.addClass("checked");$weekday.find("input").val("on")}else{if(type=="repeat_monthly"){GTD.Taskform.setRepeatMonthly($(".task-repeat .meta-input").data("repeater"))}}})})};$.fn.taskForm_showXorNot=function(){return this.each(function(){var $this=$(this);var $meta=$(this).closest(".meta");$this.bind("keyup",function(){var val=$.trim($(this).val());if($meta.hasClass("task-title")){if(val!=""){$("#taskform .taskform-btn-save").removeClass("disabled")}else{$("#taskform .taskform-btn-save").addClass("disabled")}}if($meta.hasClass("task-title")||$(this).is("textarea")){if(val!=""){$meta.find(".clear-this").show()}else{$meta.find(".clear-this").hide()}}})})};GTD.Taskform.disableWhenNoStartat=function(){var start_at=$("#task_start_at").val()};GTD.Taskform.showXorNot=function(meta){var $token_size=meta.find(".token").length;var $clear=meta.find(".clear-this");if($token_size>0){$clear.show()}else{$clear.show()}};GTD.Taskform.disableNoStartat=function(bool){if(bool){$(".task-reminder .popup").taskForm_reminderPopup("event");GTD.Taskform.resetReminder("reminder");$("#taskform .task-repeat").addClass("disabled");$("#taskform .task-repeat .meta-input").val("");$("#taskform .task-repeat input").attr("disabled","disabled");$("#taskform .task-repeat .clear-this").hide();$("#taskform .task-repeat .meta-default-text").each(function(){var orig=$(this).html();if($(this).data("text")==null){$(this).data("text",orig)}$(this).show().html(L.PLS_SET_START_TIME_FIRST)})}else{$("#taskform .task-repeat").removeClass("disabled");$("#taskform .task-repeat input").removeAttr("disabled");$("#taskform .task-repeat .meta-default-text").each(function(){var orig=$(this).data("text");$(this).html(orig);if($(this).next().val()!=""){$(this).hide()}})}};GTD.Taskform.resetMetaHeight=function(_meta){var $meta_wrap=_meta.find(".meta-wrap");var $height=_meta.find(".token-items").height();$meta_wrap.css({height:$height+"px"})};GTD.Taskform.resetNotesHeight=function(_textarea){_textarea.bind("keyup.notesAdd",function(e){$textarea=$(this);var keycode=e.keyCode;var $textarea_tmp=$textarea.next();setTimeout(function(){var text=$textarea.val();if(text.length>2048){text=text.substr(0,2048);_textarea.val(text)}text=Do.escapeHTML(text).replace(/\n/gi,"<br />");$textarea_tmp.html(text+"&nbps;");var $height=$textarea_tmp.height();if(keycode==13){$height+=20}if(text!=""){$textarea.css({height:$height+"px"})}else{$textarea.css({height:"20px"})}},1)})};$.fn.taskForm_metaAutoComp=function(options){return this.each(function(){var _options=$.extend({maxSize:1,data:{},filters:["name"],createNew:L.TF_PROJECT,callback:function(){}},options);var $this=$(this);var $meta=$this.closest(".meta");$this.doitAutocomplete({data:_options.data,filters:_options.filters,focusShow:true,maxHeight:6,automove:_options.automove,valueFunction:function(input){return Do.escapeHTML($.trim($(input).val()))},showFunction:function(item){if($meta.hasClass("task-assign")){if(item.name==item.email){return $('<li><div title="'+item.name+'">'+item.name+"</div></li>")}else{return $('<li><div title="'+item.name+"("+item.email+')">'+item.name+"("+item.email+")</div></li>")}}else{return $('<li><div title="'+item.name+'">'+item.name+"</div></li>")}},cantClass:"cant",showNoVal:false,selectFucntion:function(selected){var iswrap=_options.iswrap;var parent=$meta.find(".input-li");if(iswrap){selected.unbind("click");if(selected.hasClass("new-item")){var text=Do.maxText(selected.data("value"),30);selected=$('<li name="'+Do.escapeHTML(text)+'"><div title="'+text+'">'+text+"</div></li>");_options.callback(text);if($meta.hasClass("task-tags")){Doit.tags.push({name:Do.escapeHTML(text)})}}if($meta.hasClass("task-assign")){selected.find("div").html(selected.attr("name"))}var isexist=GTD.Taskform.isExist(selected,$meta);if(isexist){GTD.M("请不要重复添加");return}selected.taskForm_delSelect($meta,_options.maxSize);parent.before(selected.addClass("token"))}else{if(selected.hasClass("new-item")){var text=Do.maxText(selected.data("value"),30);_options.callback(text)}else{var text=Do.maxText(Do.unescapeHTML(selected.attr("name")))}$meta.find(".meta-input").val(text)}},noResult:function(){if(!$meta.hasClass("task-assign")){var _callback=this.callbackFunction;var val=Do.escapeHTML($meta.find(".autocomp-input").val());var no_result=$('<div class="new-item selected">+ '+L.CREATE+L.WORDSPACE+_options.createNew+' "'+val+'"</div>').data("value",val);no_result.bind("click",function(){var parent=$meta.find(".input-li");var text=Do.maxText(val,30);var selected=$('<li name="'+val+'"><div title="'+Do.unescapeHTML(val)+'">'+val+"</div></li>");_options.callback(val);selected.taskForm_delSelect($meta,_options.maxSize);parent.before(selected.addClass("token"));$meta.find(".autocomp-input").val("").trigger("focus");if($meta.hasClass("task-tags")){Doit.tags.push({name:val})}_callback()});return no_result}else{if($(".task-assign:visible .autocomp-input").val().length){return $('<div class="noresult">'+L.TASKFORM_NOT_CONTACT+"</div>")}else{return $('<div class="noresult">'+L.TASKFORM_NO_CONTACTS+"</div>")}}},append:function(){var autoval=$.trim($meta.find(".autocomp-input").val());if(autoval==""){return false}if(!$meta.hasClass("task-assign")){var val=Do.escapeHTML($meta.find(".autocomp-input").val());var isexist=GTD.issameName(val,_options.data);if(!isexist){return $('<li class="new-item">+ '+L.CREATE+L.WORDSPACE+_options.createNew+' "'+val+'"</li>').data("value",val)}}},callbackFunction:function(){var iswrap=_options.iswrap;GTD.Taskform.showXorNot($meta);$meta.find(".meta-default-text").hide();if(iswrap){$meta.find(".autocomp-input").val("");GTD.Taskform.resetMetaHeight($meta);var $token_size=$meta.find("li.token").size();if($token_size!=null&&$token_size==_options.maxSize){$meta.find(".token").trigger("click");$meta.addClass("focus");$meta.find(".autocomp-input").addClass("cant")}else{}if($meta.hasClass("task-assign")){$("#taskform .taskform-btn-save").html(L.TASKFORM_SEND);$(".taskform-autoc").show()}}}})})};$.fn.taskForm_tabBack=function(){$(this).unbind(".taskform_tab").bind("keydown.taskform_tab",function(e){var keycode=e.keyCode;if(keycode==9){e.preventDefault();$("#taskform li.meta:last input:first").trigger("blur");$("#taskform li.meta:not(.disabled):eq(0)").trigger("click")}})};$.fn.taskForm_delSelect=function(_parent,maxsize){return this.each(function(){var $this=$(this);var $input=_parent.find(".autocomp-input");$this.bind("click.selected",function(){$("#taskform .token-items .s").removeClass("s");if(!$(this).hasClass("cant")){$(this).addClass("s")}var $meta=$(this).closest(".meta");$(document).unbind(".delitem").bind("keydown.delitem",function(e){var keycode=e.keyCode;if(keycode==8){if($this.hasClass("s")){e.preventDefault();$this.remove();GTD.Taskform.resetMetaHeight($meta);var $token_size=_parent.find(".token").length;if($token_size<1){_parent.find(".clear-this").hide().unbind(".clear");_parent.trigger("click");if($meta.hasClass("task-assign")){$("#taskform .taskform-btn-save").html(L.TASKFORM_SAVE);$(".taskform-autoc").hide()}}if($token_size<maxsize){$input.removeClass("cant")}$(document).unbind(".delitem")}}});return false})})};$.fn.taskForm_clickX=function(){return this.each(function(){$(this).click(function(e){e.stopPropagation();var $meta=$(this).closest(".meta");var $meta_wrap=$meta.find(".meta-wrap");var $input=$meta.find(".meta-input");var $auto_input=$meta.find(".autocomp-input");if($meta.hasClass("task-title")){$("#taskform .taskform-btn-save").addClass("disabled");$input.val("").trigger("focus")}else{if($meta.hasClass("task-assign")){$("#taskform .taskform-btn-save").html(L.TASKFORM_SAVE);$meta.find('.token:not(".cant")').remove();$(".taskform-autoc").hide()}else{if($meta.hasClass("task-reminder")){$meta.find(".popup li:not(:first)").remove();$meta.find(".popup li:first .reminder").val("10");$input.val("");$("#taskform .task-reminder .meta-default-text").show();$("#taskform .task-reminder .popup").hide();$(document).unbind(".reminderPopup")}else{if($meta.hasClass("task-deadline")){$input.val("");$("#taskform .task-deadline .meta-default-text").show();$("#taskform .task-deadline .popup").hide()}else{if($meta.hasClass("smart")){$meta.find(".token").remove();$meta_wrap.removeAttr("style");$auto_input.val("").trigger("focus").removeClass("cant")}else{if($meta.hasClass("task-notes")){$input.val("").removeAttr("style");$input.val("").trigger("focus")}else{$input.val("").trigger("focus")}}}}}}if($meta.find(".token").length<1){$(this).hide()}})})};GTD.Taskform.isExist=function(selected,meta){var $token=meta.find(".token");var s_name=selected.attr("name");var isexist=false;$token.each(function(){if($(this).attr("name")==s_name){isexist=true}});return isexist};GTD.Taskform.removeNoContacts=function(){var contacts=Do.objClone(Doit.contacts);for(var i=0;i<contacts.length;i++){var contact=contacts[i];if(contact.status=="waiting"){contacts.splice(i,1);i--}}return contacts};GTD.Taskform.checkToday=function(time1){if(time1==null){return false}if(typeof time1=="object"){time1=time1.format("yyyy/mm/dd")}else{time1=time1.split(" ")[0]}time1=new Date(time1.replace(/-/g,"/"));var time2=new Date(Doit.time.format("yyyy/mm/dd"));var getTime1=time1.getTime();var getTime2=time2.getTime();if(getTime1<=getTime2){return true}else{return false}};$.fn.setTaskBoxByChanageStartAt=function(date){if(date==null){return}var A=$(this);var box_li=$("#taskform .task-starttime .left li");var now=Time.setTodayDateToLocalDate();var tomorrow=Time.userDay(now);var dayat=Time.userDay(now);date=Time.setDateToLocalDate(date);tomorrow.setDate(tomorrow.getDate()+1);dayat.setDate(dayat.getDate()+2);if(date.getTime()<tomorrow.getTime()){box_li.removeClass("select");box_li.filter('[data-id="today"]').addClass("select");return A.attr("data-id","today").text(L.TODAY)}else{if(date.getTime()>=tomorrow.getTime()&&date.getTime()<dayat.getTime()){box_li.removeClass("select");box_li.filter('[data-id="tomorrow"]').addClass("select");return A.attr("data-id","tomorrow").text(L.TOMORROW)}else{if(date.getTime()>=dayat.getTime()){box_li.removeClass("select");box_li.filter('[data-id="scheduled"]').addClass("select");return A.attr("data-id","scheduled").text(L.SCHEDULED)}}}};GTD.Taskform.setDataByDatepicker=function(obj,date,input){if($("#taskform_allday").is("checked")){date=date.split(" ")[0]}if($(input).hasClass("task-start-at")){$(".task-starttime .box").setTaskBoxByChanageStartAt(new Date(date.replace(/-/g,"/")));$(".repeat_start_at").val(date)}else{if($(input).hasClass("task-end-at")){}}};GTD.Taskform.save=function(){$("#taskform .taskform-btn-save").addClass("disabled");var _newTask=GTD.Taskform.getData();if(GTD.Taskform.type=="add"){$.ajax.createTask({data:GTD.Taskform.data,onSuccess:function(resp){if(Doit.currentBox=="calendar"){CA.rebuildDayTasks()}else{var data=GTD.Taskform.data;GTD.taskEscapeHTML(_newTask);GTD.updateTags();TASKS.push(_newTask);var today=new Date(Doit.time);today=Time.userDay(today);var task_box=GTD.getTaskBox(data);var box=Doit.currentBox;if(GTD.isIn(data,Doit.currentBox)){var mode=Doit.currentGroupBy;GTD.group.addNewTask(data,mode)}if(GTD.isToday(data)||GTD.isInRepeat(today,data)){GTD.increaseCount($("#today"))}if(GTD.isInbox(data)){GTD.increaseCount($("#inbox"))}var box=GTD.getTaskBox(data);if(Doit.currentBox!=box){$("div#sidebar li#"+box).effect("highlight",{color:"#0069bc"},500)}TASKS_FILTER=TASKS;if(GTD.Taskform.data.assignment==null){GTD.M(L.TIPS_TASK_ADDED_OK)}else{GTD.M(L.TASKFORM_TASK_SEND_OK)}}if(GTD.Taskform.addTaskDueToday){GTD.M(L.I_TASK_ADD_DUETODAY)}GTD.overlay.remove();$("#taskform").fadeOut("fast",function(){$(this).removeAttr("style")})},onError:function(resp){if(Do.parseJSON(resp.responseText).retcode=="E028"){var E028=L.E028}else{var E028=""}$("#taskform .taskform-btn-save").removeClass("disabled");if($(".task-assign .token-items li").length==1){GTD.M(L.AJAX_TASK_ADDING_FAILED+E028,"error")}else{GTD.M(L.TASKFORM_TASK_SEND_FALSE+E028,"error")}},onFailure:function(resp){$("#taskform .taskform-btn-save").removeClass("disabled");if($(".task-assign .token-items li").length==1){GTD.M(L.AJAX_TASK_ADDING_FAILED+E028,"error")}else{GTD.M(L.TASKFORM_TASK_SEND_FALSE+E028,"error")}}})}else{Do.log("更新旧任务");$.ajax.updateTask({data:GTD.Taskform.data,onSuccess:function(resp){GTD.taskEscapeHTML(_newTask);var box=GTD.getTaskBox(GTD.Taskform.data);if(Doit.currentBox!=box){$("div#sidebar li#"+box).effect("highlight",{color:"#0069bc"},500)}if($(".taskList li").length==0){if(!GTD.isIn(_newTask,Doit.currentBox)){$("#sidebar .s").removeClass("s");$("#"+box).addClass("s");GTD.reduceCount();Doit.currentBox=box}GTD.updateTaskView(GTD.Taskform.data);GTD.updateTaskList(_newTask)}else{GTD.updateTags();GTD.updateTaskList(_newTask);_newTask.start_at=Time.anyToDateObj(_newTask.start_at);if(Doit.currentBox=="calendar"){CA.rebuildDayTasks()}else{if("contact"==Doit.currentBox){var node=GTD.updateTask(_newTask);node.effect("highlight",1000)}else{if("search"==Doit.currentBox||Doit.currentBox=="smartbox"||GTD.isIn(_newTask,Doit.currentBox)||GTD.isRepeatTask(_newTask,Doit.currentBox)){var node=GTD.updateTask(_newTask);node.effect("highlight",1000)}else{if(GTD.isTodayJS(_newTask)||GTD.isRepeatTask(_newTask,"today")){GTD.increaseCount($("#today"))}if(GTD.isInbox(_newTask)){GTD.increaseCount($("#inbox"))}GTD.removeTask(_newTask)}}}var ts=_newTask.tags==undefined?"":_newTask.tags;GTD.updateTaskView(GTD.Taskform.data);if($('.task-assign .token-items li:not(".cant")').length>1){GTD.M(L.TASKFORM_TASK_SEND_OK)}else{GTD.M(L.TIPS_TASK_UPDATE_OK)}if(GTD.Taskform.addTaskDueToday){GTD.M(L.I_TASK_ADD_DUETODAY)}}GTD.overlay.remove();$("#taskform").fadeOut("fast",function(){$(this).removeAttr("style")})},onError:function(){if(Do.parseJSON(resp.responseText).retcode=="E028"){var E028=L.E028}else{var E028=""}$("#taskform .taskform-btn-save").removeClass("disabled");if($('.task-assign .token-items li:not(".cant")').length==1){GTD.M(L.AJAX_TASK_ADDING_FAILED+E028,"error")}else{GTD.M(L.TASKFORM_TASK_SEND_FALSE+E028,"error")}},onFailure:function(resp){$("#taskform .taskform-btn-save").removeClass("disabled");if($('.task-assign .token-items li:not(".cant")').length==1){GTD.M("任务更新失败！","error")}else{GTD.M(L.TASKFORM_TASK_SEND_FALSE,"error")}}},"")}};GTD.Taskform.getData=function(){if(GTD.Taskform.type=="add"){var uuid=Do.randomUUID();var uuid_b=new Do.Base64();var uuid_base64=uuid_b.encode(uuid);GTD.Taskform.data={repeat_no:null,repeater:null,all_day:true,forwarded_by:null,completed:null,trashed:null,deleted:null,archived:null,id:uuid_base64,title:"干嘛不添加标题?",start_at:null,end_at:null,notes:"",context_id:null,project_id:null,priority:0,tags:[],reminders:[],attribute:"inbox",assignment:null}}var title=$.trim($("#taskform .task-title .meta-input").val());if(title!=""){GTD.Taskform.data.title=title}if($("#taskform .taskform-allday").length==1){if($("#taskform_allday").attr("checked")){GTD.Taskform.data.all_day=true}else{GTD.Taskform.data.all_day=false}}if($("#taskform .task-starttime").length==1){var box=$("#taskform .task-starttime .box").attr("data-id");if(box!=null){switch(box){case"inbox":GTD.Taskform.data.attribute="inbox";break;case"today":GTD.Taskform.data.attribute="plan";break;case"next":GTD.Taskform.data.attribute="next";break;case"tomorrow":GTD.Taskform.data.attribute="plan";break;case"scheduled":GTD.Taskform.data.attribute="plan";break;case"someday":GTD.Taskform.data.attribute="noplan";break;case"waiting":GTD.Taskform.data.attribute="waiting";break;default:GTD.Taskform.data.attribute="plan";Do.log("WTF!")}}var start_at=$("#taskform .task-starttime .meta-input").val();if(start_at!=""){start_at=GTD.setDateTime(start_at);GTD.Taskform.data.start_at=start_at}else{GTD.Taskform.data.start_at=null}}if($("#taskform .task-deadline").length==1){var end_at=$("#taskform .task-deadline .meta-input").val();if(end_at!=""){if(box!="next"&&box!="waiting"){end_at=GTD.setDateTime(end_at);GTD.Taskform.data.end_at=end_at;var end=$("#taskform .task-deadline .meta-input").val();var duetoday=GTD.Taskform.checkToday(end);if(start_at==""&&duetoday){GTD.Taskform.addTaskDueToday=true;GTD.Taskform.data.attribute="plan";GTD.Taskform.data.start_at=end_at}else{GTD.Taskform.addTaskDueToday=false}}else{end_at=GTD.setDateTime(end_at);GTD.Taskform.data.end_at=end_at;GTD.Taskform.addTaskDueToday=false}}else{GTD.Taskform.data.end_at=null}}if($("#taskform .task-project .token").length){var project=$.trim($("#taskform .task-project .token div").text());var project_id=GTD.findUUIDByName(Doit.projects,Do.escapeHTML(project));GTD.Taskform.data.project_id=project_id}else{GTD.Taskform.data.project_id=null}if($("#taskform .task-context").length==1){if($("#taskform .task-context .token").length){var context=$.trim($("#taskform .task-context .token div").text());var context_id=GTD.findUUIDByName(Doit.contexts,Do.escapeHTML(context));GTD.Taskform.data.context_id=context_id}else{GTD.Taskform.data.context_id=null}}var notes=$.trim($("#taskform .task-notes .meta-input").val());if(notes!=""){GTD.Taskform.data.notes=notes}else{GTD.Taskform.data.notes=""}if($("#taskform .task-tags").length==1){if($("#taskform .task-tags .token-items li").length>1){var tags=[];var tag_text=$("#taskform .task-tags .token div");tag_text.each(function(){tags.push($(this).text())});GTD.Taskform.data.tags=tags}else{GTD.Taskform.data.tags=[]}}if($("#taskform .task-assign .token").length>0){if(GTD.Taskform.data.assignment==null){GTD.Taskform.data.assignment={};if("inbox"==box){GTD.Taskform.data.assignment.attribute="inbox"}else{if("next"==box){GTD.Taskform.data.assignment.attribute="next"}else{if("today"==box){GTD.Taskform.data.assignment.attribute="plan"}else{if("waiting"==box){GTD.Taskform.data.assignment.attribute="waiting"}else{if("tomorrow"==box){GTD.Taskform.data.assignment.attribute="plan"}else{if("scheduled"==box){GTD.Taskform.data.assignment.attribute="plan"}else{if("someday"==box){GTD.Taskform.data.assignment.attribute="noplan"}}}}}}}}var contacts=[];var contact_items=$("#taskform .task-assign .token");contact_items.each(function(){var email=$(this).attr("email");var contact=new Object();contact.contact=email;contacts.push(contact)});GTD.Taskform.data.assignment.items=contacts;GTD.Taskform.data.attribute="waiting";GTD.Taskform.data.context=null;if($("#taskform_autoc").attr("checked")){GTD.Taskform.data.assignment.autocomplete="ACAAC"}else{GTD.Taskform.data.assignment.autocomplete=""}}if($("#taskform .task-reminder").length==1){var reminders=GTD.Taskform.getReminder();GTD.Taskform.data.reminders=reminders}if(GTD.Taskform.data.start_at!=null){if($("#taskform .task-repeat").length==1){var repeater=GTD.Taskform.getRepeat();GTD.Taskform.data.repeater=repeater}}else{GTD.Taskform.data.repeater=null}var priority=Do.parseInt($("#taskform .task-priority .meta-input").attr("data-id"));GTD.Taskform.data.priority=priority;return GTD.Taskform.data};GTD.Taskform.getReminder=function(){var $meta=$("#taskform .task-reminder");var input=$("#taskform .task-reminder .meta-input").val();if(input==""){return[]}if($meta.hasClass("disabled")){return[]}var A=$("#taskform .task-reminder .popup li");var arr=[],reminder,B,time,remind;A.each(function(i){if($(this).attr("data-type")=="relative"){reminder=new Object();reminder.view="relative";B=$(this);time=$.trim(B.find(".reminder").val());if(!Do.isEmptyStr(time)){reminder.mode=B.find(".type").val();var unit=B.find(".unit").val();reminder.sent=false;if(typeof(GTD.Taskform.data.start_at)=="string"){var start_at=new Date(GTD.Taskform.data.start_at.replace(/-/g,"/"))}else{var start_at=GTD.Taskform.data.start_at}reminder.time=GTD.remindMath(time,unit,start_at);arr.push(reminder)}}else{reminder=new Object();reminder.view="absolute";B=$(this);time=$.trim(B.find(".nlinput").val());time=time+" "+Time.zoneToString(Do.cookie("user_timezone"));reminder.mode=B.find(".type").val();reminder.sent=false;reminder.time=time;arr.push(reminder)}});return arr};GTD.remindMath=function(_time,unit,start_at){var start=new Date(start_at);var min=start.getMinutes();var hour=start.getHours();var day=start.getDate();var time=eval(_time);switch(unit){case"min":start.setMinutes(min-time);break;case"hour":start.setHours(hour-time);break;case"day":start.setDate(day-time);break;default:Do.log("恭喜您中奖了!")}return start};GTD.Taskform.getRepeat=function(){if(GTD.Taskform.data.start_at==null||$("#taskform .task-repeat .meta-input").val()==""){GTD.Taskform.data.repeater=null;return GTD.Taskform.data.repeater}var repeater={};var repeat_mode=$("#taskform .task-repeat .popup .type").val();repeater.mode=repeat_mode;var repeat_div=$("#repeat_"+repeat_mode);switch(repeat_mode){case"daily":repeater.cycle=repeat_div.find(".repeat-cycle").val();repeater.date=null;repeater.day=null;if(repeat_div.find(".repeat_end_at").val()!=L.END_TIME){repeater.ends_on=GTD.setDateTime(repeat_div.find(".repeat_end_at").val())}else{repeater.ends_on=null}repeater.month=null;repeater.week=null;break;case"weekly":weeks=repeat_div.find(".repeat-cycle").val();if(repeat_div.find(".repeat_end_at").val()!=L.END_TIME){ends_on=GTD.setDateTime(repeat_div.find(".repeat_end_at").val())}else{ends_on=null}var ds=[];repeat_div.find('input[value="on"]').each(function(i){ds.push(Do.parseInt($(this).parent().attr("data-id")))});repeater={mode:"weekly",cycle:weeks,month:null,week:null,date:null,day:ds.toString(),ends_on:ends_on};break;case"monthly":var repeats_by,start_day;months=repeat_div.find(".repeat-cycle").val();function getLastDay(date){var ymd=date.format("yyyy-mm-dd");var year=ymd.split("-")[0];var month=ymd.split("-")[1];var last=new Date(year,month,0);return last.getDate()}function getFirstDay(date){var ymd=date.format("yyyy-mm-dd");var year=ymd.split("-")[0];var month=ymd.split("-")[1]+1;var firstDay=new Date(year,month,1);return firstDay.getDay()}if($("#repeat_monthly").find('input:checked[name="repeat_monthly_type"]').attr("id")=="repeat_monthly_day"){var lastday=$("#repeat_monthly .repeat-monthly-type").attr("data-days");start_day=$("#repeat_monthly .repeat-monthly-type").val();var n=lastday-start_day;if(n==0){start_day=-1}else{if(n==1){start_day=-2}else{if(n==2){start_day=-3}else{}}}repeats_by="monthday"}else{if($("#repeat_monthly").find('input:checked[name="repeat_monthly_type"]').attr("id")=="repeat_monthly_date"){var week=$("#taskform .repeat-monthly-o").val();var current=$("#taskform .repeat-monthly-w").val();repeats_by="weekday"}}if(repeat_div.find(".repeat_end_at").val()!=L.END_TIME){ends_on=GTD.setDateTime(repeat_div.find(".repeat_end_at").val())}else{ends_on=null}if(repeats_by=="monthday"){repeater={mode:"monthly",cycle:months,month:null,day:null,week:null,date:start_day.toString(),ends_on:ends_on}}else{repeater={mode:"monthly",cycle:months,ends_on:ends_on,month:null,week:week.toString(),day:current.toString(),date:null}}break;case"weekday":if(repeat_div.find(".repeat_end_at").val()!=L.END_TIME){ends_on=GTD.setDateTime(repeat_div.find(".repeat_end_at").val())}else{ends_on=null}repeater={mode:"weekly",cycle:1,month:null,week:null,date:null,day:"1,2,3,4,5",ends_on:ends_on};break;case"yearly":function getLastDay(date){var ymd=date.format("yyyy-mm-dd");var year=ymd.split("-")[0];var month=ymd.split("-")[1];var last=new Date(year,month,0);return last.getDate()}var date=GTD.Taskform.data.start_at;var lastday=getLastDay(date);var start_day=GTD.Taskform.data.start_at.getDate();var n=lastday-start_day;if(n==0){start_day=-1}else{if(n==1){start_day=-2}else{if(n==2){start_day=-3}else{}}}years=repeat_div.find(".repeat-cycle").val();if(repeat_div.find(".repeat_end_at").val()!=L.END_TIME){ends_on=GTD.setDateTime(repeat_div.find(".repeat_end_at").val())}else{ends_on=null}var month=GTD.Taskform.data.start_at.getMonth();repeater={mode:"yearly",cycle:years,month:month,week:null,day:null,date:start_day.toString(),ends_on:ends_on};break;default:repeater=null}return repeater};GTD.Taskform.setRepeatMonthly=function(repeater){function setDate(){var date=$("#task_start_at").val().split("-");var m=date[1];var y=date[0];var d=date[2];var ds=new Date(y,m,0).getDate();var option_str="";for(i=1;i<=ds;i++){option_str+='<option value="'+i+'">'+i+"</optioin>"}if(repeater!=null&&repeater.date!=null){$("#repeat_monthly_day").trigger("click");d=repeater.date;switch(d){case"-3":d=ds-2;break;case"-2":d=ds-1;break;case"-1":d=ds;break;default:break}}$("#taskform .repeat-monthly-type").attr("data-days",ds).html(option_str).val(d)}function setWeek(){var date=$("#task_start_at").val();date=GTD.setDateTime(date);var current=date.getDay();var week;var month_week=GTD.getMonthWeekByDay(date);week=month_week.num;if(week==5){week=-1}if(repeater!=null&&repeater.week!=null){$("#repeat_monthly_date").trigger("click");week=repeater.week;current=repeater.day}$("#taskform .repeat-monthly-o").val(week);$("#taskform .repeat-monthly-w").val(current)}setDate();setWeek()};GTD.Taskform.getRepeatMode=function(){var $meta=$("#taskform .task-repeat");var repeat_mode=$("#taskform .task-repeat .popup .type").val().toUpperCase();$meta.find(".meta-default-text").hide();var start_at=$("#taskform .task-starttime .meta-input").val();GTD.Taskform.data=GTD.Taskform.data==null?{}:GTD.Taskform.data;if(start_at!=""){GTD.Taskform.data.start_at=GTD.setDateTime(start_at)}else{GTD.Taskform.data.start_at=null}$meta.find(".meta-input").val(" ");var repeater=GTD.Taskform.getRepeat();$(".task-repeat .meta-input").data("repeater",repeater);var repeater_str=GTD.getRepeatStr(repeater,GTD.Taskform.data.start_at);$meta.find(".meta-input").val(repeater_str);$meta.find(".popup").hide();$meta.find(".clear-this").show()};Time.getDateOrDatetime=function(datetime){if(datetime.split(" ").length>1&&datetime.split(" ")[1]=="00:00"){return datetime.split(" ")[0]}return datetime};Time.anyToDateObj=function(date){if(typeof(date)=="string"){date=Time.strToDateObject(date)}return date};GTD.Taskform.setSelectValue=function(type){switch(type){case"context":var select_id=GTD.Context.selection_context_id;if(select_id!=null&&select_id!="none"&&select_id!="all"){$("#taskform .task-context .meta-default-text").hide();$("#taskform .task-context .clear-this").show();var context=GTD.findNameByUUID(Doit.contexts,select_id);var context_node=$('<li class="token"><div title="'+context+'">'+context+"</div></li>");context_node.taskForm_delSelect($("#taskform .task-context"),1);$("#taskform .task-context .token-items").prepend(context_node)}break;case"project":var select_id=GTD.Project.selection_project_id;if(select_id!=null&&select_id!="none"&&select_id!="all"){$("#taskform .task-project .meta-default-text").hide();$("#taskform .task-project .clear-this").show();var project=GTD.findNameByUUID(Doit.projects,select_id);var project_node=$('<li class="token"><div title="'+project+'">'+project+"</div></li>");project_node.taskForm_delSelect($("#taskform .task-project"),1);$("#taskform .task-project .token-items").prepend(project_node)}break;default:Do.log("What?")}};$.fn.taskForm_setDefaultDataByCurrentBox=function(box,task){var A=$(this);var task_box=A.find(".box");var popup_box=A.find(".left");if(task!=null&&!$.isEmptyObject(task)){box=GTD.getTaskTimeBox(task)}$("#taskform .task-starttime .meta-default-text").hide();switch(box){case"inbox":task_box.attr("data-id","inbox").html(L.INBOX);popup_box.find('li[data-id="inbox"]').addClass("select");GTD.Taskform.disableNoStartat(true);break;case"next":task_box.attr("data-id","next").html(L.NEXT);popup_box.find('li[data-id="next"]').addClass("select");GTD.Taskform.disableNoStartat(true);break;case"today":var today=Time.userDay(GTD.setDateTime(Doit.time.format("yyyy-mm-dd HH:MM")));if(task==null){$("#taskform .task-starttime .meta-input,#taskform .repeat_start_at").val(Time.userDayStr(today));$(".repeat_start_at").html(Time.userDayStr(today))}task_box.attr("data-id","today").html(L.TODAY);popup_box.find('li[data-id="today"]').addClass("select");break;case"waiting":task_box.attr("data-id","waiting").html(L.WAITING_FOR);popup_box.find('li[data-id="waiting"]').addClass("select");GTD.Taskform.disableNoStartat(true);break;case"tomorrow":var tomorrow=Time.userDay(GTD.setDateTime(Doit.time.format("yyyy-mm-dd HH:MM")));tomorrow.setDate(tomorrow.getDate()+1);if(task==null){$("#taskform .task-starttime .meta-input,#taskform .repeat_start_at").val(Time.userDayStr(tomorrow));$(".repeat_start_at").html(Time.userDayStr(tomorrow))}task_box.attr("data-id","tomorrow").html(L.TOMORROW);popup_box.find('li[data-id="tomorrow"]').addClass("select");break;case"scheduled":var day=Time.userDay(GTD.setDateTime(Doit.time.format("yyyy-mm-dd HH:MM")));day.setDate(day.getDate()+2);if(task==null){$("#taskform .task-starttime .meta-input,#taskform .repeat_start_at").val(Time.userDayStr(day));$(".repeat_start_at").html(Time.userDayStr(day))}task_box.attr("data-id","scheduled").html(L.SCHEDULED);popup_box.find('li[data-id="scheduled"]').addClass("select");break;case"someday":task_box.attr("data-id","someday").html(L.SOMEDAY);popup_box.find('li[data-id="someday"]').addClass("select");GTD.Taskform.disableNoStartat(true);break;case"project":GTD.Taskform.setSelectValue("project");task_box.attr("data-id","inbox").html(L.INBOX);popup_box.find('li[data-id="inbox"]').addClass("select");GTD.Taskform.disableNoStartat(true);break;case"context":GTD.Taskform.setSelectValue("context");task_box.attr("data-id","inbox").html(L.INBOX);popup_box.find('li[data-id="inbox"]').addClass("select");GTD.Taskform.disableNoStartat(true);break;case"completed":task_box.attr("data-id","inbox").html(L.INBOX);popup_box.find('li[data-id="inbox"]').addClass("select");GTD.Taskform.disableNoStartat(true);break;case"trash":task_box.attr("data-id","inbox").html(L.INBOX);popup_box.find('li[data-id="inbox"]').addClass("select");GTD.Taskform.disableNoStartat(true);break;case"calendar":break;default:task_box.attr("data-id","inbox").html(L.INBOX);popup_box.find('li[data-id="inbox"]').addClass("select");GTD.Taskform.disableNoStartat(true)}};GTD.Taskform.setData=function(data){Do.log("当前编辑的任务数据↓");Do.log(data);$("#taskform .toggle").removeClass("toggle");$("#taskform .taskform-foot").remove();$("#taskform .taskform-btn-save").removeClass("disabled");var title=Do.unescapeHTML(data.title);$("#taskform .task-title .meta-default-text").hide();$("#taskform .task-title .clear-this").show();$("#taskform .task-title .meta-input").val(title);$("#taskform .task-starttime").taskForm_setDefaultDataByCurrentBox(Doit.currentBox,data);var start_at=data.start_at;if(start_at!=null){var start_val=Time.strToDatetimeStr(start_at);if(data.all_day==true){start_val=start_val.split(" ")[0]}$("#taskform .task-starttime .meta-default-text").hide();$("#taskform .task-starttime .meta-input").val(start_val);$(".repeat_start_at").html(start_val);GTD.Taskform.disableNoStartat(false)}else{GTD.Taskform.disableNoStartat(true)}var deadline=data.end_at;if(deadline!=null){var end_val=Time.strToDatetimeStr(deadline);if(data.all_day==true){end_val=end_val.split(" ")[0]}$("#taskform .task-deadline .meta-default-text").hide();$("#taskform .task-deadline .clear-this").show();$("#taskform .task-deadline .meta-input").val(Time.getDateOrDatetime(end_val))}if(data.all_day==true){$("#taskform_allday").attr("checked","checked")}else{$("#taskform_allday").removeAttr("checked")}var project=GTD.findNameByUUID(Doit.projects,data.project_id);if(project!=null){$("#taskform .task-project .meta-default-text").hide();$("#taskform .task-project .clear-this").show();var project_node=$('<li class="token"><div title="'+project+'">'+project+"</div></li>");project_node.taskForm_delSelect($("#taskform .task-project"),1);$("#taskform .task-project .token-items").prepend(project_node);$("#taskform .task-project .autocomp-input").addClass("cant")}var notes=data.notes;if(notes!=""){notes=Do.unescapeHTML(notes);$("#taskform .task-notes .meta-default-text").hide();$("#taskform .task-notes .clear-this").show();$("#taskform .task-notes .meta-input").val(notes);$("#taskform .task-notes .textarea-tmp").html(notes.replace(/\n/gi,"<br />"));var note_h=$("#taskform .task-notes .textarea-tmp").height();if(note_h>100){$("#taskform .task-notes .meta-input").addClass("min-h")}else{$("#taskform .task-notes .meta-input").css({"min-height":note_h+"px"})}}else{if(GTD.Taskform.type=="sent"||GTD.Taskform.type=="received"){$("#taskform .task-notes").hide()}}var context=GTD.findNameByUUID(Doit.contexts,data.context_id);if(context!=null){$("#taskform .task-context .meta-default-text").hide();$("#taskform .task-context .clear-this").show();var context_node=$('<li class="token"><div title="'+context+'">'+context+"</div></li>");context_node.taskForm_delSelect($("#taskform .task-context"),1);$("#taskform .task-context .token-items").prepend(context_node);$("#taskform .task-context .autocomp-input").addClass("cant")}var tags=data.tags;var tags_length=tags.length;if(tags_length>0){$("#taskform .task-tags .meta-default-text").hide();$("#taskform .task-tags .clear-this").show();if(tags_length==5){$("#taskform .task-tags .autocomp-input").addClass("cant")}$.each(tags,function(i){var tag_node=$('<li class="token"><div title="'+tags[i]+'">'+tags[i]+"</div></li>");tag_node.taskForm_delSelect($("#taskform .task-tags"),5);$("#taskform .task-tags .token-items").prepend(tag_node)})}var assign=data.assignment;if(assign!=null){var assing_items=assign.items;$("#taskform .task-assign .meta-default-text").hide();$("#taskform .task-assign .clear-this").show();$.each(assing_items,function(i){var assign_contact=assing_items[i].contact;var name=GTD.find_contact_name_by_user_email(assign_contact);var assign_node=$('<li class="token cant" title="'+name+'" email="'+assign_contact+'"><div title="'+Do.unescapeHTML(name)+"("+assign_contact+')">'+name+"</div></li>");assign_node.taskForm_delSelect($("#taskform .task-assign"),100);$("#taskform .task-assign .token-items").prepend(assign_node)});var autoc=assign.autocomplete;if(autoc==""){$("#taskform_autoc").attr("checked","")}}else{$("#taskform_autoc").attr("checked","")}var priority=data.priority;var priority_txt=L["TASK_PRI_NUM"+priority];$("#taskform .task-priority .meta-input").val(priority_txt).attr("data-id",priority);GTD.Taskform.setReminder(data.reminders);GTD.Taskform.setRepeater(data.repeater,data.start_at);if(data.repeat_no!=null){$(".task-repeat").addClass("disabled");$(".task-repeat .meta-default-text").html(L.TIPS_REPEAT_CHILD_CANT_SET)}};GTD.Taskform.setReminder=function(reminds){if(reminds.length==0){return}$(".task-reminder .clear-this").show();for(i=0;i<reminds.length;i++){if(i!=0){$(".task-reminder .add").trigger("click")}var item=reminds[i];var view=item.view;if(view=="relative"){var start_at=GTD.Taskform.data.start_at;var time=item.time;if(typeof(time)=="string"){time=Time.strToDatetimeStr(time).replace(/-/g,"/")}if(typeof(start_at)=="string"){start_at=Time.strToDatetimeStr(start_at).replace(/-/g,"/")}var math_time=GTD.remindMathBack(time,start_at);time=math_time.time;var uuid=item.id;var mode=item.mode;var unit=math_time.unit;var $obj=$(".task-reminder .popup li:eq("+i+")");$obj.find(".reminder").val(time);var unit_text=$obj.find(".unit").val(unit);var mode_text=$obj.find(".type").val(mode)}else{var time=item.time.substr(0,16);var mode=item.mode;var $obj=$(".task-reminder .popup li:eq("+i+")");$obj.attr("data-type","absolute");$obj.find(".reminder").hide();$obj.find(".nlinput").show().val(time);var unit_text=$obj.find(".unit").val("ondate");var mode_text=$obj.find(".type").val(mode)}}var str="";$(".task-reminder li").each(function(){var val=$.trim($(this).find(".text").val());var reminder_type=$(this).attr("data-type");if(reminder_type=="relative"){if(val!=""){var num=Do.parseInt($(this).find(".text").val());var unit=$(this).find(".unit").val();var type=$(this).find(".type").val();str+=L.AHEAD_CN+num+L.WORDSPACE+L[unit.toUpperCase()]+L.AHEAD_EN+"("+L["REMINDER_"+type.toUpperCase()]+");"}}else{if(val!=""){var reminder_time=$(this).find(".nlinput").val();var type=$(this).find(".type").val();str+=reminder_time+"("+L["REMINDER_"+type.toUpperCase()]+");"}}});if(!$("#taskform .task-reminder").hasClass("disabled")){$("#taskform .task-reminder .meta-default-text").hide()}$("#taskform .task-reminder .meta-input").val(str)};GTD.Taskform.setRepeater=function(repeater,start_at){if(repeater==null){return}var mode=repeater.mode;var cycle=repeater.cycle;var ends_on=repeater.ends_on;if(repeater.day!=null){var day=repeater.day.split(",")}var week=repeater.week;$(".task-repeat .type").val(mode);$("#repeat_daily").hide();$("#repeat_"+mode).show().find(".repeat-cycle").val(cycle);if(ends_on!=null){ends_on=Time.strToDate(repeater.ends_on).format("yyyy-mm-dd");$("#repeat_"+mode).find(".repeat_end_at").val(ends_on)}if(mode=="weekly"){if(day.length>0){for(i=0;i<day.length;i++){$("#repeat_"+mode).find('.task-repeat-box div[data-id="'+day[i]+'"]').addClass("checked").find("input").val("on")}}}else{if(mode=="monthly"){$(".task-repeat .meta-input").data("repeater",repeater);GTD.Taskform.setRepeatMonthly(repeater)}}var $meta=$("#taskform .task-repeat");$meta.find(".meta-default-text").hide();var repeater_str=GTD.getRepeatStr(repeater,start_at);$meta.find(".meta-input").val(repeater_str);$meta.find(".clear-this").show()};GTD.Taskform.newContext=function(val){var data={};var uuid=Do.randomUUID();var uuid_b=new Do.Base64();var uuid_base64=uuid_b.encode(uuid);data.deleted=null;data.id=uuid_base64;data.created=Doit.time;data.name=Do.unescapeHTML(val);data.group_by=null;var li=$('<li class="sub-box" uuid="'+data.id+'"></li>');$.ajax.createContext({data:data,onSuccess:function(reps){data.name=Do.escapeHTML(data.name);GTD.addToArray(data,Doit.contexts);if(Doit.currentBox=="context"){li.attr("uuid",data.id).attr("id","s_context_"+encodeURIComponent(data.id)).attr("data-name",data.name).attr("title",Do.unescapeHTML(data.name)).append('<a class="side-item" href="#/context/'+data.id+'" id="'+data.id+'">'+data.name+"</a>");var $cl=$("#context_list");if($cl.get(0).scrollHeight-$cl.get(0).clientHeight>0){var clbg=$cl.css("background");$cl.css({background:"#fff"});$cl.append(li.fadeIn(function(){$cl.css({background:clbg})}));$cl.scrollTop(5000)}else{$cl.append(li.fadeIn())}li.ellipsis();li.data("data",data);window.location="#/context/"+data.id;li.contextBox();li.bind("dblclick",function(e){GTD.Context.editContext(li)})}Doit.contexts_smart=[];$.each(Doit.contexts,function(i,item){Doit.contexts_smart.push(Do.unescapeHTML(item.name))});$.smartAdd.setRules({flag:"@",list:Doit.contexts_smart,repeat:false,hr:-1})},onError:function(reps){GTD.M(L.AJAX_CONTEXT_ADDING_FAILED,"error")},onFailure:function(reps){GTD.M(L.AJAX_CONTEXT_ADDING_FAILED,"error")}})};GTD.Taskform.newProject=function(val){var data={};var uuid=Do.randomUUID();var uuid_b=new Do.Base64();var uuid_base64=uuid_b.encode(uuid);data.deleted=null;data.created=Doit.time;data.id=uuid_base64;data.name=Do.unescapeHTML(val);data.group_by="box";var li=$('<li class="sub-box" uuid="'+data.id+'"><a class="side-item" href="#/project/'+data.id+'" id="'+data.id+'"><div class="checkbox" title="'+L.COMPLETE_PROJECT+'"></div></a></li>');data.completed=null;function afterPost(data){data.name=Do.escapeHTML(data.name);GTD.addToArray(data,Doit.projects);if(Doit.currentBox=="project"){li.attr("uuid",data.id).attr("id","s_project_"+encodeURIComponent(data.id)).attr("data-name",data.name).attr("title",Do.unescapeHTML(data.name)).find("a").attr("id",data.id).attr("href","#/project/"+data.id).append('<span class="title">'+data.name+"</span>");var $pl=$("#project_list");if($pl.get(0).scrollHeight-$pl.get(0).clientHeight>0){var clbg=$pl.css("background");$pl.css({background:"#fff"});$pl.append(li.fadeIn(function(){$pl.css({background:clbg})}));$pl.scrollTop(5000)}else{$pl.append(li.fadeIn())}li.find(".title").ellipsis();li.find(".checkbox").comProject();window.location="#/project/"+data.id;li.data("data",data);li.projectBox();li.bind("dblclick",function(e){GTD.Project.editProject(li)})}Doit.projects_smart=[];$.each(Doit.projects,function(i,item){Doit.projects_smart.push(Do.unescapeHTML(item.name))});$.smartAdd.setRules({flag:"#",list:Doit.projects_smart,repeat:false,hr:-1})}$.ajax.createProject({data:data,onSuccess:function(resp){afterPost(data)},onError:function(resp){var res=Do.parseJSON(resp.responseText);if(res.retcode=="E005"){data.id=res.online_data.id;afterPost(data)}},onFailure:function(resp){GTD.M(L.AJAX_PROJECT_ADDING_FAILED,"error")}})};GTD.Taskform.popup=function(type,data){window.onbeforeunload=function(){return"Want to leave this page?"};GTD.syncTime();GTD.Taskform.type=type;$("#taskform").html("").append(GTD.Taskform.node);GTD.Taskform.event();GTD.Taskform.init(type);GTD.Taskform.data=data;if(type!="add"){GTD.Taskform.setData(data)}else{$("#taskform .task-starttime").taskForm_setDefaultDataByCurrentBox(Doit.currentBox,null)}$(document).bind("keydown.escCancel",function(e){var keycode=e.keyCode;if(keycode==27){var close=true;if($(".popup:visible").length||$(".autocomplete:visible").length||$(".task-deadline .popup").css("display")=="block"){close=false}if(close){$("#taskform .taskform-btn-cancel").trigger("click");$("#taskform :focus").trigger("blur");$(document).unbind("keydown.escCancel");$(document).unbind("keydown.save")}else{$("#taskform :focus").trigger("blur");$(".popup,.autocomplete").hide()}}});$(document).bind("keydown.save",function(e){var keycode=e.keyCode;if((e.ctrlKey||e.metaKey)&&keycode==13){$("#taskform .taskform-btn-save").trigger("click");$(document).unbind("keydown.save")}});$("#taskform .task-title").bind("keydown",function(e){var keycode=e.keyCode;if(keycode==13){$("#taskform .taskform-btn-save").trigger("click");$("input:focus").trigger("blur");return false}})};GTD.Taskform.init=function(type){switch(type){case"add":break;case"edit":$(".taskform-title").text(L.EDIT_TASK);break;case"sent":$(".taskform-title").text(L.EDIT_TASK);$("#taskform .task-starttime,#taskform .task-deadline,#taskform .task-context,#taskform .task-repeat,#taskform .taskform-foot,#taskform .taskform-allday,#taskform .task-priority").remove();$("#taskform .task-assign").removeClass("toggle");$("#taskform .task-notes,#taskform .task-title").addClass("disabled").find(".meta-input").attr("disabled","disabled");$("#taskform .task-notes,#taskform .task-title").find(".clear-this").remove();break;case"received":$(".taskform-title").text(L.EDIT_TASK);$("#taskform .task-notes,#taskform .task-title").addClass("disabled").find(".meta-input").attr("disabled","disabled");$("#taskform .task-notes,#taskform .task-title").find(".clear-this").remove();break;default:break}var $taskform=$("#taskform");GTD.overlay.add(0);$taskform.show();$taskform.animate({opacity:1,left:"+=300"},500,function(){$("#taskform .task-title").trigger("click")})};$.each(["add","edit","sent","received"],function(i,v){GTD.Taskform["init_"+v]=function(){GTD.Taskform.init(v)}});GTD.Taskform.event=function(){$("#taskform").draggable({start:function(event,ui){GTD.disableSelection()},stop:function(event,ui){GTD.enableSelection()},handle:".taskform-head",cancel:".taskform-btn,.taskform-autoc",containment:"window"});$("#taskform li.meta:last").taskForm_tabBack();$("#taskform .meta").taskForm_clickToEdit();$("#taskform .meta .meta-input,#taskform .meta .autocomp-input,#taskform .meta textarea").taskForm_focusToEdit().taskForm_blurToNormal().taskForm_showXorNot();$("#taskform .task-repeat select.type").taskForm_repeatType();$("#repeat_monthly .repeat-on label").bind("click",function(){$("#repeat_monthly .repeat-on select").attr("disabled","disabled");$(this).next().find("select").removeAttr("disabled")});$(".datepicker:not('.task-end-at')").click(function(e){$("body").die("click.datepicker");if($("#dpDiv").length==0){$("#dpDiv").remove();GTD.showDate($(this))}else{$("#dpDiv").remove()}});$.fn.reminderDatepicker=function(){return this.each(function(){$(this).bind("click",function(e){e.stopPropagation();$("body").die("click.datepicker");if($("#dpDiv").length==0){$("#dpDiv").remove();GTD.showDate($(this))}else{$("#dpDiv").remove()}$("body").live("click.datepicker",function(evt){var $target=$(evt.target);if(($target.parents("#dpDiv").length==0)&&($target.parents(".taskform-allday").length==0)){$("#dpDiv").remove();$("body").die("click.datepicker")}})})})};$(".task-reminder .unset").bind("click",function(){$(".task-reminder .clear-this").trigger("click")});GTD.makeLeftGTRight=function(d,completeTime){var $dp=d;if(($("#task_start_at").val().split("-").length==3)){if(($dp.attr("id")=="task_start_at")||($dp.attr("id")=="task_end_at")){var rightTime=$("#task_end_at").val();var leftTime=$("#task_start_at").val();var tomorrowDateFormate=new Date(parseInt(leftTime.split(" ")[0].split("-")[0],10),parseInt(leftTime.split(" ")[0].split("-")[1],10)-1,parseInt(leftTime.split(" ")[0].split("-")[2],10)+1);var _tomorrow_year=tomorrowDateFormate.getFullYear();var _tomorrow_month=tomorrowDateFormate.getMonth()+1;var _tomorrow_date=tomorrowDateFormate.getDate();var _tomorrow_dateString=_tomorrow_year+"-"+makeUpZero(_tomorrow_month)+"-"+makeUpZero(_tomorrow_date);if(rightTime!=""&&leftTime>rightTime){var _hourTmp=parseInt($("#task_start_at").val().split(" ")[1].split(":")[0],10)+1;_hour=(_hourTmp==24?0:_hourTmp);if(_hour==0){$("#task_end_at").val(_tomorrow_dateString+" 00:00")}else{$("#task_end_at").val($("#task_start_at").val().split(" ")[0]+($("#task_start_at").val().split(" ")[1]?" "+makeUpZero(_hour)+":"+$("#task_start_at").val().split(" ")[1].split(":")[1]:""))}$("#task_start_at").data("realVal",$("#task_start_at").val());$("#task_end_at").data("realVal",$("#task_end_at").val());if($("#taskform_allday").attr("checked")){$("#task_end_at").val($("#task_start_at").val().split(" ")[0])}}if($("#taskform_allday").attr("checked")){$dp.val(completeTime.split(" ")[0]);$dp.data("realVal",completeTime)}}}else{if($("#taskform_allday").attr("checked")||$("#all_day_task_second").attr("checked")){$dp.val(completeTime.split(" ")[0]);$dp.data("realVal",completeTime)}}if($dp.hasClass("repeat_end_at")){$dp.val(completeTime.split(" ")[0])}};function makeUpZero(num){return num<10?("0"+num):num}$(".taskform-allday label").click(function(e){e.stopPropagation();function inputIsTime(t){if(t.split(" ")[0].split("-").length==3){return true}else{return false}}var now_hour=new Date(Doit.time).getHours();var now_year=new Date(Doit.time).getFullYear();var now_month=makeUpZero(parseInt(new Date(Doit.time).getMonth()+1,10));var now_date=makeUpZero(parseInt(new Date(Doit.time).getDate(),10));var now_hour_plus_one_time=makeUpZero(now_hour+1)+":00";var now_hour_plus_two_time=makeUpZero(now_hour+2)+":00";var now_all_time_hour_plus_one=now_year+"-"+now_month+"-"+now_date+" "+now_hour_plus_one_time;var now_all_time_hour_plus_two=now_year+"-"+now_month+"-"+now_date+" "+now_hour_plus_two_time;$(".datepicker:not(.reminder`)").each(function(){if($(this).val().split("-").length==3){if($(this).hasClass("task-start-at")){if($("#taskform_allday").attr("checked")){var _inputValAry=$(this).val().split(" ");if(_inputValAry.length==2){$(this).data("realVal",$(this).val())}if(_inputValAry[0].split("-").length==3){$(this).val(_inputValAry[0])}$("#date_time").addClass("date-time-disable");$("#date_time").unbind("click");$("#date_up").hide();$("#date_out_wrap").hide();$("#date_down").hide()}else{if($(this).data("realVal")==null){if(($(this).val().split("-").length==3)&&($(this).val().split(" ").length==1)){var now_hour=new Date(Doit.time).getHours();if((now_hour+1)==24){now_all_time_hour_plus_one=now_year+"-"+now_month+"-"+now_date+" 23:45";$(this).val(now_all_time_hour_plus_one)}else{$(this).val($(this).val()+" "+now_hour_plus_one_time)}}else{}}else{$(this).val($(this).data("realVal"))}$("#date_time").removeClass("date-time-disable");$("#date_time").toggle(function(){$("#date_up").show();$("#date_out_wrap").show();$("#date_down").show()},function(){$("#date_up").hide();$("#date_out_wrap").hide();$("#date_down").hide()})}}else{if($(this).hasClass("task-end-at")){if($("#taskform_allday").attr("checked")){var _inputValAry=$(this).val().split(" ");if(_inputValAry[0].split("-").length==3){$(this).val(_inputValAry[0])}GTD.showRightTimePan()}else{if($(this).data("realVal")==null){if(($(this).val().split("-").length==3)&&($(this).val().split(" ").length==1)){var now_hour=new Date(Doit.time).getHours();if((now_hour+2)==24){now_all_time_hour_plus_two=now_year+"-"+now_month+"-"+now_date+" 23:45";$(this).val(now_all_time_hour_plus_two)}else{$(this).val($(this).val()+" "+now_hour_plus_two_time)}}else{}}else{$(this).val($(this).data("realVal"))}GTD.hideRightTimePan()}}}}});GTD.Taskform.setDataByDatepicker(this,$(".task-start-at").val(),$(".task-start-at"))});GTD.Taskform.resetNotesHeight($("#taskform .meta textarea"));$("#taskform .taskform-foot").bind("click",function(){$(this).hide();$("#taskform .toggle").removeClass("toggle")});$("#taskform .task-reminder .add").taskForm_reminderAdd();$("#taskform .meta .autocomp-input").taskMetaAdd();$("#taskform .meta .clear-this").taskForm_clickX();$("#taskform .task-context .autocomp-input").taskForm_metaAutoComp({data:Doit.contexts,iswrap:true,createNew:L.TF_CONTEXT,callback:function(val){GTD.Taskform.newContext(val)}});$("#taskform .task-project .autocomp-input").taskForm_metaAutoComp({data:Doit.projects,iswrap:true,callback:function(val){GTD.Taskform.newProject(val)}});$("#taskform .task-tags .autocomp-input").taskForm_metaAutoComp({data:Doit.tags,iswrap:true,maxSize:5,automove:true,createNew:L.TF_TAG,callback:function(){}});var contacts_left=GTD.Taskform.removeNoContacts();$("#taskform .task-assign .autocomp-input").taskForm_metaAutoComp({data:contacts_left,iswrap:true,maxSize:100,automove:true,filters:["name","email"]});$(".repeat-cycle").isNumInputLargeThanZero();$(".task-repeat-box .checkbox").each(function(i,el){var $el=$(el);var $el_input=$(el).find("input[type=hidden]");var applyCheckboxStyle=function(){if($el.not(".checked")&&$el_input.val()==="on"){$el.addClass("checked")}else{if($("dd.task-repeat-box div.checked:not(.disabled)").length>1){$el.removeClass("checked")}}};applyCheckboxStyle();$el.click(function(ev){if($(this).hasClass("disabled")){return}else{if($el_input.val()==="on"){$el_input.val("")}else{$el_input.val("on")}applyCheckboxStyle()}})});$("#taskform .task-repeat .repeat-ok").bind("click",function(){GTD.Taskform.getRepeatMode();if(!Do.isEmptyStr($(".task-reminder .meta-input").val())){$(".task-reminder .popup").taskForm_reminderPopup();GTD.Taskform.resetReminder("repeat")}});$("#taskform .task-reminder .popup .reminder").isNumInput();$("#taskform .taskform-btn-cancel").bind("click",function(){window.onbeforeunload=null;GTD.overlay.remove();$("#taskform").fadeOut("fast",function(){$(this).removeAttr("style")});$("#taskform").unbind(".escCancel")});$("#taskform .taskform-btn-save").bind("click",function(){window.onbeforeunload=null;if($(this).hasClass("disabled")){return false}GTD.Taskform.save();$("#taskform").unbind(".escCancel")})}})(jQuery);(function(a){GTD.Smartfolder={};GTD.Smartfolder.nextform=function(){a("#smartfolder_form").removeClass("clickhide");GTD.Smartfolder.getData();var c=Do.objClone(GTD.Smartfolder.data);GTD.Smartfolder.genChoosed(c);a("#smartfolder_next,#smartfolder_cancel").hide();a("#smartfolder_prev,#smartfolder_save").show();var b=a("#smartfolder_form_2").outerHeight();a(".formbox-main-wrap").animate({marginLeft:"-750px",height:b+"px"},500);a(".smartbox-menu").addClass("smartbox-menu-next");a(".smartbox-menu li:first").removeClass("on");a(".smartbox-menu li:eq(1)").addClass("on")};GTD.Smartfolder.prevform=function(){a("#smartfolder_next,#smartfolder_cancel").show();a("#smartfolder_prev,#smartfolder_save").hide();var b=a("#smartfolder_form_1").outerHeight();a(".formbox-main-wrap").animate({marginLeft:"0px",height:b+"px"},500);a(".smartbox-menu").removeClass("smartbox-menu-next");a(".smartbox-menu li:eq(1)").removeClass("on");a(".smartbox-menu li:first").addClass("on")};GTD.Smartfolder.datainit=function(c,e){var b=Do.makeUUID();var f=a("#sidebar .more li").length+2+1;GTD.Smartfolder.data={id:b,name:"noname",box_condition:{status:null,forwarded_by:null,assign_to:null,start_at:null,end_at:null,priority:[],contexts:[],projects:[],tags:[]},type:"user",pos:f,group_by:null,order_by:[],hidden:false};if(c=="update"){GTD.Smartfolder.data=Do.objClone(e);Do.log("当前编辑的自定义箱子数据↓");Do.log(GTD.Smartfolder.data);GTD.Smartfolder.setData(GTD.Smartfolder.data)}};GTD.Smartfolder.popup=function(c,g){GTD.Smartfolder.type=c;var h=a("#smartfolder_form");h.html("").append(GTD.Smartfolder.node);GTD.overlay.add(0);h.show();h.animate({opacity:1,top:"+=50"},500);a("#smartfolder_form .btn-control-next").click(function(){GTD.Smartfolder.nextform()});a("#smartfolder_form .btn-control-prev").click(function(){GTD.Smartfolder.prevform()});a("#smartfolder_cancel .btn-control-cancel").bind("click",function(){h.slideUp("fast");GTD.overlay.remove();h.removeAttr("style")});a("#smartfolder_starttime li").bind("click",function(){if(a(this).attr("data-id")=="mn"){a("#smartfolder_starttime_mn").show()}else{a("#smartfolder_starttime_mn").hide()}});a("#smartfolder_starttime_mn input,#smartfolder_deadline_mn input").isSecondBiggerFirsrt();a("#smartfolder_context,#smartfolder_project,#smartfolder_tag").bind("click",function(k){a("#smartfolder_form").addClass("clickhide");var m=a(this).attr("id");var l=a(this);a(".smartfolder-drop:visible").hide();l.next().toggle();k.stopPropagation();a("body").bind("click."+m,function(n){if(a(n.target).closest(".smartfolder-drop").prev().attr("id")!=m){l.next().hide()}})});a("#smartfolder_deadline li").bind("click",function(){if(a(this).attr("data-id")=="mn"){a("#smartfolder_deadline_mn").show()}else{a("#smartfolder_deadline_mn").hide()}});a("#smartfolder_form .select-box").click(function(){a("#smartfolder_form").addClass("clickhide")});function b(l){var k=a(l);k.bind("click",function(){var n=a(this).closest("ul").find(":checked");var o="";var m=[];n.each(function(r,s){var p=a(s).attr("data-id");if(p==null){m=[null]}else{m.push(p)}var q=a(this).next().text();o=o==""?q:o+","+q});a(this).closest(".smartfolder-wrapdiv").find("input").val(o).data("data",m)})}function f(){var o=Doit.contexts;var s=a('<div><li><input type="checkbox" id="smartfolder_context_null" value=""><label title="'+L.NO_CONTEXT+'" for="smartfolder_context_null">'+L.NO_CONTEXT+"</label></li></div>");for(i=0;i<o.length;i++){var l=o[i].name;var k=o[i].id;var m="smartfolder_context_drop_"+encodeURIComponent(l);var q=a('<input id="'+m+'" data-id="'+k+'" type="checkbox" />');var p=a('<label for="'+m+'" title="'+l+'">'+l+"</label>");var r=a("<li></li>");r.append(q).append(p);s.append(r)}a("#smartfolder_context_div ul").append(s.html());var n=a("#smartfolder_context_div ul input,#smartfolder_context_div ul input label");b(n)}f();function j(){var n=Doit.projects;var s=a('<div><li><input type="checkbox" id="smartfolder_project_null" value=""><label title="'+L.NO_PROJECT+'" for="smartfolder_project_null">'+L.NO_PROJECT+"</label></li></div>");for(i=0;i<n.length;i++){var l=n[i].name;var k=n[i].id;var m="smartfolder_project_drop_"+encodeURIComponent(l);var q=a('<input id="'+m+'" data-id="'+k+'" type="checkbox" />');var p=a('<label for="'+m+'" title="'+l+'">'+l+"</label>");var r=a("<li></li>");r.append(q).append(p);s.append(r)}a("#smartfolder_project_div ul").append(s.html());var o=a("#smartfolder_project_div ul input,#smartfolder_project_div ul input label");b(o)}j();function e(){var o=Doit.tags;var q=a('<div><li><input type="checkbox" id="smartfolder_tag_null" value=""><label title="'+L.NO_TAG+'" for="smartfolder_tag_null">'+L.NO_TAG+"</label></li></div>");for(i=0;i<o.length;i++){var n=o[i].name;var r="smartfolder_tag_drop_"+encodeURIComponent(n);var l=a('<input id="'+r+'" data-id="'+n+'" type="checkbox" />');var m=a('<label for="'+r+'" title="'+n+'">'+n+"</label>");var k=a("<li></li>");k.append(l).append(m);q.append(k)}a("#smartfolder_tag_div ul").append(q.html());var p=a("#smartfolder_tag_div ul input,#smartfolder_tag_div ul input label");b(p)}e();contacts_left=GTD.Taskform.removeNoContacts();a("#smartfolder_forwardby").doitAutocomplete({data:contacts_left,filters:["name","email"],valueFunction:function(m){var k=a(m).val().split(",");var l=k.length;var n=a.trim(k[l-1]);return n},showFunction:function(k){if(k.name==k.email){return a('<li><span title="'+k.name+'">'+k.name+"</span></li>")}else{return a('<li><span title="'+k.name+"("+k.email+')">'+k.name+"("+k.email+")</span></li>")}},selectFucntion:function(m){email=m.attr("email");var l=a("#smartfolder_forwardby");var k=Do.trimArray(l.val().split(","));k=Do.uniqueArray(Do.replaceArrayLastElement(k,email)).toString()+",";l.val(k);a("#smartfolder_forwardby").focus()},callbackFunction:function(){is_autocomplete=true}});a("#smartfolder_forward").doitAutocomplete({data:contacts_left,filters:["name","email"],valueFunction:function(m){var k=a(m).val().split(",");var l=k.length;var n=a.trim(k[l-1]);return n},showFunction:function(k){if(k.name==k.email){return a('<li><span title="'+k.name+'">'+k.name+"</span></li>")}else{return a('<li><span title="'+k.name+"("+k.email+')">'+k.name+"("+k.email+")</span></li>")}},selectFucntion:function(m){email=m.attr("email");var l=a("#smartfolder_forward");var k=Do.trimArray(l.val().split(","));k=Do.uniqueArray(Do.replaceArrayLastElement(k,email)).toString()+",";l.val(k);a("#smartfolder_forward").focus()},callbackFunction:function(){is_autocomplete=true}});a("#smartfolder_save").bind("click",function(){GTD.Smartfolder.save()});GTD.Smartfolder.datainit(c,g);if(c=="update"){a("#smartfolder_del").show();a("#smartfolder_del").bind("click",function(){var k=GTD.Smartfolder.data;k.name=a("#smartfolder_name").val();k.deleted=Doit.time;a.ajax.update_user_boxes({data:k,onSuccess:function(){GTD.smartBox.saveSmartBox(k);h.slideUp("fast");GTD.overlay.remove()}},"")})}};a.fn.isSecondBiggerFirsrt=function(){return this.each(function(){var c=a(this);var b=a(this).parent();c.bind("blur",function(f){var h=Do.parseInt(a.trim(b.find("input:first").val()));var g=Do.parseInt(a.trim(b.find("input:last").val()));var e=b.find("input").index(a(this));if(e==1&&h!=""&&g<h){a(this).val(h+1)}if(e==0&&g!=""&&h>g){a(this).next().val(h+1)}if(!/^[0-9]*$/.test(c.val())){c.val("")}})})};GTD.Smartfolder.genChoosed=function(O){var A="";var z=O.box_condition.status;var F=L.SMARTFOLDER_STATUS;switch(z){case"completed":F+=L.SMARTFOLDER_STATUS_COMP+"; ";break;case"uncompleted":F+=L.SMARTFOLDER_STATUS_NOCOMP+"; ";break;default:F="";break}var l=O.box_condition.priority;var Q=L.SMARTFOLDER_PRIORITY;if(l.length>0){var I=l.toString().replace("0",L.SMARTFOLDER_PRIORITY_N).replace("1",L.SMARTFOLDER_PRIORITY_L).replace("2",L.SMARTFOLDER_PRIORITY_M).replace("3",L.SMARTFOLDER_PRIORITY_H);Q+=I;Q+="; "}else{Q=""}var h=O.group_by;var f=L.SMARTFOLDER_GROUPBY;if(h!=null){f+=a('#smartfolder_groupby li[data-id="'+h+'"]').html()+"; "}else{f=""}var q=O.order_by[0];var C=L.SMARTFOLDER_SORTBY;if(q.length>0){var r=q[0];var m=a('#smartfolder_sort li[data-id="'+r+'"]').html();var k=q[1];var y=a('#smartfolder_sort_order li[data-id="'+k+'"]').html();C+=m+" "+y+"; "}else{C=""}var N=O.box_condition.start_at;var v=L.SMARTFOLDER_STARTTIME;if(N!=null){var e=N.split(":");if(e.length>1){N="mn";var j=e[0];switch(j){case"1":j+=L.SMARTFOLDER_TIME_ST;break;case"2":j+=L.SMARTFOLDER_TIME_ND;break;default:break}var H=e[1];switch(H){case"1":H+=L.SMARTFOLDER_TIME_ST;break;case"2":H+=L.SMARTFOLDER_TIME_ND;break;default:break}v+=a('#smartfolder_starttime li[data-id="'+N+'"]').html()+L.SMARTFOLDER_TIME_SPACE+L.SMARTFOLDER_TIME_FROM+j+L.SMARTFOLDER_TIME_SPACE+L.SMARTFOLDER_TIME_TO+L.SMARTFOLDER_TIME_SPACE+H+L.SMARTFOLDER_TIME_DAY+"; "}else{v+=a('#smartfolder_starttime li[data-id="'+N+'"]').html()+"; "}}else{v=""}var c=O.box_condition.end_at;var K=L.SMARTFOLDER_DEADLINE;if(c!=null){var b=c.split(":");if(b.length>1){c="mn";var n=b[0];switch(n){case"1":n+=L.SMARTFOLDER_TIME_ST;break;case"2":n+=L.SMARTFOLDER_TIME_ND;break;default:break}var P=b[1];switch(P){case"1":P+=L.SMARTFOLDER_TIME_ST;break;case"2":P+=L.SMARTFOLDER_TIME_ND;break;default:break}K+=a('#smartfolder_deadline li[data-id="'+c+'"]').html()+L.SMARTFOLDER_TIME_SPACE+L.SMARTFOLDER_TIME_FROM+n+L.SMARTFOLDER_TIME_SPACE+L.SMARTFOLDER_TIME_TO+L.SMARTFOLDER_TIME_SPACE+P+L.SMARTFOLDER_TIME_DAY+"; "}else{K+=a('#smartfolder_deadline li[data-id="'+c+'"]').html()+"; "}}else{K=""}var g=a("#smartfolder_context").val();g=g==""?g:L.SMARTFOLDER_CONTECTS+g+";";var s=a("#smartfolder_project").val();s=s==""?s:L.SMARTFOLDER_PROJECTS+s+";";var u=Do.escapeArrayHTML(O.box_condition.tags);var B=L.SMARTFOLDER_TAGS;if(u.length>0&&u[0]!=""){if(u[0]==null){u[0]=L.NO_CONTEXT}B+=u.toString()+"; "}else{B=""}var o=O.box_condition.forwarded_by;var p=L.SMARTFOLDER_BY;if(o!=null){var w=o.action;var x=a('#smartfolder_fowardby_type li[data-id="'+w+'"]').html();var M=o.email;p+=x+L.SMARTFOLDER_SPACE+M.toString()+"; "}else{p=""}var G=O.box_condition.assign_to;var J=L.SMARTFOLDER_TO;if(G!=null){var D=G.action;var E=a('#smartfolder_foward_type li[data-id="'+D+'"]').html();var t=G.email;J+=E+L.SMARTFOLDER_SPACE+t.toString()+"; "}else{J=""}A=A+F+Q+f+C+v+K+g+s+B+p+J;a("#smartfolder_form_2 p").html(A)};GTD.Smartfolder.setData=function(U){var e=Do.unescapeHTML(U.name);a("#smartfolder_name").val(e);var C=U.box_condition.status;switch(C){case"completed":a("#smartfolder_comp").attr("checked","checked");break;case"uncompleted":a("#smartfolder_nocomp").attr("checked","checked");break;default:break}var o=U.box_condition.priority;if(o.length!=0){for(S=0;S<o.length;S++){var K=o[S];a("#smartfolder_pri_"+K).attr("checked","checked")}}var m=U.group_by;if(m!=null){var O=a('#smartfolder_groupby li[data-id="'+m+'"]').html();a("#smartfolder_groupby .selected-text").html(O).attr("data-id",m)}var s=U.order_by[0];var t=s[0];var Q=a('#smartfolder_sort li[data-id="'+t+'"]').html();a("#smartfolder_sort .selected-text").html(Q).attr("data-id",t);var n=s[1];var J=a('#smartfolder_sort_order li[data-id="'+n+'"]').html();a("#smartfolder_sort_order .selected-text").html(J).attr("data-id",n);var T=U.box_condition.start_at;if(T!=null){var g=T.split(":");if(g.length>1){a("#smartfolder_starttime_mn").show();a("#smartfolder_starttime_m").val(g[0]);a("#smartfolder_starttime_n").val(g[1]);T="mn"}var E=a('#smartfolder_starttime li[data-id="'+T+'"]').html();a("#smartfolder_starttime .selected-text").html(E).attr("data-id",T)}var f=U.box_condition.end_at;if(f!=null){var c=f.split(":");if(c.length>1){a("#smartfolder_deadline_mn").show();a("#smartfolder_deadline_m").val(c[0]);a("#smartfolder_deadline_n").val(c[1]);f="mn"}var G=a('#smartfolder_deadline li[data-id="'+f+'"]').html();a("#smartfolder_deadline .selected-text").html(G).attr("data-id",f)}var p=U.box_condition.forwarded_by;if(p!=null){var A=p.action;var B=a('#smartfolder_fowardby_type li[data-id="'+A+'"]').html();var R=p.email;a("#smartfolder_fowardby_type .selected-text").html(B).attr("data-id",A);a("#smartfolder_forwardby").val(R.toString()+",")}var M=U.box_condition.assign_to;if(M!=null){var H=M.action;var I=a('#smartfolder_foward_type li[data-id="'+H+'"]').html();var v=M.email;a("#smartfolder_foward_type .selected-text").html(I).attr("data-id",H);a("#smartfolder_forward").val(v.toString()+",")}var x=U.box_condition.contexts;var l=[];if(x.length>0){var j="";for(S=0;S<x.length;S++){var V=x[S];var q=Do.unescapeHTML(GTD.find_name_by_uuid(Doit.contexts,V));if(S==0&&V==null){a("#smartfolder_context_null").attr("checked","checked");q=L.NO_CONTEXT;l=[null]}else{l.push(V)}j=S==0?q:j+","+q;q=q==L.NO_CONTEXT?"null":q;var w=encodeURIComponent(q);Do.id("smartfolder_context_drop_"+w).attr("checked","checked")}a("#smartfolder_context").val(j).data("data",l)}var h=U.box_condition.projects;var N=[];if(h.length>0){var u="";for(var S=0;S<h.length;S++){var b=h[S];var F=Do.unescapeHTML(GTD.find_name_by_uuid(Doit.projects,b));if(S==0&&b==null){a("#smartfolder_project_null").attr("checked","checked");F=L.NO_PROJECT;N=[null]}else{N.push(b)}u=S==0?F:u+","+F;F=F==L.NO_PROJECT?"null":F;var k=encodeURIComponent(F);Do.id("smartfolder_project_drop_"+k).attr("checked","checked")}a("#smartfolder_project").val(u).data("data",N)}var y=U.box_condition.tags;var z=[];if(y.length>0){var D="";for(S=0;S<y.length;S++){var P=Do.unescapeHTML(y[S]);if(S==0&&P==null){a("#smartfolder_tag_null").attr("checked","checked");P=L.NO_TAG;z=[null]}else{z.push(P)}D=S==0?P:D+","+P;var r=encodeURIComponent(y[S]);Do.id("smartfolder_tag_drop_"+r).attr("checked","checked")}a("#smartfolder_tag").val(D).data("data",z)}};GTD.Smartfolder.getData=function(){GTD.Smartfolder.data.name=a("#smartfolder_name").val();var b=a("#smartfolder_state input:checked").length;switch(b){case 0:GTD.Smartfolder.data.box_condition.status=null;break;case 2:GTD.Smartfolder.data.box_condition.status=null;break;default:GTD.Smartfolder.data.box_condition.status=a("#smartfolder_state input:checked").attr("data-id")}var k=[];if(a("#smartfolder_pri input:checked").length>0){a("#smartfolder_pri input:checked").each(function(){var r=Do.parseInt(a(this).attr("data-id"));k.push(r)});GTD.Smartfolder.data.box_condition.priority=k}else{GTD.Smartfolder.data.box_condition.priority=[]}var n=a("#smartfolder_groupby .selected-text").attr("data-id");GTD.Smartfolder.data.group_by=n=="none"?null:n;var f=a("#smartfolder_sort .selected-text").attr("data-id");var q=a("#smartfolder_sort_order .selected-text").attr("data-id");var l=[];GTD.Smartfolder.data.order_by=[];l.push(f);l.push(q);GTD.Smartfolder.data.order_by.push(l);var j=a("#smartfolder_starttime .selected-text").attr("data-id");function o(s){if(s=="mn"){var r=a.trim(a("#smartfolder_starttime_m").val());var u=a.trim(a("#smartfolder_starttime_n").val());if(r==""||u==""){var t=null}else{var t=r+":"+u}}else{var t=s}return t}GTD.Smartfolder.data.box_condition.start_at=j=="none"?null:o(j);var c=a("#smartfolder_deadline .selected-text").attr("data-id");function h(s){if(s=="mn"){var r=a.trim(a("#smartfolder_deadline_m").val());var u=a.trim(a("#smartfolder_deadline_n").val());if(r==""||u==""){var t=null}else{var t=r+":"+u}}else{var t=s}return t}GTD.Smartfolder.data.box_condition.end_at=c=="none"?null:h(c);if(a("#smartfolder_forwardby").val().length>0){var e=a("#smartfolder_fowardby_type .selected-text").attr("data-id");var g=Do.uniqueArray(Do.trimArray(a("#smartfolder_forwardby").val().split(",")).emptyFilter());GTD.Smartfolder.data.box_condition.forwarded_by={};GTD.Smartfolder.data.box_condition.forwarded_by.action=e=="in"?"in":"nin";GTD.Smartfolder.data.box_condition.forwarded_by.email=g}else{GTD.Smartfolder.data.box_condition.forwarded_by=null}if(a("#smartfolder_forward").val().length>0){var p=a("#smartfolder_foward_type .selected-text").attr("data-id");var m=Do.uniqueArray(Do.trimArray(a("#smartfolder_forward").val().split(",")).emptyFilter());GTD.Smartfolder.data.box_condition.assign_to={};GTD.Smartfolder.data.box_condition.assign_to.action=p=="in"?"in":"nin";GTD.Smartfolder.data.box_condition.assign_to.email=m}else{GTD.Smartfolder.data.box_condition.assign_to=null}GTD.Smartfolder.data.box_condition.contexts=a("#smartfolder_context").val()==""?[]:a("#smartfolder_context").data("data");GTD.Smartfolder.data.box_condition.projects=a("#smartfolder_project").val()==""?[]:a("#smartfolder_project").data("data");GTD.Smartfolder.data.box_condition.tags=a("#smartfolder_tag").val()==""?[]:a("#smartfolder_tag").data("data");Do.log("当前的自定义箱子已选择的条件数据↓");Do.log(GTD.Smartfolder.data)};GTD.Smartfolder.save=function(){var c=a.trim(a("#smartfolder_name").val());var b="server_length?str="+encodeURIComponent(c);a.ajax.checkLength({onSuccess:function(h){var e=Do.parseJSON(h.responseText);if(e.length>12||e.length<=0){GTD.M(L.SMARTFOLDER_TITLELIMIT)}else{GTD.Smartfolder.data.name=c;var g=GTD.Smartfolder.data;if(GTD.Smartfolder.type=="update"){var f=a("#sidebar .s").attr("id");a.ajax.update_user_boxes({data:g,onSuccess:function(){Do.escapeArrayHTML(g.box_condition.contexts);Do.escapeArrayHTML(g.box_condition.projects);Do.escapeArrayHTML(g.box_condition.tags);g.name=Do.escapeHTML(c);GTD.Smartfolder.localData=g;Do.log("当前的自定义箱子已选择的条件存往本地的数据↓");Do.log(g);GTD.smartBox.saveSmartBox(GTD.Smartfolder.localData);var j=a("#smartfolder_form");j.slideUp("fast");GTD.overlay.remove();if(f==g.id){GTD.Time.loadTimeboxTask(f)}},onError:function(k){var j=Do.parseJSON(k.responseText);if(j.retcode=="E006"){GTD.M(L.SMARTFOLDER_TITLELIMIT)}if(j.retcode=="E005"){GTD.M(L.SMARTFOLDER_EXISTNAME)}}},"")}else{a.ajax.add_user_boxes({data:g,onSuccess:function(){Do.escapeArrayHTML(g.box_condition.contexts);Do.escapeArrayHTML(g.box_condition.projects);Do.escapeArrayHTML(g.box_condition.tags);g.name=Do.escapeHTML(c);GTD.Smartfolder.localData=g;Do.log("当前的自定义箱子已选择的条件存往本地的数据↓");Do.log(g);GTD.smartBox.saveSmartBox(GTD.Smartfolder.localData);var j=a("#smartfolder_form");j.slideUp("fast");GTD.overlay.remove()},onError:function(k){var j=Do.parseJSON(k.responseText);if(j.retcode=="E006"){GTD.M(L.SMARTFOLDER_TITLELIMIT)}if(j.retcode=="E005"){GTD.M(L.SMARTFOLDER_EXISTNAME)}}},"")}}}},b)}})(jQuery);(function(a){a.smartAdd={rules:[{flag:"^",list:["今日","明日","择日待办","mm-dd (e.g. 04-01)","yy-mm-dd (e.g. 2012-12-20)"],repeat:false,hr:3,className:["","",""]},{flag:"#",list:["life","study","Doit.im","运动","办公"],repeat:false,hr:-1}],getRules:function(){return a.smartAdd.rules},setRules:function(){if(arguments!="undefined"){a.smartAdd.rules=arguments}}};a.fn.smartAdd=function(){$input=this;var h=a('<div id="pDiv" style="position:absolute;visibility:hidden"></div>');h.css({"font-size":$input.css("font-size")},{border:0},{margin:0},{padding:0});var f=$input.position();var j=$input.parent().css("padding-left");var l=parseInt(j.substring(0,j.length-2),10);var k=$input.css("padding-left");var c=parseInt(k.substring(0,k.length-2),10);h.css("left",(f.left+l+c)+"px");$input.val("").removeAttr("disabled").parent().append(h);var g=a('<div id="smart_add_list" style="text-align:left"></div>');a("#smart_add_list li").live("mouseover",function(){if(a(this).hasClass("disabled")){}else{a(this).parent().find(".highlight").removeClass("highlight")}a(this).not(".disabled").addClass("highlight")}).live("mouseout",function(){if(a(this).parent().find(".highlight").length!=1){a(this).removeClass("highlight")}}).live("mousedown",function(){if(a(this).hasClass("disabled")){}else{$input.val($input.val()+g.find(".highlight").text()+" ");e();return false}});$input.parent().append(g);$input.blur().bind("focus",function(){a(this).unbind("keyup.saku").bind("keyup.saku",function(q){if(q.which!=38&&q.which!=40&&q.which!=13&&q.which!=16){h.text($input.val());var t=$input.parent().css("padding-top");var n=parseInt(t.substring(0,t.length-2),10);var r=$input.css("padding-top");var p=parseInt(r.substring(0,r.length-2),10);if(h.width()>$input.width()){g.css({left:h.position().left+$input.width()+"px"}).css({top:$input.position().top+n+$input.outerHeight()/2-1+"px"})}else{g.css({left:h.position().left+h.width()+"px"}).css({top:$input.position().top+n+$input.outerHeight()/2-1+"px"})}var w=this.value;var v=w.split(" ");var u=v[v.length-1];var m=u.toString();var o=false;a.each(a.smartAdd.getRules(),function(G,B){var B=B;var C=B.flag;var D="(^| )\\"+C;var y=new RegExp(D);var s=B.repeat==undefined?false:B.repeat;if(y.test(m)){if(m.length==1&&(s||!(new RegExp("(^| )\\"+C+".+ ").test($input.val())))){b(B.list,B.className,B.hr)}else{if(m.length>1){var F=[];var E=B.list;var I=E.length>B.hr?B.hr:E.length;var H=I<0?E.length:I;for(var A=0;A<H;A++){var z="^"+m.substring(1,m.length).replace(/([\!\$\^\&\*\(\)\+\{\}\|\:\?\-\=\[\]\.\/\\])/g,"\\$1");var x=new RegExp(z,"i");if(x.test(E[A])){F.push(E[A])}}if(F.length==0){e()}else{b(F)}}}o=true}});if(!o){e()}}}).unbind("keydown.sakd").bind("keydown.sakd",function(u){if(u.which==38){var o=g.find("li.highlight").prev();var p=o.next();var v=o.length==0?22222:o.position().top;var n=a("#smart_add_list ul").scrollTop();if(v<=0){a("#smart_add_list ul").scrollTop(n+v)}else{if(v==22222){a("#smart_add_list ul").scrollTop(22222);o=g.find("li:last");p=g.find("li:first")}}o.not(".disabled").addClass("highlight");p.removeClass("highlight");return false}else{if(u.which==40){var p=g.find("li.highlight").next();var o=p.prev();var s=g.find("li").index(p);var r=(s-7)*26+10;if(s>=8){a("#smart_add_list ul").scrollTop(r)}else{if(s==-1){a("#smart_add_list ul").scrollTop(0);p=g.find("li:first");o=g.find("li:last")}}p.not(".disabled").addClass("highlight");o.removeClass("highlight");return false}else{if(u.which==13){if(a("#smart_add_list").css("visibility")!="hidden"){var m=$input.val();var q=m.split(" ");var t=q.pop();q.push(t.substring(0,1)+g.find(".highlight").text()+" ");$input.val(q.join(" "));e();u.stopPropagation();return false}}else{if(u.keyCode==27){a(this).trigger("blur")}}}}})}).bind("blur",function(){a(this).unbind("keyup.saku").unbind("keydown.sakd");e()});function b(n,p,o){if(n.length==0){return}var p=p==undefined?[]:p;var o=o==undefined?-1:o;var q="";for(var m=0;m<n.length;m++){if(m==0){q+='<li class="highlight '+(p[m]==undefined?"":p[m])+'">'+Do.escapeHTML(n[m])+"</li>"}else{if(m>=o&&o>0){if(m==o){q+='<li class="disabled hr '+(p[m]==undefined?"":p[m])+'">'+Do.escapeHTML(n[m])+"</li>"}else{q+='<li class="disabled'+(p[m]==undefined?"":p[m])+'">'+Do.escapeHTML(n[m])+"</li>"}}else{q+='<li class="'+(p[m]==undefined?"":p[m])+'">'+Do.escapeHTML(n[m])+"</li>"}}}var r="<ul>"+q+"</ul>";g.html(r).css("visibility","visible")}function e(){g.css("visibility","hidden")}};a.smartAdd.readyToPostTask=function(m){var c=m;var J=c.split(" ");var M="";var k=null;var z=null;var p=null;var g=null;var j=null;var v=[];var I=0;var A=false,f=false;var C=Time.zoneToRubyString(Do.cookie("user_timezone"));for(var F=0;F<J.length;F++){if(/^\^/.test(J[F])){p=J[F].substring(1,J[F].length)}else{if(/^\!/.test(J[F])){I=J[F].substring(1,J[F].length);I=Do.parseInt(I)}else{M+=" "+J[F]}}}var w=Doit.projects_smart;var r=/^.*(\s\#.*)/;var K=r.exec(" "+m);K=K==null?null:a.trim(K[1]).replace("#","");if(K!=null){while(a.inArray(K,w)==-1){if(K.split(" ").length==1){break}K=K.split(" ");K=K.slice(0,K.length-1);K=K.join(" ")}m=(" "+m+" ").replace(" #"+K,"")}if(K!=null&&GTD.findUUIDByName(Doit.projects,K)==null){A=true}var o=Doit.contexts_smart;var b=/^.*(\s\@.*)/;var t=b.exec(" "+m);t=t==null?null:a.trim(t[1]).replace("@","");if(t!=null){while(a.inArray(t,o)==-1){if(t.split(" ").length==1){break}t=t.split(" ");t=t.slice(0,t.length-1);t=t.join(" ")}m=(" "+m+" ").replace(" @"+t,"")}if(t!=null&&GTD.findUUIDByName(Doit.contexts,t)==null){f=true}var q=Doit.tags_smart;var n=/^.*(\s\&.*)/;var u=[];var E=n.exec(" "+m);if(E!=null){var s,H=m;while(E.length==2){if(E[0]==E[1]){s=true}H=H.replace(E[1],"");E=E==null?null:a.trim(E[1]).replace("&","");if(E!=null){while(a.inArray(E,q)==-1){if(E.split(" ").length==1){break}E=E.split(" ");E=E.slice(0,E.length-1);E=E.join(" ")}u.push(E);m=(" "+m+" ").replace(" &"+E,"")}if(s){break}E=n.exec(" "+H);if(E==null){break}}}u=Do.uniqueArray(u);if(u.length>5){u=u.slice(0,5)}var y=(" "+m).replace(" !"+I,"").replace(" ^"+p,"");var G={all_day:true,archived:null,assignment:null,attribute:"inbox",completed:null,created:Doit.time,deleted:null,end_at:null,forwarded_by:null,hidden:null,id:Do.makeUUID(),notes:"",priority:I,reminders:[],repeat_no:null,repeater:null,start_at:null,tags:u,title:a.trim(y),trashed:null,updated:Doit.time};GTD.syncTime();var x=Doit.currentBox;if(p==null){if(a.inArray(x,["inbox","next","today","tomorrow","someday","waiting"])>-1){GTD["set_"+x](G)}else{if(a.inArray(x,["context","project"])>-1){if(Doit.getTid()=="none"){GTD.set_inbox(G)}else{GTD["set_"+x](G,Doit.getTid());if(x=="project"){z=Doit.getTid()}else{j=Doit.getTid()}}}}}else{if(x=="context"){GTD["set_"+x](G,Doit.getTid());j=Doit.getTid()}else{if(x=="project"){GTD["set_"+x](G,Doit.getTid());z=Doit.getTid()}}var l=null;if(a.trim(p)==""||new RegExp(L.INBOX,"i").test(p)){l=null;G.attribute="inbox"}else{if(new RegExp(L.NEXT,"i").test(p)){l=null;G.attribute="next"}else{if(new RegExp(L.WAITING,"i").test(p)){l=null;G.attribute="waiting"}else{if(new RegExp(L.TOMORROW,"i").test(p)){l=Date.today().add(1).days().toString("yyyy-MM-dd HH:mm:ss ")+C;G.attribute="plan"}else{if(new RegExp(L.SOMEDAY,"i").test(p)){l=null;G.attribute="noplan"}else{if(new RegExp(L.TODAY,"i").test(p)){l=Date.today().toString("yyyy-MM-dd HH:mm:ss ")+C;G.attribute="plan"}else{G.attribute="plan";var h=a.trim(p);if(h.match(/^(\d{4})-(0\d{1}|1[0-2])-(0\d{1}|[12]\d{1}|3[01])$/)){l=h+" 00:00:00 "+C}else{if(h.match(/^(\d{4})\/(0\d{1}|1[0\/2])\/(0\d{1}|[12]\d{1}|3[01])$/)){l=h.replace(/\//g,"-")+" 00:00:00 "+C}else{if(h.match(/^(\d{2})-(0\d{1}|1[0-2])-(0\d{1}|[12]\d{1}|3[01])$/)){l=new Date().getFullYear().toString().substring(0,2)+h+" 00:00:00 "+C}else{if(h.match(/^(\d{2})\/(0\d{1}|1[0\/2])\/(0\d{1}|[12]\d{1}|3[01])$/)){l=new Date().getFullYear().toString().substring(0,2)+h.replace(/\//g,"-")+" 00:00:00 "+C}else{if(h.match(/^(\d{2})-([1-9])-([1-9])$/)){l=new Date().getFullYear().toString().substring(0,2)+h.replace(/-/g,"-0")+" 00:00:00 "+C}else{if(h.match(/^(\d{2})\/([1-9])\/([1-9])$/)){l=new Date().getFullYear().toString().substring(0,2)+h.replace(/\//g,"-0")+" 00:00:00 "+C}else{if(h.match(/^(0\d{1}|1[0-2])-(0\d{1}|[12]\d{1}|3[01])$/)){l=new Date().getFullYear().toString()+"-"+h+" 00:00:00 "+C}else{if(h.match(/^(0\d{1}|1[0\/2])\/(0\d{1}|[12]\d{1}|3[01])$/)){l=new Date().getFullYear().toString()+"-"+h.replace(/\//g,"-")+" 00:00:00 "+C}else{if(h.match(/^([1-9])-(0\d{1}|[12]\d{1}|3[01])$/)){l=new Date().getFullYear().toString()+"-0"+h+" 00:00:00 "+C}else{if(h.match(/^([1-9])\/(0\d{1}|[12]\d{1}|3[01])$/)){l=new Date().getFullYear().toString()+"-0"+h.replace(/\//g,"-")+" 00:00:00 "+C}else{if(h.match(/^(0\d{1}|1[0-2])-([1-9])$/)){l=new Date().getFullYear().toString()+"-"+h.replace(/-/g,"-0")+" 00:00:00 "+C}else{if(h.match(/^(0\d{1}|1[0\/2])\/([1-9])$/)){l=new Date().getFullYear().toString()+"-"+h.replace(/\//g,"-0")+" 00:00:00 "+C}else{if(h.match(/^([1-9])-([1-9])$/)){l=new Date().getFullYear().toString()+"-0"+h.replace(/-/g,"-0")+" 00:00:00 "+C}else{if(h.match(/^([1-9])\/([1-9])$/)){l=new Date().getFullYear().toString()+"-0"+h.replace(/\//g,"-0")+" 00:00:00 "+C}else{l=Date.today().toString("yyyy-MM-dd HH:mm:ss ")+C}}}}}}}}}}}}}}}}}}}}G.start_at=l}if(G.title==""){GTD.M(L.TITLE_REQUIRED);return false}else{if(G.title.length>225){GTD.M(L.TITLE_LESS_255);return false}}function D(N,P){var O={deleted:null,completed:null,created:Doit.time,name:N,id:Do.makeUUID(),group_by:"box"};a.ajax.createProject({data:O,onSuccess:function(Q){G.project_id=O.id;Doit.projects.push(O);if(P!=null){P()}Doit.projects_smart=[];a.each(Doit.projects,function(R,S){Doit.projects_smart.push(Do.unescapeHTML(S.name))});a.smartAdd.setRules({flag:"#",list:Doit.projects_smart,repeat:false,hr:-1})},onError:function(Q){GTD.M(L.AJAX_PROJECT_ADDING_FAILED,"error")},onFailure:function(Q){GTD.M(L.AJAX_PROJECT_ADDING_FAILED,"error")}})}function B(N,P){var O={deleted:null,created:Doit.time,name:N,group_by:null,id:Do.makeUUID()};a.ajax.createContext({data:O,onSuccess:function(Q){G.context_id=O.id;Doit.contexts.push(O);if(P!=null){P()}Doit.contexts_smart=[];a.each(Doit.contexts,function(R,S){Doit.contexts_smart.push(Do.unescapeHTML(S.name))});a.smartAdd.setRules({flag:"@",list:Doit.contexts_smart,repeat:false,hr:-1})},onError:function(Q){GTD.M(L.AJAX_CONTEXT_ADDING_FAILED,"error")},onFailure:function(Q){GTD.M(L.AJAX_CONTEXT_ADDING_FAILED,"error")}})}function e(){a.ajax.createTask({data:G,onSuccess:function(S){var Q=G;GTD.taskEscapeHTML(Q);GTD.updateTags();TASKS.push(Q);var N=new Date(Doit.time);N=Time.userDay(N);var P=GTD.getTaskBox(Q);var O=Doit.currentBox;if(GTD.isIn(Q,Doit.currentBox)){var R=Doit.currentGroupBy;GTD.group.addNewTask(Q,R)}if(GTD.isToday(Q)||GTD.isInRepeat(N,Q)){GTD.increaseCount(a("#today"))}if(GTD.isInbox(Q)){GTD.increaseCount(a("#inbox"))}if(O!=P){a("div#sidebar li#"+P).effect("highlight",{color:"#0069bc"},500)}TASKS_FILTER=TASKS;GTD.M(L.TIPS_TASK_ADDED_OK)},onError:function(){a("#taskform .taskform-btn-save").removeClass("disabled");if(a(".task-assign .token-items li").length==1){GTD.M(L.AJAX_TASK_ADDING_FAILED,"error")}else{GTD.M(L.TASKFORM_TASK_SEND_FALSE,"error")}},onFailure:function(N){a("#taskform .taskform-btn-save").removeClass("disabled");if(a(".task-assign .token-items li").length==1){GTD.M(L.AJAX_TASK_ADDING_FAILED,"error")}else{GTD.M(L.TASKFORM_TASK_SEND_FALSE,"error")}}})}if(A&&!f){k=Do.maxText(K,30);D(k,e)}else{if(f&&!A){g=Do.maxText(t,30);B(g,e)}else{if(f&&A){k=Do.maxText(K,30);g=Do.maxText(t,30);D(k,B(g,e))}else{k=z!=null?z:GTD.findUUIDByName(Doit.projects,K);g=j!=null?j:GTD.findUUIDByName(Doit.contexts,t);G.project_id=k;G.context_id=g;e()}}}$input.val("");return false}})(jQuery);(function(a){Doit.search={};Doit.search.filterTasks=function(h){h=a.trim(h);var j=[];var f=new RegExp(Do.escapeHTML(h),"i");var b=new Array();var e=new Array();if(Doit&&Doit.projects){for(var c=0;c<Doit.projects.length;c++){var g=Doit.projects[c];if(f.test(g.name)){b.push(g.name)}}}if(Doit&&Doit.contexts){for(var c=0;c<Doit.contexts.length;c++){var g=Doit.contexts[c];if(f.test(g.name)){e.push(g.name)}}}j=a.grep(TASKS,function(l){var k=l.repeat_no==null?"task_"+l.id:"task_"+l.id+"_"+l.repeat_no;if((l.project!=null&&!a.isEmptyObject(b)&&a.inArray(l.project,b)!=-1)||(l.context!=null&&!a.isEmptyObject(e)&&a.inArray(l.context,e)!=-1)||f.test(l.title)||f.test(l.tags)){Do.id(k).removeClass("search-hidden");return l}else{Do.id(k).addClass("search-hidden")}});return j};Doit.search.current=function(b){a(".archiver-tool").hide();a("#task_quick_add").hide();a("#search_result").show();if(Doit.currentBox!="project"){a("#project_info").remove()}a("#search_result .keyword").text(b);var c=Doit.search.filterTasks(b);if(c.length==0){a("#empty_tip_content").html("<p>"+L.i_search_no_result+"</p>").show()}else{a("#empty_tip_content").hide()}a(".group").each(function(){var e=a(this).find("li:not(:hidden)").length;if(e==0){a(this).hide()}else{a(this).show()}});GTD.loadingData("hide")};Doit.search.global=function(b){a(".archiver-tool").hide();a("#search_result").show();a("#search_result .keyword").text(b);if(Doit.currentBox!="project"){a("#project_info").remove()}a("#sidebar .s").removeClass("s");Doit.currentBox="search";a.ajax.search({data:{condition:b},onSuccess:function(c){var e=a.parseJSON(c.responseText).entries;TASKS=e;TASKS_FILTER=e;GTD.group.getGroups("default");if(e.length==0){a("#empty_tip_content").html("<p>"+L.i_search_no_result+"</p>").show()}a("#task_quick_add").hide()}},"tasks")};a("input[placeholder]").each(function(){Do.bindPlaceholder(this)});a.fn.isSearchResult=function(){a(".search-input").bind("keyup",function(f){var c=f.keyCode;if(f.keyCode==27){a(this).trigger("blur")}});var b=a(".search-form");a(".search-type").bind("click",function(){a(".search-type-drop").toggle()});a(".search-type-drop ul").delegate("li","click",function(){var e=a(this).text();var c=a(this).attr("data-id");a(".search-type").text(e).attr("data-id",c);a(".search-type-drop").hide();return false});b.bind("submit",function(){var c=a.trim(a(".search-input").val());if(c==""){return false}if(a(".search-type").attr("data-id")=="current"){window.location="#/search/current/"+c}else{window.location="#/search/global/"+c}return false})};a("#top_search").isSearchResult()})(jQuery);$(document).ready(function(){GTD.doitNowExternal=function(a){$(a).bind("click",function(){var e=window.screen.width-500;var b="height=500,width=500,top=0,left="+e+",location=no,menubar=no,resizable=yes,scrollbars=yes,status=no,toolbar=no";var c=window.open("/home/doitnow","doitnow",b);GTD.childWindow=c;return false})};$("#logo,#rocket").bind("click",function(){if($(this).hasClass("disabled")){return false}$("#logo,#rocket").addClass("disabled");var a=$('<div id="lasttime" style="display:none"><div class="word">'+L.HAPPY2012_1+"</div></div>");var c=$(window).height();var e=e=$(window).height()+260;var b=$(window).width();var g=c/2-50;var f=b/2-300;c+=250;$("body").append(a);a.css({top:g+"px",left:f+"px"});a.fadeIn(3000,function(){$(this).fadeOut(3000,function(){$(this).find(".word").html(L.HAPPY2012_2);$(this).fadeIn(3000,function(){$(this).fadeOut(3000,function(){$(this).find(".word").html(L.FIREROCKET);$(this).fadeIn(3000,function(){var h=10;var j=setTimeout(function(){var k=setInterval(function(){$("#lasttime .word").html(h--);if(h==-1){$("#lasttime .word").html("").hide();setTimeout(function(){$("#lasttime .word").html("");$("#rocket").animate({left:"+=100",top:"-=100"},2000,function(){$("#goodbye_earth").show();$("body").css({"overflow-y":"hidden"});$("body").animate({marginTop:"-="+e,},8000,function(){$("#rocket").css({top:c+"px"});var m=b+Do.parseInt(200);var l=c+Do.parseInt(50);$("#rocket").animate({left:"+="+m,top:"-="+l},8000,function(){$("#lasttime .word").html(L.GOODBYEEARTH).show();var n=$('<div class="back">'+L.HAPPY41+" <span>("+L.BACKTOEARTH+")</span> </div>");n.find("span").bind("click",function(){$("body").css({"margin-top":"0px","overflow-y":"auto"});$("#lasttime").remove();$("#goodbye_earth").hide();$("#rocket").removeAttr("style");$("#logo,#rocket").removeClass("disabled")});a.append(n)})})})},1000);clearInterval(k)}},1000)},1000)})})})})})});$("#user_info_setting .user-info-icon").click(function(b){var a=$(b.target).parents(".user-info-box");if(a.hasClass("active")){a.removeClass("active");$("body").unbind("click.user_info");return}a.addClass("active");if(a.is("#user_info_search")){a.find("input").focus()}$("body").trigger("click.user_info");b.stopPropagation();$("body").unbind("click.user_info");$("body").bind("click.user_info",function(c){if(!$(c.target).parents("#"+a.attr("id")).length){a.removeClass("active");$("#search_task_result").hide();$("body").unbind("click.user_info")}})});$("#user_info_msg .user-info-icon").click(function(b){var a=$(b.target).parents(".message");if(a.hasClass("active")){a.removeClass("active");$("body").unbind("click.user_info");return}a.addClass("active");if(a.is("#user_info_search")){a.find("input").focus()}$("body").trigger("click.user_info");b.stopPropagation();$("body").unbind("click.user_info");$("body").bind("click.user_info",function(c){if(!$(c.target).parents("#"+a.attr("id")).length){a.removeClass("active");$("#search_task_result").hide();$("body").unbind("click.user_info")}})});$("#header .hotkey-help").bind("click",function(){GTD.hotkey_toggleHotkeyHelp();return false});$("#search_task_input").bind("keydown",function(a){if(a.keyCode===27){if($(this).val()){$(this).val("");$("#search_task_reset").hide();$("#search_task_result").hide()}else{$("#user_info_search").removeClass("active");$("body").unbind("click.user_info")}}});$("#search_task_input").bind("keyup",function(a){if($(this).val()){$("#search_task_reset").show();$("#search_task_result").show()}else{$("#search_task_reset").hide();$("#search_task_result").hide()}});$("#search_task_reset").click(function(){$("#search_task_input").val("");$("#search_task_reset").hide();$("#search_task_result").hide()});$("#user_info_msg_box>dl>dt>span").live("click",function(){$(this).parent().next().slideToggle("fast")});$("#msg_box_select_all").click(function(){var a=$(this).parents("#user_info_msg_box").find("input[type=checkbox]");a.attr("checked","checked")});$("#msg_box_select_op").click(function(){var a=$(this).parents("#user_info_msg_box").find("input");a.each(function(c,e){var b=$(e);if(b.attr("checked")){b.removeAttr("checked")}else{b.attr("checked","checked")}})});GTD.Taskform.node=$("#taskform").html();GTD.Projectform.node=$("#project_form").html();$(".contact-title li").live("click",function(){var b=$(this).parent();b.siblings(".contact-title").children().removeClass("s");b.siblings(".contact-list").slideUp();var a=b.next();if(a.is(":hidden")){a.slideDown();$(this).addClass("s")}else{a.slideUp();$(this).removeClass("s")}});GTD.SetTimer();$("div#groupby h3 a").groupPopToggle();$("#groupby_pop").groupMode();$("div#paper_title span#btn_tags_toggle").tagsToggle();GTD.topMenu();GTD.reloadTaskList();$("#user_info_msg_box>dl").everyTimeListMsg();if($("#quick_add_input").length){GTD.quickAdd.init()}Do.hotkey();GTD.Smartfolder.node=$("#smartfolder_form").html()});